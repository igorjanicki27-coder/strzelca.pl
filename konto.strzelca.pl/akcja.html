<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Akcje konta - strzelca.pl">
    <meta name="author" content="Strzelca.pl">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="https://strzelca.pl/ikona.svg">
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg">

    <title>Akcje konta - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --coyote: #C19A6B; }
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; margin: 0; overflow-x: hidden; }
        .main-wrapper { min-height: 100vh; width: 100%; background: linear-gradient(rgba(10,10,10,0.1) 0%, rgba(10,10,10,0.4) 50%, #0a0a0a 100%), url('https://strzelca.pl/tlo.png'); background-size: cover; background-position: top center; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .coyote-text { color: var(--coyote); font-family: 'Orbitron'; }
        .spinner { border: 4px solid #333; border-top: 4px solid var(--coyote); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .action-card { background: rgba(20, 20, 20, 0.95); border: 1px solid #333; border-radius: 20px; padding: 40px; text-align: center; max-width: 500px; width: 90%; }
        .checkmark { width: 80px; height: 80px; margin: 0 auto 20px; position: relative; animation: checkmark-appear 1s ease-in-out; }
        .checkmark::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(45deg); width: 25px; height: 40px; border: solid #10b981; border-width: 0 5px 5px 0; }
        @keyframes checkmark-appear { 0% { opacity: 0; transform: scale(0.3); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 1; transform: scale(1); } }

        input {
            background: #111 !important;
            border: 1px solid #222 !important;
            color: white !important;
            padding: 16px 20px !important;
            border-radius: 12px;
            width: 100%;
            outline: none;
            transition: 0.3s;
        }
        input:focus {
            border-color: var(--coyote) !important;
            background: #161616 !important;
        }

        .btn-action {
            background: var(--coyote);
            color: black;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            padding: 20px;
            border-radius: 12px;
            transition: 0.3s;
            cursor: pointer;
            width: 100%;
        }
        .btn-action:hover { transform: scale(1.02); box-shadow: 0 0 20px rgba(193, 154, 107, 0.2); }
        .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .error-message {
            color: #ef4444;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
    </style>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9EJ2R3JPVD"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-9EJ2R3JPVD');
    </script>
</head>
<body>
    <div class="main-wrapper">
        <div class="action-card" id="action-content">
            <!-- Treść zostanie załadowana dynamicznie przez JavaScript -->
            <div class="spinner"></div>
            <p class="text-lg text-zinc-300">Ładowanie...</p>
        </div>
    </div>

    <!-- Session Manager -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, applyActionCode, confirmPasswordReset, verifyPasswordResetCode, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        
      async function getFirebaseApiKey() {
        const urls = [
          "/api/firebase-config",
          "https://strzelca.pl/api/firebase-config",
        ];

        for (const url of urls) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) continue;
            const data = await res.json().catch(() => null);
            if (data && typeof data.apiKey === "string" && data.apiKey.length > 10) {
              return data.apiKey;
            }
          } catch (_) {
            // ignore and try next url
          }
        }

        throw new Error("Nie udało się pobrać FIREBASE_WEB_API_KEY z /api/firebase-config");
      }
const firebaseConfig = {
            apiKey: await getFirebaseApiKey(),
            authDomain: "strzelca-pl.firebaseapp.com",
            projectId: "strzelca-pl",
            storageBucket: "strzelca-pl.firebasestorage.app",
            messagingSenderId: "511362047688",
            appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
            measurementId: "G-9EJ2R3JPVD"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        function showError(message) {
            const actionContent = document.getElementById('action-content');
            if (!actionContent) {
                console.error('Element action-content nie znaleziony w showError');
                return;
            }
            actionContent.innerHTML = `
                <i class="fa-solid fa-exclamation-triangle text-6xl text-red-500 mb-6"></i>
                <h1 class="text-2xl md:text-3xl font-bold text-red-500 uppercase italic font-[Orbitron] mb-4">
                    Błąd
                </h1>
                <p class="text-lg mb-4 text-zinc-300">${message}</p>
                <a href="./login.html" class="inline-block bg-coyote text-black px-6 py-3 rounded-lg font-semibold hover:bg-white transition">
                    Powrót do logowania
                </a>
            `;
        }

        function showSuccess(message, redirectUrl = './login.html', redirectText = 'Powrót do logowania') {
            const actionContent = document.getElementById('action-content');
            if (!actionContent) {
                console.error('Element action-content nie znaleziony w showSuccess');
                return;
            }
            actionContent.innerHTML = `
                <div class="checkmark"></div>
                <h1 class="text-2xl md:text-3xl font-bold coyote-text uppercase italic font-[Orbitron] mb-4">
                    SUKCES
                </h1>
                <p class="text-lg mb-8 text-zinc-300">${message}</p>
                <a href="${redirectUrl}" class="inline-block bg-coyote text-black px-6 py-3 rounded-lg font-semibold hover:bg-white transition">
                    ${redirectText}
                </a>
            `;
        }

        function showPasswordResetForm(email) {
            const actionContent = document.getElementById('action-content');
            if (!actionContent) {
                console.error('Element action-content nie znaleziony w showPasswordResetForm');
                return;
            }
            actionContent.innerHTML = `
                <h1 class="text-2xl md:text-3xl font-bold coyote-text uppercase italic font-[Orbitron] mb-4">
                    RESET HASŁA
                </h1>
                <p class="text-lg mb-6 text-zinc-300">
                    Wprowadź nowe hasło dla konta: <strong>${email}</strong>
                </p>

                <form id="password-reset-form" class="space-y-6">
                    <div>
                        <label class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest">NOWE HASŁO</label>
                        <input type="password" id="new-password" placeholder="Wprowadź nowe hasło" required minlength="6">
                    </div>

                    <div>
                        <label class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest">POTWIERDŹ HASŁO</label>
                        <input type="password" id="confirm-password" placeholder="Potwierdź nowe hasło" required minlength="6">
                    </div>

                    <div class="error-message" id="password-error"></div>

                    <button type="submit" class="btn-action" id="reset-btn">
                        <i class="fa-solid fa-key mr-2"></i>
                        ZAPISZ NOWE HASŁO
                    </button>
                </form>
            `;

            // Obsługa formularza resetowania hasła
            document.getElementById('password-reset-form').addEventListener('submit', async (e) => {
                e.preventDefault();

                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                const resetBtn = document.getElementById('reset-btn');
                const errorEl = document.getElementById('password-error');

                // Sprawdź czy hasła są identyczne
                if (newPassword !== confirmPassword) {
                    errorEl.textContent = 'Hasła nie są identyczne.';
                    errorEl.style.display = 'block';
                    return;
                }

                if (newPassword.length < 6) {
                    errorEl.textContent = 'Hasło musi mieć co najmniej 6 znaków.';
                    errorEl.style.display = 'block';
                    return;
                }

                resetBtn.disabled = true;
                resetBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zapisywanie...';
                errorEl.style.display = 'none';

                try {
                    await confirmPasswordReset(auth, actionCode, newPassword);
                    showSuccess('Hasło zostało pomyślnie zmienione! Możesz się teraz zalogować.', './login.html', 'Przejdź do logowania');
                } catch (error) {
                    console.error('Password reset error:', error);
                    let errorMessage = 'Wystąpił błąd podczas zmiany hasła.';
                    if (error.code === 'auth/expired-action-code') {
                        errorMessage = 'Link wygasł. Poproś o nowy link resetowania hasła.';
                    } else if (error.code === 'auth/invalid-action-code') {
                        errorMessage = 'Link jest nieprawidłowy.';
                    } else if (error.code === 'auth/user-disabled') {
                        errorMessage = 'Konto zostało zablokowane.';
                    } else if (error.code === 'auth/user-not-found') {
                        errorMessage = 'Nie znaleziono użytkownika.';
                    }
                    errorEl.textContent = errorMessage;
                    errorEl.style.display = 'block';
                    resetBtn.disabled = false;
                    resetBtn.innerHTML = '<i class="fa-solid fa-key mr-2"></i>ZAPISZ NOWE HASŁO';
                }
            });
        }

        function startCountdown() {
            const actionContent = document.getElementById('action-content');
            if (!actionContent) {
                console.error('Element action-content nie znaleziony w startCountdown');
                return;
            }

            let countdown = 5;
            const countdownElement = document.createElement('p');
            countdownElement.className = 'text-sm text-zinc-400 mt-4 cursor-pointer hover:text-coyote hover:underline transition-colors';
            countdownElement.textContent = `Przekierowanie za ${countdown} sekund...`;
            actionContent.appendChild(countdownElement);

            const timer = setInterval(() => {
                countdownElement.textContent = `Przekierowanie za ${countdown} sekund...`;
                countdown--;

                if (countdown < 0) {
                    clearInterval(timer);
                    window.location.href = 'https://strzelca.pl/index.html';
                }
            }, 1000);

            countdownElement.addEventListener('click', () => {
                clearInterval(timer);
                window.location.href = 'https://strzelca.pl/index.html';
            });
        }

        // Główna funkcja obsługi akcji
        async function handleAction() {
            // Sprawdź czy element DOM istnieje
            const actionContent = document.getElementById('action-content');
            if (!actionContent) {
                console.error('Element action-content nie znaleziony');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            const actionCode = urlParams.get('oobCode');

            // Debug - sprawdź parametry
            console.log('Mode:', mode);
            console.log('Action Code:', actionCode);

            // Główna logika rozpoznawania akcji
            if (!actionCode) {
                console.error('Brak kodu akcji (oobCode) w URL');
                showError('Brak kodu akcji. Sprawdź link.');
                return;
            }

            if (!mode) {
                console.error('Brak parametru mode w URL');
                showError('Brak parametru akcji. Sprawdź link.');
                return;
            }

        switch (mode) {
            case 'resetPassword':
                console.log('Rozpoczynam proces resetowania hasła...');
                // Najpierw sprawdź czy kod jest poprawny
                verifyPasswordResetCode(auth, actionCode)
                    .then((email) => {
                        console.log('Kod resetowania hasła jest poprawny, email:', email);
                        showPasswordResetForm(email);
                    })
                    .catch((error) => {
                        console.error('Verify password reset code error:', error);
                        let errorMessage = 'Link wygasł lub jest nieprawidłowy.';
                        if (error.code === 'auth/expired-action-code') {
                            errorMessage = 'Link wygasł. Poproś o nowy link resetowania hasła.';
                        } else if (error.code === 'auth/invalid-action-code') {
                            errorMessage = 'Link jest nieprawidłowy.';
                        }
                        showError(errorMessage);
                    });
                break;

            case 'verifyEmail':
                console.log('Rozpoczynam proces weryfikacji emaila...');
                console.log('Action Code length:', actionCode.length);
                console.log('Action Code preview:', actionCode.substring(0, 20) + '...');

                // Sprawdź czy użytkownik jest zalogowany
                const currentUser = auth.currentUser;
                console.log('Current user:', currentUser ? currentUser.email : 'none');

                // Weryfikacja emaila
                applyActionCode(auth, actionCode)
                    .then(async () => {
                        console.log('applyActionCode zakończone sukcesem');

                        // Po applyActionCode użytkownik może nie być automatycznie zalogowany
                        // Poczekaj chwilę i sprawdź czy Firebase zaktualizował stan
                        await new Promise(resolve => setTimeout(resolve, 500));

                        // Sprawdź czy użytkownik jest teraz zalogowany
                        let currentUser = auth.currentUser;
                        
                        // Jeśli nie ma currentUser, poczekaj na onAuthStateChanged
                        if (!currentUser) {
                            console.log('Brak currentUser bezpośrednio po applyActionCode - czekam na synchronizację...');
                            
                            // Poczekaj na zmianę stanu autoryzacji (max 3 sekundy)
                            const authStatePromise = new Promise((resolve) => {
                                const unsubscribe = onAuthStateChanged(auth, (user) => {
                                    unsubscribe();
                                    resolve(user);
                                });
                                setTimeout(() => {
                                    unsubscribe();
                                    resolve(null);
                                }, 3000);
                            });
                            
                            currentUser = await authStatePromise;
                            console.log('Po oczekiwaniu na auth state, currentUser:', currentUser ? currentUser.email : 'none');
                        }

                        if (currentUser) {
                            try {
                                await currentUser.reload();
                                console.log('Dane użytkownika zostały odświeżone, emailVerified:', currentUser.emailVerified);

                                // Sprawdź czy email jest rzeczywiście zweryfikowany
                                if (currentUser.emailVerified) {
                                    console.log('Email potwierdzony - użytkownik może się logować');
                                    document.getElementById('action-content').innerHTML = `
                                        <div class="checkmark"></div>
                                        <h1 class="text-2xl md:text-3xl font-bold coyote-text uppercase italic font-[Orbitron] mb-4">
                                            WERYFIKACJA STRZELCA
                                        </h1>
                                        <p class="text-lg mb-8 text-zinc-300">
                                            Email został pomyślnie zweryfikowany! Teraz możesz się zalogować do swojego konta.
                                        </p>
                                    `;

                                    // Dodaj dodatkową synchronizację - poczekaj chwilę na odświeżenie stanu
                                    setTimeout(() => {
                                        startCountdown();
                                    }, 3000);
                                } else {
                                    console.warn('Email nadal nie jest zweryfikowany po reload');
                                    // Spróbuj ponownie za chwilę
                                    setTimeout(async () => {
                                        await currentUser.reload();
                                        if (currentUser.emailVerified) {
                                            console.log('Email zweryfikowany przy drugiej próbie');
                                            startCountdown();
                                        } else {
                                            showError('Weryfikacja emaila może potrwać chwilę. Spróbuj odświeżyć stronę i zalogować się ponownie.');
                                        }
                                    }, 2000);
                                }
                            } catch (reloadError) {
                                console.warn('Błąd odświeżania danych użytkownika:', reloadError);
                                // Spróbuj kontynuować bez reload
                                document.getElementById('action-content').innerHTML = `
                                    <div class="checkmark"></div>
                                    <h1 class="text-2xl md:text-3xl font-bold coyote-text uppercase italic font-[Orbitron] mb-4">
                                        WERYFIKACJA STRZELCA
                                    </h1>
                                    <p class="text-lg mb-8 text-zinc-300">
                                        Email został zweryfikowany! Jeśli nie możesz się zalogować, odśwież stronę.
                                    </p>
                                `;
                                setTimeout(() => {
                                    startCountdown();
                                }, 3000);
                            }
                        } else {
                            console.warn('Brak currentUser po weryfikacji - weryfikacja może się udała, ale użytkownik nie jest zalogowany');
                            // Weryfikacja się udała, ale użytkownik nie jest zalogowany
                            // To jest normalne - użytkownik musi się zalogować ręcznie
                            document.getElementById('action-content').innerHTML = `
                                <div class="checkmark"></div>
                                <h1 class="text-2xl md:text-3xl font-bold coyote-text uppercase italic font-[Orbitron] mb-4">
                                    WERYFIKACJA STRZELCA
                                </h1>
                                <p class="text-lg mb-8 text-zinc-300">
                                    Email został pomyślnie zweryfikowany! Możesz się teraz zalogować do swojego konta.
                                </p>
                                <a href="./login.html" class="btn-primary inline-block mt-4">
                                    Przejdź do logowania
                                </a>
                            `;
                        }
                    })
                    .catch((error) => {
                        console.error('Email verification error:', error);
                        let errorMessage = 'Wystąpił błąd podczas weryfikacji emaila.';
                        let redirectUrl = './login.html';
                        let redirectText = 'Przejdź do logowania';

                        if (error.code === 'auth/expired-action-code') {
                            errorMessage = 'Link weryfikacyjny wygasł (ważny 24 godziny). Zarejestruj się ponownie lub poproś o nowy link.';
                        } else if (error.code === 'auth/invalid-action-code') {
                            errorMessage = 'Link weryfikacyjny jest nieprawidłowy lub został już użyty. Spróbuj zalogować się ponownie.';
                        } else if (error.code === 'auth/user-disabled') {
                            errorMessage = 'Konto zostało zablokowane. Skontaktuj się z administratorem.';
                        } else if (error.code === 'auth/user-not-found') {
                            errorMessage = 'Nie znaleziono użytkownika. Spróbuj zarejestrować się ponownie.';
                        } else if (error.code === 'auth/network-request-failed') {
                            errorMessage = 'Błąd połączenia z serwerem. Sprawdź połączenie internetowe i spróbuj ponownie.';
                            redirectUrl = './akcja.html' + window.location.search; // Ponów próbę z tym samym linkiem
                            redirectText = 'Spróbuj ponownie';
                        }

                        // Sprawdź czy może email jest już zweryfikowany
                        if (currentUser) {
                            currentUser.reload().then(() => {
                                if (currentUser.emailVerified) {
                                    console.log('Email został zweryfikowany mimo błędu API');
                                    showSuccess('Email został pomyślnie zweryfikowany! Przenoszę do Strefy Strzelca.', 'https://strzelca.pl/index.html', 'Przejdź do Strefy Strzelca');
                                    setTimeout(() => {
                                        window.location.href = 'https://strzelca.pl/index.html';
                                    }, 3000);
                                    return;
                                }
                            }).catch(reloadError => {
                                console.warn('Błąd sprawdzania statusu po nieudanej weryfikacji:', reloadError);
                            });
                        }

                        showError(errorMessage);

                        // Automatyczne przekierowanie po 5 sekundach
                        setTimeout(() => {
                            window.location.href = redirectUrl;
                        }, 5000);
                    });
                break;

            default:
                console.error('Nieznana akcja:', mode);
                showError('Nieznana akcja. Sprawdź link.');
                break;
            }
        }

        // Wywołaj funkcję obsługi akcji po załadowaniu strony
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                handleAction();
            });
        } else {
            // DOM już załadowany
            handleAction();
        }
    </script>
    <script
      type="module"
      src="https://strzelca.pl/auth-widget.mjs?v=2026-02-02-1"
    ></script>
  </body>
</html>