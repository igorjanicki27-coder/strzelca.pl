<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://strzelca.pl/ikona.svg"
    />
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg" />

    <title>Profil - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --coyote: #c19a6b;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #0a0a0a;
        color: #e5e5e5;
        margin: 0;
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }

      .avatar-container {
        position: relative;
        display: inline-block;
      }

      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--coyote);
        object-fit: cover;
      }

      .avatar-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--coyote);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        background: linear-gradient(135deg, var(--coyote), #8b6b4a);
      }

      .avatar-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        background: var(--coyote);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.3s;
      }

      .avatar-upload:hover {
        transform: scale(1.1);
      }

      input,
      select,
      textarea {
        background: #111 !important;
        border: 1px solid #222 !important;
        color: white !important;
        padding: 12px 16px !important;
        border-radius: 8px;
        width: 100%;
        outline: none;
        transition: 0.3s;
      }
      input[type="checkbox"] {
        width: auto !important;
        padding: 0 !important;
        border-radius: 4px;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--coyote) !important;
        background: #161616 !important;
      }
      input:disabled,
      input[readonly] {
        background: #0a0a0a !important;
        border-color: #333 !important;
        color: #888 !important;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .field-label-readonly {
        color: #666 !important;
      }

      .btn-save {
        background: var(--coyote);
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 12px 24px;
        border-radius: 8px;
        transition: 0.3s;
        cursor: pointer;
      }
      .btn-save:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(193, 154, 107, 0.3);
      }
      .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Style dla opinii */
      .star-rating {
        display: flex;
        gap: 4px;
      }
      .star {
        color: #c19a6b;
        font-size: 18px;
        cursor: pointer;
        transition: 0.3s;
      }
      .star:hover,
      .star.active {
        color: #c19a6b;
      }
      .star.inactive {
        color: #666;
      }

      .review-card {
        background: rgba(39, 39, 42, 0.5);
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .review-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 8px;
      }
      .review-author {
        font-weight: bold;
        color: #c19a6b;
      }
      .review-date {
        color: #9ca3af;
        font-size: 12px;
      }
      .review-rating {
        display: flex;
        gap: 2px;
      }
      .review-comment {
        color: #e5e7eb;
        margin-top: 8px;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        border: 1px solid #333;
      }
      .modal-content--wide {
        max-width: 980px;
        width: 95%;
        max-height: 85vh;
        overflow: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-close {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 24px;
        cursor: pointer;
      }
      .rating-input {
        display: flex;
        gap: 8px;
        margin: 16px 0;
      }
    </style>

    <!-- Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-9EJ2R3JPVD"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-9EJ2R3JPVD");
    </script>
  </head>
  <body>
    <nav
      class="h-[73px] border-b border-zinc-900 sticky top-0 bg-black/95 z-50 backdrop-blur-md flex items-center relative"
    >
      <a
        href="https://strzelca.pl"
        class="absolute left-4 md:left-8 text-zinc-500 hover:text-white transition text-xl"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div class="container mx-auto px-6 flex justify-center">
        <div
          class="uppercase font-bold text-[11px] tracking-[0.3em] font-[Orbitron] text-zinc-400"
        >
          PROFIL.<span class="coyote-text">STRZELCA</span>.PL
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-6 py-12 max-w-4xl">
      <!-- Nagłówek profilu -->
      <div
        class="bg-zinc-900/50 p-8 rounded-3xl border border-zinc-800 shadow-2xl mb-8"
      >
        <div
          class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8"
        >
          <!-- Avatar -->
          <div class="avatar-container">
            <div id="avatar-display" class="avatar-placeholder">
              <i class="fa-solid fa-user text-white"></i>
            </div>
            <div
              class="avatar-upload"
              onclick="document.getElementById('avatar-input').click()"
            >
              <i class="fa-solid fa-camera text-black text-sm"></i>
            </div>
            <input
              type="file"
              id="avatar-input"
              accept="image/*"
              style="display: none"
            />
          </div>

          <!-- Informacje podstawowe -->
          <div class="flex-1 text-center md:text-left">
            <h1 id="display-name" class="text-3xl font-bold text-white mb-2">
              Ładowanie...
            </h1>
            <p id="user-email" class="text-zinc-400 mb-4"></p>
            <div
              class="flex flex-wrap justify-center md:justify-start gap-4 text-sm"
            >
              <span
                id="member-since"
                class="bg-zinc-800 px-3 py-1 rounded-full"
              ></span>
              <span
                id="verification-status"
                class="bg-green-800 px-3 py-1 rounded-full"
                >Email zweryfikowany</span
              >
            </div>

            <div class="mt-6 flex flex-wrap justify-center md:justify-start gap-3">
              <button
                type="button"
                id="open-profile-data-btn"
                class="px-5 py-2 rounded-lg text-[11px] font-black uppercase tracking-widest border border-zinc-700 text-zinc-300 hover:text-white hover:border-coyote hover:bg-zinc-900/40 transition"
              >
                <i class="fa-solid fa-id-card mr-2"></i>
                Dane profilu
              </button>
              <button
                type="button"
                onclick="window.changePassword && window.changePassword()"
                class="px-5 py-2 rounded-lg text-[11px] font-black uppercase tracking-widest border border-zinc-700 text-zinc-300 hover:text-white hover:border-zinc-500 hover:bg-zinc-900/40 transition"
              >
                <i class="fa-solid fa-key mr-2"></i>
                Zmień hasło
              </button>
              <button
                type="button"
                onclick="window.logout && window.logout()"
                class="px-5 py-2 rounded-lg text-[11px] font-black uppercase tracking-widest border border-red-900 text-red-200 hover:text-white hover:border-red-700 hover:bg-red-900/20 transition"
              >
                <i class="fa-solid fa-right-from-bracket mr-2"></i>
                Wyloguj się
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dane profilu (domyślnie ukryte) -->
      <div id="profile-data-modal" class="modal">
        <div class="modal-content modal-content--wide">
          <div class="modal-header">
            <h3 class="text-xl font-bold coyote-text">Dane profilu</h3>
            <button class="modal-close" onclick="closeProfileModal()">
              &times;
            </button>
          </div>

          <form id="profile-form" class="space-y-6">
          <!-- Dane podstawowe (tylko do odczytu) -->
          <div
            class="bg-zinc-800/50 p-6 rounded-2xl border border-zinc-700 mb-6"
          >
            <h3 class="text-lg font-semibold text-white mb-4">
              Dane podstawowe
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Nazwa profilu -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Nazwa profilu</label
                >
                <input type="text" id="edit-display-name" readonly disabled />
              </div>

              <!-- E-mail -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Adres e-mail</label
                >
                <input type="email" id="edit-email" readonly disabled />
              </div>

              <!-- Imię -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Imię STRZELCA</label
                >
                <input type="text" id="edit-first-name" readonly disabled />
              </div>

              <!-- Nazwisko -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Nazwisko STRZELCA</label
                >
                <input type="text" id="edit-last-name" readonly disabled />
              </div>
            </div>
          </div>

          <!-- Dane kontaktowe -->
          <div class="bg-zinc-800/50 p-6 rounded-2xl border border-zinc-700">
            <h3 class="text-lg font-semibold text-white mb-4">
              Dane kontaktowe
            </h3>

            <!-- Telefon i Paczkomat w jednej linii -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Telefon -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                  >Numer telefonu</label
                >
                <input
                  type="tel"
                  id="edit-phone"
                  placeholder="np. 555 444 333"
                />
              </div>

              <!-- Paczkomat -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                  >Paczkomat InPost (opcjonalnie)</label
                >
                <input
                  type="text"
                  id="edit-parcel-locker"
                  placeholder="np. WAW01A"
                />
              </div>
            </div>

            <!-- Adres STRZELCA -->
            <div class="space-y-4 mt-6 pt-6 border-t border-zinc-700">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Ulica</label
                  >
                  <input
                    type="text"
                    id="edit-street"
                    placeholder="np. Nowowiejska"
                  />
                </div>
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Numer budynku / lokalu</label
                  >
                  <input
                    type="text"
                    id="edit-building-number"
                    placeholder="np. 12/3"
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Kod pocztowy</label
                  >
                  <input
                    type="text"
                    id="edit-postal-code"
                    placeholder="np. 00-000"
                  />
                </div>
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Miasto</label
                  >
                  <input
                    type="text"
                    id="edit-city"
                    placeholder="np. Warszawa"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Preferencje -->
          <div class="space-y-4 pt-6 border-t border-zinc-700">
            <h3 class="text-lg font-semibold text-white mb-4">Preferencje</h3>
            <div class="flex items-start gap-3">
              <input
                type="checkbox"
                id="edit-newsletter"
                class="mt-1 shrink-0"
              />
              <label
                for="edit-newsletter"
                class="text-sm text-zinc-300 leading-relaxed min-w-0 break-words"
              >
                Chcę otrzymywać newsletter (rezygnacja możliwa w każdej chwili)
              </label>
            </div>
          </div>

          <!-- Przyciski -->
          <div
            class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-zinc-700"
          >
            <button type="submit" class="btn-save flex-1">
              <i class="fa-solid fa-save mr-2"></i>
              Zapisz zmiany
            </button>
            <button
              type="button"
              onclick="closeProfileModal()"
              class="bg-zinc-700 text-white px-6 py-3 rounded-lg hover:bg-zinc-600 transition"
            >
              <i class="fa-solid fa-xmark mr-2"></i>
              Wyjdź
            </button>
          </div>
          </form>
        </div>
      </div>

      <!-- Sekcja statystyk -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        <div
          class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 text-center"
        >
          <div class="text-3xl font-bold coyote-text mb-2">0</div>
          <div class="text-sm text-zinc-400 uppercase tracking-widest">
            Wystawionych ofert
          </div>
        </div>
        <div
          class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 text-center"
        >
          <div class="text-3xl font-bold coyote-text mb-2">0</div>
          <div class="text-sm text-zinc-400 uppercase tracking-widest">
            Wiadomości
          </div>
        </div>
        <div
          class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 text-center"
        >
          <div class="text-3xl font-bold coyote-text mb-2">0</div>
          <div class="text-sm text-zinc-400 uppercase tracking-widest">
            Ulubionych
          </div>
        </div>
      </div>

      <!-- Sekcja opinii użytkowników -->
      <div id="reviews-section" class="mt-8">
        <div
          class="bg-zinc-900/50 p-8 rounded-3xl border border-zinc-800 shadow-2xl"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold coyote-text">Opinie użytkowników</h2>
            <button
              id="add-review-btn"
              class="bg-zinc-700 text-white px-4 py-2 rounded-lg hover:bg-zinc-600 transition"
            >
              <i class="fa-solid fa-plus mr-2"></i>
              Dodaj opinię
            </button>
          </div>

          <!-- Średnia ocena -->
          <div class="flex items-center space-x-4 mb-6">
            <div class="text-4xl font-bold coyote-text" id="average-rating">
              0.0
            </div>
            <div class="flex space-x-1" id="average-stars">
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
            </div>
            <div class="text-sm text-zinc-400" id="reviews-count">
              (0 opinii)
            </div>
          </div>

          <!-- Lista opinii -->
          <div id="reviews-list" class="space-y-4">
            <!-- Opinie będą ładowane dynamicznie -->
          </div>
        </div>
      </div>

      <!-- Strefa niebezpieczna (celowo na samym dole) -->
      <div class="mt-12">
        <div class="bg-zinc-900/30 p-6 rounded-2xl border border-zinc-800">
          <h3 class="text-sm font-black uppercase tracking-widest text-zinc-500 mb-3">
            Strefa niebezpieczna
          </h3>
          <button
            type="button"
            id="open-delete-account-btn"
            class="text-[11px] text-zinc-600 hover:text-red-300 transition font-bold uppercase tracking-widest"
            title="Usuń konto"
          >
            Usuń konto
          </button>
        </div>
      </div>
    </main>

    <!-- Modal: Usuwanie konta -->
    <div id="delete-account-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-xl font-bold text-red-200">Usuwanie konta</h3>
          <button class="modal-close" onclick="closeDeleteAccountModal()">
            &times;
          </button>
        </div>

        <div class="text-sm text-zinc-300 space-y-3">
          <p class="text-zinc-400">
            Ta operacja jest <span class="text-red-200 font-bold">nieodwracalna</span>.
          </p>
          <p class="text-zinc-400">
            Usunięcie konta spowoduje utratę dostępu oraz próbę usunięcia Twoich danych (m.in. profilu),
            a także powiązanych treści, takich jak: opinie, oferty, konwersacje i wiadomości.
          </p>
          <p class="text-zinc-400">
            Aby odblokować przycisk usunięcia, przepisz dokładnie:
            <span class="text-white font-black">Usuń konto</span>
          </p>
        </div>

        <div class="mt-5">
          <input
            id="delete-account-confirm-input"
            type="text"
            placeholder='Wpisz: "Usuń konto"'
          />
          <p class="mt-2 text-[11px] text-zinc-500">
            Tekst musi zgadzać się 1:1 (wielkość liter i spacje).
          </p>
        </div>

        <div class="flex gap-4 mt-6">
          <button
            type="button"
            onclick="closeDeleteAccountModal()"
            class="bg-zinc-700 text-white px-6 py-3 rounded-lg hover:bg-zinc-600 transition flex-1"
          >
            Anuluj
          </button>
          <button
            type="button"
            id="confirm-delete-account-btn"
            disabled
            class="bg-red-900 text-white px-6 py-3 rounded-lg border border-red-700 opacity-50 cursor-not-allowed transition flex-1"
          >
            Usuń konto
          </button>
        </div>
      </div>
    </div>

    <!-- Modal dodawania opinii -->
    <div id="add-review-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-xl font-bold coyote-text">Dodaj opinię</h3>
          <button class="modal-close" onclick="closeReviewModal()">
            &times;
          </button>
        </div>

        <form id="review-form">
          <div class="mb-4">
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Wybierz użytkownika do oceny</label
            >
            <select id="rated-user-select" required class="w-full">
              <option value="">Wybierz użytkownika...</option>
              <!-- Użytkownicy będą ładowani dynamicznie -->
            </select>
          </div>

          <div class="mb-4">
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Ocena (0-5 gwiazdek)</label
            >
            <div class="rating-input">
              <i class="fa-solid fa-star star" data-rating="1"></i>
              <i class="fa-solid fa-star star" data-rating="2"></i>
              <i class="fa-solid fa-star star" data-rating="3"></i>
              <i class="fa-solid fa-star star" data-rating="4"></i>
              <i class="fa-solid fa-star star" data-rating="5"></i>
            </div>
            <input type="hidden" id="rating-value" value="0" />
          </div>

          <div class="mb-6">
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Krótki opis opinii</label
            >
            <textarea
              id="review-comment"
              required
              minlength="10"
              maxlength="500"
              rows="4"
              placeholder="Napisz swoją opinię o tym użytkowniku..."
            ></textarea>
          </div>

          <div class="flex gap-4">
            <button type="submit" class="btn-save flex-1">
              <i class="fa-solid fa-save mr-2"></i>
              Dodaj opinię
            </button>
            <button
              type="button"
              onclick="closeReviewModal()"
              class="bg-zinc-700 text-white px-6 py-3 rounded-lg hover:bg-zinc-600 transition"
            >
              Anuluj
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer
      class="text-center py-10 border-t border-zinc-900 text-zinc-700 text-[10px] uppercase font-bold tracking-[0.4em]"
    >
      <a href="https://strzelca.pl" class="hover:text-white transition"
        >STRZELCA.PL</a
      >
      |
      <a
        href="https://dokumenty.strzelca.pl"
        class="hover:text-white transition ml-4"
        >DOKUMENTY - REGULAMINY, ZWROTY ITP.</a
      >
    </footer>

    <!-- Session Manager -->

    <script type="module">
      // Dodaj globalną obsługę błędów CORS (ignoruj błędy Firebase internal)
      window.addEventListener('error', function(e) {
        // Ignoruj błędy CORS związane z Firebase/Firestore
        if (e.message && (
          e.message.includes('access control checks') ||
          e.message.includes('CORS') ||
          e.message.includes('firestore.googleapis.com')
        )) {
          console.warn('Ignored Firebase CORS error in profile:', e.message);
          e.preventDefault();
          return false;
        }
      });

      // Dodaj obsługę błędów dla fetch API
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && e.reason.message && (
          e.reason.message.includes('access control checks') ||
          e.reason.message.includes('CORS') ||
          e.reason.message.includes('firestore.googleapis.com')
        )) {
          console.warn('Ignored Firebase CORS promise rejection in profile:', e.reason.message);
          e.preventDefault();
          return false;
        }
      });

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        initializeFirestore,
        doc,
        getDoc,
        updateDoc,
        setDoc,
        deleteDoc,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        updatePassword,
        EmailAuthProvider,
        reauthenticateWithCredential,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getStorage,
        ref as storageRef,
        uploadString,
        getDownloadURL,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
      import { ensureFirebaseSSO } from "https://strzelca.pl/sso-client.mjs?v=2026-01-28-1";

      
      async function getFirebaseApiKey() {
        const urls = [
          "https://strzelca.pl/api/firebase-config",
          "/api/firebase-config",
        ];

        for (const url of urls) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) continue;
            const data = await res.json().catch(() => null);
            if (data && typeof data.apiKey === "string" && data.apiKey.length > 10) {
              return data.apiKey;
            }
          } catch (_) {
            // ignore and try next url
          }
        }

        throw new Error("Nie udało się pobrać FIREBASE_WEB_API_KEY z /api/firebase-config");
      }
const firebaseConfig = {
        apiKey: await getFirebaseApiKey(),
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.firebasestorage.app",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false,
      });
      const auth = getAuth(app);
      const storage = getStorage(app);

      // Ustaw trwałość sesji na LOCAL dla wszystkich stron wymagających logowania
      await setPersistence(auth, browserLocalPersistence);

      // SSO: jeśli użytkownik jest zalogowany w innej subdomenie, dologuj go tutaj z cookie
      try {
        await ensureFirebaseSSO(auth);
      } catch (e) {
        console.warn("SSO ensure failed (ignored):", e?.message || e);
      }

      let currentUser = null;
      let userProfile = null;

      // Base64 helpers that support UTF-8 (btoa/atob fail on Polish chars like ą,ę,ł)
      function b64EncodeUtf8(str) {
        try {
          const bytes = new TextEncoder().encode(String(str ?? ""));
          let bin = "";
          for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
          return btoa(bin);
        } catch (e) {
          console.error("b64EncodeUtf8 failed:", e);
          return "";
        }
      }

      function b64DecodeUtf8(b64) {
        try {
          if (!b64) return "";
          const bin = atob(String(b64));
          const bytes = new Uint8Array(bin.length);
          for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
          return new TextDecoder().decode(bytes);
        } catch {
          return "";
        }
      }

      // Listener stanu autoryzacji z logiką przekierowań
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Odśwież dane użytkownika przed sprawdzeniem weryfikacji
          try {
            await user.reload();
            console.log("Użytkownik zalogowany:", user.email, "emailVerified:", user.emailVerified);

            // Jeśli użytkownik jest niezweryfikowany: tryb ograniczony (bez wylogowania) -> strona po rejestracji
            if (!user.emailVerified) {
              window.location.href = "./po.rejestracji.html";
              return;
            }

            // Użytkownik jest zalogowany i zweryfikowany - pozwól mu zostać na stronie
            currentUser = user;

            // Pobierz dane użytkownika z bazy dla kolorów przycisków
            await loadUserProfile(user.uid);

            // Załaduj profil użytkownika
            await loadProfile();
          } catch (reloadError) {
            console.warn("Błąd odświeżania danych użytkownika:", reloadError);
            // W przypadku błędu, wyloguj dla bezpieczeństwa
            try {
              await signOut(auth);
              window.location.href = "./login.html";
            } catch (signOutError) {
              console.error("Błąd wylogowania po błędzie reload:", signOutError);
            }
          }
        } else {
          // Użytkownik nie jest zalogowany - przekieruj do strony logowania
          console.log("Użytkownik niezalogowany, przekierowanie do login.html");
          window.location.href = "login.html";
        }
      });

      // Funkcja pobierania danych użytkownika z bazy
      async function loadUserProfile(uid) {
        try {
          const profileDoc = await getDoc(doc(db, "userProfiles", uid));
          if (profileDoc.exists()) {
            userProfile = profileDoc.data();
            console.log("Dane użytkownika załadowane:", userProfile);

            // Tutaj można ustawić kolory przycisków na podstawie danych użytkownika
            // Na razie pozostawiam to do implementacji gdy zrozumiem strukturę
          } else {
            console.log("Profil użytkownika nie istnieje");
          }
        } catch (error) {
          console.error("Błąd podczas ładowania profilu użytkownika:", error);
        }
      }

      // Funkcja logowania aktywności (zachowana dla kompatybilności wstecznej)
      async function logActivity(
        type,
        userId,
        userName,
        details,
        timestamp = null,
      ) {
        try {
          const activityData = {
            type: type,
            userId: userId,
            userName: userName,
            details: details,
            timestamp: timestamp || new Date(),
          };

          const { addDoc, collection } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          await addDoc(collection(db, "activityLogs"), activityData);

          console.log("Aktywność zalogowana:", activityData);
        } catch (error) {
          console.error("Błąd podczas logowania aktywności:", error);
        }
      }

      // Nowa funkcja logowania zdarzeń użytkowników
      async function logUserEvent(
        type,
        userId,
        userName,
        action,
        targetId = null,
        targetType = null,
        metadata = {},
      ) {
        try {
          const eventData = {
            type: type,
            userId: userId,
            userName: userName,
            action: action,
            targetId: targetId,
            targetType: targetType,
            details: action,
            metadata: metadata,
            timestamp: new Date().toISOString(),
          };

          // Najpierw spróbuj przez API
          try {
            const response = await fetch("/api/user-events", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(eventData),
            });

            if (response.ok) {
              const result = await response.json();
              console.log("User event logged via API:", result.data);
              return;
            }
          } catch (apiError) {
            console.warn(
              "API logging failed, falling back to Firebase:",
              apiError.message,
            );
          }

          // Fallback do Firebase (zachowana kompatybilność wsteczna)
          const { addDoc, collection } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          await addDoc(collection(db, "activityLogs"), {
            type: type,
            userId: userId,
            userName: userName,
            details: action,
            timestamp: new Date(),
          });

          console.log("User event logged via Firebase fallback:", eventData);
        } catch (error) {
          console.error("Błąd podczas logowania zdarzenia użytkownika:", error);
        }
      }

      // Funkcje pomocnicze
      function getDefaultAvatar(gender) {
        if (gender === "female") {
          return '<i class="fa-solid fa-user text-white"></i>';
        } else {
          return '<i class="fa-solid fa-user text-white"></i>';
        }
      }

      function formatDate(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate
          ? timestamp.toDate()
          : new Date(timestamp);
        return date.toLocaleDateString("pl-PL");
      }

      async function compressImageToDataUrl(file, { maxSide = 512, quality = 0.85 } = {}) {
        const dataUrl = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onerror = () => reject(new Error("Nie udało się odczytać pliku."));
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });

        const img = await new Promise((resolve, reject) => {
          const i = new Image();
          i.onload = () => resolve(i);
          i.onerror = () => reject(new Error("Nie udało się wczytać obrazu."));
          i.src = dataUrl;
        });

        const w = img.naturalWidth || img.width;
        const h = img.naturalHeight || img.height;
        const scale = Math.min(1, maxSide / Math.max(w, h));
        const targetW = Math.max(1, Math.round(w * scale));
        const targetH = Math.max(1, Math.round(h * scale));

        const canvas = document.createElement("canvas");
        canvas.width = targetW;
        canvas.height = targetH;
        const ctx = canvas.getContext("2d");
        if (!ctx) throw new Error("Brak wsparcia canvas w przeglądarce.");
        ctx.drawImage(img, 0, 0, targetW, targetH);

        // JPEG dla mniejszego rozmiaru
        return canvas.toDataURL("image/jpeg", quality);
      }

      // Status weryfikacji emaila w UI
      async function updateVerificationStatus() {
        try {
          if (!currentUser) return;

          // Upewnij się, że status jest aktualny (best-effort)
          try {
            await currentUser.reload();
          } catch {}

          const el = document.getElementById("verification-status");
          if (!el) return;

          if (currentUser.emailVerified) {
            el.textContent = "Email zweryfikowany";
            el.className = "bg-green-800 px-3 py-1 rounded-full";
          } else {
            el.textContent = "Email niezweryfikowany";
            el.className = "bg-yellow-800 px-3 py-1 rounded-full";
          }
        } catch (e) {
          console.warn("updateVerificationStatus failed (ignored):", e?.message || e);
        }
      }

      // Ładowanie danych profilu
      async function loadProfile() {
        if (!currentUser) {
          window.location.href = "./login.html";
          return;
        }

        try {
          const profileDoc = await getDoc(
            doc(db, "userProfiles", currentUser.uid),
          );

          if (profileDoc.exists()) {
            userProfile = profileDoc.data();

            // Wypełnij nagłówek
            document.getElementById("display-name").textContent =
              userProfile.displayName;
            document.getElementById("user-email").textContent =
              userProfile.email;
            document.getElementById("member-since").textContent =
              `Członek od ${formatDate(userProfile.createdAt)}`;

            // Ustaw avatar
            const avatarDisplay = document.getElementById("avatar-display");
            if (userProfile.avatar) {
              avatarDisplay.innerHTML = `<img src="${userProfile.avatar}" alt="Avatar" class="avatar">`;
            } else {
              avatarDisplay.innerHTML = getDefaultAvatar(userProfile.gender);
            }

            // Odszyfruj dane wrażliwe
            const decryptedProfile = {
              ...userProfile,
              phone: userProfile.phone ? b64DecodeUtf8(userProfile.phone) : "",
              parcelLocker: userProfile.parcelLocker
                ? b64DecodeUtf8(userProfile.parcelLocker)
                : "",
              address: {
                street: userProfile.address?.street
                  ? b64DecodeUtf8(userProfile.address.street)
                  : "",
                buildingNumber: userProfile.address?.buildingNumber
                  ? b64DecodeUtf8(userProfile.address.buildingNumber)
                  : "",
                postalCode: userProfile.address?.postalCode
                  ? b64DecodeUtf8(userProfile.address.postalCode)
                  : "",
                city: userProfile.address?.city
                  ? b64DecodeUtf8(userProfile.address.city)
                  : "",
              },
            };

            // Wypełnij formularz (odszyfrowanymi danymi)
            document.getElementById("edit-display-name").value =
              decryptedProfile.displayName || "";
            document.getElementById("edit-email").value =
              currentUser.email || "";
            document.getElementById("edit-first-name").value =
              decryptedProfile.firstName || "";
            document.getElementById("edit-last-name").value =
              decryptedProfile.lastName || "";
            document.getElementById("edit-phone").value =
              decryptedProfile.phone || "";
            document.getElementById("edit-street").value =
              decryptedProfile.address?.street || "";
            document.getElementById("edit-building-number").value =
              decryptedProfile.address?.buildingNumber || "";
            document.getElementById("edit-postal-code").value =
              decryptedProfile.address?.postalCode || "";
            document.getElementById("edit-city").value =
              decryptedProfile.address?.city || "";
            document.getElementById("edit-parcel-locker").value =
              decryptedProfile.parcelLocker || "";
            document.getElementById("edit-newsletter").checked =
              decryptedProfile.newsletter || false;

            // Aktualizuj status weryfikacji emaila
            await updateVerificationStatus();

            // Załaduj opinie użytkownika
            loadUserReviews();
          } else {
            alert(
              "Nie znaleziono danych profilu. Skontaktuj się z administratorem.",
            );
            logout();
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          alert("Błąd podczas ładowania profilu.");
        }
      }

      // Lista zabronionych nazw
      const forbiddenNames = [
        "admin",
        "administrator",
        "mod",
        "moderator",
        "moderacja",
        "moderowanie",
        "support",
        "pomoc",
        "help",
        "owner",
        "wlasciciel",
        "boss",
        "szef",
        "system",
        "bot",
        "robot",
        "strzelec",
        "strzelca",
        "platform",
        "site",
      ];

      // Funkcja sprawdzania dostępności nazwy użytkownika
      async function checkDisplayNameAvailability(displayName, currentUserId) {
        try {
          // Sprawdź czy nazwa nie jest zabroniona
          if (forbiddenNames.includes(displayName.toLowerCase())) {
            return {
              available: false,
              reason: "Ta nazwa jest zarezerwowana",
            };
          }

          // Sprawdź czy nazwa już istnieje w kolekcji displayNames
          const displayNameDoc = await getDoc(
            doc(db, "displayNames", displayName.toLowerCase()),
          );

          if (displayNameDoc.exists()) {
            // Jeśli nazwa należy do aktualnego użytkownika, jest dostępna
            if (displayNameDoc.data().userId === currentUserId) {
              return { available: true };
            }
            return {
              available: false,
              reason: "Ta nazwa jest już zajęta",
            };
          }

          return { available: true };
        } catch (error) {
          console.error("Error checking display name:", error);
          return {
            available: false,
            reason: "Błąd sprawdzania dostępności nazwy",
          };
        }
      }

      // Zapisywanie zmian profilu
      document
        .getElementById("profile-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!currentUser || !userProfile) return;

          const saveBtn = e.target.querySelector('button[type="submit"]');
          saveBtn.disabled = true;
          saveBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zapisywanie...';

          try {
            // Zapisujemy TYLKO zmienione pola (żeby np. zapis avatara nie wymuszał zmian w telefonie)
            const getDec = (v) => {
              return b64DecodeUtf8(v);
            };

            const oldDecrypted = {
              phone: getDec(userProfile.phone),
              parcelLocker: getDec(userProfile.parcelLocker),
              address: {
                street: getDec(userProfile.address?.street),
                buildingNumber: getDec(userProfile.address?.buildingNumber),
                postalCode: getDec(userProfile.address?.postalCode),
                city: getDec(userProfile.address?.city),
              },
              newsletter: !!userProfile.newsletter,
            };

            const newDecrypted = {
              phone: (document.getElementById("edit-phone").value || "").trim(),
              parcelLocker: (document.getElementById("edit-parcel-locker").value || "").trim(),
              address: {
                street: (document.getElementById("edit-street").value || "").trim(),
                buildingNumber: (document.getElementById("edit-building-number").value || "").trim(),
                postalCode: (document.getElementById("edit-postal-code").value || "").trim(),
                city: (document.getElementById("edit-city").value || "").trim(),
              },
              newsletter: document.getElementById("edit-newsletter").checked,
            };

            const updatedProfile = {};

            if (newDecrypted.phone !== oldDecrypted.phone) {
              updatedProfile.phone = b64EncodeUtf8(newDecrypted.phone);
            }

            if (newDecrypted.parcelLocker !== oldDecrypted.parcelLocker) {
              updatedProfile.parcelLocker = b64EncodeUtf8(newDecrypted.parcelLocker);
            }

            const addrChanged =
              newDecrypted.address.street !== oldDecrypted.address.street ||
              newDecrypted.address.buildingNumber !== oldDecrypted.address.buildingNumber ||
              newDecrypted.address.postalCode !== oldDecrypted.address.postalCode ||
              newDecrypted.address.city !== oldDecrypted.address.city;

            if (addrChanged) {
              updatedProfile.address = {
                street: b64EncodeUtf8(newDecrypted.address.street),
                buildingNumber: b64EncodeUtf8(newDecrypted.address.buildingNumber),
                postalCode: b64EncodeUtf8(newDecrypted.address.postalCode),
                city: b64EncodeUtf8(newDecrypted.address.city),
              };
            }

            if (newDecrypted.newsletter !== oldDecrypted.newsletter) {
              updatedProfile.newsletter = newDecrypted.newsletter;
              updatedProfile.newsletterChanged = true;
            } else {
              updatedProfile.newsletterChanged = false;
            }

            const keysToWrite = Object.keys(updatedProfile).filter(k => k !== "newsletterChanged");
            if (keysToWrite.length === 0 && updatedProfile.newsletterChanged === false) {
              alert("Brak zmian do zapisania.");
              return;
            }

            // Usuń pole pomocnicze przed zapisem do userProfiles
            const { newsletterChanged, ...docUpdate } = updatedProfile;
            if (Object.keys(docUpdate).length > 0) {
              await updateDoc(doc(db, "userProfiles", currentUser.uid), docUpdate);
            }

            // Aktualizuj mailing list jeśli zmieniła się zgoda na newsletter
            if (updatedProfile.newsletterChanged === true) {
              if (newDecrypted.newsletter) {
                // Dodaj do mailing list
                await setDoc(doc(db, "mailingList", currentUser.email), {
                  email: currentUser.email,
                  subscribedAt: new Date(),
                  active: true,
                  source: "profile_update",
                });
              } else {
                // Usuń z mailing list
                await deleteDoc(doc(db, "mailingList", currentUser.email));
              }
            }

            alert("Profil został zaktualizowany!");
            // Zaktualizuj lokalną kopię profilu (bez pola pomocniczego)
            userProfile = { ...userProfile, ...docUpdate };
            loadProfile(); // Odśwież wyświetlane dane
          } catch (error) {
            console.error("Error updating profile:", error);
            alert("Błąd podczas aktualizacji profilu.");
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML =
              '<i class="fa-solid fa-save mr-2"></i>Zapisz zmiany';
          }
        });

      // Zmiana hasła
      window.changePassword = async () => {
        const newPassword = prompt("Wprowadź nowe hasło (minimum 8 znaków):");
        if (!newPassword || newPassword.length < 8) {
          alert("Hasło musi mieć co najmniej 8 znaków.");
          return;
        }

        const confirmPassword = prompt("Potwierdź nowe hasło:");
        if (newPassword !== confirmPassword) {
          alert("Hasła nie są identyczne.");
          return;
        }

        try {
          await updatePassword(currentUser, newPassword);
          alert("Hasło zostało zmienione!");
        } catch (error) {
          console.error("Error changing password:", error);

          if (error.code === "auth/requires-recent-login") {
            alert("Aby zmienić hasło, musisz się ponownie zalogować.");
            logout();
          } else {
            alert("Błąd podczas zmiany hasła.");
          }
        }
      };

      // Usuwanie konta
      window.deleteAccount = async () => {
        if (!currentUser) return;

        try {
          // najpierw zamknij modal (jeśli otwarty)
          try {
            window.closeDeleteAccountModal?.();
          } catch {}

          const idToken = await currentUser.getIdToken(true);
          const res = await fetch("https://strzelca.pl/api/delete-account", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken }),
            credentials: "include",
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || data?.success !== true) {
            console.error("Delete account API failed:", res.status, data);
            alert(
              "Nie udało się usunąć konta automatycznie. Jeśli problem się powtarza, skontaktuj się z administratorem.",
            );
            return;
          }

          // Wyczyść localStorage i wyloguj się (czyści też cookie SSO)
          try {
            localStorage.clear();
          } catch {}

          alert("Konto zostało usunięte. Zostaniesz wylogowany.");
          try {
            await window.logout();
          } catch {
            window.location.href = "https://strzelca.pl/index.html";
          }
        } catch (error) {
          console.error("Error deleting account:", error);
          alert(
            "Wystąpił błąd podczas usuwania konta. Skontaktuj się z administratorem.",
          );
        }
      };

      // Wylogowanie
      window.logout = async () => {
        try {
          // SSO: wyczyść cookie wspólnej sesji
          try {
            await fetch("https://strzelca.pl/api/sso-session-logout", {
              method: "POST",
              credentials: "include",
            });
          } catch (e) {
            console.warn("SSO logout failed (ignored):", e?.message || e);
          }
          await signOut(auth);
          // Wyczyść ewentualne dane w localStorage (preferencje kolorów itp.)
          localStorage.clear();
          window.location.href = "https://strzelca.pl/index.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };

      // Obsługa zmiany avatara
      document
        .getElementById("avatar-input")
        .addEventListener("change", async (e) => {
          const file = e.target.files[0];
          if (!file) return;

          // Sprawdź rozmiar pliku (max 2MB)
          if (file.size > 2 * 1024 * 1024) {
            alert("Plik jest zbyt duży. Maksymalny rozmiar to 2MB.");
            return;
          }

          // Sprawdź typ pliku
          if (!file.type.startsWith("image/")) {
            alert("Wybierz plik graficzny.");
            return;
          }

          try {
            if (!currentUser) {
              alert("Musisz być zalogowany, aby zmienić avatar.");
              return;
            }

            // Tryb ograniczony: niezweryfikowane konto nie może uploadować avatara
            if (!currentUser.emailVerified) {
              alert("Aby ustawić avatar, aktywuj konto (zweryfikuj email).");
              window.location.href = "./po.rejestracji.html";
              return;
            }

            // Podgląd + kompresja
            const avatarDisplay = document.getElementById("avatar-display");
            if (avatarDisplay) {
              avatarDisplay.innerHTML = `<div class="text-zinc-400 text-sm">Wysyłanie avatara...</div>`;
            }

            const dataUrl = await compressImageToDataUrl(file, { maxSide: 512, quality: 0.85 });

            // Upload do Firebase Storage (nadpisuje poprzedni avatar)
            const path = `avatars/${currentUser.uid}.jpg`;
            const refObj = storageRef(storage, path);
            await uploadString(refObj, dataUrl, "data_url", {
              contentType: "image/jpeg",
              customMetadata: {
                uid: currentUser.uid,
              },
            });

            const url = await getDownloadURL(refObj);

            // Zapisz URL w profilu użytkownika
            await updateDoc(doc(db, "userProfiles", currentUser.uid), {
              avatar: url,
              avatarUpdatedAt: new Date(),
            });

            // Odśwież UI
            if (avatarDisplay) {
              avatarDisplay.innerHTML = `<img src="${url}" alt="Avatar" class="avatar">`;
            }

            alert("Avatar został zapisany.");
          } catch (error) {
            console.error("Error uploading avatar:", error);
            // Typowy przypadek: brak reguł Storage / brak włączonego Storage
            if (error?.code === "storage/unauthorized" || error?.code === "storage/unknown") {
              alert(
                "Nie mogę zapisać avatara w Storage (brak uprawnień lub Storage nie jest skonfigurowany). " +
                "Jeśli chcesz, podam gotowe reguły Storage dla avatarów."
              );
              return;
            }
            alert("Błąd podczas uploadu avatara. Spróbuj ponownie.");
          }
        });

      // ===== FUNKCJE DO OBSŁUGI OPINII =====

      // Ładowanie opinii użytkownika
      async function loadUserReviews() {
        try {
          // Zapytanie wymaga indeksu - użyj prostszego zapytania lub obsłuż błąd
          const reviewsQuery = query(
            collection(db, "userReviews"),
            where("ratedId", "==", currentUser.uid),
            where("status", "==", "approved"),
            orderBy("timestamp", "desc"),
          );

          const reviewsSnapshot = await getDocs(reviewsQuery);
          const reviews = reviewsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          displayReviews(reviews);
          updateAverageRating(reviews);
        } catch (error) {
          console.error("Błąd ładowania opinii:", error);
          // Jeśli błąd to brak indeksu, użyj prostszego zapytania
          if (error.code === "failed-precondition") {
            try {
              console.log("Próba prostszego zapytania bez indeksu (1 filtr + sortowanie po stronie klienta)");
              const simpleQuery = query(
                collection(db, "userReviews"),
                where("ratedId", "==", currentUser.uid),
              );
              const simpleSnapshot = await getDocs(simpleQuery);
              let reviews = simpleSnapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              // Filtruj ręcznie (żeby nie wymagać indeksu kompozytowego)
              reviews = reviews.filter((r) => r.status === "approved");
              // Sortuj ręcznie
              reviews.sort((a, b) => {
                const aTime = a.timestamp?.toDate?.() || new Date(a.timestamp || 0);
                const bTime = b.timestamp?.toDate?.() || new Date(b.timestamp || 0);
                return bTime - aTime;
              });
              displayReviews(reviews);
              updateAverageRating(reviews);
            } catch (simpleError) {
              console.error("Błąd prostszego zapytania:", simpleError);
              displayReviews([]);
            }
          } else {
            displayReviews([]);
          }
        }
      }

      // Wyświetlanie opinii
      function displayReviews(reviews) {
        const reviewsList = document.getElementById("reviews-list");

        if (reviews.length === 0) {
          reviewsList.innerHTML =
            '<p class="text-zinc-400 text-center py-8">Brak opinii użytkowników.</p>';
          return;
        }

        reviewsList.innerHTML = reviews
          .map(
            (review) => `
                <div class="review-card">
                    <div class="review-header">
                        <span class="review-author">${review.raterName || "Anonimowy użytkownik"}</span>
                        <span class="review-date">${formatDate(review.timestamp)}</span>
                    </div>
                    <div class="review-rating">
                        ${generateStars(review.rating)}
                    </div>
                    <div class="review-comment">${review.comment}</div>
                </div>
            `,
          )
          .join("");
      }

      // Generowanie gwiazdek dla opinii
      function generateStars(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += `<i class="fa-solid fa-star ${i <= rating ? "text-yellow-400" : "text-zinc-600"}"></i>`;
        }
        return stars;
      }

      // Aktualizacja średniej oceny
      function updateAverageRating(reviews) {
        const averageRating = document.getElementById("average-rating");
        const averageStars = document.getElementById("average-stars");
        const reviewsCount = document.getElementById("reviews-count");

        if (reviews.length === 0) {
          averageRating.textContent = "0.0";
          reviewsCount.textContent = "(0 opinii)";
          return;
        }

        const sum = reviews.reduce((acc, review) => acc + review.rating, 0);
        const avg = (sum / reviews.length).toFixed(1);

        averageRating.textContent = avg;
        reviewsCount.textContent = `(${reviews.length} opinii)`;

        // Aktualizuj wizualne gwiazdki
        const starElements = averageStars.querySelectorAll(".fa-star");
        const fullStars = Math.floor(avg);

        starElements.forEach((star, index) => {
          if (index < fullStars) {
            star.className = "fa-solid fa-star text-yellow-400";
          } else if (index === fullStars && avg % 1 >= 0.5) {
            star.className = "fa-solid fa-star-half-alt text-yellow-400";
          } else {
            star.className = "fa-solid fa-star text-zinc-600";
          }
        });
      }

      // Ładowanie listy użytkowników do wyboru
      async function loadUsersList() {
        try {
          const usersQuery = query(collection(db, "userProfiles"));
          const usersSnapshot = await getDocs(usersQuery);

          const select = document.getElementById("rated-user-select");
          const currentOptions =
            '<option value="">Wybierz użytkownika...</option>';

          const users = usersSnapshot.docs
            .map((doc) => ({ id: doc.id, ...doc.data() }))
            .filter(
              (user) => user.id !== currentUser.uid && user.role !== "admin",
            ) // Wyklucz siebie i adminów
            .map(
              (user) =>
                `<option value="${user.id}">${user.displayName} (${user.email})</option>`,
            )
            .join("");

          select.innerHTML = currentOptions + users;
        } catch (error) {
          console.error("Błąd ładowania użytkowników:", error);
        }
      }

      // Obsługa gwiazdek w formularzu
      function initializeStarRating() {
        const stars = document.querySelectorAll(".rating-input .star");
        const ratingInput = document.getElementById("rating-value");

        stars.forEach((star) => {
          star.addEventListener("click", () => {
            const rating = parseInt(star.dataset.rating);
            ratingInput.value = rating;

            stars.forEach((s, index) => {
              if (index < rating) {
                s.classList.add("active");
                s.classList.remove("inactive");
              } else {
                s.classList.remove("active");
                s.classList.add("inactive");
              }
            });
          });
        });
      }

      // Otwórz modal dodawania opinii
      function openReviewModal() {
        document.getElementById("add-review-modal").classList.add("show");
        loadUsersList();
        resetReviewForm();
      }

      // Zamknij modal
      function closeReviewModal() {
        document.getElementById("add-review-modal").classList.remove("show");
        resetReviewForm();
      }

      // Reset formularza opinii
      function resetReviewForm() {
        document.getElementById("review-form").reset();
        document.getElementById("rating-value").value = "0";
        document.querySelectorAll(".rating-input .star").forEach((star) => {
          star.classList.remove("active", "inactive");
        });
      }

      // ===== MODAL: DANE PROFILU =====
      window.openProfileModal = function openProfileModal() {
        document.getElementById("profile-data-modal")?.classList.add("show");
      };
      window.closeProfileModal = function closeProfileModal() {
        document.getElementById("profile-data-modal")?.classList.remove("show");
      };

      // przycisk "Dane profilu"
      document.getElementById("open-profile-data-btn")?.addEventListener("click", () => {
        window.openProfileModal();
      });

      // zamykanie modalu po kliknięciu w tło
      document.getElementById("profile-data-modal")?.addEventListener("click", (e) => {
        if (e.target?.id === "profile-data-modal") {
          window.closeProfileModal();
        }
      });

      // ===== MODAL: USUWANIE KONTA =====
      window.openDeleteAccountModal = function openDeleteAccountModal() {
        document.getElementById("delete-account-modal")?.classList.add("show");
        const input = document.getElementById("delete-account-confirm-input");
        const btn = document.getElementById("confirm-delete-account-btn");
        if (input) input.value = "";
        if (btn) {
          btn.disabled = true;
          btn.classList.add("opacity-50", "cursor-not-allowed");
        }
      };
      window.closeDeleteAccountModal = function closeDeleteAccountModal() {
        document.getElementById("delete-account-modal")?.classList.remove("show");
      };

      document.getElementById("open-delete-account-btn")?.addEventListener("click", () => {
        window.openDeleteAccountModal();
      });

      document.getElementById("delete-account-modal")?.addEventListener("click", (e) => {
        if (e.target?.id === "delete-account-modal") {
          window.closeDeleteAccountModal();
        }
      });

      const deleteConfirmInput = document.getElementById("delete-account-confirm-input");
      const deleteConfirmBtn = document.getElementById("confirm-delete-account-btn");
      const requiredPhrase = "Usuń konto";

      function updateDeleteButtonState() {
        if (!deleteConfirmInput || !deleteConfirmBtn) return;
        const ok = deleteConfirmInput.value === requiredPhrase;
        deleteConfirmBtn.disabled = !ok;
        deleteConfirmBtn.classList.toggle("opacity-50", !ok);
        deleteConfirmBtn.classList.toggle("cursor-not-allowed", !ok);
      }

      deleteConfirmInput?.addEventListener("input", updateDeleteButtonState);

      deleteConfirmBtn?.addEventListener("click", async () => {
        try {
          deleteConfirmBtn.disabled = true;
          deleteConfirmBtn.classList.add("opacity-50", "cursor-not-allowed");
          deleteConfirmBtn.textContent = "Usuwanie...";

          await window.deleteAccount();
        } finally {
          // jeśli coś pójdzie nie tak, przywróć stan przycisku (zależnie od inputu)
          deleteConfirmBtn.textContent = "Usuń konto";
          updateDeleteButtonState();
        }
      });

      // Dodawanie nowej opinii
      async function submitReview(event) {
        event.preventDefault();

        const ratedUserId = document.getElementById("rated-user-select").value;
        const rating = parseInt(document.getElementById("rating-value").value);
        const comment = document.getElementById("review-comment").value.trim();

        if (!ratedUserId) {
          alert("Wybierz użytkownika do oceny.");
          return;
        }

        if (rating === 0) {
          alert("Wybierz ocenę (co najmniej 1 gwiazdka).");
          return;
        }

        if (comment.length < 10) {
          alert("Opis opinii musi mieć co najmniej 10 znaków.");
          return;
        }

        try {
          // Pobierz dane ocenianego użytkownika
          const ratedUserDoc = await getDoc(
            doc(db, "userProfiles", ratedUserId),
          );
          const ratedUser = ratedUserDoc.data();

          // Dodaj opinię do bazy danych
          await addDoc(collection(db, "userReviews"), {
            raterId: currentUser.uid,
            raterName: userProfile.displayName,
            ratedId: ratedUserId,
            ratedName: ratedUser.displayName,
            rating: rating,
            comment: comment,
            timestamp: new Date(),
            status: "approved", // W wersji podstawowej wszystkie opinie są automatycznie zatwierdzane
          });

          // Zaloguj zdarzenie użytkownika
          await logUserEvent(
            "USER-REVIEW",
            currentUser.uid,
            userProfile.displayName,
            `Ocena użytkownika ${ratedUser.displayName}: ${rating} gwiazdek`,
            ratedUser.uid,
            "user",
            {
              rating: rating,
              comment:
                comment.substring(0, 100) + (comment.length > 100 ? "..." : ""),
              targetUserName: ratedUser.displayName,
            },
          );

          alert("Opinia została dodana pomyślnie!");
          closeReviewModal();

          // Odśwież opinie jeśli jesteśmy na profilu ocenianego użytkownika
          if (ratedUserId === currentUser.uid) {
            loadUserReviews();
          }
        } catch (error) {
          console.error("Błąd dodawania opinii:", error);
          alert("Wystąpił błąd podczas dodawania opinii. Spróbuj ponownie.");
        }
      }

      // Inicjalizacja obsługi zdarzeń
      function initializeReviewEvents() {
        // Przycisk dodawania opinii
        document
          .getElementById("add-review-btn")
          .addEventListener("click", openReviewModal);

        // Formularz opinii
        document
          .getElementById("review-form")
          .addEventListener("submit", submitReview);

        // Inicjalizacja gwiazdek
        initializeStarRating();

        // Zamykanie modalu przy kliknięciu poza nim
        document
          .getElementById("add-review-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "add-review-modal") {
              closeReviewModal();
            }
          });
      }

      // ===== KONIEC FUNKCJI OPINII =====

      // Sprawdź stan autoryzacji
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loadProfile();
          initializeReviewEvents();
        } else {
          window.location.href = "./login.html";
        }
      });
    </script>
    <script
      type="module"
      src="https://strzelca.pl/auth-widget.mjs?v=2026-02-02-1"
    ></script>
  </body>
</html>
