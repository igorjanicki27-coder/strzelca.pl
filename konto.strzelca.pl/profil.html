<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://strzelca.pl/ikona.svg"
    />
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg" />

    <title>Profil - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Wspólne poprawki responsywności -->
    <link rel="stylesheet" href="https://strzelca.pl/shared.css?v=2026-02-06-1" />
    <style>
      :root {
        --coyote: #c19a6b;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #0a0a0a;
        color: #e5e5e5;
        margin: 0;
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }

      /* Role colors for display name */
      #display-name {
        color: #ffffff;
      }
      #display-name.name-role-user {
        color: #34d399 !important; /* emerald-400 */
        text-shadow: 0 0 10px rgba(52, 211, 153, 0.25);
      }
      #display-name.name-role-company {
        color: #60a5fa !important; /* blue-400 */
        text-shadow: 0 0 10px rgba(96, 165, 250, 0.25);
      }
      #display-name.name-role-admin {
        color: #f87171 !important; /* red-400 */
        text-shadow: 0 0 10px rgba(248, 113, 113, 0.25);
      }

      /* Tooltip on hover (moved from email to display name) */
      .hover-tooltip {
        display: inline-block;
        position: relative;
        cursor: help;
      }
      .hover-tooltip[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 0;
        top: calc(100% + 8px);
        background: rgba(0, 0, 0, 0.92);
        border: 1px solid #333;
        color: #e5e7eb;
        font-size: 12px;
        padding: 8px 10px;
        border-radius: 10px;
        white-space: pre;
        z-index: 2000;
        min-width: 240px;
        max-width: min(520px, 90vw);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      }

      .avatar-container {
        position: relative;
        display: inline-block;
      }

      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--coyote);
        object-fit: cover;
      }

      .avatar-placeholder {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        border: 4px solid var(--coyote);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
        background: linear-gradient(135deg, var(--coyote), #8b6b4a);
      }

      .avatar-upload {
        position: absolute;
        bottom: 0;
        right: 0;
        background: var(--coyote);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: 0.3s;
      }

      .avatar-upload:hover {
        transform: scale(1.1);
      }

      input,
      select,
      textarea {
        background: #111 !important;
        border: 1px solid #222 !important;
        color: white !important;
        padding: 12px 16px !important;
        border-radius: 8px;
        width: 100%;
        outline: none;
        transition: 0.3s;
      }
      input[type="checkbox"] {
        width: auto !important;
        padding: 0 !important;
        border-radius: 4px;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--coyote) !important;
        background: #161616 !important;
      }
      input:disabled,
      input[readonly] {
        background: #0a0a0a !important;
        border-color: #333 !important;
        color: #888 !important;
        cursor: not-allowed;
        opacity: 0.7;
      }
      .field-label-readonly {
        color: #666 !important;
      }

      .btn-save {
        background: var(--coyote);
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 12px 24px;
        border-radius: 8px;
        transition: 0.3s;
        cursor: pointer;
      }
      .btn-save:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(193, 154, 107, 0.3);
      }
      .btn-save:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Style dla opinii */
      .star-rating {
        display: flex;
        gap: 4px;
      }
      .star {
        color: #c19a6b;
        font-size: 18px;
        cursor: pointer;
        transition: 0.3s;
      }
      .star:hover,
      .star.active {
        color: #c19a6b;
      }
      .star.inactive {
        color: #666;
      }

      .review-card {
        background: rgba(39, 39, 42, 0.5);
        border: 1px solid #374151;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 16px;
      }
      .review-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 8px;
      }
      .review-author {
        font-weight: bold;
        color: #c19a6b;
      }
      .review-date {
        color: #9ca3af;
        font-size: 12px;
      }
      .review-rating {
        display: flex;
        gap: 2px;
      }
      .review-comment {
        color: #e5e7eb;
        margin-top: 8px;
      }

      /* Email verification highlight (replaces badges) */
      .email-status {
        display: inline-block;
        position: relative;
        color: #9ca3af; /* zinc-400 base */
        transition: 0.2s;
      }
      .email-status-verified {
        color: #34d399; /* emerald-400 */
        text-shadow: 0 0 10px rgba(52, 211, 153, 0.35);
      }
      .email-status-unverified {
        color: #f87171; /* red-400 */
        text-shadow: 0 0 10px rgba(248, 113, 113, 0.35);
      }
      .email-status[data-tooltip]:hover::after {
        content: attr(data-tooltip);
        position: absolute;
        left: 0;
        top: calc(100% + 8px);
        background: rgba(0, 0, 0, 0.92);
        border: 1px solid #333;
        color: #e5e7eb;
        font-size: 12px;
        padding: 8px 10px;
        border-radius: 10px;
        white-space: pre;
        z-index: 2000;
        min-width: 240px;
        max-width: min(520px, 90vw);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.45);
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      }
      .modal.show {
        display: flex;
      }
      .modal-content {
        background: #1a1a1a;
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        border: 1px solid #333;
      }
      .modal-content--wide {
        max-width: 980px;
        width: 95%;
        max-height: 85vh;
        overflow: auto;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .modal-close {
        background: none;
        border: none;
        color: #9ca3af;
        font-size: 24px;
        cursor: pointer;
      }
      .rating-input {
        display: flex;
        gap: 8px;
        margin: 16px 0;
      }
    </style>

    <!-- Google Analytics -->
    <!-- Cookies/zgody + warunkowe ładowanie analityki -->
    <script src="https://strzelca.pl/consent.js?v=2026-02-06-1"></script>
  </head>
  <body>
    <nav
      class="h-[73px] border-b border-zinc-900 sticky top-0 bg-black/95 z-50 backdrop-blur-md flex items-center relative"
    >
      <a
        href="https://strzelca.pl"
        class="absolute left-4 md:left-8 text-zinc-500 hover:text-white transition text-xl"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div class="container mx-auto px-6 flex justify-center">
        <div
          class="uppercase font-bold text-[11px] tracking-[0.3em] font-[Orbitron] text-zinc-400"
        >
          PROFIL.<span class="coyote-text">STRZELCA</span>.PL
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-6 py-12 max-w-4xl">
      <!-- Nagłówek profilu -->
      <div
        class="bg-zinc-900/50 p-8 rounded-3xl border border-zinc-800 shadow-2xl mb-8"
      >
        <div
          class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8"
        >
          <!-- Avatar -->
          <div class="avatar-container">
            <div id="avatar-display" class="avatar-placeholder">
              <i class="fa-solid fa-user text-white"></i>
            </div>
            <div
              class="avatar-upload"
              onclick="window.openAvatarPicker && window.openAvatarPicker()"
              title="Wybierz avatar"
            >
              <i class="fa-solid fa-camera text-black text-sm"></i>
            </div>
          </div>

          <!-- Informacje podstawowe + akcje -->
          <div class="flex-1 w-full">
            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
              <!-- Lewa kolumna (nick + email) -->
              <div class="min-w-0 flex-1 text-center md:text-left">
                <h1 id="display-name" class="text-2xl md:text-3xl font-bold text-white mb-2 hover-tooltip">
              Ładowanie...
            </h1>
            <p
              id="user-email"
                  class="email-status mb-4 font-semibold text-sm md:text-base"
              title=""
            ></p>
              </div>

              <!-- Prawa kolumna (przyciski) - pod nazwą na mniejszych ekranach, obok na większych -->
              <div class="w-full lg:w-auto lg:shrink-0 lg:min-w-[280px]">
                <div class="flex flex-col gap-2 w-full">
                  <button
                    type="button"
                    id="open-profile-data-btn"
                    class="h-9 w-full px-4 rounded-lg text-[10px] font-black uppercase tracking-wider border border-zinc-700 text-zinc-200 hover:text-white hover:border-coyote hover:bg-zinc-900/40 transition inline-flex items-center justify-center"
                  >
                    <i class="fa-solid fa-id-card mr-2 text-xs"></i>
                    Dane konta
                  </button>

                  <div class="flex gap-2 w-full">
                    <button
                      type="button"
                      onclick="window.changePassword && window.changePassword()"
                      class="h-9 flex-1 px-3 rounded-lg text-[10px] font-black uppercase tracking-wider border border-zinc-700 text-zinc-200 hover:text-white hover:border-zinc-500 hover:bg-zinc-900/40 transition inline-flex items-center justify-center min-w-0"
                    >
                      <i class="fa-solid fa-key mr-1.5 text-xs"></i>
                      <span class="hidden sm:inline">Zmień hasło</span>
                      <span class="sm:hidden">Hasło</span>
                    </button>

                    <button
                      type="button"
                      onclick="window.logout && window.logout()"
                      class="h-9 flex-1 px-3 rounded-lg text-[10px] font-black uppercase tracking-wider border border-red-900 text-red-200 hover:text-white hover:border-red-700 hover:bg-red-900/20 transition inline-flex items-center justify-center min-w-0"
                      title="Wyloguj się"
                    >
                      <i class="fa-solid fa-right-from-bracket mr-1.5 text-xs"></i>
                      <span class="hidden sm:inline">Wyloguj się</span>
                      <span class="sm:hidden">Wyloguj</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dane profilu (domyślnie ukryte) -->
      <div id="profile-data-modal" class="modal">
        <div class="modal-content modal-content--wide">
          <div class="modal-header">
            <h3 class="text-xl font-bold coyote-text">Dane profilu</h3>
            <button type="button" class="modal-close" onclick="closeProfileModal(event)">
              &times;
            </button>
          </div>

          <form id="profile-form" class="space-y-6">
          <!-- Dane podstawowe (tylko do odczytu) -->
          <div
            class="bg-zinc-800/50 p-6 rounded-2xl border border-zinc-700 mb-6"
          >
            <h3 class="text-lg font-semibold text-white mb-4">
              Dane podstawowe
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Nazwa profilu -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Nazwa profilu</label
                >
                <input type="text" id="edit-display-name" readonly disabled />
              </div>

              <!-- E-mail -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Adres e-mail</label
                >
                <input type="email" id="edit-email" readonly disabled />
              </div>

              <!-- Imię -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Imię STRZELCA</label
                >
                <input type="text" id="edit-first-name" readonly disabled />
              </div>

              <!-- Nazwisko -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold field-label-readonly ml-2 mb-2 block tracking-widest"
                  >Nazwisko STRZELCA</label
                >
                <input type="text" id="edit-last-name" readonly disabled />
              </div>
            </div>
          </div>

          <!-- Dane kontaktowe -->
          <div class="bg-zinc-800/50 p-6 rounded-2xl border border-zinc-700">
            <h3 class="text-lg font-semibold text-white mb-4">
              Dane kontaktowe
            </h3>

            <!-- Telefon i Paczkomat w jednej linii -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Telefon -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                  >Numer telefonu</label
                >
                <input
                  type="tel"
                  id="edit-phone"
                  placeholder="np. 555 444 333"
                />
              </div>

              <!-- Paczkomat -->
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                  >Paczkomat InPost (opcjonalnie)</label
                >
                <input
                  type="text"
                  id="edit-parcel-locker"
                  placeholder="np. WAW01A"
                />
              </div>
            </div>

            <!-- Adres STRZELCA -->
            <div class="space-y-4 mt-6 pt-6 border-t border-zinc-700">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Ulica</label
                  >
                  <input
                    type="text"
                    id="edit-street"
                    placeholder="np. Nowowiejska"
                  />
                </div>
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Numer budynku / lokalu</label
                  >
                  <input
                    type="text"
                    id="edit-building-number"
                    placeholder="np. 12/3"
                  />
                </div>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Kod pocztowy</label
                  >
                  <input
                    type="text"
                    id="edit-postal-code"
                    placeholder="np. 00-000"
                  />
                </div>
                <div>
                  <label
                    class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
                    >Miasto</label
                  >
                  <input
                    type="text"
                    id="edit-city"
                    placeholder="np. Warszawa"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Preferencje -->
          <div class="space-y-4 pt-6 border-t border-zinc-700">
            <h3 class="text-lg font-semibold text-white mb-4">Preferencje</h3>
            <div class="flex items-start gap-3">
              <input
                type="checkbox"
                id="edit-newsletter"
                class="mt-1 shrink-0"
              />
              <label
                for="edit-newsletter"
                class="text-sm text-zinc-300 leading-relaxed min-w-0 break-words"
              >
                Chcę otrzymywać newsletter (rezygnacja możliwa w każdej chwili)
              </label>
            </div>
          </div>

          <!-- Przyciski -->
          <div
            class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-zinc-700"
          >
            <button type="submit" class="btn-save flex-1">
              <i class="fa-solid fa-save mr-2"></i>
              Zapisz zmiany
            </button>
            <button
              type="button"
              onclick="closeProfileModal(event)"
              class="bg-zinc-700 text-white px-6 py-3 rounded-lg hover:bg-zinc-600 transition"
            >
              <i class="fa-solid fa-xmark mr-2"></i>
              Wyjdź
            </button>
          </div>
          </form>
        </div>
      </div>

      <!-- Sekcja statystyk -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-8">
        <div
          class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 text-center"
        >
          <div class="text-3xl font-bold coyote-text mb-2">0</div>
          <div class="text-sm text-zinc-400 uppercase tracking-widest">
            Wystawionych ofert
          </div>
        </div>
        <div
          class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 text-center"
        >
          <div class="text-3xl font-bold coyote-text mb-2">0</div>
          <div class="text-sm text-zinc-400 uppercase tracking-widest">
            Wiadomości
          </div>
        </div>
        <div
          class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800 text-center"
        >
          <div class="text-3xl font-bold coyote-text mb-2">0</div>
          <div class="text-sm text-zinc-400 uppercase tracking-widest">
            Ulubionych
          </div>
        </div>
      </div>

      <!-- Sekcja opinii użytkowników -->
      <div id="reviews-section" class="mt-8">
        <div
          class="bg-zinc-900/50 p-8 rounded-3xl border border-zinc-800 shadow-2xl"
        >
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold coyote-text">Opinie użytkowników</h2>
            <button
              id="add-review-btn"
              class="bg-zinc-700 text-white px-4 py-2 rounded-lg hover:bg-zinc-600 transition"
            >
              <i class="fa-solid fa-plus mr-2"></i>
              Dodaj opinię
            </button>
          </div>

          <!-- Średnia ocena -->
          <div class="flex items-center space-x-4 mb-6">
            <div class="text-4xl font-bold coyote-text" id="average-rating">
              0.0
            </div>
            <div class="flex space-x-1" id="average-stars">
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
              <i class="fa-solid fa-star text-zinc-600"></i>
            </div>
            <div class="text-sm text-zinc-400" id="reviews-count">
              (0 opinii)
            </div>
          </div>

          <!-- Lista opinii -->
          <div id="reviews-list" class="space-y-4">
            <!-- Opinie będą ładowane dynamicznie -->
          </div>
        </div>
      </div>

      <div class="mt-12 flex justify-end">
        <button
          type="button"
          id="open-delete-account-btn"
          class="text-[11px] text-zinc-600 hover:text-red-300 transition font-bold uppercase tracking-widest"
          title="Usuń konto"
        >
          Usuń konto
        </button>
      </div>
    </main>

    <!-- Modal: Wybór avatara (lokalne pliki z /avatary/) -->
    <div id="avatar-picker-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9999] hidden">
      <div class="min-h-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl rounded-2xl border border-zinc-800 bg-zinc-950 shadow-2xl">
          <div class="flex items-center justify-between px-6 py-4 border-b border-zinc-900">
            <div>
              <h3 class="text-lg font-black text-white uppercase tracking-widest">Wybierz avatar</h3>
              <p class="text-xs text-zinc-400 mt-1">
                Dostępne avatary są ładowane z <span class="text-zinc-200">/avatary/</span>.
              </p>
            </div>
            <button
              type="button"
              class="text-zinc-400 hover:text-white text-2xl leading-none"
              onclick="window.closeAvatarPicker && window.closeAvatarPicker()"
              aria-label="Zamknij"
            >
              &times;
            </button>
          </div>

          <div class="px-6 py-5">
            <div id="avatar-picker-status" class="text-sm text-zinc-400">
              Ładowanie listy avatarów...
            </div>
            <div
              id="avatar-picker-grid"
              class="mt-4 grid grid-cols-4 sm:grid-cols-6 gap-3"
            ></div>
          </div>

          <div class="px-6 py-4 border-t border-zinc-900 flex justify-end gap-3">
            <button
              type="button"
              class="px-5 py-2 rounded-lg text-[11px] font-black uppercase tracking-widest border border-zinc-700 text-zinc-300 hover:text-white hover:border-zinc-500 hover:bg-zinc-900/40 transition"
              onclick="window.closeAvatarPicker && window.closeAvatarPicker()"
            >
              Zamknij
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Usuwanie konta -->
    <div id="delete-account-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-xl font-bold text-red-200">Usuwanie konta</h3>
          <button class="modal-close" onclick="closeDeleteAccountModal()">
            &times;
          </button>
        </div>

        <div class="text-sm text-zinc-300 space-y-3">
          <p class="text-zinc-400">
            Ta operacja jest <span class="text-red-200 font-bold">nieodwracalna</span>.
          </p>
          <p class="text-zinc-400">
            Usunięcie konta spowoduje utratę dostępu oraz próbę usunięcia Twoich danych (m.in. profilu),
            a także powiązanych treści, takich jak: opinie, oferty, konwersacje i wiadomości.
          </p>
          <p class="text-zinc-400">
            Aby odblokować przycisk usunięcia, przepisz dokładnie:
            <span class="text-white font-black">Usuń konto</span>
          </p>
        </div>

        <div class="mt-5">
          <input
            id="delete-account-confirm-input"
            type="text"
            placeholder='Wpisz: "Usuń konto"'
          />
          <p class="mt-2 text-[11px] text-zinc-500">
            Tekst musi zgadzać się 1:1 (wielkość liter i spacje).
          </p>
        </div>

        <div class="flex gap-4 mt-6">
          <button
            type="button"
            onclick="closeDeleteAccountModal()"
            class="bg-zinc-700 text-white px-6 py-3 rounded-lg hover:bg-zinc-600 transition flex-1"
          >
            Anuluj
          </button>
          <button
            type="button"
            id="confirm-delete-account-btn"
            disabled
            class="bg-red-900 text-white px-6 py-3 rounded-lg border border-red-700 opacity-50 cursor-not-allowed transition flex-1"
          >
            Usuń konto
          </button>
        </div>
      </div>
    </div>

    <!-- Modal dodawania opinii -->
    <div id="add-review-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="text-xl font-bold coyote-text">Dodaj opinię</h3>
          <button type="button" class="modal-close" onclick="closeReviewModal()">
            &times;
          </button>
        </div>

        <form id="review-form">
          <div class="mb-4">
            <div class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest">
              Wystawiasz opinię użytkownikowi
            </div>
            <div class="text-sm text-zinc-200 font-bold ml-2" id="review-target-name">
              —
            </div>
          </div>

          <div class="mb-4">
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Ocena (0-5 gwiazdek)</label
            >
            <div class="rating-input">
              <i class="fa-solid fa-star star" data-rating="1"></i>
              <i class="fa-solid fa-star star" data-rating="2"></i>
              <i class="fa-solid fa-star star" data-rating="3"></i>
              <i class="fa-solid fa-star star" data-rating="4"></i>
              <i class="fa-solid fa-star star" data-rating="5"></i>
            </div>
            <input type="hidden" id="rating-value" value="0" />
          </div>

          <div class="mb-6">
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Krótki opis opinii</label
            >
            <textarea
              id="review-comment"
              required
              minlength="10"
              maxlength="500"
              rows="4"
              placeholder="Napisz swoją opinię o tym użytkowniku..."
            ></textarea>
          </div>

          <div class="flex gap-4">
            <button type="submit" class="btn-save flex-1">
              <i class="fa-solid fa-save mr-2"></i>
              Dodaj opinię
            </button>
            <button
              type="button"
              onclick="closeReviewModal()"
              class="bg-zinc-700 text-white px-6 py-3 rounded-lg hover:bg-zinc-600 transition"
            >
              Anuluj
            </button>
          </div>
        </form>
      </div>
    </div>

    <footer
      class="text-center py-10 border-t border-zinc-900 text-zinc-700 text-[10px] uppercase font-bold tracking-[0.4em]"
    >
      <a href="https://strzelca.pl" class="hover:text-white transition"
        >STRZELCA.PL</a
      >
      |
      <a
        href="?cookies=1"
        class="hover:text-white transition ml-4"
        >Ustawienia cookies</a
      >
    </footer>

    <!-- Session Manager -->

    <script type="module">
      // Dodaj globalną obsługę błędów CORS (ignoruj błędy Firebase internal)
      window.addEventListener('error', function(e) {
        // Ignoruj błędy CORS związane z Firebase/Firestore
        if (e.message && (
          e.message.includes('access control checks') ||
          e.message.includes('CORS') ||
          e.message.includes('firestore.googleapis.com')
        )) {
          console.warn('Ignored Firebase CORS error in profile:', e.message);
          e.preventDefault();
          return false;
        }
      });

      // Dodaj obsługę błędów dla fetch API
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && e.reason.message && (
          e.reason.message.includes('access control checks') ||
          e.reason.message.includes('CORS') ||
          e.reason.message.includes('firestore.googleapis.com')
        )) {
          console.warn('Ignored Firebase CORS promise rejection in profile:', e.reason.message);
          e.preventDefault();
          return false;
        }
      });

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        initializeFirestore,
        doc,
        getDoc,
        updateDoc,
        setDoc,
        deleteDoc,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        orderBy,
        limit,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
        updatePassword,
        EmailAuthProvider,
        reauthenticateWithCredential,
        setPersistence,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import { ensureFirebaseSSO } from "https://strzelca.pl/sso-client.mjs?v=2026-02-06-1";

      ;(async () => {
      try {
      
      // Informacja po przekierowaniu (np. próba wejścia do panelu admina bez uprawnień)
      try {
        const url = new URL(window.location.href);
        const notice = url.searchParams.get("notice");
        if (notice === "admin_only") {
          alert("Strona dostępna tylko dla uprawnionych użytkowników.");
          // usuń parametr, żeby alert nie wyskakiwał przy odświeżeniu
          url.searchParams.delete("notice");
          window.history.replaceState({}, "", url.toString());
        }
      } catch {}
      
      async function getFirebaseApiKey() {
        // Na części domen / subdomen endpoint /api/* może nie być podpięty.
        // Dlatego mamy fallback do głównej domeny.
        const isMain = (window.location?.hostname || "") === "strzelca.pl";
        const urls = isMain
          ? ["/api/firebase-config", "https://strzelca.pl/api/firebase-config"]
          : ["https://strzelca.pl/api/firebase-config", "/api/firebase-config"];

        for (const url of urls) {
          try {
            const res = await fetch(url, {
              cache: "no-store",
              credentials: url.startsWith("http") ? "omit" : "same-origin",
            });
            if (!res.ok) continue;
            const data = await res.json().catch(() => null);
            if (data && typeof data.apiKey === "string" && data.apiKey.length > 10) {
              return data.apiKey;
            }
          } catch (_) {
            // ignore and try next url
          }
        }

        return null;
      }

      const apiKey = await getFirebaseApiKey();
      if (!apiKey) {
        console.error("Nie udało się pobrać FIREBASE_WEB_API_KEY z /api/firebase-config (ani z fallbacku).");
        alert(
          "Błąd konfiguracji: nie działa /api/firebase-config. " +
          "Jeśli hostujesz stronę bez funkcji Vercel, musimy podać klucz Firebase inaczej."
        );
        return;
      }

const firebaseConfig = {
        apiKey,
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.appspot.com",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const db = initializeFirestore(app, {
        experimentalAutoDetectLongPolling: true,
        useFetchStreams: true,
      });
      const auth = getAuth(app);

      // Ustaw trwałość sesji na LOCAL dla wszystkich stron wymagających logowania
      await setPersistence(auth, browserLocalPersistence);

      // SSO: jeśli użytkownik jest zalogowany w innej subdomenie, dologuj go tutaj z cookie
      try {
        await ensureFirebaseSSO(auth);
      } catch (e) {
        console.warn("SSO ensure failed (ignored):", e?.message || e);
      }

      let currentUser = null;
      let userProfile = null;
      let selfPrivateProfile = null;
      let memberSinceLabel = "";
      let profileFormSnapshot = null;
      let viewedProfileUid = null;
      let isViewingOwnProfile = true;
      let reviewTargetUid = null;
      let reviewTargetDisplayName = "";

      // Stały avatar dla administratorów (w repo jest obecnie: /admin/Avatar_admin.png).
      // Jeśli zmienisz nazwę pliku na /admin/avatar_admin.jpg, podmień stałą poniżej.
      const ADMIN_AVATAR_URL = "https://strzelca.pl/admin/Avatar_admin.png";
      const isAdminRole = (role) => String(role || "").toLowerCase() === "admin";

      async function syncPublicProfileFromPrivate() {
        if (!currentUser || !isViewingOwnProfile || !userProfile) return;
        try {
          const adminForcedAvatar = isAdminRole(userProfile.role) ? ADMIN_AVATAR_URL : "";
          // publiczny profil zawiera tylko nick + avatar
          const publicDoc = {
            displayName: String(userProfile.displayName || "").trim(),
            avatar: adminForcedAvatar || userProfile.avatar || "",
            updatedAt: new Date(),
          };
          if (!publicDoc.displayName) return;
          await setDoc(doc(db, "publicProfiles", currentUser.uid), publicDoc, { merge: true });
        } catch (e) {
          console.warn("syncPublicProfileFromPrivate failed (ignored):", e?.message || e);
        }
      }

      function getViewedProfileUidFromUrl() {
        try {
          const url = new URL(window.location.href);
          const q =
            url.searchParams.get("profile") ||
            url.searchParams.get("uid") ||
            url.searchParams.get("u");
          if (q) return q;

          const m = window.location.pathname.match(/\/profil\/([^\/?#]+)/);
          return m ? decodeURIComponent(m[1]) : null;
        } catch {
          return null;
        }
      }

      function applyProfileViewMode() {
        const openDataBtn = document.getElementById("open-profile-data-btn");
        const avatarUploadBtn = document.querySelector(".avatar-upload");
        const avatarInput = document.getElementById("avatar-input");
        const deleteBtnWrapper = document.getElementById("open-delete-account-btn")?.closest("div") || null;

        // Dane profilu (edytowalne) tylko dla właściciela
        if (openDataBtn) openDataBtn.style.display = isViewingOwnProfile ? "" : "none";

        // Upload avatara tylko dla właściciela
        if (avatarUploadBtn) avatarUploadBtn.style.display = isViewingOwnProfile ? "" : "none";
        if (avatarInput) avatarInput.disabled = !isViewingOwnProfile;

        // Usuwanie konta tylko dla właściciela
        if (deleteBtnWrapper) deleteBtnWrapper.style.display = isViewingOwnProfile ? "" : "none";

        // Przycisk opinii: nie pokazuj na własnym profilu
        const addReviewBtn = document.getElementById("add-review-btn");
        if (addReviewBtn) {
          addReviewBtn.style.display = isViewingOwnProfile ? "none" : "";
        }
      }

      function captureProfileFormSnapshot() {
        try {
          profileFormSnapshot = {
            phone: (document.getElementById("edit-phone")?.value || ""),
            parcelLocker: (document.getElementById("edit-parcel-locker")?.value || ""),
            street: (document.getElementById("edit-street")?.value || ""),
            buildingNumber: (document.getElementById("edit-building-number")?.value || ""),
            postalCode: (document.getElementById("edit-postal-code")?.value || ""),
            city: (document.getElementById("edit-city")?.value || ""),
            newsletter: !!document.getElementById("edit-newsletter")?.checked,
          };
        } catch {
          profileFormSnapshot = null;
        }
      }

      function restoreProfileFormSnapshot() {
        if (!profileFormSnapshot) return;
        const setVal = (id, v) => {
          const el = document.getElementById(id);
          if (el) el.value = v ?? "";
        };
        setVal("edit-phone", profileFormSnapshot.phone);
        setVal("edit-parcel-locker", profileFormSnapshot.parcelLocker);
        setVal("edit-street", profileFormSnapshot.street);
        setVal("edit-building-number", profileFormSnapshot.buildingNumber);
        setVal("edit-postal-code", profileFormSnapshot.postalCode);
        setVal("edit-city", profileFormSnapshot.city);
        const n = document.getElementById("edit-newsletter");
        if (n) n.checked = !!profileFormSnapshot.newsletter;
      }

      // Base64 helpers that support UTF-8 (btoa/atob fail on Polish chars like ą,ę,ł)
      function b64EncodeUtf8(str) {
        try {
          const bytes = new TextEncoder().encode(String(str ?? ""));
          let bin = "";
          for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
          return btoa(bin);
        } catch (e) {
          console.error("b64EncodeUtf8 failed:", e);
          return "";
        }
      }

      function b64DecodeUtf8(b64) {
        try {
          if (!b64) return "";
          const bin = atob(String(b64));
          const bytes = new Uint8Array(bin.length);
          for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
          return new TextDecoder().decode(bytes);
        } catch {
          return "";
        }
      }

      // Listener stanu autoryzacji z logiką przekierowań
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Odśwież dane użytkownika (best-effort)
          try {
            await user.reload();
            console.log("Użytkownik zalogowany:", user.email);

            currentUser = user;

            // Jaki profil oglądamy?
            viewedProfileUid = getViewedProfileUidFromUrl() || currentUser.uid;
            isViewingOwnProfile = viewedProfileUid === currentUser.uid;
            applyProfileViewMode();

            // Pobierz dane użytkownika (zalogowanego) z bazy (kolory/ustawienia)
            await loadUserProfile(user.uid);

            // Załaduj profil, który oglądamy
            await loadProfile(viewedProfileUid);
          } catch (reloadError) {
            console.warn("Błąd odświeżania danych użytkownika:", reloadError);
            // W przypadku błędu, wyloguj dla bezpieczeństwa
            try {
              await signOut(auth);
              window.location.href = "./logowanie.html";
            } catch (signOutError) {
              console.error("Błąd wylogowania po błędzie reload:", signOutError);
            }
          }
        } else {
          // Użytkownik nie jest zalogowany - przekieruj do strony logowania
          console.log("Użytkownik niezalogowany, przekierowanie do logowanie.html");
          window.location.href = "logowanie.html";
        }
      });

      // Funkcja pobierania danych użytkownika z bazy
      async function loadUserProfile(uid) {
        try {
          const profileDoc = await getDoc(doc(db, "userProfiles", uid));
          if (profileDoc.exists()) {
            // uwaga: to są dane zalogowanego użytkownika (prywatne). Nie mieszaj z danymi oglądanego profilu.
            // Trzymamy je tylko do ewentualnych ustawień/kolorów. W praktyce większość UI używa loadProfile().
            // (zostawiamy kompatybilność wstecz)
            selfPrivateProfile = profileDoc.data();
            console.log("Dane użytkownika (self) załadowane:", selfPrivateProfile);

            // Tutaj można ustawić kolory przycisków na podstawie danych użytkownika
            // Na razie pozostawiam to do implementacji gdy zrozumiem strukturę
          } else {
            console.log("Profil użytkownika nie istnieje");
          }
        } catch (error) {
          console.error("Błąd podczas ładowania profilu użytkownika:", error);
        }
      }

      // Funkcja logowania aktywności (zachowana dla kompatybilności wstecznej)
      async function logActivity(
        type,
        userId,
        userName,
        details,
        timestamp = null,
      ) {
        try {
          const activityData = {
            type: type,
            userId: userId,
            userName: userName,
            details: details,
            timestamp: timestamp || new Date(),
          };

          const { addDoc, collection } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          await addDoc(collection(db, "activityLogs"), activityData);

          console.log("Aktywność zalogowana:", activityData);
        } catch (error) {
          console.error("Błąd podczas logowania aktywności:", error);
        }
      }

      // Nowa funkcja logowania zdarzeń użytkowników
      async function logUserEvent(
        type,
        userId,
        userName,
        action,
        targetId = null,
        targetType = null,
        metadata = {},
      ) {
        try {
          const eventData = {
            type: type,
            userId: userId,
            userName: userName,
            action: action,
            targetId: targetId,
            targetType: targetType,
            details: action,
            metadata: metadata,
            timestamp: new Date().toISOString(),
          };

          // Najpierw spróbuj przez API
          try {
            const response = await fetch("/api/user-events", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(eventData),
            });

            if (response.ok) {
              const result = await response.json();
              console.log("User event logged via API:", result.data);
              return;
            }
          } catch (apiError) {
            console.warn(
              "API logging failed, falling back to Firebase:",
              apiError.message,
            );
          }

          // Fallback do Firebase (zachowana kompatybilność wsteczna)
          const { addDoc, collection } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
          await addDoc(collection(db, "activityLogs"), {
            type: type,
            userId: userId,
            userName: userName,
            details: action,
            timestamp: new Date(),
          });

          console.log("User event logged via Firebase fallback:", eventData);
        } catch (error) {
          console.error("Błąd podczas logowania zdarzenia użytkownika:", error);
        }
      }

      // Funkcje pomocnicze
      function getDefaultAvatar(gender) {
        if (gender === "female") {
          return '<i class="fa-solid fa-user text-white"></i>';
        } else {
          return '<i class="fa-solid fa-user text-white"></i>';
        }
      }

      function formatDate(timestamp) {
        if (!timestamp) return "";
        const date = timestamp.toDate
          ? timestamp.toDate()
          : new Date(timestamp);
        return date.toLocaleDateString("pl-PL");
      }

      // ===== AVATARY (wybór z lokalnego katalogu /avatary/) =====
      const AVATAR_PUBLIC_ORIGIN = "https://konto.strzelca.pl";
      const AVATAR_BASE_PATH = "/avatary/";
      let _availableAvatarsCache = null;

      function avatarUrlForFile(fileName) {
        // zapisujemy absolutny URL, żeby działało w każdej subdomenie (publicProfiles, widgety itd.)
        return `${AVATAR_PUBLIC_ORIGIN}${AVATAR_BASE_PATH}${encodeURIComponent(fileName)}`;
      }

      function getAvatarModalEls() {
        return {
          modal: document.getElementById("avatar-picker-modal"),
          grid: document.getElementById("avatar-picker-grid"),
          status: document.getElementById("avatar-picker-status"),
        };
      }

      async function listAvailableAvatarFiles() {
        if (_availableAvatarsCache) return _availableAvatarsCache;

        // Preferuj listowanie po stronie serwera (działa dla dowolnych nazw plików).
        const isMain = (window.location?.hostname || "") === "strzelca.pl";
        const urls = isMain
          ? ["/api/avatars", "https://strzelca.pl/api/avatars"]
          : ["https://strzelca.pl/api/avatars", "/api/avatars"];

        let lastStatus = null;
        for (const url of urls) {
          try {
            const res = await fetch(url, {
              cache: "no-store",
              credentials: url.startsWith("http") ? "omit" : "same-origin",
            });
            lastStatus = res.status;
            if (!res.ok) continue;
            const data = await res.json().catch(() => null);
            const files = Array.isArray(data?.files) ? data.files : [];
            _availableAvatarsCache = files
              .filter((x) => typeof x === "string" && x.length > 0)
              .sort((a, b) => a.localeCompare(b, "pl"));
            return _availableAvatarsCache;
          } catch (e) {
            // ignore and try next url
          }
        }

        // fallback: brak listowania (zwróć pustą listę) + zapisz status do komunikatu UI
        _availableAvatarsCache = [];
        _availableAvatarsCache.__error = lastStatus ? `HTTP ${lastStatus}` : "network";
        return _availableAvatarsCache;
      }

      function renderAvatarPicker(files) {
        const { grid, status } = getAvatarModalEls();
        if (!grid || !status) return;

        grid.innerHTML = "";

        // Kafelek: domyślny (czyści avatar)
        const defaultBtn = document.createElement("button");
        defaultBtn.type = "button";
        defaultBtn.className =
          "rounded-xl border border-zinc-800 bg-zinc-900/40 hover:bg-zinc-900/70 hover:border-coyote transition p-3 flex flex-col items-center justify-center gap-2";
        defaultBtn.title = "Ustaw domyślny avatar";

        const defaultIcon = document.createElement("div");
        defaultIcon.className =
          "w-full aspect-square rounded-lg bg-zinc-800/50 flex items-center justify-center text-zinc-200";
        defaultIcon.innerHTML = '<i class="fa-solid fa-user text-xl"></i>';

        const defaultLabel = document.createElement("div");
        defaultLabel.className = "text-[10px] font-black uppercase tracking-widest text-zinc-300";
        defaultLabel.textContent = "Domyślny";

        defaultBtn.appendChild(defaultIcon);
        defaultBtn.appendChild(defaultLabel);
        defaultBtn.addEventListener("click", async () => {
          await resetAvatarToDefault();
        });

        grid.appendChild(defaultBtn);

        if (!files || files.length === 0) {
          const err = files && files.__error ? String(files.__error) : "";
          status.textContent = err
            ? `Nie mogę pobrać listy avatarów (${err}). Upewnij się, że działa endpoint /api/avatars (na strzelca.pl) i odśwież stronę.`
            : "Nie znaleziono avatarów. Dodaj pliki do katalogu /konto.strzelca.pl/avatary/ i odśwież stronę.";
          return;
        }

        status.textContent = `Dostępne avatary: ${files.length}`;

        for (const file of files) {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "rounded-xl border border-zinc-800 bg-zinc-900/40 hover:bg-zinc-900/70 hover:border-coyote transition p-1";
          btn.title = file;

          const img = document.createElement("img");
          img.src = `${AVATAR_BASE_PATH}${file}`;
          img.alt = "Avatar";
          img.className = "w-full aspect-square object-cover rounded-lg";
          img.loading = "lazy";

          btn.appendChild(img);
          btn.addEventListener("click", async () => {
            await setAvatarFromCatalog(file);
          });

          grid.appendChild(btn);
        }
      }

      window.openAvatarPicker = async () => {
        try {
          if (!currentUser) {
            alert("Musisz być zalogowany, aby zmienić avatar.");
            return;
          }
          if (!isViewingOwnProfile) return;

          // Admin ma stały avatar
          if (isAdminRole(userProfile?.role || selfPrivateProfile?.role)) {
            alert("Avatar administratora jest stały i nie może być zmieniany.");
            return;
          }

          const { modal, status } = getAvatarModalEls();
          if (!modal) return;
          modal.classList.remove("hidden");
          if (status) status.textContent = "Ładowanie listy avatarów...";

          const files = await listAvailableAvatarFiles();
          renderAvatarPicker(files);
        } catch (e) {
          console.error("openAvatarPicker failed:", e);
          alert("Nie udało się otworzyć wyboru avatara.");
        }
      };

      window.closeAvatarPicker = () => {
        const { modal } = getAvatarModalEls();
        if (modal) modal.classList.add("hidden");
      };

      async function setAvatarFromCatalog(file) {
        const avatarDisplay = document.getElementById("avatar-display");
        try {
          if (!currentUser) {
            alert("Musisz być zalogowany, aby zmienić avatar.");
            return;
          }
          if (!isViewingOwnProfile) return;

          // Admin ma stały avatar
          if (isAdminRole(userProfile?.role || selfPrivateProfile?.role)) {
            alert("Avatar administratora jest stały i nie może być zmieniany.");
            return;
          }

          const url = avatarUrlForFile(file);

          if (avatarDisplay) {
            avatarDisplay.innerHTML = `<div class="text-zinc-400 text-sm">Zapisywanie avatara...</div>`;
          }

          await updateDoc(doc(db, "userProfiles", currentUser.uid), {
            avatar: url,
            avatarFile: file,
            avatarSource: "catalog",
            avatarUpdatedAt: new Date(),
          });

          // Best-effort: publiczny profil (nick + avatar)
          try {
            await setDoc(
              doc(db, "publicProfiles", currentUser.uid),
              {
                displayName: String(userProfile?.displayName || "").trim(),
                avatar: url,
                updatedAt: new Date(),
              },
              { merge: true },
            );
          } catch (e) {
            console.warn("Public profile avatar sync failed (ignored):", e?.message || e);
          }

          if (avatarDisplay) {
            avatarDisplay.innerHTML = `<img src="${url}" alt="Avatar" class="avatar">`;
          }

          // aktualizuj stan lokalny, jeśli był już wczytany
          if (userProfile) userProfile.avatar = url;

          window.closeAvatarPicker && window.closeAvatarPicker();
          alert("Avatar został ustawiony.");
        } catch (error) {
          console.error("Error setting avatar:", error);
          if (avatarDisplay) {
            avatarDisplay.innerHTML = userProfile?.avatar
              ? `<img src="${userProfile.avatar}" alt="Avatar" class="avatar">`
              : getDefaultAvatar(userProfile?.gender);
          }
          alert("Nie udało się ustawić avatara. Spróbuj ponownie.");
        }
      }

      async function resetAvatarToDefault() {
        const avatarDisplay = document.getElementById("avatar-display");
        try {
          if (!currentUser) {
            alert("Musisz być zalogowany, aby zmienić avatar.");
            return;
          }
          if (!isViewingOwnProfile) return;

          // Admin ma stały avatar
          if (isAdminRole(userProfile?.role || selfPrivateProfile?.role)) {
            // ustaw stały avatar admina
            await updateDoc(doc(db, "userProfiles", currentUser.uid), {
              avatar: ADMIN_AVATAR_URL,
              avatarFile: "",
              avatarSource: "admin_default",
              avatarUpdatedAt: new Date(),
            });
            try {
              await setDoc(
                doc(db, "publicProfiles", currentUser.uid),
                {
                  displayName: String(userProfile?.displayName || "").trim(),
                  avatar: ADMIN_AVATAR_URL,
                  updatedAt: new Date(),
                },
                { merge: true },
              );
            } catch (e) {
              console.warn("Public profile avatar sync failed (ignored):", e?.message || e);
            }

            if (userProfile) userProfile.avatar = ADMIN_AVATAR_URL;
            if (avatarDisplay) {
              avatarDisplay.innerHTML = `<img src="${ADMIN_AVATAR_URL}" alt="Avatar" class="avatar">`;
            }
            window.closeAvatarPicker && window.closeAvatarPicker();
            alert("Przywrócono domyślny avatar administratora.");
            return;
          }

          if (avatarDisplay) {
            avatarDisplay.innerHTML = `<div class="text-zinc-400 text-sm">Przywracanie domyślnego avatara...</div>`;
          }

          // Pierwotnie (przy rejestracji) avatar jest pusty ("") — UI pokazuje placeholder.
          await updateDoc(doc(db, "userProfiles", currentUser.uid), {
            avatar: "",
            avatarFile: "",
            avatarSource: "default",
            avatarUpdatedAt: new Date(),
          });

          // Best-effort: publiczny profil (nick + avatar)
          try {
            await setDoc(
              doc(db, "publicProfiles", currentUser.uid),
              {
                displayName: String(userProfile?.displayName || "").trim(),
                avatar: "",
                updatedAt: new Date(),
              },
              { merge: true },
            );
          } catch (e) {
            console.warn("Public profile avatar sync failed (ignored):", e?.message || e);
          }

          if (userProfile) userProfile.avatar = "";
          if (avatarDisplay) {
            avatarDisplay.innerHTML = getDefaultAvatar(userProfile?.gender);
          }

          window.closeAvatarPicker && window.closeAvatarPicker();
          alert("Przywrócono domyślny avatar.");
        } catch (error) {
          console.error("resetAvatarToDefault failed:", error);
          if (avatarDisplay) {
            avatarDisplay.innerHTML = userProfile?.avatar
              ? `<img src="${userProfile.avatar}" alt="Avatar" class="avatar">`
              : getDefaultAvatar(userProfile?.gender);
          }
          alert("Nie udało się przywrócić domyślnego avatara.");
        }
      }

      // Status konta w UI (logika weryfikacji emaila jest sprawdzana wyłącznie przy logowaniu)
      async function updateAccountStatus() {
        try {
          if (!currentUser) return;

          const emailEl = document.getElementById("user-email");
          const nameEl = document.getElementById("display-name");
          if (!emailEl || !nameEl) return;

          // Tooltip przeniesiony na nazwę użytkownika
          const memberText = memberSinceLabel ? `Członek od: ${memberSinceLabel}` : "";

          const role = (userProfile?.role || selfPrivateProfile?.role || "user").toString();
          const roleLabel =
            role === "admin" ? "Status: Administrator" :
            role === "company" ? "Status: Firma" :
            "Status: Użytkownik";

          const tooltip = [roleLabel, memberText].filter(Boolean).join("\n");
          nameEl.title = tooltip;
          nameEl.dataset.tooltip = tooltip;

          // Email bez tooltipa (info jest na nicku)
          emailEl.title = "";
          try { delete emailEl.dataset.tooltip; } catch {}
        } catch (e) {
          console.warn("updateAccountStatus failed (ignored):", e?.message || e);
        }
      }

      // Ładowanie danych profilu (własnego lub cudzego)
      async function loadProfile(uidToLoad = null) {
        if (!currentUser) {
          window.location.href = "./logowanie.html";
          return;
        }

        const uid = uidToLoad || currentUser.uid;

        try {
          const profileDoc = isViewingOwnProfile
            ? await getDoc(doc(db, "userProfiles", uid))
            : await getDoc(doc(db, "publicProfiles", uid));

          if (profileDoc.exists()) {
            userProfile = profileDoc.data();

            // Wypełnij nagłówek
            const displayNameEl = document.getElementById("display-name");
            if (displayNameEl) displayNameEl.textContent = userProfile.displayName;
            memberSinceLabel = formatDate(userProfile.createdAt);

            // Koloruj nick wg roli (zielony user, niebieski firma, czerwony admin)
            try {
              const role = (userProfile?.role || "user").toString();
              const el = document.getElementById("display-name");
              if (el) {
                el.classList.remove("name-role-user", "name-role-company", "name-role-admin");
                el.classList.add(
                  role === "admin"
                    ? "name-role-admin"
                    : role === "company"
                      ? "name-role-company"
                      : "name-role-user"
                );
              }
            } catch {}

            // target do opinii = oglądany profil
            reviewTargetUid = uid;
            reviewTargetDisplayName = userProfile.displayName || "Użytkownik";
            const reviewTargetEl = document.getElementById("review-target-name");
            if (reviewTargetEl) reviewTargetEl.textContent = reviewTargetDisplayName;

            // Email pokazujemy tylko właścicielowi (dla cudzych profili nie ujawniamy maila)
            if (isViewingOwnProfile) {
              document.getElementById("user-email").textContent =
                userProfile.email;
            } else {
              document.getElementById("user-email").textContent = "";
            }

            // Ustaw avatar (admin ma stały)
            const avatarDisplay = document.getElementById("avatar-display");
            const effectiveAvatar = isAdminRole(userProfile.role) ? ADMIN_AVATAR_URL : (userProfile.avatar || "");

            // Jeśli to admin i ogląda własny profil, zapisujemy wymuszony avatar do profilu (i publicznego profilu)
            if (isViewingOwnProfile && isAdminRole(userProfile.role) && userProfile.avatar !== ADMIN_AVATAR_URL) {
              try {
                await updateDoc(doc(db, "userProfiles", currentUser.uid), {
                  avatar: ADMIN_AVATAR_URL,
                  avatarFile: "",
                  avatarSource: "admin_default",
                  avatarUpdatedAt: new Date(),
                });
                userProfile.avatar = ADMIN_AVATAR_URL;
              } catch (e) {
                console.warn("Admin avatar enforce (private) failed (ignored):", e?.message || e);
              }
            }

            if (effectiveAvatar) {
              avatarDisplay.innerHTML = `<img src="${effectiveAvatar}" alt="Avatar" class="avatar">`;
            } else {
              avatarDisplay.innerHTML = getDefaultAvatar(userProfile.gender);
            }

            if (isViewingOwnProfile) {
              // best-effort: zapewnij publiczny profil do podglądu
              await syncPublicProfileFromPrivate();

              // Odszyfruj dane wrażliwe
              const decryptedProfile = {
                ...userProfile,
                phone: userProfile.phone ? b64DecodeUtf8(userProfile.phone) : "",
                parcelLocker: userProfile.parcelLocker
                  ? b64DecodeUtf8(userProfile.parcelLocker)
                  : "",
                address: {
                  street: userProfile.address?.street
                    ? b64DecodeUtf8(userProfile.address.street)
                    : "",
                  buildingNumber: userProfile.address?.buildingNumber
                    ? b64DecodeUtf8(userProfile.address.buildingNumber)
                    : "",
                  postalCode: userProfile.address?.postalCode
                    ? b64DecodeUtf8(userProfile.address.postalCode)
                    : "",
                  city: userProfile.address?.city
                    ? b64DecodeUtf8(userProfile.address.city)
                    : "",
                },
              };

              // Wypełnij formularz (odszyfrowanymi danymi)
              document.getElementById("edit-display-name").value =
                decryptedProfile.displayName || "";
              document.getElementById("edit-email").value =
                currentUser.email || "";
              document.getElementById("edit-first-name").value =
                decryptedProfile.firstName || "";
              document.getElementById("edit-last-name").value =
                decryptedProfile.lastName || "";
              document.getElementById("edit-phone").value =
                decryptedProfile.phone || "";
              document.getElementById("edit-street").value =
                decryptedProfile.address?.street || "";
              document.getElementById("edit-building-number").value =
                decryptedProfile.address?.buildingNumber || "";
              document.getElementById("edit-postal-code").value =
                decryptedProfile.address?.postalCode || "";
              document.getElementById("edit-city").value =
                decryptedProfile.address?.city || "";
              document.getElementById("edit-parcel-locker").value =
                decryptedProfile.parcelLocker || "";
              document.getElementById("edit-newsletter").checked =
                decryptedProfile.newsletter || false;

              // Zapisz snapshot wartości formularza, żeby "Wyjdź" mógł przywrócić stan bez zapisywania
              captureProfileFormSnapshot();

              // Aktualizuj status konta
              await updateAccountStatus();
            } else {
              // Dla cudzych profili nie pokazujemy statusu weryfikacji emaila zalogowanego usera
              const emailEl = document.getElementById("user-email");
              if (emailEl) {
                emailEl.classList.remove("email-status-verified", "email-status-unverified");
                emailEl.title = "";
                try { delete emailEl.dataset.tooltip; } catch {}
              }
            }

            // Załaduj opinie oglądanego użytkownika
            loadUserReviews(uid);
          } else {
            alert(
              "Nie znaleziono danych profilu. Skontaktuj się z administratorem.",
            );
            logout();
          }
        } catch (error) {
          console.error("Error loading profile:", error);
          alert("Błąd podczas ładowania profilu.");
        }
      }

      // Lista zabronionych nazw
      const forbiddenNames = [
        "admin",
        "administrator",
        "mod",
        "moderator",
        "moderacja",
        "moderowanie",
        "support",
        "pomoc",
        "help",
        "owner",
        "wlasciciel",
        "boss",
        "szef",
        "system",
        "bot",
        "robot",
        "strzelec",
        "strzelca",
        "platform",
        "site",
      ];

      // Funkcja sprawdzania dostępności nazwy użytkownika
      async function checkDisplayNameAvailability(displayName, currentUserId) {
        try {
          // Sprawdź czy nazwa nie jest zabroniona
          if (forbiddenNames.includes(displayName.toLowerCase())) {
            return {
              available: false,
              reason: "Ta nazwa jest zarezerwowana",
            };
          }

          // Sprawdź czy nazwa już istnieje w kolekcji displayNames
          const displayNameDoc = await getDoc(
            doc(db, "displayNames", displayName.toLowerCase()),
          );

          if (displayNameDoc.exists()) {
            // Jeśli nazwa należy do aktualnego użytkownika, jest dostępna
            if (displayNameDoc.data().userId === currentUserId) {
              return { available: true };
            }
            return {
              available: false,
              reason: "Ta nazwa jest już zajęta",
            };
          }

          return { available: true };
        } catch (error) {
          console.error("Error checking display name:", error);
          return {
            available: false,
            reason: "Błąd sprawdzania dostępności nazwy",
          };
        }
      }

      // Zapisywanie zmian profilu
      document
        .getElementById("profile-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          if (!currentUser || !userProfile) return;

          const saveBtn = e.target.querySelector('button[type="submit"]');
          saveBtn.disabled = true;
          saveBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zapisywanie...';

          try {
            // Zapisujemy TYLKO zmienione pola (żeby np. zapis avatara nie wymuszał zmian w telefonie)
            const getDec = (v) => {
              return b64DecodeUtf8(v);
            };

            const oldDecrypted = {
              phone: getDec(userProfile.phone),
              parcelLocker: getDec(userProfile.parcelLocker),
              address: {
                street: getDec(userProfile.address?.street),
                buildingNumber: getDec(userProfile.address?.buildingNumber),
                postalCode: getDec(userProfile.address?.postalCode),
                city: getDec(userProfile.address?.city),
              },
              newsletter: !!userProfile.newsletter,
            };

            const newDecrypted = {
              phone: (document.getElementById("edit-phone").value || "").trim(),
              parcelLocker: (document.getElementById("edit-parcel-locker").value || "").trim(),
              address: {
                street: (document.getElementById("edit-street").value || "").trim(),
                buildingNumber: (document.getElementById("edit-building-number").value || "").trim(),
                postalCode: (document.getElementById("edit-postal-code").value || "").trim(),
                city: (document.getElementById("edit-city").value || "").trim(),
              },
              newsletter: document.getElementById("edit-newsletter").checked,
            };

            const updatedProfile = {};

            if (newDecrypted.phone !== oldDecrypted.phone) {
              updatedProfile.phone = b64EncodeUtf8(newDecrypted.phone);
            }

            if (newDecrypted.parcelLocker !== oldDecrypted.parcelLocker) {
              updatedProfile.parcelLocker = b64EncodeUtf8(newDecrypted.parcelLocker);
            }

            const addrChanged =
              newDecrypted.address.street !== oldDecrypted.address.street ||
              newDecrypted.address.buildingNumber !== oldDecrypted.address.buildingNumber ||
              newDecrypted.address.postalCode !== oldDecrypted.address.postalCode ||
              newDecrypted.address.city !== oldDecrypted.address.city;

            if (addrChanged) {
              updatedProfile.address = {
                street: b64EncodeUtf8(newDecrypted.address.street),
                buildingNumber: b64EncodeUtf8(newDecrypted.address.buildingNumber),
                postalCode: b64EncodeUtf8(newDecrypted.address.postalCode),
                city: b64EncodeUtf8(newDecrypted.address.city),
              };
            }

            if (newDecrypted.newsletter !== oldDecrypted.newsletter) {
              updatedProfile.newsletter = newDecrypted.newsletter;
              updatedProfile.newsletterChanged = true;
            } else {
              updatedProfile.newsletterChanged = false;
            }

            const keysToWrite = Object.keys(updatedProfile).filter(k => k !== "newsletterChanged");
            if (keysToWrite.length === 0 && updatedProfile.newsletterChanged === false) {
              alert("Brak zmian do zapisania.");
              return;
            }

            // Usuń pole pomocnicze przed zapisem do userProfiles
            const { newsletterChanged, ...docUpdate } = updatedProfile;
            if (Object.keys(docUpdate).length > 0) {
              await updateDoc(doc(db, "userProfiles", currentUser.uid), docUpdate);
            }

            // Aktualizuj mailing list jeśli zmieniła się zgoda na newsletter
            if (updatedProfile.newsletterChanged === true) {
              if (newDecrypted.newsletter) {
                // Dodaj do mailing list
                await setDoc(doc(db, "mailingList", currentUser.email), {
                  email: currentUser.email,
                  subscribedAt: new Date(),
                  active: true,
                  source: "profile_update",
                });
              } else {
                // Usuń z mailing list
                await deleteDoc(doc(db, "mailingList", currentUser.email));
              }
            }

            alert("Profil został zaktualizowany!");
            // Zaktualizuj lokalną kopię profilu (bez pola pomocniczego)
            userProfile = { ...userProfile, ...docUpdate };
            loadProfile(); // Odśwież wyświetlane dane
          } catch (error) {
            console.error("Error updating profile:", error);
            alert("Błąd podczas aktualizacji profilu.");
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML =
              '<i class="fa-solid fa-save mr-2"></i>Zapisz zmiany';
          }
        });

      // Zmiana hasła
      window.changePassword = async () => {
        const newPassword = prompt("Wprowadź nowe hasło (minimum 8 znaków):");
        if (!newPassword || newPassword.length < 8) {
          alert("Hasło musi mieć co najmniej 8 znaków.");
          return;
        }

        const confirmPassword = prompt("Potwierdź nowe hasło:");
        if (newPassword !== confirmPassword) {
          alert("Hasła nie są identyczne.");
          return;
        }

        try {
          await updatePassword(currentUser, newPassword);
          alert("Hasło zostało zmienione!");
        } catch (error) {
          console.error("Error changing password:", error);

          if (error.code === "auth/requires-recent-login") {
            alert("Aby zmienić hasło, musisz się ponownie zalogować.");
            logout();
          } else {
            alert("Błąd podczas zmiany hasła.");
          }
        }
      };

      // Usuwanie konta
      window.deleteAccount = async () => {
        if (!currentUser) return;

        try {
          // najpierw zamknij modal (jeśli otwarty)
          try {
            window.closeDeleteAccountModal?.();
          } catch {}

          const idToken = await currentUser.getIdToken(true);
          const res = await fetch("https://strzelca.pl/api/delete-account", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken }),
            credentials: "include",
          });

          const data = await res.json().catch(() => ({}));
          if (!res.ok || data?.success !== true) {
            console.error("Delete account API failed:", res.status, data);
            alert(
              "Nie udało się usunąć konta automatycznie. Jeśli problem się powtarza, skontaktuj się z administratorem.",
            );
            return;
          }

          // Wyczyść localStorage i wyloguj się (czyści też cookie SSO)
          try {
            localStorage.clear();
          } catch {}

          alert("Konto zostało usunięte. Zostaniesz wylogowany.");
          try {
            await window.logout();
          } catch {
            window.location.href = "https://strzelca.pl/index.html";
          }
        } catch (error) {
          console.error("Error deleting account:", error);
          alert(
            "Wystąpił błąd podczas usuwania konta. Skontaktuj się z administratorem.",
          );
        }
      };

      // Wylogowanie
      window.logout = async () => {
        try {
          // SSO: wyczyść cookie wspólnej sesji
          try {
            await fetch("https://strzelca.pl/api/sso-session-logout", {
              method: "POST",
              credentials: "include",
            });
          } catch (e) {
            console.warn("SSO logout failed (ignored):", e?.message || e);
          }
          
          // Wyczyść cache SSO (ważne dla synchronizacji między subdomenami)
          try {
            const { clearSSOCache } = await import("https://strzelca.pl/sso-client.mjs?v=2026-02-06-1");
            clearSSOCache();
          } catch (e) {
            console.warn("SSO cache clear failed (ignored):", e?.message || e);
          }
          
          await signOut(auth);
          // Wyczyść ewentualne dane w localStorage (preferencje kolorów itp.)
          localStorage.clear();
          window.location.href = "https://strzelca.pl/index.html";
        } catch (error) {
          console.error("Error signing out:", error);
        }
      };

      // Avatary są wybierane z lokalnego katalogu /avatary/ (zob. openAvatarPicker / setAvatarFromCatalog)

      // ===== FUNKCJE DO OBSŁUGI OPINII =====

      // Ładowanie opinii użytkownika
      async function loadUserReviews(ratedUid) {
        const uid = ratedUid || currentUser?.uid;
        if (!uid) return;
        try {
          // Zapytanie wymaga indeksu - użyj prostszego zapytania lub obsłuż błąd
          const reviewsQuery = query(
            collection(db, "userReviews"),
            where("ratedId", "==", uid),
            where("status", "==", "approved"),
            orderBy("timestamp", "desc"),
          );

          const reviewsSnapshot = await getDocs(reviewsQuery);
          const reviews = reviewsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          displayReviews(reviews);
          updateAverageRating(reviews);
        } catch (error) {
          console.error("Błąd ładowania opinii:", error);
          // Jeśli błąd to brak indeksu, użyj prostszego zapytania
          if (error.code === "failed-precondition") {
            try {
              console.log("Próba prostszego zapytania bez indeksu (1 filtr + sortowanie po stronie klienta)");
              const simpleQuery = query(
                collection(db, "userReviews"),
                where("ratedId", "==", uid),
              );
              const simpleSnapshot = await getDocs(simpleQuery);
              let reviews = simpleSnapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
              // Filtruj ręcznie (żeby nie wymagać indeksu kompozytowego)
              reviews = reviews.filter((r) => r.status === "approved");
              // Sortuj ręcznie
              reviews.sort((a, b) => {
                const aTime = a.timestamp?.toDate?.() || new Date(a.timestamp || 0);
                const bTime = b.timestamp?.toDate?.() || new Date(b.timestamp || 0);
                return bTime - aTime;
              });
              displayReviews(reviews);
              updateAverageRating(reviews);
            } catch (simpleError) {
              console.error("Błąd prostszego zapytania:", simpleError);
              displayReviews([]);
            }
          } else {
            displayReviews([]);
          }
        }
      }

      // Wyświetlanie opinii
      function displayReviews(reviews) {
        const reviewsList = document.getElementById("reviews-list");

        if (reviews.length === 0) {
          reviewsList.innerHTML =
            '<p class="text-zinc-400 text-center py-8">Brak opinii użytkowników.</p>';
          return;
        }

        reviewsList.innerHTML = reviews
          .map(
            (review) => `
                <div class="review-card">
                    <div class="review-header">
                        ${
                          review.raterId
                            ? `<a class="review-author hover:underline" href="https://konto.strzelca.pl/profil/${review.raterId}">${review.raterName || "Anonimowy użytkownik"}</a>`
                            : `<span class="review-author">${review.raterName || "Anonimowy użytkownik"}</span>`
                        }
                        <span class="review-date">${formatDate(review.timestamp)}</span>
                    </div>
                    <div class="review-rating">
                        ${generateStars(review.rating)}
                    </div>
                    <div class="review-comment">${review.comment}</div>
                </div>
            `,
          )
          .join("");
      }

      // Generowanie gwiazdek dla opinii
      function generateStars(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += `<i class="fa-solid fa-star ${i <= rating ? "text-yellow-400" : "text-zinc-600"}"></i>`;
        }
        return stars;
      }

      // Aktualizacja średniej oceny
      function updateAverageRating(reviews) {
        const averageRating = document.getElementById("average-rating");
        const averageStars = document.getElementById("average-stars");
        const reviewsCount = document.getElementById("reviews-count");

        if (reviews.length === 0) {
          averageRating.textContent = "0.0";
          reviewsCount.textContent = "(0 opinii)";
          return;
        }

        const sum = reviews.reduce((acc, review) => acc + review.rating, 0);
        const avg = (sum / reviews.length).toFixed(1);

        averageRating.textContent = avg;
        reviewsCount.textContent = `(${reviews.length} opinii)`;

        // Aktualizuj wizualne gwiazdki
        const starElements = averageStars.querySelectorAll(".fa-star");
        const fullStars = Math.floor(avg);

        starElements.forEach((star, index) => {
          if (index < fullStars) {
            star.className = "fa-solid fa-star text-yellow-400";
          } else if (index === fullStars && avg % 1 >= 0.5) {
            star.className = "fa-solid fa-star-half-alt text-yellow-400";
          } else {
            star.className = "fa-solid fa-star text-zinc-600";
          }
        });
      }

      // (Wyłączone) Wcześniej był wybór użytkownika do oceny.
      // Teraz opinia jest zawsze wystawiana użytkownikowi, którego profil oglądasz.

      // Obsługa gwiazdek w formularzu
      function initializeStarRating() {
        const stars = document.querySelectorAll(".rating-input .star");
        const ratingInput = document.getElementById("rating-value");

        stars.forEach((star) => {
          star.addEventListener("click", () => {
            const rating = parseInt(star.dataset.rating);
            ratingInput.value = rating;

            stars.forEach((s, index) => {
              if (index < rating) {
                s.classList.add("active");
                s.classList.remove("inactive");
              } else {
                s.classList.remove("active");
                s.classList.add("inactive");
              }
            });
          });
        });
      }

      // Otwórz modal dodawania opinii
      function openReviewModal() {
        if (!currentUser || !reviewTargetUid) return;
        if (reviewTargetUid === currentUser.uid) {
          alert("Nie możesz dodać opinii samemu sobie.");
          return;
        }
        document.getElementById("add-review-modal").classList.add("show");
        resetReviewForm();
      }

      // Zamknij modal
      function closeReviewModal() {
        document.getElementById("add-review-modal").classList.remove("show");
        resetReviewForm();
      }

      // Inline onclick handlers in HTML need globals (module scope isn't on window)
      window.openReviewModal = openReviewModal;
      window.closeReviewModal = closeReviewModal;

      // Reset formularza opinii
      function resetReviewForm() {
        document.getElementById("review-form").reset();
        document.getElementById("rating-value").value = "0";
        document.querySelectorAll(".rating-input .star").forEach((star) => {
          star.classList.remove("active", "inactive");
        });
      }

      // ===== MODAL: DANE PROFILU =====
      window.openProfileModal = function openProfileModal() {
        // Przy otwieraniu odrzuć niezapisane zmiany w polach
        restoreProfileFormSnapshot();
        document.getElementById("profile-data-modal")?.classList.add("show");
      };
      window.closeProfileModal = function closeProfileModal(e) {
        try { e?.preventDefault?.(); e?.stopPropagation?.(); } catch {}
        // Przy zamknięciu odrzuć niezapisane zmiany
        restoreProfileFormSnapshot();
        document.getElementById("profile-data-modal")?.classList.remove("show");
      };

      // przycisk "Dane profilu"
      document.getElementById("open-profile-data-btn")?.addEventListener("click", () => {
        window.openProfileModal();
      });

      // zamykanie modalu po kliknięciu w tło
      document.getElementById("profile-data-modal")?.addEventListener("click", (e) => {
        if (e.target?.id === "profile-data-modal") {
          window.closeProfileModal();
        }
      });

      // ===== MODAL: USUWANIE KONTA =====
      window.openDeleteAccountModal = function openDeleteAccountModal() {
        document.getElementById("delete-account-modal")?.classList.add("show");
        const input = document.getElementById("delete-account-confirm-input");
        const btn = document.getElementById("confirm-delete-account-btn");
        if (input) input.value = "";
        if (btn) {
          btn.disabled = true;
          btn.classList.add("opacity-50", "cursor-not-allowed");
        }
      };
      window.closeDeleteAccountModal = function closeDeleteAccountModal() {
        document.getElementById("delete-account-modal")?.classList.remove("show");
      };

      document.getElementById("open-delete-account-btn")?.addEventListener("click", () => {
        window.openDeleteAccountModal();
      });

      document.getElementById("delete-account-modal")?.addEventListener("click", (e) => {
        if (e.target?.id === "delete-account-modal") {
          window.closeDeleteAccountModal();
        }
      });

      const deleteConfirmInput = document.getElementById("delete-account-confirm-input");
      const deleteConfirmBtn = document.getElementById("confirm-delete-account-btn");
      const requiredPhrase = "Usuń konto";

      function updateDeleteButtonState() {
        if (!deleteConfirmInput || !deleteConfirmBtn) return;
        const ok = deleteConfirmInput.value === requiredPhrase;
        deleteConfirmBtn.disabled = !ok;
        deleteConfirmBtn.classList.toggle("opacity-50", !ok);
        deleteConfirmBtn.classList.toggle("cursor-not-allowed", !ok);
      }

      deleteConfirmInput?.addEventListener("input", updateDeleteButtonState);

      deleteConfirmBtn?.addEventListener("click", async () => {
        try {
          deleteConfirmBtn.disabled = true;
          deleteConfirmBtn.classList.add("opacity-50", "cursor-not-allowed");
          deleteConfirmBtn.textContent = "Usuwanie...";

          await window.deleteAccount();
        } finally {
          // jeśli coś pójdzie nie tak, przywróć stan przycisku (zależnie od inputu)
          deleteConfirmBtn.textContent = "Usuń konto";
          updateDeleteButtonState();
        }
      });

      // Dodawanie nowej opinii
      async function submitReview(event) {
        event.preventDefault();

        const ratedUserId = reviewTargetUid;
        const rating = parseInt(document.getElementById("rating-value").value);
        const comment = document.getElementById("review-comment").value.trim();

        if (!ratedUserId) {
          alert("Brak użytkownika do oceny.");
          return;
        }

        // Twarda blokada: nie można dodać opinii samemu sobie (nawet jeśli ktoś zmanipuluje DOM)
        if (ratedUserId === currentUser.uid) {
          alert("Nie możesz dodać opinii samemu sobie.");
          return;
        }

        if (rating === 0) {
          alert("Wybierz ocenę (co najmniej 1 gwiazdka).");
          return;
        }

        if (comment.length < 10) {
          alert("Opis opinii musi mieć co najmniej 10 znaków.");
          return;
        }

        try {
          // Pobierz dane ocenianego użytkownika
          const ratedUserDoc = await getDoc(
            doc(db, "publicProfiles", ratedUserId),
          );
          const ratedUser = ratedUserDoc.data();

          // Dodaj opinię do bazy danych
          const reviewRef = await addDoc(collection(db, "userReviews"), {
            raterId: currentUser.uid,
            raterName: userProfile.displayName,
            ratedId: ratedUserId,
            ratedName: ratedUser.displayName,
            rating: rating,
            comment: comment,
            timestamp: new Date(),
            status: "approved", // W wersji podstawowej wszystkie opinie są automatycznie zatwierdzane
          });

          // Zaloguj zdarzenie użytkownika
          await logUserEvent(
            "USER-REVIEW",
            currentUser.uid,
            userProfile.displayName,
            `Ocena użytkownika ${ratedUser.displayName}: ${rating} gwiazdek`,
            ratedUserId,
            "user",
            {
              rating: rating,
              comment:
                comment.substring(0, 100) + (comment.length > 100 ? "..." : ""),
              targetUserName: ratedUser.displayName,
            },
          );

          // Zaloguj do activityLogs w formacie zgodnym z panelem admina
          try {
            const { addDoc: addDocActivity, collection: collectionActivity } =
              await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
            await addDocActivity(collectionActivity(db, "activityLogs"), {
              userId: currentUser.uid,
              action: "REVIEW_CREATED",
              details: {
                productName: ratedUser.displayName,
                target: ratedUser.displayName,
                rating: rating,
                comment: comment.substring(0, 100) + (comment.length > 100 ? "..." : ""),
              },
              timestamp: new Date(),
              userAgent: navigator.userAgent,
            });
          } catch (logError) {
            console.warn("Błąd logowania opinii do activityLogs:", logError);
          }

          alert("Opinia została dodana pomyślnie!");
          closeReviewModal();

          // Odśwież opinie na aktualnie oglądanym profilu
          loadUserReviews(ratedUserId);
        } catch (error) {
          console.error("Błąd dodawania opinii:", error);
          alert("Wystąpił błąd podczas dodawania opinii. Spróbuj ponownie.");
        }
      }

      // Inicjalizacja obsługi zdarzeń
      function initializeReviewEvents() {
        // Przycisk dodawania opinii
        document
          .getElementById("add-review-btn")
          .addEventListener("click", openReviewModal);

        // Formularz opinii
        document
          .getElementById("review-form")
          .addEventListener("submit", submitReview);

        // Inicjalizacja gwiazdek
        initializeStarRating();

        // Zamykanie modalu przy kliknięciu poza nim
        document
          .getElementById("add-review-modal")
          .addEventListener("click", (e) => {
            if (e.target.id === "add-review-modal") {
              closeReviewModal();
            }
          });
      }

      // ===== KONIEC FUNKCJI OPINII =====

      // Inicjalizuj śledzenie aktywności
      try {
        const { initActivityTracker } = await import("https://strzelca.pl/activity-tracker.mjs?v=2026-02-06-1");
        await initActivityTracker(auth, db);
        
        // Monitorowanie statusu użytkownika (blokowanie)
        const { initUserStatusMonitor } = await import("https://strzelca.pl/user-status-monitor.mjs?v=2026-02-06-1");
        await initUserStatusMonitor(auth, db);
      } catch (error) {
      console.warn("Could not initialize activity tracker:", error);
    }
    
    // Inicjalizuj śledzenie odwiedzin (działa dla wszystkich użytkowników, również niezalogowanych)
    try {
      const { initVisitTracker } = await import("https://strzelca.pl/visit-tracker.mjs?v=2026-02-06-3");
      await initVisitTracker(auth);
    } catch (error) {
      console.warn("Could not initialize visit tracker:", error);
    }

    // Sprawdź stan autoryzacji
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUser = user;
          loadProfile();
          initializeReviewEvents();
        } else {
          window.location.href = "./logowanie.html";
        }
      });
      
      } catch (e) {
        console.error("Profile boot failed:", e);
        alert("Nie udało się uruchomić profilu (błąd konfiguracji).");
      }
      })();
    </script>
    <script
      type="module"
      src="https://strzelca.pl/auth-widget.mjs?v=2026-02-06-1"
    ></script>
    <script
      type="module"
      src="https://strzelca.pl/messages-widget.mjs?v=2026-02-05-14"
    ></script>
  </body>
</html>
