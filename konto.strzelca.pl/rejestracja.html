<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://strzelca.pl/ikona.svg"
    />
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg" />

    <title>Rejestracja - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --coyote: #c19a6b;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #0a0a0a;
        color: #e5e5e5;
        margin: 0;
        overflow-x: hidden;
      }
      .main-wrapper {
        min-height: 100vh;
        width: 100%;
        background:
          linear-gradient(rgba(10,10,10,0.1) 0%, rgba(10,10,10,0.4) 50%, #0a0a0a 100%),
          url("https://strzelca.pl/tlo.png");
        background-size: cover;
        background-position: top center;
        display: flex;
        flex-direction: column;
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }

      /* Reset domyślnych ramek inputów/textarea/select i zostaw tylko własne zaokrąglone obramowanie */
      /* Wykluczamy checkboxy i radio z globalnych stylów */
      input:not([type="checkbox"]):not([type="radio"]),
      select,
      textarea {
        /* Zapewnij widoczność wszystkich pól formularza */
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: #111 !important;
        border: none; /* usuwa natywny border (prostokątny) */
        color: white !important;
        padding: 16px 20px !important;
        border-radius: 12px;
        width: 100%;
        outline: none; /* usuwa prostokątny outline przeglądarki */
        box-shadow: 0 0 0 1px #222; /* pseudo-border, który podlega zaokrągleniu */
        transition: 0.3s;
      }
      input:not([type="checkbox"]):not([type="radio"]):focus,
      select:focus,
      textarea:focus {
        outline: none;
        box-shadow: 0 0 0 2px var(--coyote); /* tylko zaokrąglone obramowanie przy focus */
        background: #161616 !important;
      }

      .radio-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin: 10px 0;
      }

      .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .radio-option input[type="radio"],
      .checkbox-group input[type="checkbox"] {
        width: 18px !important;
        height: 18px !important;
        min-width: 18px !important;
        min-height: 18px !important;
        cursor: pointer;
        accent-color: var(--coyote);
        /* Resetuj style z globalnych inputów */
        appearance: auto !important;
        -webkit-appearance: checkbox !important;
        -moz-appearance: checkbox !important;
        background: transparent !important;
        padding: 0 !important;
        border: 2px solid #444 !important;
        border-radius: 4px !important;
        box-shadow: none !important;
        margin: 0 !important;
        flex-shrink: 0;
        /* Zapewnij widoczność */
        display: inline-block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
      
      .checkbox-group input[type="checkbox"]:checked {
        background-color: var(--coyote) !important;
        border-color: var(--coyote) !important;
      }
      
      .checkbox-group input[type="checkbox"]:focus {
        outline: 2px solid var(--coyote) !important;
        outline-offset: 2px !important;
        box-shadow: none !important;
      }

      .gender-selection {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-top: 12px;
        min-height: 50px;
        align-items: center;
      }

      .gender-option {
        font-size: 16px;
        font-weight: 500;
        color: #888;
        cursor: pointer;
        transition: all 0.3s;
        user-select: none;
        padding: 8px 16px;
        border-radius: 8px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .gender-option.active {
        color: var(--coyote);
        font-weight: 700;
        font-size: 20px;
      }

      .gender-selection input[type="radio"] {
        display: none;
      }

      .form-section {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
      }

      .section-title {
        color: var(--coyote);
        font-family: "Orbitron", sans-serif;
        font-size: 14px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-bottom: 20px;
        text-align: center;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 16px;
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
          gap: 16px;
        }

        .form-section {
          padding: 16px;
        }
      }

      .optional-field {
        color: #999 !important;
      }

      .btn-register {
        background: var(--coyote);
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        padding: 20px;
        border-radius: 12px;
        transition: 0.3s;
        cursor: pointer;
        width: 100%;
      }
      .btn-register:hover {
        transform: scale(1.02);
        box-shadow: 0 0 20px rgba(193, 154, 107, 0.2);
      }
      .btn-register:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .checkbox-group {
        display: flex;
        align-items: flex-start;
        gap: 10px;
        margin: 15px 0;
      }

      .checkbox-group label {
        color: #888;
        transition: color 0.3s;
      }

      .checkbox-group input[type="checkbox"]:checked + label {
        color: #e5e5e5;
      }

      .error-message {
        color: #ef4444;
        font-size: 14px;
        margin-top: 5px;
        display: none;
      }

      .field-required::after {
        content: " *";
        color: #ef4444;
      }

      .tooltip-container {
        position: relative;
        display: inline-block;
      }

      .tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background: #111;
        color: #e5e5e5;
        padding: 12px 16px;
        border-radius: 8px;
        border: 1px solid #333;
        font-size: 12px;
        line-height: 1.4;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 1000;
        margin-bottom: 8px;
      }

      .tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: #111;
      }

      .tooltip.show {
        opacity: 1;
        visibility: visible;
      }

      .tooltip-trigger {
        cursor: help;
        position: relative;
      }

      .tooltip-trigger::after {
        content: "ℹ";
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #666;
        font-size: 14px;
        transition: color 0.3s;
      }

      .tooltip-trigger:focus::after,
      .tooltip-trigger:hover::after {
        color: var(--coyote);
      }

      .validation-success {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3) !important;
      }
      
      /* Upewnij się, że wszystkie pola z validation-success mają ten sam kolor */
      input.validation-success,
      textarea.validation-success,
      select.validation-success,
      .strzelec-input-container.validation-success input,
      .strzelec-input-container.validation-success textarea,
      .strzelec-input-container.validation-success select {
        border-color: #10b981 !important;
        box-shadow: 0 0 0 2px rgba(16, 185, 129, 0.3) !important;
      }

      .validation-error {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2) !important;
      }

      /* Kontener inputów dostaje klasy walidacji – musi mieć to samo zaokrąglenie, żeby nie robić kwadratu */
      .strzelec-input-container {
        border-radius: 12px;
      }

      /* Wymuś zaokrąglenie także na samych klasach walidacji */
      .validation-success,
      .validation-error {
        border-radius: 12px !important;
      }

      /* Safari/Chrome potrafią dodać ring na :focus-visible mimo resetu */
      input:focus-visible,
      select:focus-visible,
      textarea:focus-visible {
        outline: none !important;
      }
    </style>

    <!-- Google Analytics -->
    <script
      async
      src="https://www.googletagmanager.com/gtag/js?id=G-9EJ2R3JPVD"
    ></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag() {
        dataLayer.push(arguments);
      }
      gtag("js", new Date());
      gtag("config", "G-9EJ2R3JPVD");
    </script>
  </head>
  <body>
    <div class="main-wrapper">
      <nav
      class="h-[73px] border-b border-zinc-900 sticky top-0 bg-black/95 z-50 backdrop-blur-md flex items-center relative"
    >
      <a
        href="https://strzelca.pl"
        class="absolute left-4 md:left-8 text-zinc-500 hover:text-white transition text-xl"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div class="container mx-auto px-6 flex justify-center">
        <div
          class="uppercase font-bold text-[11px] tracking-[0.3em] font-[Orbitron] text-zinc-400"
        >
          REJESTRACJA.<span class="coyote-text">STRZELCA</span>.PL
        </div>
      </div>
    </nav>

    <main class="container mx-auto px-6 py-12 max-w-2xl">
      <div
        class="bg-zinc-900/50 p-8 md:p-12 rounded-3xl border border-zinc-800 shadow-2xl"
      >
        <h1
          class="text-3xl md:text-5xl font-black uppercase italic font-[Orbitron] text-center mb-8"
        >
          REJESTRACJA <span class="coyote-text">STRZELCA</span>
        </h1>

        <form id="registration-form">
          <!-- Sekcja 1: DANE LOGOWANIA -->
          <div class="form-section">
            <div class="section-title">DANE LOGOWANIA</div>

            <!-- Linia 1: Nazwa użytkownika, Email -->
            <div class="form-row">
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest field-required"
                  >Nazwa użytkownika</label
                >
                <div class="tooltip-container strzelec-input-container">
                  <input
                    type="text"
                    id="display-name"
                    placeholder="Jan.K"
                    required
                    minlength="3"
                    maxlength="12"
                    pattern="[a-zA-Z0-9\-_.]+"
                    class="tooltip-trigger"
                  />
                  <div class="tooltip">
                    Dozwolone: 3-12 znaków, litery, cyfry, znaki: - . _
                  </div>
                </div>
                <div class="error-message" id="display-name-error"></div>
              </div>

              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest field-required"
                  >Adres email</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="email"
                    id="email"
                    placeholder="jan.kowalski@email.com"
                    required
                    maxlength="50"
                  />
                </div>
                <div class="error-message" id="email-error"></div>
              </div>
            </div>

            <!-- Linia 2: Hasło, Powtórz hasło -->
            <div class="form-row">
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest field-required"
                  >Hasło</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="password"
                    id="password"
                    placeholder="Hasło"
                    required
                    minlength="8"
                  />
                </div>
                <div class="error-message" id="password-error"></div>
              </div>

              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest field-required"
                  >Powtórz hasło</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="password"
                    id="password-confirm"
                    placeholder="Powtórz hasło"
                    required
                  />
                </div>
                <div class="error-message" id="password-confirm-error"></div>
              </div>
            </div>
          </div>

          <!-- Sekcja 2: DANE STRZELCA -->
          <div class="form-section">
            <div class="section-title">DANE STRZELCA</div>

            <!-- Płeć -->
            <div class="mb-6">
              <div class="gender-selection strzelec-input-container">
                <label for="gender-male" class="gender-option active"
                  >MĘŻCZYZNA</label
                >
                <label for="gender-female" class="gender-option">KOBIETA</label>
                <input
                  type="radio"
                  name="gender"
                  id="gender-male"
                  value="male"
                  checked
                  required
                />
                <input
                  type="radio"
                  name="gender"
                  id="gender-female"
                  value="female"
                  required
                />
              </div>
            </div>

            <!-- Linia 1: Imię, Nazwisko -->
            <div class="form-row">
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Imię</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="text"
                    id="first-name"
                    placeholder="Jan"
                    maxlength="25"
                    pattern="[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż\s\-]*"
                    title="Tylko litery, zaczynając od dużej litery"
                  />
                </div>
              </div>

              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Nazwisko</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="text"
                    id="last-name"
                    placeholder="Kowalski"
                    maxlength="25"
                    pattern="[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż\s\-]*"
                    title="Tylko litery, zaczynając od dużej litery"
                  />
                </div>
              </div>
            </div>

            <!-- Linia 2: Ulica, Nr budynku/lokalu -->
            <div class="form-row">
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Ulica</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="text"
                    id="street"
                    placeholder="Ulica"
                    maxlength="25"
                  />
                </div>
              </div>

              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Nr budynku/lokalu</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="text"
                    id="building-number"
                    placeholder="Numer budynku/lokalu"
                    maxlength="25"
                  />
                </div>
              </div>
            </div>

            <!-- Linia 3: Kod pocztowy, Miasto -->
            <div class="form-row">
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Kod pocztowy</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="text"
                    id="postal-code"
                    placeholder="Kod pocztowy"
                  />
                </div>
              </div>

              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Miasto</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="text"
                    id="city"
                    placeholder="Miasto"
                    maxlength="25"
                  />
                </div>
              </div>
            </div>

            <!-- Linia 4: Telefon, Paczkomat -->
            <div class="form-row">
              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Numer telefonu</label
                >
                <div class="strzelec-input-container">
                  <input
                    type="tel"
                    id="phone"
                    placeholder="+48 123 456 789"
                    maxlength="21"
                    pattern="[\+]?[0-9\s]*"
                  />
                </div>
              </div>

              <div>
                <label
                  class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest optional-field"
                  >Paczkomat InPost</label
                >
                <input
                  type="text"
                  id="parcel-locker"
                  placeholder="np. WRO42M"
                />
              </div>
            </div>
          </div>

          <!-- Zgody -->
          <div class="form-section">
            <div class="section-title">ZGODY</div>
            <div class="space-y-4">
              <!-- Główny checkbox wszystkich zgód -->
              <div class="checkbox-group">
                <input type="checkbox" id="all-consents" />
                <label for="all-consents" class="text-sm font-semibold">
                  Zaznacz wszystkie zgody STRZELCA
                </label>
              </div>

              <!-- Wiek -->
              <div class="checkbox-group">
                <input type="checkbox" id="age-confirm" />
                <label for="age-confirm" class="text-sm">
                  Potwierdzam, że mam ukończone 18 lat
                  <span class="text-red-500">*</span>
                </label>
              </div>

              <!-- Regulamin i RODO -->
              <div class="checkbox-group">
                <input type="checkbox" id="terms-privacy-accept" />
                <label for="terms-privacy-accept" class="text-sm">
                  Akceptuję
                  <a
                    href="https://dokumenty.strzelca.pl#regulamin-platformy"
                    target="_blank"
                    class="text-coyote hover:underline"
                    >regulamin</a
                  >
                  i wyrażam zgodę na przetwarzanie danych osobowych zgodnie z
                  <a
                    href="https://dokumenty.strzelca.pl#polityka-prywatnosci-platformy"
                    target="_blank"
                    class="text-coyote hover:underline"
                    >polityką prywatności</a
                  >
                  (RODO) <span class="text-red-500">*</span>
                </label>
              </div>

              <!-- Newsletter -->
              <div class="checkbox-group">
                <input type="checkbox" id="newsletter" />
                <label for="newsletter" class="text-sm">
                  Chcę otrzymywać newsletter (rezygnacja możliwa w każdej
                  chwili)
                </label>
              </div>
            </div>
          </div>

          <button type="submit" class="btn-register" id="register-btn">
            <i class="fa-solid fa-user-plus mr-2"></i>
            Utwórz STRZELCA
          </button>

          <div class="text-center pt-4">
            <a
              href="./login.html"
              class="text-zinc-400 hover:text-coyote hover:underline transition text-sm"
            >
              Masz już konto STRZELCA? Zaloguj się.
            </a>
          </div>

          <div class="text-center text-xs text-zinc-400 mt-6">
            <span class="text-red-500">*</span> Pola oznaczone gwiazdką są
            obowiązkowe
          </div>
        </form>
      </div>
    </main>

    <footer
      class="text-center py-10 border-t border-zinc-900 text-zinc-700 text-[10px] uppercase font-bold tracking-[0.4em]"
    >
      <a href="https://strzelca.pl" class="hover:text-white transition"
        >STRZELCA.PL</a
      >
      |
      <a
        href="https://dokumenty.strzelca.pl"
        class="hover:text-white transition ml-4"
        >DOKUMENTY - REGULAMINY, ZWROTY ITP.</a
      >
    </footer>

    <!-- Session Manager -->

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        deleteDoc,
        collection,
        query,
        where,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        sendEmailVerification,
        browserLocalPersistence,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD_gXFh3a4NW9Hzzsr5IQuDADM2GVpPMVc",
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.firebasestorage.app",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // Ustaw trwałość sesji na LOCAL dla wszystkich stron wymagających logowania
      await auth.setPersistence(browserLocalPersistence);

      // Flaga do kontroli przekierowania podczas rejestracji
      let isRegistering = false;

      // Listener stanu autoryzacji - jeśli użytkownik już jest zalogowany, przekieruj do profilu
      const { onAuthStateChanged } =
        await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
      onAuthStateChanged(auth, (user) => {
        // Nie przekierowuj podczas procesu rejestracji
        if (isRegistering) {
          console.log("Proces rejestracji w toku, pomijam przekierowanie");
          return;
        }
        
        if (user) {
          // Sprawdź czy profil istnieje przed przekierowaniem
          getDoc(doc(db, "userProfiles", user.uid))
            .then((profileDoc) => {
              if (profileDoc.exists()) {
                // Użytkownik już jest zalogowany i ma profil - przekieruj do profilu
                console.log(
                  "Użytkownik już zalogowany, przekierowanie do profil.html",
                );
                window.location.href = "profil.html";
              } else {
                // Użytkownik zalogowany, ale brak profilu - przekieruj do strony aktywacji
                console.log("Użytkownik zalogowany, ale brak profilu - przekierowanie do po.rejestracji.html");
                window.location.href = "po.rejestracji.html";
              }
            })
            .catch((error) => {
              console.error("Błąd sprawdzania profilu:", error);
              // W przypadku błędu, przekieruj do strony aktywacji
              window.location.href = "po.rejestracji.html";
            });
        } else {
          // Użytkownik niezalogowany - pozwól mu się zarejestrować
          console.log("Użytkownik niezalogowany, można się zarejestrować");
        }
      });

      // Lista zabronionych słów (nazwa zawierająca którekolwiek z tych słów jest zabroniona)
      const forbiddenWords = [
        "admin",
        "administrator",
        "mod",
        "moderator",
        "moderacja",
        "moderowanie",
        "support",
        "pomoc",
        "help",
        "owner",
        "wlasciciel",
        "boss",
        "szef",
        "system",
        "bot",
        "robot",
        "strzelec",
        "strzelca",
        "platform",
        "site",
      ];

      // Funkcja sprawdzająca czy nazwa zawiera zabronione słowa
      function containsForbiddenWord(displayName) {
        const nameLower = displayName.toLowerCase();
        return forbiddenWords.some(word => nameLower.includes(word));
      }

      // Funkcja sprawdzania dostępności nazwy strzelca
      async function checkDisplayNameAvailability(displayName) {
        try {
          // Sprawdź czy nazwa zawiera zabronione słowa
          if (containsForbiddenWord(displayName)) {
            return {
              available: false,
              reason: "Ta nazwa jest zarezerwowana",
            };
          }

          // Sprawdzenie po stronie serwera (Vercel /api) – omija problemy z regułami/AppCheck
          // Używamy pełnego URL do głównej domeny, bo formularz działa na subdomenie konto.strzelca.pl
          const resp = await fetch(
            `https://strzelca.pl/api/display-name?name=${encodeURIComponent(displayName)}`,
            { method: "GET" },
          );
          const data = await resp.json().catch(() => null);

          if (!resp.ok || !data || data.success !== true) {
            return {
              available: false,
              reason: "Błąd sprawdzania dostępności nazwy",
            };
          }

          if (data.available === false) {
            return { available: false, reason: data.reason || "Ta nazwa jest już zajęta" };
          }

          return { available: true };
        } catch (error) {
          console.error("Error checking display name:", error);
          return {
            available: false,
            reason: "Błąd sprawdzania dostępności nazwy",
          };
        }
      }

      // Funkcje pomocnicze
      function showError(elementId, message) {
        const element = document.getElementById(elementId);
        element.textContent = message;
        element.style.display = "block";
      }

      function hideError(elementId) {
        const element = document.getElementById(elementId);
        element.style.display = "none";
      }

      function validateForm() {
        let isValid = true;

        // Sprawdź hasła
        const password = document.getElementById("password").value;
        const passwordConfirm =
          document.getElementById("password-confirm").value;

        if (password !== passwordConfirm) {
          showError("password-confirm-error", "Hasła nie są identyczne");
          isValid = false;
        } else {
          hideError("password-confirm-error");
        }

        // Sprawdź nazwę strzelca
        const displayName = document
          .getElementById("display-name")
          .value.trim();

        if (displayName.length < 3 || displayName.length > 12) {
          showError(
            "display-name-error",
            "Nazwa użytkownika musi mieć 3-12 znaków",
          );
          isValid = false;
        } else if (!/^[a-zA-Z0-9\-_.]+$/.test(displayName)) {
          showError(
            "display-name-error",
            "Nazwa użytkownika może zawierać tylko litery, cyfry oraz znaki: -, _, .",
          );
          isValid = false;
        } else if (containsForbiddenWord(displayName)) {
          showError("display-name-error", "Ta nazwa jest zarezerwowana");
          isValid = false;
        } else {
          hideError("display-name-error");
        }

        // Sprawdź email
        const email = document.getElementById("email").value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          showError("email-error", "Nieprawidłowy format adresu email");
          isValid = false;
        } else {
          hideError("email-error");
        }

        // Sprawdź siłę hasła
        if (password.length < 8) {
          showError("password-error", "Hasło musi mieć co najmniej 8 znaków");
          isValid = false;
        } else {
          hideError("password-error");
        }

        // Sprawdź zgody
        if (!document.getElementById("age-confirm").checked) {
          showError(
            "age-confirm",
            "Musisz potwierdzić, że masz ukończone 18 lat",
          );
          isValid = false;
        } else {
          hideError("age-confirm");
        }

        if (!document.getElementById("terms-privacy-accept").checked) {
          showError(
            "terms-privacy-accept",
            "Musisz zaakceptować regulamin i politykę prywatności",
          );
          isValid = false;
        } else {
          hideError("terms-privacy-accept");
        }

        return isValid;
      }

      // Obsługa formularza rejestracji
      document
        .getElementById("registration-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          console.log("Formularz wysyłany - sprawdzanie checkboxów:");
          console.log("age-confirm:", document.getElementById("age-confirm")?.checked, document.getElementById("age-confirm")?.style.display);
          console.log("terms-privacy-accept:", document.getElementById("terms-privacy-accept")?.checked, document.getElementById("terms-privacy-accept")?.style.display);
          console.log("newsletter:", document.getElementById("newsletter")?.checked, document.getElementById("newsletter")?.style.display);

          if (!validateForm()) {
            console.log("Walidacja formularza nie przeszła");

            // Sprawdź ponownie widoczność checkboxów po walidacji
            setTimeout(() => {
              console.log("Po walidacji - checkboxy:");
              console.log("age-confirm visible:", document.getElementById("age-confirm")?.offsetParent !== null);
              console.log("terms-privacy-accept visible:", document.getElementById("terms-privacy-accept")?.offsetParent !== null);
              console.log("newsletter visible:", document.getElementById("newsletter")?.offsetParent !== null);
            }, 100);

            return;
          }

          const registerBtn = document.getElementById("register-btn");
          registerBtn.disabled = true;
          registerBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Tworzenie konta...';

          // Ustaw flagę rejestracji
          isRegistering = true;

          try {
            const formData = {
              gender: document.querySelector('input[name="gender"]:checked')
                .value,
              displayName: document.getElementById("display-name").value.trim(),
              firstName: document.getElementById("first-name").value.trim(),
              lastName: document.getElementById("last-name").value.trim(),
              email: document
                .getElementById("email")
                .value.trim()
                .toLowerCase(),
              phone: document.getElementById("phone").value.trim(),
              parcelLocker: document
                .getElementById("parcel-locker")
                .value.trim(),
              address: {
                street: document.getElementById("street").value.trim(),
                buildingNumber: document
                  .getElementById("building-number")
                  .value.trim(),
                postalCode: document.getElementById("postal-code").value.trim(),
                city: document.getElementById("city").value.trim(),
              },
              ageConfirmed: document.getElementById("age-confirm").checked,
              termsAccepted: document.getElementById("terms-privacy-accept")
                .checked,
              privacyAccepted: document.getElementById("terms-privacy-accept")
                .checked,
              newsletter: document.getElementById("newsletter").checked,
              createdAt: new Date(),
              emailVerified: false,
              role: "user",
            };

            // 0. Sprawdź dostępność nazwy użytkownika przed utworzeniem konta
            const nameAvailability = await checkDisplayNameAvailability(
              formData.displayName,
            );
            if (!nameAvailability.available) {
              showError("display-name-error", nameAvailability.reason);
              registerBtn.disabled = false;
              registerBtn.innerHTML =
                '<i class="fa-solid fa-user-plus mr-2"></i>Utwórz STRZELCA';
              return;
            }

            // 1. Utwórz konto w Firebase Auth
            const userCredential = await createUserWithEmailAndPassword(
              auth,
              formData.email,
              document.getElementById("password").value,
            );
            const user = userCredential.user;

            // 2. Wyślij email weryfikacyjny
            await sendEmailVerification(user);

            // 3. Przygotuj dane do zapisania (z szyfrowaniem wrażliwych danych)
            const profileData = {
              uid: user.uid,
              displayName: formData.displayName,
              gender: formData.gender,
              firstName: formData.firstName,
              lastName: formData.lastName,
              email: formData.email, // Email nie szyfrujemy dla funkcjonalności
              phone: btoa(formData.phone), // Szyfrowanie base64 dla telefonu
              parcelLocker: formData.parcelLocker
                ? btoa(formData.parcelLocker)
                : "",
              address: {
                street: formData.address.street
                  ? btoa(formData.address.street)
                  : "",
                buildingNumber: formData.address.buildingNumber
                  ? btoa(formData.address.buildingNumber)
                  : "",
                postalCode: formData.address.postalCode
                  ? btoa(formData.address.postalCode)
                  : "",
                city: formData.address.city ? btoa(formData.address.city) : "",
              },
              ageConfirmed: formData.ageConfirmed,
              termsAccepted: formData.termsAccepted,
              privacyAccepted: formData.privacyAccepted,
              newsletter: formData.newsletter,
              createdAt: formData.createdAt,
              emailVerified: false,
              role: "user", // Domyślnie rola user - admin musi zmienić ręcznie w Firebase Console
              status: "active", // active, blocked, suspended
            };

            // Zapisz nazwę użytkownika w kolekcji displayNames (dla sprawdzania dostępności)
            // Najpierw zapisujemy nazwę, żeby uniknąć wyścigu - jeśli się nie powiedzie, konto jeszcze nie zostało utworzone
            let displayNameSaved = false;
            try {
              await setDoc(doc(db, "displayNames", formData.displayName.toLowerCase()), {
                displayName: formData.displayName, // Oryginalna nazwa (zachowuje wielkość liter)
                userId: user.uid,
                createdAt: new Date(),
              });
              displayNameSaved = true;
              console.log(`Nazwa "${formData.displayName}" została zarejestrowana w displayNames`);
            } catch (displayNameError) {
              console.error("Błąd zapisu do displayNames:", displayNameError);

              // Jeśli zapis do displayNames się nie powiedzie, usuń konto Firebase Auth
              try {
                await user.delete();
                console.log("Konto Firebase Auth zostało usunięte z powodu błędu displayNames");
              } catch (deleteError) {
                console.error("Błąd podczas usuwania konta Firebase Auth:", deleteError);
              }

              throw new Error("Nie udało się zarejestrować nazwy użytkownika. Spróbuj ponownie.");
            }

            // Zapisz dane profilu w Firestore
            try {
              await setDoc(doc(db, "userProfiles", user.uid), profileData);
            } catch (profileError) {
              console.error("Błąd zapisu profilu:", profileError);

              // Jeśli zapis profilu się nie powiedzie, wyczyść wszystko
              try {
                // Usuń nazwę z displayNames
                if (displayNameSaved) {
                  await deleteDoc(doc(db, "displayNames", formData.displayName.toLowerCase()));
                  console.log("Nazwa została usunięta z displayNames z powodu błędu profilu");
                }

                // Usuń konto Firebase Auth
                await user.delete();
                console.log("Konto Firebase Auth zostało usunięte z powodu błędu profilu");

              } catch (cleanupError) {
                console.error("Błąd podczas czyszczenia po nieudanym zapisie profilu:", cleanupError);
              }

              throw new Error("Nie udało się utworzyć profilu użytkownika. Spróbuj ponownie.");
            }

            // 4. Jeśli użytkownik zgodził się na newsletter, dodaj do mailing list
            if (formData.newsletter) {
              try {
                await setDoc(doc(db, "mailingList", formData.email), {
                  email: formData.email,
                  subscribedAt: new Date(),
                  active: true,
                  source: "registration",
                });
                console.log(`Email "${formData.email}" dodany do mailingList`);
              } catch (mailingListError) {
                console.warn("Błąd zapisu do mailing list (ignorowany - nie krytyczny):", mailingListError);
                // Nie przerywamy rejestracji z powodu błędu mailing list
                // To nie jest krytyczna operacja - użytkownik może dodać się później
              }
            }

            // Wyloguj użytkownika, żeby mógł przejść przez proces logowania
            // (kontrola weryfikacji emaila jest w login.html)
            try {
              const { signOut } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
              await signOut(auth);
              console.log("Użytkownik został wylogowany po rejestracji");
            } catch (signOutError) {
              console.warn("Błąd wylogowania po rejestracji:", signOutError);
            }

            // Przekieruj do strony po rejestracji
            isRegistering = false; // Reset flagi przed przekierowaniem

            // Dodaj obsługę błędów CORS (ignoruj błędy Firebase internal)
            window.addEventListener('error', function(e) {
              // Ignoruj błędy CORS związane z Firebase/Firestore
              if (e.message && (
                e.message.includes('access control checks') ||
                e.message.includes('CORS') ||
                e.message.includes('firestore.googleapis.com')
              )) {
                console.warn('Ignored Firebase CORS error:', e.message);
                e.preventDefault();
                return false;
              }
            });

            // Dodaj obsługę błędów dla fetch API
            window.addEventListener('unhandledrejection', function(e) {
              if (e.reason && e.reason.message && (
                e.reason.message.includes('access control checks') ||
                e.reason.message.includes('CORS') ||
                e.reason.message.includes('firestore.googleapis.com')
              )) {
                console.warn('Ignored Firebase CORS promise rejection:', e.reason.message);
                e.preventDefault();
                return false;
              }
            });

            window.location.href = "./po.rejestracji.html";
          } catch (error) {
            console.error("Registration error:", error);

            // Reset flagi rejestracji
            isRegistering = false;

            // Jeśli użytkownik został utworzony, ale wystąpił błąd przy zapisie danych,
            // wyczyść wszystkie utworzone dane
            const { signOut } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
            const currentUser = auth.currentUser;

            if (currentUser) {
              try {
                // Sprawdź czy poszczególne dane zostały utworzone i wyczyść je
                const cleanupPromises = [];

                // Sprawdź czy profil istnieje
                try {
                  const profileDoc = await getDoc(doc(db, "userProfiles", currentUser.uid));
                  if (profileDoc.exists()) {
                    cleanupPromises.push(deleteDoc(doc(db, "userProfiles", currentUser.uid)));
                  }
                } catch (e) {
                  console.warn("Nie udało się sprawdzić profilu podczas czyszczenia:", e);
                }

                // Sprawdź czy nazwa została zapisana w displayNames
                try {
                  const displayNameDoc = await getDoc(doc(db, "displayNames", formData.displayName.toLowerCase()));
                  if (displayNameDoc.exists()) {
                    cleanupPromises.push(deleteDoc(doc(db, "displayNames", formData.displayName.toLowerCase())));
                  }
                } catch (e) {
                  console.warn("Nie udało się sprawdzić displayNames podczas czyszczenia:", e);
                }

                // Sprawdź czy zapis do mailing list się udał
                if (formData.newsletter) {
                  try {
                    const mailingDoc = await getDoc(doc(db, "mailingList", formData.email));
                    if (mailingDoc.exists()) {
                      cleanupPromises.push(deleteDoc(doc(db, "mailingList", formData.email)));
                    }
                  } catch (e) {
                    console.warn("Nie udało się sprawdzić mailing list podczas czyszczenia:", e);
                  }
                }

                // Wykonaj wszystkie operacje czyszczenia
                if (cleanupPromises.length > 0) {
                  await Promise.all(cleanupPromises);
                  console.log("Dane użytkownika zostały wyczyszczone po nieudanej rejestracji");
                }

                // Wyloguj użytkownika
                await signOut(auth);

              } catch (cleanupError) {
                console.error("Błąd podczas czyszczenia po nieudanej rejestracji:", cleanupError);
                // Spróbuj przynajmniej wylogować
                try {
                  await signOut(auth);
                } catch (signOutError) {
                  console.error("Błąd wylogowania:", signOutError);
                }
              }
            }

            let errorMessage = "Wystąpił błąd podczas rejestracji.";

            if (error.code === "auth/email-already-in-use") {
              errorMessage = "Konto z tym adresem email już istnieje. Jeśli nie pamiętasz hasła, użyj opcji 'Przypomnij hasło'.";
            } else if (error.code === "auth/weak-password") {
              errorMessage = "Hasło jest zbyt słabe. Użyj co najmniej 8 znaków.";
            } else if (error.code === "auth/invalid-email") {
              errorMessage = "Nieprawidłowy adres email.";
            } else if (error.code === "auth/network-request-failed") {
              errorMessage = "Błąd połączenia z serwerem. Sprawdź połączenie internetowe i spróbuj ponownie.";
            } else if (error.message) {
              errorMessage = `Błąd: ${error.message}`;
            }

            alert(errorMessage);
          } finally {
            registerBtn.disabled = false;
            registerBtn.innerHTML =
              '<i class="fa-solid fa-user-plus mr-2"></i>Utwórz STRZELCA';
          }
        });

      // Walidacja w czasie rzeczywistym
      document
        .getElementById("password-confirm")
        .addEventListener("input", () => {
          const password = document.getElementById("password").value;
          const passwordConfirm =
            document.getElementById("password-confirm").value;

          if (passwordConfirm && password !== passwordConfirm) {
            showError("password-confirm-error", "Hasła nie są identyczne");
          } else {
            hideError("password-confirm-error");
          }
        });

      // Walidacja live nazwy strzelca
      let displayNameTimeout;
      document
        .getElementById("display-name")
        .addEventListener("input", async (e) => {
          const displayName = e.target.value.trim();
          clearTimeout(displayNameTimeout);

          // Najpierw sprawdź podstawowe wymagania
          if (displayName.length < 3) {
            hideError("display-name-error");
            return;
          }

          if (displayName.length > 12) {
            e.target
              .closest(".strzelec-input-container")
              .classList.add("validation-error");
            showError(
              "display-name-error",
              "Nazwa użytkownika nie może mieć więcej niż 12 znaków",
            );
            return;
          }

          if (!/^[a-zA-Z0-9\-_.]+$/.test(displayName)) {
            e.target
              .closest(".strzelec-input-container")
              .classList.add("validation-error");
            showError(
              "display-name-error",
              "Nazwa użytkownika może zawierać tylko litery, cyfry oraz znaki: -, _, .",
            );
            return;
          }

          // Sprawdź czy nazwa nie jest zabroniona (lokalne sprawdzenie bez Firebase)
          if (containsForbiddenWord(displayName)) {
            e.target
              .closest(".strzelec-input-container")
              .classList.add("validation-error");
            showError("display-name-error", "Ta nazwa jest zarezerwowana");
            return;
          }

          // Dopiero potem sprawdź dostępność w bazie danych
          displayNameTimeout = setTimeout(async () => {
            try {
              const result = await checkDisplayNameAvailability(displayName);
              const container = document.querySelector(
                ".strzelec-input-container",
              );
              if (!result.available) {
                container.classList.add("validation-error");
                container.classList.remove("validation-success");
                showError("display-name-error", result.reason);
              } else {
                container.classList.add("validation-success");
                container.classList.remove("validation-error");
                hideError("display-name-error");
              }
            } catch (error) {
              console.error(
                "Błąd podczas sprawdzania dostępności nazwy:",
                error,
              );
              const container = document.querySelector(
                ".strzelec-input-container",
              );
              container.classList.add("validation-error");
              container.classList.remove("validation-success");
              showError(
                "display-name-error",
                "Błąd sprawdzania dostępności nazwy",
              );
            }
          }, 800); // Zwiększone opóźnienie żeby uniknąć zbyt częstych zapytań
        });

      // Obsługa głównego checkboxa zgód
      const allConsentsCheckbox = document.getElementById("all-consents");
      if (allConsentsCheckbox) {
        allConsentsCheckbox.addEventListener("change", (e) => {
          const isChecked = e.target.checked;
          const ageConfirm = document.getElementById("age-confirm");
          const termsAccept = document.getElementById("terms-privacy-accept");
          const newsletter = document.getElementById("newsletter");

          if (ageConfirm) ageConfirm.checked = isChecked;
          if (termsAccept) termsAccept.checked = isChecked;
          if (newsletter) newsletter.checked = isChecked;

          console.log("All consents changed:", isChecked);
        });
      }

      // Aktualizacja głównego checkboxa gdy zmienia się którykolwiek z podrzędnych
      ["age-confirm", "terms-privacy-accept", "newsletter"].forEach((id) => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.addEventListener("change", () => {
            const allChecked = [
              "age-confirm",
              "terms-privacy-accept",
              "newsletter",
            ].every((checkboxId) => {
              const cb = document.getElementById(checkboxId);
              return cb && cb.checked;
            });
            const allConsents = document.getElementById("all-consents");
            if (allConsents) {
              allConsents.checked = allChecked;
            }
            console.log(`Checkbox ${id} changed, all checked:`, allChecked);
          });
        }
      });

      // Obsługa tooltipów
      function initTooltips() {
        const tooltipTriggers = document.querySelectorAll(".tooltip-trigger");

        tooltipTriggers.forEach((trigger) => {
          const tooltip = trigger.nextElementSibling;

          // Pokaż tooltip przy kliknięciu
          trigger.addEventListener("focus", () => {
            tooltip.classList.add("show");
          });

          // Ukryj tooltip przy utracie focus
          trigger.addEventListener("blur", () => {
            tooltip.classList.remove("show");
          });

          // Pokaż tooltip przy kliknięciu (dla pól bez focus)
          trigger.addEventListener("click", (e) => {
            if (!tooltip.classList.contains("show")) {
              tooltip.classList.add("show");
              e.stopPropagation();
            }
          });
        });

        // Ukryj wszystkie tooltips przy kliknięciu gdziekolwiek indziej
        document.addEventListener("click", (e) => {
          if (!e.target.classList.contains("tooltip-trigger")) {
            document.querySelectorAll(".tooltip.show").forEach((tooltip) => {
              tooltip.classList.remove("show");
            });
          }
        });
      }

      // Walidacja pól formularza
      function validateField(fieldId, validator) {
        const field = document.getElementById(fieldId);
        if (!field) return;

        // Znajdź kontener lub użyj samego pola
        const container =
          field.closest(".strzelec-input-container") ||
          field.parentElement ||
          field;
        const errorElement = document.getElementById(fieldId + "-error");

        field.addEventListener("input", () => {
          const value = field.value.trim();
          const result = validator(value);

          // Usuń klasy walidacji
          container.classList.remove("validation-success", "validation-error");
          field.classList.remove("validation-success", "validation-error");

          if (result.isValid) {
            container.classList.add("validation-success");
            field.classList.add("validation-success");
            if (errorElement) hideError(fieldId + "-error");
          } else if (value.length > 0) {
            container.classList.add("validation-error");
            field.classList.add("validation-error");
            if (errorElement && result.message)
              showError(fieldId + "-error", result.message);
          } else {
            if (errorElement) hideError(fieldId + "-error");
          }
        });

        field.addEventListener("blur", () => {
          const value = field.value.trim();
          if (value.length === 0 && field.hasAttribute("required")) {
            container.classList.add("validation-error");
            field.classList.add("validation-error");
            if (errorElement)
              showError(fieldId + "-error", "To pole jest wymagane");
          }
        });
      }

      // Walidatory dla poszczególnych pól
      const validators = {
        "first-name": (value) => ({
          isValid:
            value === "" ||
            (value.length >= 1 &&
              value.length <= 25 &&
              /^[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*(?:\s+[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*(?:\s*-\s*[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*$/.test(
                value,
              )),
          message:
            value !== "" &&
            !/^[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*(?:\s+[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*(?:\s*-\s*[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*$/.test(
              value,
            )
              ? "Imię musi mieć 1-25 znaków i pasować do wzoru: Xxxx, Xx Xx, Xx-Xx, Xx - Xx"
              : "",
        }),
        "last-name": (value) => ({
          isValid:
            value === "" ||
            (value.length >= 1 &&
              value.length <= 25 &&
              /^[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*(?:\s+[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*(?:\s*-\s*[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*$/.test(
                value,
              )),
          message:
            value !== "" &&
            !/^[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*(?:\s+[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*(?:\s*-\s*[A-ZĄĆĘŁŃÓŚŹŻ][a-ząćęłńóśźż]*)*$/.test(
              value,
            )
              ? "Nazwisko musi mieć 1-25 znaków i pasować do wzoru: Xxxx, Xx Xx, Xx-Xx, Xx - Xx"
              : "",
        }),
        email: (value) => ({
          isValid: /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value),
          message: "Nieprawidłowy format adresu email",
        }),
        password: (value) => ({
          isValid:
            value.length >= 8 && /[A-Z]/.test(value) && /[a-z]/.test(value),
          message:
            "Hasło musi mieć co najmniej 8 znaków, zawierać dużą i małą literę",
        }),
        "password-confirm": (value) => {
          const password = document.getElementById("password").value;
          return {
            isValid: value === password,
            message: value !== password ? "Hasła nie są identyczne" : "",
          };
        },
        phone: (value) => ({
          isValid:
            value === "" || /^\+?\d{9,20}$/.test(value.replace(/\s/g, "")),
          message:
            value !== "" && !/^\+?\d{9,20}$/.test(value.replace(/\s/g, ""))
              ? "Numer telefonu musi mieć 9-20 cyfr (możliwy + na początku)"
              : "",
        }),
        street: (value) => ({
          isValid: value === "" || (value.length > 0 && value.length <= 25),
          message:
            value.length > 25 ? "Ulica nie może mieć więcej niż 25 znaków" : "",
        }),
        "building-number": (value) => ({
          isValid: value === "" || (value.length > 0 && value.length <= 10),
          message:
            value.length > 10
              ? "Numer budynku/lokalu nie może mieć więcej niż 10 znaków"
              : "",
        }),
        city: (value) => ({
          isValid:
            value === "" ||
            (value.length >= 2 &&
              value.length <= 50 &&
              /^[A-Z][a-zA-Z\s\-]*$/.test(value)),
          message:
            value !== "" && !/^[A-Z][a-zA-Z\s\-]*$/.test(value)
              ? "Miasto musi zaczynać się z dużej litery i zawierać tylko litery, spacje i -"
              : value.length < 2
                ? "Miasto musi mieć co najmniej 2 znaki"
                : value.length > 50
                  ? "Miasto nie może mieć więcej niż 50 znaków"
                  : "",
        }),
        "postal-code": (value) => ({
          isValid: value === "" || /^\d{2}-\d{3}$/.test(value),
          message:
            value !== "" && !/^\d{2}-\d{3}$/.test(value)
              ? "Kod pocztowy musi mieć format XX-XXX (np. 12-345)"
              : "",
        }),
      };

      // Obsługa wyboru płci
      document.querySelectorAll(".gender-option").forEach((option) => {
        option.addEventListener("click", function () {
          const targetId = this.getAttribute("for");
          const maleLabel = document.querySelector('label[for="gender-male"]');
          const femaleLabel = document.querySelector(
            'label[for="gender-female"]',
          );
          const maleRadio = document.getElementById("gender-male");
          const femaleRadio = document.getElementById("gender-female");

          if (targetId === "gender-male") {
            maleLabel.classList.add("active");
            femaleLabel.classList.remove("active");
            maleRadio.checked = true;
            femaleRadio.checked = false;
          } else if (targetId === "gender-female") {
            femaleLabel.classList.add("active");
            maleLabel.classList.remove("active");
            femaleRadio.checked = true;
            maleRadio.checked = false;
          }
        });
      });

      // Dodatkowa obsługa bezpośrednich kliknięć na radio buttons
      document
        .getElementById("gender-male")
        .addEventListener("change", function () {
          if (this.checked) {
            document
              .querySelector('label[for="gender-male"]')
              .classList.add("active");
            document
              .querySelector('label[for="gender-female"]')
              .classList.remove("active");
          }
        });

      document
        .getElementById("gender-female")
        .addEventListener("change", function () {
          if (this.checked) {
            document
              .querySelector('label[for="gender-female"]')
              .classList.add("active");
            document
              .querySelector('label[for="gender-male"]')
              .classList.remove("active");
          }
        });

      // Autowstawianie myślnika w kodzie pocztowym
      document
        .getElementById("postal-code")
        .addEventListener("input", function (e) {
          let value = e.target.value.replace(/\D/g, ""); // Usuń wszystkie nie-cyfry
          if (value.length >= 2) {
            value = value.substring(0, 2) + "-" + value.substring(2, 5);
          }
          e.target.value = value;
        });

      // Automatyczna kapitalizacja pierwszej litery w imieniu i nazwisku
      function capitalizeFirstLetter(input) {
        input.addEventListener("input", function (e) {
          let value = e.target.value;
          let result = "";

          // Przetwarzaj każdy znak
          for (let i = 0; i < value.length; i++) {
            if (
              i === 0 ||
              value[i - 1] === " " ||
              (value[i - 1] === "-" && value[i - 2] === " ")
            ) {
              result += value[i].toUpperCase();
            } else {
              result += value[i];
            }
          }

          e.target.value = result;
        });
      }

      capitalizeFirstLetter(document.getElementById("first-name"));
      capitalizeFirstLetter(document.getElementById("last-name"));
      capitalizeFirstLetter(document.getElementById("city"));

      // Blokowanie liter w polu telefonu
      document.getElementById("phone").addEventListener("input", function (e) {
        let value = e.target.value;
        // Usuń wszystkie znaki oprócz cyfr, spacji i +
        e.target.value = value.replace(/[^0-9\s\+]/g, "");
      });

      // Inicjalizuj walidację dla wszystkich pól
      Object.keys(validators).forEach((fieldId) => {
        validateField(fieldId, validators[fieldId]);
      });

      // Inicjalizuj tooltips po załadowaniu strony
      initTooltips();
    </script>
    </div>
  </body>
</html>
