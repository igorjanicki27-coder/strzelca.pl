rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =============================================================================
    // HELPER FUNCTIONS
    // =============================================================================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isAdmin() {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/userProfiles/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/userProfiles/$(request.auth.uid)).data.role == 'admin';
    }

    function isSuperAdmin() {
      return isAuthenticated() && request.auth.uid == 'nCMUz2fc8MM9WhhMVBLZ1pdR7O43';
    }

    function isAdminOrSuperAdmin() {
      return isAdmin() || isSuperAdmin();
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // =============================================================================
    // USER PROFILES
    // =============================================================================
    match /userProfiles/{userId} {
      // Prywatne dane profilu - tylko właściciel lub admin/superadmin
      allow read: if isOwner(userId) || isAdminOrSuperAdmin();

      // Tworzenie profilu - tylko dla właściciela podczas rejestracji
      allow create: if isOwner(userId) || isAdminOrSuperAdmin();

      // Aktualizacja - tylko właściciel (nie może zmienić własnej roli)
      allow update: if (isOwner(userId) &&
        (!('role' in request.resource.data) || request.resource.data.role == resource.data.role))
        || isAdminOrSuperAdmin();

      // Usuwanie profilu - tylko admin/superadmin (usuwanie konta robimy przez backend)
      allow delete: if isAdminOrSuperAdmin();
    }

    // =============================================================================
    // PUBLIC PROFILES (publiczne: nick + avatar)
    // =============================================================================
    match /publicProfiles/{userId} {
      // Publiczne dane: każdy może odczytać (np. podgląd profilu)
      allow read: if true;

      // Tworzy/aktualizuje tylko właściciel lub admin (kontrola pól)
      allow create, update: if (isOwner(userId) || isAdminOrSuperAdmin()) &&
        request.resource.data.keys().hasOnly(['displayName', 'avatar', 'updatedAt']) &&
        request.resource.data.displayName is string &&
        request.resource.data.displayName.size() >= 2 &&
        request.resource.data.displayName.size() <= 32 &&
        (!('avatar' in request.resource.data) || request.resource.data.avatar is string);

      // Usuwanie: owner lub admin (np. sprzątanie konta)
      allow delete: if isOwner(userId) || isAdminOrSuperAdmin();
    }

    // =============================================================================
    // DISPLAY NAMES (sprawdzanie unikalności przy rejestracji)
    // =============================================================================
    match /displayNames/{displayName} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow delete: if isAdminOrSuperAdmin();
      allow update: if false;
    }

    // =============================================================================
    // MESSAGES & CONVERSATIONS
    // =============================================================================
    match /messages/{messageId} {
      allow read: if isAdminOrSuperAdmin() || (isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid ||
        resource.data.recipientId == 'admin'
      ));

      allow create: if isAuthenticated() &&
        request.resource.data.senderId == request.auth.uid;

      // Użytkownik nie może zmieniać statusu/recipientId — to robi admin/backoffice
      allow update: if isAuthenticated() &&
        resource.data.senderId == request.auth.uid &&
        request.resource.data.senderId == resource.data.senderId &&
        request.resource.data.recipientId == resource.data.recipientId &&
        request.resource.data.status == resource.data.status;

      allow update, delete: if isAdminOrSuperAdmin();
    }

    match /conversations/{conversationId} {
      allow read: if isAdminOrSuperAdmin() || (isAuthenticated() && (
        conversationId == request.auth.uid ||
        resource.data.userId == request.auth.uid
      ));

      // Tworzenie (best-effort) — zwykle przez system, ale zostawiamy dla zalogowanych
      allow create: if isAuthenticated();

      allow update, delete: if isAdminOrSuperAdmin();
    }

    match /privateMessages/{messageId} {
      allow read: if isAdminOrSuperAdmin() || (isAuthenticated() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.recipientId == request.auth.uid
      ));

      allow create: if isAuthenticated() &&
        request.resource.data.senderId == request.auth.uid;

      // Update: pozwalamy tylko na oznaczenie wiadomości jako przeczytanej (`isRead=true`)
      // przez nadawcę lub odbiorcę, bez możliwości edycji treści / uczestników.
      allow update: if isAuthenticated() &&
        (resource.data.senderId == request.auth.uid || resource.data.recipientId == request.auth.uid) &&
        request.resource.data.senderId == resource.data.senderId &&
        request.resource.data.recipientId == resource.data.recipientId &&
        request.resource.data.content == resource.data.content &&
        request.resource.data.conversationId == resource.data.conversationId &&
        request.resource.data.timestamp == resource.data.timestamp &&
        request.resource.data.isRead == true;

      allow delete: if isAdminOrSuperAdmin();
    }

    match /privateConversations/{conversationId} {
      allow read: if isAdminOrSuperAdmin() || (isAuthenticated() && (
        request.auth.uid in resource.data.participants
      ));

      // Tworzenie/aktualizacja: tylko uczestnicy (minimalnie)
      allow create: if isAuthenticated() &&
        request.resource.data.participants is list &&
        request.resource.data.participants.size() == 2 &&
        request.auth.uid in request.resource.data.participants;

      // Aktualizacja: tylko uczestnicy i bez zmiany participants
      allow update: if isAuthenticated() &&
        request.auth.uid in resource.data.participants &&
        request.resource.data.participants == resource.data.participants;

      allow delete: if isAdminOrSuperAdmin();
    }

    // =============================================================================
    // MAILING LIST & CONTACT FORMS
    // =============================================================================
    match /mailingList/{email} {
      // DocID = email. Pozwalamy zapisać się (także gościom), ale tylko dla zgodnego docId/email.
      allow create: if request.resource.data.email == email;

      // Zalogowany użytkownik może zarządzać swoim mailem
      allow update, delete: if isAuthenticated() &&
        request.auth.token.email != null &&
        request.auth.token.email == email;

      // Pełny wgląd dla admina
      allow read, create, update, delete: if isAdminOrSuperAdmin();
    }

    match /contactForms/{formId} {
      allow create: if true;
      allow read, update, delete: if isAdminOrSuperAdmin();
    }

    // =============================================================================
    // CONTENT: PRODUCTS, TRAININGS, EVENTS, CHARITY
    // =============================================================================
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    match /trainings/{trainingId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    match /events/{eventId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    match /charity/{charityId} {
      allow read: if true;
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    match /trainingAccess/{accessId} {
      allow read: if isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        isAdminOrSuperAdmin()
      );
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // =============================================================================
    // USER REVIEWS
    // =============================================================================
    match /userReviews/{reviewId} {
      allow read: if true;

      // Model danych używany w profilu:
      // { raterId, ratedId, rating, comment, timestamp, ... }
      allow create: if isAuthenticated() &&
        request.resource.data.keys().hasAll(['raterId', 'ratedId', 'rating', 'comment']) &&
        request.resource.data.raterId == request.auth.uid &&
        request.resource.data.ratedId != request.auth.uid &&
        request.resource.data.rating is int &&
        request.resource.data.rating >= 1 && request.resource.data.rating <= 5;

      // Edycja/usuwanie opinii tylko przez admina (żeby nie było nadużyć)
      allow update, delete: if isAdminOrSuperAdmin();
    }

    // =============================================================================
    // LOGS & SYSTEM
    // =============================================================================
    match /activityLogs/{logId} {
      allow read: if isAdminOrSuperAdmin() || (isAuthenticated() && (
        resource.data.userId == request.auth.uid ||
        resource.data.adminId == request.auth.uid
      ));

      // Zabezpieczamy przed wpisami "w cudzym imieniu"
      allow create: if isAuthenticated() &&
        (!('userId' in request.resource.data) || request.resource.data.userId == request.auth.uid);

      allow update, delete: if isAdminOrSuperAdmin();
    }

    match /user_events/{eventId} {
      allow read: if isAdminOrSuperAdmin() || (isAuthenticated() &&
        resource.data.userId == request.auth.uid);

      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;

      allow update, delete: if isAdminOrSuperAdmin();
    }

    match /system_events/{eventId} {
      allow read, create, update, delete: if isAdminOrSuperAdmin();
    }

    match /messageCategories/{categoryId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    match /quickReplies/{replyId} {
      allow read, create, update, delete: if isAdminOrSuperAdmin();
    }

    match /quick_replies/{replyId} {
      allow read, create, update, delete: if isAdminOrSuperAdmin();
    }

    match /pendingTasks/{taskId} {
      allow read, create, update, delete: if isAdminOrSuperAdmin();
    }

    // =============================================================================
    // DEFAULT DENY
    // =============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
