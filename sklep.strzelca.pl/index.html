<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sklep strzelecki strzelca.pl - profesjonalna broń, amunicja i akcesoria strzeleckie. Arsenał z gwarancją jakości i bezpieczeństwa.">
    <meta name="keywords" content="sklep strzelecki, broń, amunicja, akcesoria strzeleckie, wyposażenie strzeleckie, strzelca.pl">
    <meta name="author" content="Strzelca.pl">
    <meta name="robots" content="index, follow">

    <!-- Open Graph dla Facebook -->
    <meta property="og:title" content="sklep.strzelca.pl | Arsenał">
    <meta property="og:description" content="Profesjonalny sklep strzelecki - broń, amunicja, akcesoria. Zakupy online z dostawą.">
    <meta property="og:image" content="https://strzelca.pl/tlo:logo/logo.czarne.png">
    <meta property="og:url" content="https://sklep.strzelca.pl">
    <meta property="og:type" content="website">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="https://strzelca.pl/ikona.svg">
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg">

    <title>sklep.strzelca.pl | Arsenał</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root { --coyote: #C19A6B; }
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; margin: 0; }
        
        .hero-bg {
            height: 65vh;
            background: linear-gradient(rgba(10,10,10,0.1) 0%, rgba(10,10,10,0.4) 50%, #0a0a0a 100%), url('https://strzelca.pl/tlo.png');
            background-size: cover;
            background-position: top center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .coyote-text { color: var(--coyote); font-family: 'Orbitron'; }
        .card-dark { background: #111; border: 1px solid #1f1f1f; border-radius: 12px; overflow: hidden; }
        
        .product-img-container img { width: 100%; height: 100%; object-fit: contain; background: #080808; }

        .custom-render ul { list-style-type: disc !important; padding-left: 20px !important; margin: 10px 0 !important; }
        .custom-render li { margin-bottom: 5px !important; display: list-item !important; }
        .custom-render b, .custom-render strong { font-weight: bold !important; color: var(--coyote) !important; }
        .custom-render div[style*="text-align: center"] { text-align: center !important; }
        .custom-render div[style*="text-align: right"] { text-align: right !important; }

        .details-scroll-area { max-height: 55vh; overflow-y: auto; padding-right: 20px; scrollbar-gutter: stable; }
        .details-scroll-area::-webkit-scrollbar { width: 6px; }
        .details-scroll-area::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        .details-scroll-area::-webkit-scrollbar-thumb:hover { background: var(--coyote); }
    </style>
</head>
<body>
    <!-- Panel użytkownika -->
    <div id="user-panel" class="fixed top-4 right-4 z-50 hidden">
        <div class="relative">
            <!-- Avatar - widoczny zawsze -->
            <button
                id="user-avatar-button"
                class="w-12 h-12 rounded-full bg-coyote flex items-center justify-center text-white font-bold cursor-pointer hover:opacity-80 transition shadow-lg overflow-hidden"
                onclick="toggleUserMenu()"
            >
                <div id="user-avatar" class="w-full h-full flex items-center justify-center">
                    <i class="fa-solid fa-user"></i>
                </div>
            </button>
            
            <!-- Menu rozwijane -->
            <div
                id="user-menu"
                class="absolute top-14 right-0 bg-zinc-900/95 backdrop-blur-md border border-zinc-700 rounded-2xl p-4 shadow-2xl min-w-[200px] hidden"
            >
                <div class="space-y-2">
                    <div
                        id="user-display-name"
                        class="text-white font-semibold text-sm mb-3 pb-3 border-b border-zinc-700"
                    ></div>
                    <a
                        id="profile-link"
                        href="https://konto.strzelca.pl/profil.html"
                        class="block text-zinc-300 hover:text-coyote transition text-sm"
                    >
                        <i class="fa-solid fa-user mr-2"></i>Mój profil
                    </a>
                    <button onclick="logout()" class="block w-full text-left text-zinc-300 hover:text-red-400 transition text-sm">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i>Wyloguj się
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Przycisk logowania dla niezalogowanych -->
    <div id="login-button" class="fixed top-4 right-4 z-50">
        <a href="https://konto.strzelca.pl/login.html" class="bg-coyote text-black px-4 py-2 rounded-lg font-semibold hover:bg-white transition shadow-lg">
            <i class="fa-solid fa-sign-in-alt mr-2"></i>Zaloguj się
        </a>
    </div>

    <nav class="h-[73px] border-b border-zinc-900 sticky top-0 bg-black/95 z-50 backdrop-blur-md flex items-center relative" role="navigation" aria-label="Nawigacja główna">
        <a href="https://strzelca.pl" aria-label="Powrót do centrum dowodzenia" class="absolute left-4 md:left-8 text-zinc-500 hover:text-white transition text-xl z-[60]">
            <i class="fa-solid fa-arrow-left" aria-hidden="true"></i>
        </a>
        <div class="container mx-auto px-6 flex justify-center items-center">
            <div class="uppercase font-bold text-[11px] tracking-[0.3em] font-[Orbitron] text-zinc-400">
                SKLEP.<span class="coyote-text">STRZELCA</span>.PL
            </div>
        </div>
    </nav>

    <header class="hero-bg text-center px-6 uppercase font-[Orbitron] tracking-tighter">
        <div class="space-y-1">
            <div class="text-2xl md:text-4xl font-black text-white italic">
                Arsenał <span class="coyote-text">STRZELCA</span>
            </div>
            <div class="text-xl md:text-3xl font-bold text-zinc-400 italic">
                Zamawiaj prosto z <span class="coyote-text">PL</span>
            </div>
        </div>
    </header>

    <section id="arsenal" class="py-20 container mx-auto px-6">
        <div id="product-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10"></div>
    </section>

    <div id="details-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 md:p-6 bg-black/95 backdrop-blur-md">
        <div class="bg-zinc-900 p-4 md:p-8 rounded-2xl md:rounded-3xl max-w-2xl w-full border border-zinc-800 relative shadow-2xl max-h-[90vh] overflow-y-auto">
            <button onclick="document.getElementById('details-modal').classList.add('hidden')" class="absolute top-4 md:top-6 right-4 md:right-6 text-2xl md:text-3xl text-zinc-500 hover:text-white">&times;</button>
            <div id="details-content"></div>
        </div>
    </div>

    <footer class="text-center py-12 border-t border-zinc-900 text-zinc-700 text-[10px] uppercase font-bold tracking-[0.5em]" role="contentinfo">
        <a href="https://strzelca.pl" class="hover:text-white transition">STRZELCA.PL</a> 
        <span class="mx-4 text-zinc-800">|</span> 
        <a href="https://dokumenty.strzelca.pl" class="hover:text-white transition">DOKUMENTY - REGULAMINY, ZWROTY ITP.</a>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { initializeFirestore, collection, getDocs, doc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { ensureFirebaseSSO } from "https://strzelca.pl/sso-client.mjs?v=2026-01-28-1";

        const firebaseConfig = { 
            apiKey: "AIzaSyD_gXFh3a4NW9Hzzsr5IQuDADM2GVpPMVc", 
            authDomain: "strzelca-pl.firebaseapp.com", 
            projectId: "strzelca-pl", 
            storageBucket: "strzelca-pl.firebasestorage.app", 
            messagingSenderId: "511362047688", 
            appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd" 
        };
        
        const app = initializeApp(firebaseConfig);
        const db = initializeFirestore(app, {
            experimentalAutoDetectLongPolling: true,
            experimentalForceLongPolling: true,
            useFetchStreams: false,
        });
        const auth = getAuth(app);

        // Ustaw trwałość sesji na browserLocalPersistence dla wszystkich subdomen
        await setPersistence(auth, browserLocalPersistence);

        // SSO między subdomenami: jeśli tu nie ma usera, spróbuj zalogować z cookie (.strzelca.pl)
        try {
            await ensureFirebaseSSO(auth);
        } catch (e) {
            console.warn("SSO ensure failed (ignored):", e?.message || e);
        }

        let currentUser = null;

        // Funkcja pomocnicza do generowania domyślnego awatara
        function getDefaultAvatar(gender) {
            return '<i class="fa-solid fa-user text-white"></i>';
        }

        // Funkcja rozwijania/zwijania menu użytkownika
        window.toggleUserMenu = () => {
            const userMenu = document.getElementById("user-menu");
            if (userMenu) {
                userMenu.classList.toggle("hidden");
            }
        };

        // Zamykanie menu po kliknięciu poza nim
        document.addEventListener("click", (event) => {
            const userPanel = document.getElementById("user-panel");
            const userMenu = document.getElementById("user-menu");
            
            if (
                userPanel &&
                userMenu &&
                !userPanel.contains(event.target) &&
                !userMenu.classList.contains("hidden")
            ) {
                userMenu.classList.add("hidden");
            }
        });

        // Funkcja aktualizacji interfejsu użytkownika
        async function updateUserInterface(user) {
            const loginBtn = document.getElementById("login-button");
            const userPanel = document.getElementById("user-panel");
            const userDisplayName = document.getElementById("user-display-name");
            const userAvatar = document.getElementById("user-avatar");
            const profileLink = document.getElementById("profile-link");

            if (user) {
                // Użytkownik zalogowany
                loginBtn.classList.add("hidden");
                userPanel.classList.remove("hidden");

                // Wyświetl nazwę użytkownika
                const displayName = user.displayName || user.email.split("@")[0];
                if (userDisplayName) {
                    userDisplayName.textContent = displayName;
                }

                // Tryb ograniczony dla niezweryfikowanych: profil -> po rejestracji
                if (profileLink) {
                    profileLink.href = user.emailVerified
                        ? "https://konto.strzelca.pl/profil.html"
                        : "https://konto.strzelca.pl/po.rejestracji.html";
                }

                // Pobierz awatar z profilu użytkownika
                try {
                    const profileDoc = await getDoc(doc(db, "userProfiles", user.uid));
                    if (profileDoc.exists()) {
                        const userProfile = profileDoc.data();
                        if (userProfile.displayName && userDisplayName) {
                            userDisplayName.textContent = userProfile.displayName;
                        }
                        if (userAvatar) {
                            if (userProfile.avatar) {
                                // Jeśli użytkownik ma awatar, wyświetl go
                                userAvatar.innerHTML = `<img src="${userProfile.avatar}" alt="Avatar" class="w-full h-full rounded-full object-cover">`;
                            } else {
                                // Użyj domyślnego awatara
                                userAvatar.innerHTML = getDefaultAvatar(userProfile.gender);
                            }
                        }
                    } else {
                        // Jeśli profil nie istnieje, użyj domyślnego awatara
                        if (userAvatar) {
                            userAvatar.innerHTML = getDefaultAvatar();
                        }
                    }
                } catch (error) {
                    console.error("Error loading user profile:", error);
                    if (userAvatar) {
                        userAvatar.innerHTML = getDefaultAvatar();
                    }
                }
            } else {
                // Użytkownik niezalogowany
                loginBtn.classList.remove("hidden");
                userPanel.classList.add("hidden");
            }
        }

        // Funkcja wylogowania
        window.logout = async () => {
            try {
                // SSO: wyczyść cookie wspólnej sesji
                try {
                    await fetch("https://strzelca.pl/api/sso-session-logout", {
                        method: "POST",
                        credentials: "include",
                    });
                } catch (e) {
                    console.warn("SSO logout failed (ignored):", e?.message || e);
                }

                const { signOut } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
                await signOut(auth);
                // Zamknij menu po wylogowaniu
                const userMenu = document.getElementById("user-menu");
                if (userMenu) {
                    userMenu.classList.add("hidden");
                }
            } catch (error) {
                console.error("Logout error:", error);
            }
        };

        // Monitorowanie stanu logowania
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUserInterface(user);
        });

        // Funkcja logowania aktywności
        async function logActivity(type, userId, userName, details, timestamp = null) {
            try {
                const activityData = {
                    type: type,
                    userId: userId,
                    userName: userName,
                    details: details,
                    timestamp: timestamp || new Date()
                };

                const { addDoc, collection } = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js");
                await addDoc(collection(db, "activityLogs"), activityData);

                console.log('Aktywność zalogowana:', activityData);
            } catch (error) {
                console.error('Błąd podczas logowania aktywności:', error);
            }
        }

        // Funkcja do obsługi zamówienia
        window.handleOrder = (productName) => {
            onAuthStateChanged(auth, async (user) => {
                if (user && user.emailVerified) {
                    // Zaloguj aktywność zamówienia
                    await logActivity(
                        'ORDER-PLACED',
                        user.uid,
                        user.displayName || user.email.split('@')[0] || 'Użytkownik',
                        `Zamówienie produktu: ${productName}`
                    );

                    // Użytkownik zalogowany - przekieruj z parametrami
                    const orderUrl = `https://kontakt.strzelca.pl?topic=Zamówienie&product=${encodeURIComponent(productName)}`;
                    window.location.href = orderUrl;
                } else {
                    // Użytkownik niezalogowany - przekieruj do logowania z parametrem powrotu
                    const returnUrl = encodeURIComponent(window.location.href + '?action=order&product=' + encodeURIComponent(productName));
                    window.location.href = `https://konto.strzelca.pl/login.html?redirect=${returnUrl}`;
                }
            });
        };

        const fetchAll = async () => {
            const q = query(collection(db, "products"), orderBy("order", "asc"));
            const snap = await getDocs(q);
            const grid = document.getElementById('product-grid'); 
            grid.innerHTML = "";
            
            snap.forEach(d => {
                const p = d.data();
                grid.innerHTML += `
                <article class="card-dark flex flex-col h-full shadow-2xl transition hover:border-[#C19A6B]/50" role="article">
                    <div class="h-48 md:h-64 product-img-container"><img src="${p.img}" alt="${p.title}" loading="lazy"></div>
                    <div class="p-4 md:p-8 flex flex-col flex-grow text-center">
                        <h3 class="text-lg md:text-xl font-bold uppercase mb-2 font-[Orbitron] text-white tracking-tight">${p.title}</h3>
                        <p class="coyote-text font-black text-xl md:text-2xl mb-6 md:mb-8" aria-label="Cena: ${p.price} złotych">${p.price} PLN</p>
                        <div class="mt-auto flex flex-col gap-2 md:gap-3">
                            <button onclick="window.showDetails('${d.id}')" aria-label="Zobacz szczegóły produktu ${p.title}" class="w-full py-2 md:py-3 border border-zinc-800 text-[9px] md:text-[10px] uppercase font-bold hover:bg-zinc-800 transition rounded tracking-widest text-zinc-400">Szczegóły</button>
                            <button onclick="window.handleOrder('${p.title}')" aria-label="Zamów produkt ${p.title}" class="w-full py-3 md:py-4 bg-[#C19A6B] text-black text-[9px] md:text-[10px] uppercase font-black rounded tracking-[0.2em] flex items-center justify-center hover:bg-[#b18a5f] transition">Zamów</button>
                        </div>
                    </div>
                </article>`;
            });
        };

        window.showDetails = async (id) => {
            const d = await getDoc(doc(db, "products", id));
            const p = d.data();
            document.getElementById('details-content').innerHTML = `
                <h2 class="text-2xl font-black uppercase mb-4 font-[Orbitron] text-white">${p.title}</h2>
                <div class="text-zinc-400 text-sm mb-8 custom-render details-scroll-area leading-relaxed">
                    ${p.desc}
                </div>
                <div class="flex justify-between items-center border-t border-zinc-800 pt-6">
                    <p class="text-3xl font-black coyote-text">${p.price} PLN</p>
                    <button onclick="window.handleOrder('${p.title}')" class="bg-[#C19A6B] text-black px-8 py-4 uppercase text-[10px] font-black rounded tracking-widest shadow-lg hover:bg-[#b18a5f] transition">Złóż zamówienie</button>
                </div>`;
            document.getElementById('details-modal').classList.remove('hidden');
        };

        fetchAll();
    </script>
</body>
</html>