<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Centrum Dowodzenia strzelca.pl - profesjonalne wyposażenie strzeleckie, sklep z bronią i akcesoriami. Wysoka jakość, bezpieczeństwo i niezawodność."
    />
    <meta
      name="keywords"
      content="strzelectwo, broń, amunicja, akcesoria strzeleckie, sklep strzelecki, wyposażenie strzeleckie"
    />
    <meta name="author" content="Strzelca.pl" />
    <meta name="robots" content="index, follow" />

    <!-- Open Graph dla Facebook -->
    <meta property="og:title" content="strzelca.pl | Centrum Dowodzenia" />
    <meta
      property="og:description"
      content="Profesjonalne wyposażenie strzeleckie - broń, amunicja, akcesoria. Sklep strzelecki z gwarancją jakości."
    />
    <meta property="og:image" content="./tlo:logo/logo.czarne.png" />
    <meta property="og:url" content="https://strzelca.pl" />
    <meta property="og:type" content="website" />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./ikona.svg" />
    <link rel="apple-touch-icon" href="./ikona.svg" />

    <title>strzelca.pl | Centrum Dowodzenia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --coyote: #c19a6b;
      }
      body {
        font-family: "Inter", sans-serif;
        background-color: #0a0a0a;
        color: #e5e5e5;
        margin: 0;
        overflow-x: hidden;
      }
      .main-wrapper {
        min-height: 100vh;
        width: 100%;
        background:
          linear-gradient(
            rgba(10, 10, 10, 0.1) 0%,
            rgba(10, 10, 10, 0.4) 50%,
            #0a0a0a 100%
          ),
          url("./tlo.png");
        background-size: cover;
        background-position: top center;
        background-repeat: no-repeat;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .hub-button {
        background: rgba(20, 20, 20, 0.8);
        border: 1px solid #333;
        transition: 0.3s;
        cursor: pointer;
      }
      .hub-button:hover:not(.disabled) {
        border-color: var(--coyote);
        transform: translateY(-5px);
        background: rgba(30, 30, 30, 0.9);
      }
      .hub-button.disabled {
        opacity: 0.25;
        cursor: not-allowed;
        filter: grayscale(1);
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }
      .bg-coyote {
        background-color: var(--coyote);
      }
      .text-coyote {
        color: var(--coyote);
      }
      #login-button a:hover {
        color: white !important;
      }
      .custom-render b {
        font-weight: bold;
        color: var(--coyote);
      }
      input,
      select,
      textarea,
      .editor-content {
        background: #000 !important;
        border: 1px solid #333 !important;
        color: white !important;
        padding: 14px 20px !important;
        border-radius: 10px;
        width: 100%;
        outline: none;
      }
      .editor-content {
        min-height: 250px;
        overflow-y: auto;
        text-align: left;
      }
      .toolbar {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin-bottom: 8px;
        background: #1a1a1a;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #333;
      }
      .toolbar button {
        background: #222;
        color: #fff;
        width: 38px;
        height: 38px;
        border-radius: 6px;
        border: 1px solid #444;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn-admin {
        background: var(--coyote);
        color: #000;
        font-weight: 900;
        text-transform: uppercase;
        padding: 16px;
        border-radius: 8px;
        cursor: pointer;
      }
    </style>

    <!-- Cookies/zgody + warunkowe ładowanie analityki -->
    <script src="https://strzelca.pl/consent.js?v=2026-02-06-1"></script>
  </head>
  <body>
    <div class="main-wrapper">
      <!-- Panel użytkownika -->
      <div id="user-panel" class="fixed top-4 right-4 z-50 hidden">
        <div class="relative">
          <!-- Avatar - widoczny zawsze -->
          <button
            id="user-avatar-button"
            class="w-12 h-12 rounded-full bg-coyote flex items-center justify-center text-white font-bold cursor-pointer hover:opacity-80 transition shadow-lg overflow-hidden"
            onclick="toggleUserMenu()"
          >
            <div id="user-avatar" class="w-full h-full flex items-center justify-center">
              <i class="fa-solid fa-user"></i>
            </div>
          </button>
          
          <!-- Menu rozwijane -->
          <div
            id="user-menu"
            class="absolute top-14 right-0 bg-zinc-900/95 backdrop-blur-md border border-zinc-700 rounded-2xl p-4 shadow-2xl min-w-[200px] hidden"
          >
            <div class="space-y-2">
              <div
                id="user-display-name"
                class="text-white font-semibold text-sm mb-3 pb-3 border-b border-zinc-700"
              ></div>
              <a
                id="profile-link"
                href="https://konto.strzelca.pl/profil.html"
                class="block text-zinc-300 hover:text-coyote transition text-sm"
              >
                <i class="fa-solid fa-user mr-2"></i>Mój profil
              </a>
              <button
                onclick="logout()"
                class="block w-full text-left text-zinc-300 hover:text-red-400 transition text-sm"
              >
                <i class="fa-solid fa-sign-out-alt mr-2"></i>Wyloguj się
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Przycisk logowania dla niezalogowanych -->
      <div id="login-button" class="fixed top-4 right-4 z-50">
        <a
          href="https://konto.strzelca.pl/login.html"
          class="text-coyote px-4 py-2 rounded-lg font-semibold hover:text-white transition"
        >
          <i class="fa-solid fa-sign-in-alt mr-2"></i>Zaloguj się
        </a>
      </div>

      <header class="container mx-auto px-6 text-center pt-12 md:pt-20">
        <h1
          class="text-4xl md:text-6xl font-black uppercase italic font-[Orbitron] tracking-tighter"
        >
          STREFA STRZELCA<span class="coyote-text">.PL</span>
        </h1>
      </header>

      <main class="container mx-auto px-6 py-12 flex-grow flex items-center">
        <div
          class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 max-w-7xl mx-auto w-full"
        >
          <a
            href="https://sklep.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Sklep</span
            >
          </a>
          <a
            href="https://bazar.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Bazar</span
            >
          </a>
          <a
            href="https://szkolenia.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 1 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Szkolenia</span
            >
          </a>
          <a
            href="https://wydarzenia.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Wydarzenia</span
            >
          </a>
          <a
            href="https://blog.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.487a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Blog</span
            >
          </a>
          <a
            href="https://pomoc.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Pomoc</span
            >
          </a>
          <a
            href="https://dokumenty.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Dokumenty</span
            >
          </a>
          <a
            href="https://kontakt.strzelca.pl"
            class="hub-button p-10 rounded-3xl flex flex-col items-center"
          >
            <svg
              class="w-12 h-12 coyote-text mb-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75"
              />
            </svg>
            <span class="font-bold uppercase tracking-widest text-sm"
              >Kontakt</span
            >
          </a>
        </div>
      </main>

      <footer
        class="w-full py-10 text-center text-zinc-800 text-[10px] uppercase font-bold tracking-[0.4em]"
      >
        <a href="./index.html" class="hover:text-zinc-500 transition"
          >STRZELCA.PL</a
        >
        |
        <a
          href="?cookies=1"
          class="hover:text-zinc-500 transition ml-4"
          >Ustawienia cookies</a
        >
      </footer>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        initializeFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        collection,
        deleteDoc,
        query,
        orderBy,
        where,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut,
        setPersistence,
        browserLocalPersistence,
        sendEmailVerification,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      
      async function getFirebaseApiKey() {
        const urls = ["/api/firebase-config"];

        for (const url of urls) {
          try {
            const res = await fetch(url, { cache: "no-store" });
            if (!res.ok) continue;
            const data = await res.json().catch(() => null);
            if (data && typeof data.apiKey === "string" && data.apiKey.length > 10) {
              return data.apiKey;
            }
          } catch (_) {
            // ignore and try next url
          }
        }

        throw new Error("Nie udało się pobrać FIREBASE_WEB_API_KEY z /api/firebase-config");
      }
const firebaseConfig = {
        apiKey: await getFirebaseApiKey(),
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.appspot.com",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const db = initializeFirestore(app, {
        experimentalForceLongPolling: true,
        useFetchStreams: false,
      });
      const auth = getAuth(app);

      // Ustaw trwałość sesji na browserLocalPersistence dla wszystkich subdomen
      await setPersistence(auth, browserLocalPersistence);
      let productsList = [];
      let contactTopics = [];
      let currentMessageFilter = "all";
      let currentUser = null;
      let eventsList = [];
      let usersList = [];
      let conversationsList = [];
      let currentConversationId = null;

      // Dodaj globalną obsługę błędów CORS (ignoruj błędy Firebase internal)
      window.addEventListener('error', function(e) {
        // Ignoruj błędy CORS związane z Firebase/Firestore
        if (e.message && (
          e.message.includes('access control checks') ||
          e.message.includes('CORS') ||
          e.message.includes('firestore.googleapis.com')
        )) {
          console.warn('Ignored Firebase CORS error:', e.message);
          e.preventDefault();
          return false;
        }
      });

      // Dodaj obsługę błędów dla fetch API
      window.addEventListener('unhandledrejection', function(e) {
        if (e.reason && e.reason.message && (
          e.reason.message.includes('access control checks') ||
          e.reason.message.includes('CORS') ||
          e.reason.message.includes('firestore.googleapis.com')
        )) {
          console.warn('Ignored Firebase CORS promise rejection:', e.reason.message);
          e.preventDefault();
          return false;
        }
      });

      // --- MONITOROWANIE STANU ZALOGOWANIA ---
      console.log("Firebase Auth initialized, checking current user...");

      // SSO między subdomenami: jeśli w tej subdomenie nie ma usera, spróbuj zalogować z cookie (.strzelca.pl)
      try {
        const { ensureFirebaseSSO } = await import("https://strzelca.pl/sso-client.mjs?v=2026-01-28-1");
        const ssoRes = await ensureFirebaseSSO(auth);
        console.log("SSO ensure result:", ssoRes);
      } catch (e) {
        console.warn("SSO ensure failed (ignored):", e?.message || e);
      }

      // Sprawdź czy użytkownik może być zalogowany (odśwież token jeśli potrzebne)
      try {
        await auth.authStateReady();
        console.log("Firebase Auth state ready");
      } catch (error) {
        console.warn("Firebase Auth state check failed:", error);
      }

      // Sprawdź aktualnego użytkownika przed ustawieniem listenera
      const checkCurrentUserOnIndex = async () => {
        const currentUser = auth.currentUser;
        if (currentUser) {
          try {
            await currentUser.reload();
            console.log(
              "Sprawdzanie aktualnego użytkownika na stronie głównej, emailVerified:",
              currentUser.emailVerified
            );
          } catch (error) {
            console.warn("Błąd sprawdzania aktualnego użytkownika na stronie głównej:", error);
          }
        }
        return false;
      };

      // Sprawdź przed ustawieniem listenera
      const wasSignedOut = await checkCurrentUserOnIndex();
      const shouldSkipAuthListener = wasSignedOut === true;

      // Flaga zapobiegająca wielokrotnemu wylogowaniu
      let isSigningOut = false;
      let initialAuthCheck = true; // Flaga dla pierwszego wywołania

      if (!shouldSkipAuthListener) {
        onAuthStateChanged(auth, async (user) => {
        // Ignoruj zmiany stanu podczas wylogowywania
        if (isSigningOut) {
          console.log("Ignoruję zmianę stanu podczas wylogowywania");
          return;
        }

        // Ignoruj pierwsze wywołanie z user = null TYLKO jeśli nie ma aktualnego użytkownika
        // i to jest rzeczywiście początkowe załadowanie strony (nie po przekierowaniu)
        if (initialAuthCheck && !user) {
          const currentUser = auth.currentUser;
          if (!currentUser) {
            console.log("Początkowe wywołanie onAuthStateChanged z user = null - ignoruję (brak aktualnego użytkownika)");
            initialAuthCheck = false;
            return;
          } else {
            // Jest aktualny użytkownik, więc to nie jest początkowe wywołanie
            // Może być to po przekierowaniu z login.html
            console.log("Wywołanie z user = null, ale jest aktualny użytkownik - kontynuuję (może być po przekierowaniu)");
            // Nie ignoruj - użytkownik może być zalogowany, ale Firebase jeszcze nie zsynchronizował stanu
            initialAuthCheck = false;
            // Sprawdź aktualnego użytkownika
            try {
              await currentUser.reload();
              if (currentUser.emailVerified) {
                console.log("Aktualny użytkownik jest zweryfikowany - kontynuuj normalnie");
                // Ustaw user na currentUser, aby kontynuować normalnie
                user = currentUser;
              } else {
                console.log("Aktualny użytkownik niezweryfikowany - wylogowanie");
                isSigningOut = true;
                await signOut(auth);
                window.location.href = "https://konto.strzelca.pl/po.rejestracji.html";
                return;
              }
            } catch (reloadError) {
              console.warn("Błąd sprawdzania aktualnego użytkownika:", reloadError);
              initialAuthCheck = false;
              return;
            }
          }
        }
        initialAuthCheck = false;

        console.log(
          "Auth state changed:",
          user ? "logged in" : "logged out",
          user?.email || "",
          user?.emailVerified ? "(verified)" : "(not verified)"
        );

        // Jeśli email niezweryfikowany: NIE wylogowujemy (tryb ograniczony).
        // Kliknięcie "profil" ma prowadzić do strony po rejestracji.
        if (user && !user.emailVerified) {
          console.warn("Użytkownik zalogowany, ale email niezweryfikowany (tryb ograniczony)");
        }

        currentUser = user;
        updateUserInterface(user);
        });
      }

      // Funkcja pomocnicza do generowania domyślnego awatara
      function getDefaultAvatar(gender) {
        return '<i class="fa-solid fa-user text-white"></i>';
      }

      // Funkcja aktualizacji interfejsu użytkownika
      async function updateUserInterface(user) {
        const loginBtn = document.getElementById("login-button");
        const userPanel = document.getElementById("user-panel");
        const userDisplayName = document.getElementById("user-display-name");
        const userAvatar = document.getElementById("user-avatar");

        if (user) {
          // Użytkownik zalogowany
          loginBtn.classList.add("hidden");
          userPanel.classList.remove("hidden");

          // Wyświetl nazwę użytkownika
          const displayName = user.displayName || user.email.split("@")[0];
          userDisplayName.textContent = displayName;

          // Sprawdź czy użytkownik ma zweryfikowany email (tryb ograniczony, bez wylogowania)
          const profileLink = document.getElementById("profile-link");
          if (profileLink) {
            profileLink.href = user.emailVerified
              ? "https://konto.strzelca.pl/profil.html"
              : "https://konto.strzelca.pl/po.rejestracji.html";
          }
          if (!user.emailVerified) {
            console.log("Użytkownik ma niezweryfikowany email (tryb ograniczony)");
            showEmailVerificationNotice();
          }

          // Pobierz awatar z profilu użytkownika
          try {
            const profileDoc = await getDoc(doc(db, "userProfiles", user.uid));
            if (profileDoc.exists()) {
              const userProfile = profileDoc.data();
              console.log("Profil użytkownika istnieje:", userProfile.displayName);

              if (userProfile.avatar) {
                // Jeśli użytkownik ma awatar, wyświetl go
                userAvatar.innerHTML = `<img src="${userProfile.avatar}" alt="Avatar" class="w-full h-full rounded-full object-cover">`;
              } else {
                // Użyj domyślnego awatara
                userAvatar.innerHTML = getDefaultAvatar(userProfile.gender);
              }
            } else {
              // Jeśli profil nie istnieje, użyj domyślnego awatara i pokaż ostrzeżenie
              console.warn("Profil użytkownika nie istnieje w Firestore, ale użytkownik jest zalogowany");
              userAvatar.innerHTML = getDefaultAvatar();
            }
          } catch (error) {
            // Ignoruj błędy CORS i problemy z połączeniem do Firestore
            if (error.message && (
              error.message.includes('access control checks') ||
              error.message.includes('CORS') ||
              error.message.includes('firestore.googleapis.com') ||
              error.message.includes('network-request-failed')
            )) {
              console.warn("Ignored Firestore connection error in user interface update:", error.message);
            } else {
              console.error("Error loading user profile:", error);
            }
            userAvatar.innerHTML = getDefaultAvatar();
          }
        } else {
          // Użytkownik niezalogowany
          loginBtn.classList.remove("hidden");
          userPanel.classList.add("hidden");
        }
      }

      // Funkcja rozwijania/zwijania menu użytkownika
      window.toggleUserMenu = () => {
        const userMenu = document.getElementById("user-menu");
        if (userMenu) {
          userMenu.classList.toggle("hidden");
        }
      };

      // Funkcja wyświetlająca komunikat o weryfikacji emaila
      function showEmailVerificationNotice() {
        // Sprawdź czy komunikat już istnieje
        if (document.getElementById('email-verification-notice')) {
          return;
        }

        const notice = document.createElement('div');
        notice.id = 'email-verification-notice';
        notice.className = 'fixed top-4 right-4 bg-yellow-500 text-black px-4 py-3 rounded-lg shadow-lg z-50 max-w-md';
        notice.innerHTML = `
          <div class="flex items-start">
            <div class="flex-shrink-0">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="ml-3">
              <p class="text-sm font-medium">
                Email nie został jeszcze zweryfikowany
              </p>
              <p class="text-sm mt-1">
                Sprawdź swoją skrzynkę email i kliknij link aktywacyjny, aby móc korzystać z pełnej funkcjonalności systemu.
              </p>
              <div class="mt-2">
                <button onclick="resendVerificationEmail()" class="text-black underline text-sm hover:no-underline">
                  Wyślij ponownie link aktywacyjny
                </button>
                <button onclick="dismissVerificationNotice()" class="ml-4 text-black underline text-sm hover:no-underline">
                  Zamknij
                </button>
              </div>
            </div>
          </div>
        `;

        document.body.appendChild(notice);

        // Auto-ukrycie po 30 sekundach
        setTimeout(() => {
          dismissVerificationNotice();
        }, 30000);
      }

      // Funkcja wysyłająca ponownie email weryfikacyjny
      window.resendVerificationEmail = async () => {
        if (!currentUser) return;

        try {
          await sendEmailVerification(currentUser, {
            url: window.location.origin + '/index.html'
          });
          alert('Link aktywacyjny został wysłany ponownie na Twój adres email.');
        } catch (error) {
          console.error('Błąd wysyłania emaila weryfikacyjnego:', error);
          alert('Wystąpił błąd podczas wysyłania emaila. Spróbuj ponownie później.');
        }
      };

      // Funkcja ukrywająca komunikat
      window.dismissVerificationNotice = () => {
        const notice = document.getElementById('email-verification-notice');
        if (notice) {
          notice.remove();
        }
      };

      // Zamykanie menu po kliknięciu poza nim
      document.addEventListener("click", (event) => {
        const userPanel = document.getElementById("user-panel");
        const userMenu = document.getElementById("user-menu");
        const userAvatarButton = document.getElementById("user-avatar-button");
        
        if (
          userPanel &&
          userMenu &&
          !userPanel.contains(event.target) &&
          !userMenu.classList.contains("hidden")
        ) {
          userMenu.classList.add("hidden");
        }
      });

      // Funkcja wylogowania
      window.logout = async () => {
        try {
          // SSO: wyczyść cookie wspólnej sesji
          try {
            await fetch("https://strzelca.pl/api/sso-session-logout", {
              method: "POST",
              credentials: "include",
            });
          } catch (e) {
            console.warn("SSO logout failed (ignored):", e?.message || e);
          }
          await signOut(auth);
          // Zamknij menu po wylogowaniu
          const userMenu = document.getElementById("user-menu");
          if (userMenu) {
            userMenu.classList.add("hidden");
          }
        } catch (error) {
          console.error("Logout error:", error);
        }
      };
    </script>
    <script
      type="module"
      src="https://strzelca.pl/auth-widget.mjs?v=2026-02-05-1"
    ></script>
    <script
      type="module"
      src="https://strzelca.pl/messages-widget.mjs?v=2026-02-05-14"
    ></script>
  </body>
</html>
