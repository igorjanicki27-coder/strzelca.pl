<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Centrum Dowodzenia strzelca.pl - profesjonalne wyposa≈ºenie strzeleckie, sklep z broniƒÖ i akcesoriami. Wysoka jako≈õƒá, bezpiecze≈Ñstwo i niezawodno≈õƒá.">
    <meta name="keywords" content="strzelectwo, bro≈Ñ, amunicja, akcesoria strzeleckie, sklep strzelecki, wyposa≈ºenie strzeleckie">
    <meta name="author" content="Strzelca.pl">
    <meta name="robots" content="index, follow">

    <!-- Open Graph dla Facebook -->
    <meta property="og:title" content="strzelca.pl | Centrum Dowodzenia">
    <meta property="og:description" content="Profesjonalne wyposa≈ºenie strzeleckie - bro≈Ñ, amunicja, akcesoria. Sklep strzelecki z gwarancjƒÖ jako≈õci.">
    <meta property="og:image" content="./tlo:logo/logo.czarne.png">
    <meta property="og:url" content="https://strzelca.pl">
    <meta property="og:type" content="website">

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="./ikona.svg">
    <link rel="apple-touch-icon" href="./ikona.svg">

    <title>strzelca.pl | Centrum Dowodzenia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { --coyote: #C19A6B; }
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #e5e5e5; margin: 0; overflow-x: hidden; }
        .main-wrapper { min-height: 100vh; width: 100%; background: linear-gradient(rgba(10,10,10,0.6), #0a0a0a), url('./tlo.png'); background-size: cover; background-position: center; display: flex; flex-direction: column; justify-content: space-between; }
        .hub-button { background: rgba(20, 20, 20, 0.8); border: 1px solid #333; transition: 0.3s; cursor: pointer; }
        .hub-button:hover:not(.disabled) { border-color: var(--coyote); transform: translateY(-5px); background: rgba(30, 30, 30, 0.9); }
        .hub-button.disabled { opacity: 0.25; cursor: not-allowed; filter: grayscale(1); }
        .coyote-text { color: var(--coyote); font-family: 'Orbitron'; }
        .bg-coyote { background-color: var(--coyote); }
        .text-coyote { color: var(--coyote); }
        #login-button a:hover { color: white !important; }
        .custom-render b { font-weight: bold; color: var(--coyote); }
        input, select, textarea, .editor-content { background: #000 !important; border: 1px solid #333 !important; color: white !important; padding: 14px 20px !important; border-radius: 10px; width: 100%; outline: none; }
        .editor-content { min-height: 250px; overflow-y: auto; text-align: left; }
        .toolbar { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; background: #1a1a1a; padding: 10px; border-radius: 10px; border: 1px solid #333; }
        .toolbar button { background: #222; color: #fff; width: 38px; height: 38px; border-radius: 6px; border: 1px solid #444; display: flex; align-items: center; justify-content: center; }
        .btn-admin { background: var(--coyote); color: #000; font-weight: 900; text-transform: uppercase; padding: 16px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- Panel u≈ºytkownika -->
        <div id="user-panel" class="fixed top-4 right-4 z-50 hidden">
            <div class="bg-zinc-900/95 backdrop-blur-md border border-zinc-700 rounded-2xl p-4 shadow-2xl">
                <div id="user-info" class="flex items-center space-x-3 mb-3">
                    <div id="user-avatar" class="w-10 h-10 rounded-full bg-coyote flex items-center justify-center text-white font-bold">
                        <i class="fa-solid fa-user"></i>
                    </div>
                        <div>
                            <div id="user-display-name" class="text-white font-semibold text-sm"></div>
                            <div class="text-zinc-400 text-xs">STRZELEC</div>
                        </div>
                </div>
                <div class="space-y-2">
                    <a href="https://konto.strzelca.pl/profil.html" class="block text-zinc-300 hover:text-coyote transition text-sm">
                        <i class="fa-solid fa-user mr-2"></i>M√≥j profil
                    </a>
                    <button onclick="logout()" class="block w-full text-left text-zinc-300 hover:text-red-400 transition text-sm">
                        <i class="fa-solid fa-sign-out-alt mr-2"></i>Wyloguj siƒô
                    </button>
                </div>
            </div>
        </div>

        <!-- Przycisk logowania dla niezalogowanych -->
        <div id="login-button" class="fixed top-4 right-4 z-50">
            <a href="https://konto.strzelca.pl/login.html" class="text-coyote px-4 py-2 rounded-lg font-semibold hover:text-white transition">
                <i class="fa-solid fa-sign-in-alt mr-2"></i>Zaloguj siƒô
            </a>
        </div>

        <header class="container mx-auto px-6 text-center pt-12 md:pt-20">
            <h1 class="text-4xl md:text-6xl font-black uppercase italic font-[Orbitron] tracking-tighter">STREFA STRZELCA<span class="coyote-text">.PL</span></h1>
        </header>

        <main class="container mx-auto px-6 py-12 flex-grow flex items-center">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 max-w-7xl mx-auto w-full">
                <a href="https://sklep.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 0 0-16.536-1.84M7.5 14.25 5.106 5.272M6 20.25a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Zm12.75 0a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Sklep</span>
                </a>
                <a href="https://bazar.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Bazar</span>
                </a>
                <a href="https://szkolenia.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 1 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Szkolenia</span>
                </a>
                <a href="https://wydarzenia.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5a2.25 2.25 0 0 0 2.25-2.25m-18 0v-7.5A2.25 2.25 0 0 1 5.25 9h13.5a2.25 2.25 0 0 1 2.25 2.25v7.5" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Wydarzenia</span>
                </a>
                <a href="https://blog.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L6.832 19.487a4.5 4.5 0 0 1-1.897 1.13l-2.685.8.8-2.685a4.5 4.5 0 0 1 1.13-1.897L16.863 4.487Zm0 0L19.5 7.125" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Blog</span>
                </a>
                <a href="https://pomoc.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Pomoc</span>
                </a>
                <a href="https://dokumenty.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 0 1 4.5 9.75h15A2.25 2.25 0 0 1 21.75 12v.75m-8.69-6.44-2.12-2.12a1.5 1.5 0 0 0-1.061-.44H4.5A2.25 2.25 0 0 0 2.25 6v12a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9a2.25 2.25 0 0 0-2.25-2.25h-5.379a1.5 1.5 0 0 1-1.06-.44Z" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Dokumenty</span>
                </a>
                <a href="https://kontakt.strzelca.pl" class="hub-button p-10 rounded-3xl flex flex-col items-center">
                    <svg class="w-12 h-12 coyote-text mb-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.615a2.25 2.25 0 0 1-2.36 0L3.32 8.91a2.25 2.25 0 0 1-1.07-1.916V6.75" />
                    </svg>
                    <span class="font-bold uppercase tracking-widest text-sm">Kontakt</span>
                </a>
            </div>
        </main>

        <footer class="w-full py-10 text-center text-zinc-800 text-[10px] uppercase font-bold tracking-[0.4em]">
        <a href="./index.html" class="hover:text-zinc-500 transition">STRZELCA.PL</a> |
        <a href="https://dokumenty.strzelca.pl" class="hover:text-zinc-500 transition ml-4">DOKUMENTY - REGULAMINY, ZWROTY ITP.</a>
        </footer>
    </div>

    <div id="admin-modal" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl">
        <div class="max-w-5xl w-full bg-zinc-900 p-8 rounded-3xl border border-zinc-800 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div id="login-section" class="text-center py-12 max-w-sm mx-auto">
                <h2 class="coyote-text text-xl mb-8 uppercase italic font-[Orbitron]">Autoryzacja</h2>
                <input type="email" id="adm-user" placeholder="Email administratora" class="mb-4 text-center">
                <input type="password" id="adm-pass" placeholder="Has≈Ço" class="mb-6 text-center">
                <button onclick="window.handleLogin()" class="btn-admin w-full">Zaloguj</button>
                <button onclick="window.toggleAdminModal()" class="mt-4 text-zinc-600 text-[10px] uppercase underline block">Zamknij</button>
            </div>

            <div id="admin-panel" class="hidden">
                <div class="flex justify-between items-center mb-8 border-b border-zinc-800 pb-4 uppercase">
                    <h2 class="coyote-text font-bold italic font-[Orbitron]">Centrum Operacyjne</h2>
                    <div class="flex space-x-4">
                        <button onclick="window.toggleAdminModal()" class="text-zinc-400 text-[10px] font-bold border border-zinc-700 px-3 py-1 rounded">Zamknij</button>
                        <button onclick="window.handleLogout()" class="text-red-900 text-[10px] font-black border border-red-900 px-3 py-1 rounded">Wyloguj</button>
                    </div>
                </div>

                <div class="flex space-x-4 mb-8 overflow-x-auto pb-2">
                    <button onclick="window.switchTab('sklep')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Sklep</button>
                    <button onclick="window.switchTab('kontakt')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Kontakt</button>
                    <button onclick="window.switchTab('tematy')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Tematy</button>
                    <button onclick="window.switchTab('wiadomosci')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Wiadomo≈õci</button>
                    <button onclick="window.switchTab('czaty')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Czaty</button>
                    <button onclick="window.switchTab('wydarzenia')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Wydarzenia</button>
                    <button onclick="window.switchTab('pomoc')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">Pomoc</button>
                    <button onclick="window.switchTab('uzytkownicy')" class="px-6 py-2 border border-zinc-700 rounded-full text-[10px] font-bold uppercase hover:border-coyote">STRZELCY</button>
                </div>

                <div id="tab-sklep" class="admin-tab hidden grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="space-y-4">
                        <input type="hidden" id="edit-id">
                        <input id="p-title" type="text" placeholder="Nazwa">
                        <input id="p-price" type="text" placeholder="Cena">
                        <div class="toolbar">
                            <button onclick="window.formatDoc('bold')"><i class="fa-solid fa-bold"></i></button>
                            <button onclick="window.formatDoc('insertUnorderedList')"><i class="fa-solid fa-list-ul"></i></button>
                            <button onclick="window.formatDoc('justifyCenter')"><i class="fa-solid fa-align-center"></i></button>
                            <button onclick="window.triggerDescImg()"><i class="fa-solid fa-image"></i></button>
                        </div>
                        <div id="p-desc" class="editor-content custom-render" contenteditable="true"></div>
                        <label class="text-[9px] text-zinc-500 block uppercase">Zdjƒôcie g≈Ç√≥wne:</label>
                        <input type="file" id="p-img" accept="image/*">
                        <button id="save-btn" onclick="window.saveProduct()" class="btn-admin w-full text-xs">Zatwierd≈∫ produkt</button>
                    </div>
                    <div id="p-list-admin" class="space-y-2 overflow-y-auto max-h-[500px]"></div>
                </div>

                <div id="tab-kontakt" class="admin-tab hidden grid grid-cols-1 md:grid-cols-2 gap-10">
                    <div class="space-y-4">
                        <h3 class="coyote-text text-sm uppercase font-bold mb-4">Placeholdery</h3>
                        <input id="cfg-ph-name" type="text" placeholder="Imiƒô">
                        <input id="cfg-ph-contact" type="text" placeholder="Email/Tel">
                        <textarea id="cfg-ph-msg" placeholder="Wiadomo≈õƒá" rows="3"></textarea>
                        <button onclick="window.saveContactConfig()" class="btn-admin w-full text-xs">Zapisz ustawienia</button>
                    </div>
                    <div class="space-y-4">
                        <h3 class="coyote-text text-sm uppercase font-bold mb-4">Lista Temat√≥w</h3>
                        <div class="flex gap-2">
                            <input id="new-topic" type="text" placeholder="Nowy temat...">
                            <button onclick="window.addTopic()" class="bg-zinc-800 px-4 rounded-lg">+</button>
                        </div>
                        <div id="topics-list" class="space-y-2"></div>
                    </div>
                </div>

                <div id="tab-tematy" class="admin-tab hidden space-y-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="coyote-text text-lg uppercase font-bold">ZarzƒÖdzanie Tematami Wiadomo≈õci</h3>
                        <button onclick="window.refreshTopics()" class="text-zinc-400 hover:text-white px-3 py-1 border border-zinc-700 rounded text-xs">Od≈õwie≈º</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-zinc-900/50 rounded-2xl border border-zinc-800 p-6">
                            <h4 class="text-zinc-300 font-bold mb-4 uppercase text-sm">Dodaj nowy temat</h4>
                            <div class="space-y-4">
                                <input id="topic-name" type="text" placeholder="Nazwa tematu" class="w-full">
                                <input id="topic-order" type="number" placeholder="Kolejno≈õƒá (1-99)" min="1" max="99" class="w-full">
                                <div class="flex gap-2">
                                    <button onclick="window.addTopicAdmin()" class="btn-admin flex-1 text-xs">Dodaj temat</button>
                                    <button onclick="window.clearTopicForm()" class="bg-zinc-700 text-zinc-300 px-4 py-2 rounded text-xs hover:bg-zinc-600">Wyczy≈õƒá</button>
                </div>
                            </div>
                        </div>

                        <div class="bg-zinc-900/50 rounded-2xl border border-zinc-800 p-6">
                            <h4 class="text-zinc-300 font-bold mb-4 uppercase text-sm">Edycja tematu</h4>
                            <div class="space-y-4">
                                <input id="edit-topic-id" type="hidden">
                                <input id="edit-topic-name" type="text" placeholder="Nazwa tematu" class="w-full">
                                <input id="edit-topic-order" type="number" placeholder="Kolejno≈õƒá (1-99)" min="1" max="99" class="w-full">
                                <div class="flex gap-2">
                                    <button onclick="window.updateTopic()" class="btn-admin flex-1 text-xs">Aktualizuj</button>
                                    <button onclick="window.cancelEditTopic()" class="bg-zinc-700 text-zinc-300 px-4 py-2 rounded text-xs hover:bg-zinc-600">Anuluj</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-zinc-900/50 rounded-2xl border border-zinc-800 p-6">
                        <h4 class="text-zinc-300 font-bold mb-4 uppercase text-sm">Lista temat√≥w</h4>
                        <div id="admin-topics-list" class="space-y-2 max-h-[400px] overflow-y-auto">
                            <!-- Tematy bƒôdƒÖ ≈Çadowane dynamicznie -->
                        </div>
                    </div>
                </div>

                <div id="tab-wiadomosci" class="admin-tab hidden space-y-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="coyote-text text-lg uppercase font-bold">Wiadomo≈õci z formularza kontaktowego</h3>
                        <button onclick="window.refreshMessages()" class="text-zinc-400 hover:text-white px-3 py-1 border border-zinc-700 rounded text-xs">Od≈õwie≈º</button>
                    </div>

                    <div class="flex space-x-4 mb-6">
                        <button onclick="window.showMessageFilter('all')" class="filter-btn active px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="all">Wszystkie</button>
                        <button onclick="window.showMessageFilter('unread')" class="filter-btn px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="unread">Nieprzeczytane</button>
                        <button onclick="window.showMessageFilter('read')" class="filter-btn px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="read">Przeczytane</button>
                        <button onclick="window.showMessageFilter('done')" class="filter-btn px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="done">Wykonane</button>
                    </div>

                    <div id="messages-list" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Wiadomo≈õci bƒôdƒÖ ≈Çadowane dynamicznie -->
                    </div>
                </div>

                <div id="tab-wydarzenia" class="admin-tab hidden space-y-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="coyote-text text-lg uppercase font-bold">ZarzƒÖdzanie Wydarzeniami</h3>
                        <button onclick="window.refreshEvents()" class="text-zinc-400 hover:text-white px-3 py-1 border border-zinc-700 rounded text-xs">Od≈õwie≈º</button>
                    </div>

                    <!-- Formularz dodawania/edycji wydarzenia -->
                    <div class="bg-zinc-900/50 p-6 rounded-2xl border border-zinc-800">
                        <h4 class="text-sm font-bold text-white mb-4 uppercase">Dodaj/Edytuj Wydarzenie</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="hidden" id="event-id">
                            <input id="event-title" type="text" placeholder="Tytu≈Ç wydarzenia" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                            <input id="event-date" type="datetime-local" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                            <input id="event-location" type="text" placeholder="Lokalizacja" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                            <select id="event-category" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                                <option value="zawody">Zawody Strzeleckie</option>
                                <option value="szkolenie">Szkolenie</option>
                                <option value="wystawa">Wystawa</option>
                                <option value="inne">Inne</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="event-featured" class="rounded">
                                <label for="event-featured" class="text-sm text-zinc-300">Wyr√≥≈ºnione</label>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="event-published" class="rounded" checked>
                                <label for="event-published" class="text-sm text-zinc-300">Opublikowane</label>
                            </div>
                        </div>
                        <textarea id="event-description" rows="4" placeholder="Opis wydarzenia..." class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white w-full mb-4"></textarea>
                        <div class="flex space-x-2">
                            <button onclick="window.saveEvent()" class="bg-coyote text-black px-4 py-2 rounded text-sm font-bold uppercase">Zapisz</button>
                            <button onclick="window.clearEventForm()" class="bg-zinc-700 text-white px-4 py-2 rounded text-sm">Wyczy≈õƒá</button>
                        </div>
                    </div>

                    <!-- Lista wydarze≈Ñ -->
                    <div id="events-list" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Wydarzenia bƒôdƒÖ ≈Çadowane dynamicznie -->
                    </div>
                </div>

                <div id="tab-pomoc" class="admin-tab hidden space-y-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="coyote-text text-lg uppercase font-bold">ZarzƒÖdzanie Akcjami Charytatywnymi</h3>
                        <button onclick="window.refreshCharity()" class="text-zinc-400 hover:text-white px-3 py-1 border border-zinc-700 rounded text-xs">Od≈õwie≈º</button>
                    </div>

                    <!-- Formularz dodawania/edycji akcji -->
                    <div class="bg-zinc-900/50 rounded-2xl border border-zinc-800 p-6">
                        <h4 class="text-sm font-bold text-white mb-4 uppercase">Dodaj/Edytuj Akcjƒô CharytatywnƒÖ</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input type="hidden" id="charity-id">
                            <input id="charity-title" type="text" placeholder="Nazwa akcji" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                            <input id="charity-date" type="date" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                            <div class="md:col-span-2">
                                <textarea id="charity-description" rows="3" placeholder="Opis akcji..." class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white w-full"></textarea>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="charity-active" class="rounded">
                                <label for="charity-active" class="text-sm text-zinc-300">Akcja aktywna</label>
                            </div>
                        </div>
                        <label class="text-sm text-zinc-400 block mb-2">Zdjƒôcie akcji (opcjonalne):</label>
                        <input type="file" id="charity-image" accept="image/*" class="bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white text-sm mb-4">
                        <div class="flex space-x-2">
                            <button onclick="window.saveCharity()" class="bg-coyote text-black px-4 py-2 rounded text-sm font-bold uppercase">Zapisz</button>
                            <button onclick="window.clearCharityForm()" class="bg-zinc-700 text-white px-4 py-2 rounded text-sm">Wyczy≈õƒá</button>
                        </div>
                    </div>

                    <!-- Lista akcji -->
                    <div id="charity-list" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- Akcje bƒôdƒÖ ≈Çadowane dynamicznie -->
                    </div>
                </div>

                <div id="tab-uzytkownicy" class="admin-tab hidden space-y-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="coyote-text text-lg uppercase font-bold">ZarzƒÖdzanie STRZELCAMI</h3>
                        <button onclick="window.refreshUsers()" class="text-zinc-400 hover:text-white px-3 py-1 border border-zinc-700 rounded text-xs">Od≈õwie≈º</button>
                    </div>

                    <!-- Filtry strzelc√≥w -->
                    <div class="flex space-x-4 mb-6">
                        <button onclick="window.showUserFilter('all')" class="user-filter-btn active px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="all">Wszyscy</button>
                        <button onclick="window.showUserFilter('active')" class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="active">Aktywni</button>
                        <button onclick="window.showUserFilter('blocked')" class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="blocked">Zablokowani</button>
                        <button onclick="window.showUserFilter('admin')" class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-xs uppercase" data-filter="admin">Administratorzy</button>
                    </div>

                    <!-- Lista strzelc√≥w -->
                    <div id="users-list" class="space-y-4 max-h-[600px] overflow-y-auto">
                        <!-- STRZELCY bƒôdƒÖ ≈Çadowani dynamicznie -->
                    </div>
                </div>

                <div id="tab-czaty" class="admin-tab hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[600px]">
                        <!-- Lista konwersacji -->
                        <div class="bg-zinc-900/50 rounded-2xl border border-zinc-800 p-4">
                            <h3 class="coyote-text text-lg font-bold mb-4">Konwersacje</h3>
                            <div id="conversations-list" class="space-y-2 overflow-y-auto max-h-[500px]">
                                <!-- Konwersacje bƒôdƒÖ ≈Çadowane dynamicznie -->
                            </div>
                        </div>

                        <!-- Okno czatu -->
                        <div class="lg:col-span-2 bg-zinc-900/50 rounded-2xl border border-zinc-800 p-4">
                            <div id="chat-window" class="hidden">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 id="chat-partner" class="coyote-text text-lg font-bold">Czat</h3>
                                    <button onclick="window.closeChat()" class="text-zinc-400 hover:text-white">‚úï</button>
                                </div>

                                <div id="chat-messages" class="space-y-3 mb-4 max-h-[400px] overflow-y-auto p-3 bg-black/20 rounded-lg">
                                    <!-- Wiadomo≈õci bƒôdƒÖ ≈Çadowane dynamicznie -->
                                </div>

                                <div class="flex space-x-2">
                                    <input type="text" id="chat-input" placeholder="Wpisz wiadomo≈õƒá..."
                                           class="flex-1 bg-zinc-800 border border-zinc-700 rounded px-3 py-2 text-white">
                                    <button onclick="window.sendMessage()" class="bg-coyote text-black px-4 py-2 rounded font-bold hover:bg-white transition">
                                        Wy≈õlij
                                    </button>
                                </div>
                            </div>

                            <div id="chat-placeholder" class="flex items-center justify-center h-full text-zinc-500">
                                <div class="text-center">
                                    <div class="text-4xl mb-4">üí¨</div>
                                    <div>Wybierz konwersacjƒô aby rozpoczƒÖƒá czat</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc, query, orderBy, where, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD_gXFh3a4NW9Hzzsr5IQuDADM2GVpPMVc",
            authDomain: "strzelca-pl.firebaseapp.com",
            projectId: "strzelca-pl",
            storageBucket: "strzelca-pl.firebasestorage.app",
            messagingSenderId: "511362047688",
            appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
            measurementId: "G-9EJ2R3JPVD"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Ustaw trwa≈Ço≈õƒá sesji na browserLocalPersistence dla wszystkich subdomen
        await setPersistence(auth, browserLocalPersistence);
        let productsList = [];
        let contactTopics = [];
        let currentMessageFilter = 'all';
        let currentUser = null;
        let eventsList = [];
        let usersList = [];
        let conversationsList = [];
        let currentConversationId = null;

        // Globalny dostƒôp do funkcji
        window.toggleAdminModal = () => document.getElementById('admin-modal').classList.toggle('hidden');
        window.switchTab = (id) => {
            document.querySelectorAll('.admin-tab').forEach(t => t.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            if(id === 'sklep') fetchProducts();
            if(id === 'kontakt') fetchContactConfig();
            if(id === 'tematy') fetchTopicsAdmin();
            if(id === 'wiadomosci') fetchMessages();
            if(id === 'wydarzenia') fetchEvents();
            if(id === 'pomoc') fetchCharity();
            if(id === 'uzytkownicy') fetchUsers();
            if(id === 'czaty') fetchConversations();
        };

        // --- AUTORYZACJA (FIREBASE AUTH) ---
        window.handleLogin = async () => {
            const email = document.getElementById('adm-user').value;
            const pass = document.getElementById('adm-pass').value;

            if (!email || !pass) {
                alert("Wprowad≈∫ email i has≈Ço.");
                return;
            }

            try {
                console.log('Attempting login for:', email);
                await signInWithEmailAndPassword(auth, email, pass);
                console.log('Login successful');
                // Nie musimy nic wiƒôcej robiƒá, onAuthStateChanged zajmie siƒô resztƒÖ
            } catch (err) {
                console.error('Login error:', err.code, err.message);
                let errorMessage = "B≈ÇƒÖd autoryzacji: Nieuprawniony dostƒôp.";

                if (err.code === 'auth/user-not-found') {
                    errorMessage = "STRZELEC nie istnieje.";
                } else if (err.code === 'auth/wrong-password') {
                    errorMessage = "Nieprawid≈Çowe has≈Ço.";
                } else if (err.code === 'auth/invalid-email') {
                    errorMessage = "Nieprawid≈Çowy format email.";
                } else if (err.code === 'auth/too-many-requests') {
                    errorMessage = "Zbyt wiele pr√≥b logowania. Spr√≥buj p√≥≈∫niej.";
                }

                alert(errorMessage);
            }
        };

        // --- MONITOROWANIE STANU ZALOGOWANIA ---
        console.log('Firebase Auth initialized, checking current user...');

        // Sprawd≈∫ czy STRZELEC ju≈º jest zalogowany przy ≈Çadowaniu strony
        currentUser = auth.currentUser;
        if (currentUser) {
            console.log('User already logged in on page load:', currentUser.email);
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('admin-panel').classList.remove('hidden');
            window.switchTab('sklep');
        }

        onAuthStateChanged(auth, (user) => {
            console.log('Auth state changed:', user ? 'logged in' : 'logged out', user?.email || '');
            if (user) {
                // Jeste≈õ zalogowany!
                console.log('User logged in:', user.email, 'UID:', user.uid);
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                window.switchTab('sklep');
            } else {
                // Jeste≈õ wylogowany
                console.log('User logged out');
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
            }
        });

        window.handleLogout = () => {
            if(confirm("Czy na pewno wylogowaƒá?")) signOut(auth);
        };

        // --- SKLEP ---
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_W = 800; let w = img.width, h = img.height;
                        if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
                        canvas.width = w; canvas.height = h;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }
        window.formatDoc = (cmd) => { document.getElementById('p-desc').focus(); document.execCommand(cmd, false, null); };
        window.triggerDescImg = () => {
            const input = document.createElement('input'); input.type = 'file'; input.accept = 'image/*';
            input.onchange = async () => {
                const base64 = await compressImage(input.files[0]);
                document.execCommand('insertHTML', false, `<img src="${base64}" style="max-width:100%; border-radius:8px; margin:15px 0; border:1px solid #C19A6B; display:block;">`);
            };
            input.click();
        };
        window.saveProduct = async () => {
            const id = document.getElementById('edit-id').value || Date.now().toString();
            const file = document.getElementById('p-img').files[0];

            try {
                let mainImg = "";
                if(file) mainImg = await compressImage(file);
                else if(document.getElementById('edit-id').value) {
                    mainImg = productsList.find(p => p.id === id).img;
                }

            await setDoc(doc(db, "products", id), {
                title: document.getElementById('p-title').value,
                price: document.getElementById('p-price').value,
                desc: document.getElementById('p-desc').innerHTML,
                    img: mainImg,
                    order: productsList.length,
                    date: Date.now()
                    // adminSecret ju≈º nie jest potrzebny!
            }, { merge: true });

                alert("Zapisano pomy≈õlnie!");
                fetchProducts();
            } catch (err) {
                alert("Brak uprawnie≈Ñ do zapisu w bazie danych.");
            }
        };
        async function fetchProducts() {
            const q = query(collection(db, "products"), orderBy("order", "asc"));
            const snap = await getDocs(q);
            const list = document.getElementById('p-list-admin'); list.innerHTML = ""; productsList = [];
            snap.forEach(d => {
                const data = d.data(); productsList.push({id: d.id, ...data});
                list.innerHTML += `<div class="flex justify-between items-center p-3 bg-black/40 border border-zinc-800 rounded mb-1">
                    <span class="text-[10px] font-bold uppercase">${data.title}</span>
                    <button onclick="window.deleteProd('${d.id}')" class="text-red-900 font-bold">USU≈É</button>
                </div>`;
            });
        }
        window.deleteProd = async (id) => { if(confirm("Usu≈Ñ?")) { await deleteDoc(doc(db, "products", id)); fetchProducts(); } };

        // --- KONTAKT ---
        async function fetchContactConfig() {
            const docSnap = await getDoc(doc(db, "config", "contact"));
            if(docSnap.exists()){
                const d = docSnap.data();
                document.getElementById('cfg-ph-name').value = d.ph_name || "";
                document.getElementById('cfg-ph-contact').value = d.ph_contact || "";
                document.getElementById('cfg-ph-msg').value = d.ph_msg || "";
                contactTopics = d.topics || []; renderTopics();
            }
        }
        window.saveContactConfig = async () => {
            await setDoc(doc(db, "config", "contact"), {
                ph_name: document.getElementById('cfg-ph-name').value,
                ph_contact: document.getElementById('cfg-ph-contact').value,
                ph_msg: document.getElementById('cfg-ph-msg').value,
                topics: contactTopics
            }, { merge: true }); alert("Zapisano!"); alert("Zapisano!");
        };
        window.addTopic = () => {
            const v = document.getElementById('new-topic').value;
            if(v) { contactTopics.push(v); document.getElementById('new-topic').value = ""; renderTopics(); }
        };
        function renderTopics() {
            const l = document.getElementById('topics-list'); l.innerHTML = "";
            contactTopics.forEach((t, i) => {
                l.innerHTML += `<div class="flex justify-between p-2 bg-black/40 border border-zinc-800 rounded mb-1">
                    <span class="text-xs">${t}</span>
                    <button onclick="window.removeTopic(${i})" class="text-red-900 font-bold">X</button>
                </div>`;
            });
        }
        window.removeTopic = (i) => { contactTopics.splice(i, 1); renderTopics(); };

        // --- WIADOMO≈öCI ---
        async function fetchMessages() {
            try {
                const q = query(collection(db, "messages"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);
                const list = document.getElementById('messages-list');
                list.innerHTML = "";

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-zinc-500 py-8">Brak wiadomo≈õci</div>';
                    return;
                }

                snap.forEach(d => {
                    const msg = d.data();
                    const status = msg.status || 'unread';
                    const shouldShow = currentMessageFilter === 'all' || status === currentMessageFilter;

                    if (shouldShow) {
                        const statusColors = {
                            unread: 'border-l-red-500 bg-red-900/10',
                            read: 'border-l-yellow-500 bg-yellow-900/10',
                            done: 'border-l-green-500 bg-green-900/10'
                        };

                        const statusText = {
                            unread: 'NIEPRZECZYTANA',
                            read: 'PRZECZYTANA',
                            done: 'WYKONANA'
                        };

                        list.innerHTML += `
                        <div class="border-l-4 ${statusColors[status]} bg-zinc-900/30 p-4 rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <div class="text-sm font-bold text-white">${msg.name}</div>
                                    <div class="text-xs text-zinc-400">${msg.email} ‚Ä¢ ${new Date(msg.timestamp).toLocaleString('pl-PL')}</div>
                                    <div class="text-xs text-zinc-500 uppercase">${msg.topic}</div>
                                </div>
                                <div class="flex space-x-2">
                                    ${status !== 'read' ? `<button onclick="window.markMessageAsRead('${d.id}')" class="text-xs px-2 py-1 bg-blue-600 text-white rounded">Oznacz jako przeczytanƒÖ</button>` : ''}
                                    ${status !== 'done' ? `<button onclick="window.markMessageAsDone('${d.id}')" class="text-xs px-2 py-1 bg-green-600 text-white rounded">Oznacz jako wykonanƒÖ</button>` : ''}
                                    <button onclick="window.deleteMessage('${d.id}')" class="text-xs px-2 py-1 bg-red-600 text-white rounded">Usu≈Ñ</button>
                                </div>
                            </div>
                            <div class="text-sm text-zinc-300 mt-2 p-3 bg-black/20 rounded border-l border-zinc-700">
                                ${msg.message.replace(/\n/g, '<br>')}
                            </div>
                            <div class="text-xs text-zinc-500 mt-2 uppercase">${statusText[status]}</div>
                        </div>`;
                    }
                });
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania wiadomo≈õci:', err);
                document.getElementById('messages-list').innerHTML = '<div class="text-center text-red-500 py-8">B≈ÇƒÖd ≈Çadowania wiadomo≈õci</div>';
            }
        }

        window.showMessageFilter = (filter) => {
            currentMessageFilter = filter;
            // Aktualizuj wyglƒÖd przycisk√≥w
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'border-coyote', 'text-coyote');
                btn.classList.add('border-zinc-700');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active', 'border-coyote', 'text-coyote');
            fetchMessages();
        };

        window.refreshMessages = () => {
            fetchMessages();
        };

        window.markMessageAsRead = async (id) => {
            try {
                await setDoc(doc(db, "messages", id), { status: 'read' }, { merge: true });
                fetchMessages();
            } catch (err) {
                alert('B≈ÇƒÖd podczas oznaczania wiadomo≈õci');
            }
        };

        window.markMessageAsDone = async (id) => {
            try {
                await setDoc(doc(db, "messages", id), { status: 'done' }, { merge: true });
                fetchMessages();
            } catch (err) {
                alert('B≈ÇƒÖd podczas oznaczania wiadomo≈õci');
            }
        };

        window.deleteMessage = async (id) => {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô wiadomo≈õƒá?')) {
                try {
                    await deleteDoc(doc(db, "messages", id));
                    fetchMessages();
                } catch (err) {
                    alert('B≈ÇƒÖd podczas usuwania wiadomo≈õci');
                }
            }
        };

        // --- WYDARZENIA ---
        async function fetchEvents() {
            try {
                const q = query(collection(db, "events"), orderBy("date", "asc"));
                const snap = await getDocs(q);
                const list = document.getElementById('events-list');
                list.innerHTML = "";
                eventsList = [];

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-zinc-500 py-8">Brak wydarze≈Ñ</div>';
                    return;
                }

            snap.forEach(d => {
                    const event = d.data();
                    eventsList.push({ id: d.id, ...event });

                    const eventDate = new Date(event.date);
                    const isPast = eventDate < new Date();
                    const statusBadge = event.featured ? 'bg-yellow-600' : event.published ? 'bg-green-600' : 'bg-gray-600';
                    const statusText = event.featured ? 'WYR√ì≈ªNIONE' : event.published ? 'PUBLIKOWANE' : 'SZKIC';

                    list.innerHTML += `
                    <div class="bg-zinc-900/30 p-4 rounded-lg border-l-4 ${event.featured ? 'border-l-yellow-500' : 'border-l-zinc-600'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-white font-bold">${event.title}</h4>
                                    <span class="px-2 py-1 text-xs rounded ${statusBadge} text-white">${statusText}</span>
                                    ${isPast ? '<span class="px-2 py-1 text-xs rounded bg-red-600 text-white">PRZESZ≈ÅE</span>' : ''}
                                </div>
                                <div class="text-sm text-zinc-400 space-y-1">
                                    <div>üìÖ ${eventDate.toLocaleString('pl-PL')}</div>
                                    <div>üìç ${event.location}</div>
                                    <div>üè∑Ô∏è ${event.category}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="window.editEvent('${d.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Edytuj</button>
                                <button onclick="window.toggleEventFeatured('${d.id}')" class="text-yellow-400 hover:text-yellow-300 px-2 py-1 border border-yellow-400 rounded text-xs">
                                    ${event.featured ? 'Usu≈Ñ wyr√≥≈ºnienie' : 'Wyr√≥≈ºnij'}
                                </button>
                                <button onclick="window.deleteEvent('${d.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usu≈Ñ</button>
                            </div>
                        </div>
                        <div class="text-sm text-zinc-300 mt-2">
                            ${event.description.length > 200 ? event.description.substring(0, 200) + '...' : event.description}
                        </div>
                </div>`;
            });
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania wydarze≈Ñ:', err);
                document.getElementById('events-list').innerHTML = '<div class="text-center text-red-500 py-8">B≈ÇƒÖd ≈Çadowania wydarze≈Ñ</div>';
            }
        }

        window.saveEvent = async () => {
            const id = document.getElementById('event-id').value || Date.now().toString();
            const eventData = {
                title: document.getElementById('event-title').value,
                date: document.getElementById('event-date').value,
                location: document.getElementById('event-location').value,
                category: document.getElementById('event-category').value,
                description: document.getElementById('event-description').value,
                featured: document.getElementById('event-featured').checked,
                published: document.getElementById('event-published').checked,
                created: Date.now()
            };

            if (!eventData.title || !eventData.date || !eventData.location) {
                alert('Wype≈Çnij wszystkie wymagane pola (tytu≈Ç, data, lokalizacja)');
                return;
            }

            try {
                await setDoc(doc(db, "events", id), eventData);
                alert('Wydarzenie zosta≈Ço zapisane!');
                clearEventForm();
                fetchEvents();
            } catch (err) {
                console.error('B≈ÇƒÖd zapisywania wydarzenia:', err);
                alert('B≈ÇƒÖd podczas zapisywania wydarzenia');
            }
        };

        window.editEvent = (id) => {
            const event = eventsList.find(e => e.id === id);
            if (event) {
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-date').value = event.date;
                document.getElementById('event-location').value = event.location;
                document.getElementById('event-category').value = event.category;
                document.getElementById('event-description').value = event.description;
                document.getElementById('event-featured').checked = event.featured || false;
                document.getElementById('event-published').checked = event.published !== false;
            }
        };

        window.clearEventForm = () => {
            document.getElementById('event-id').value = '';
            document.getElementById('event-title').value = '';
            document.getElementById('event-date').value = '';
            document.getElementById('event-location').value = '';
            document.getElementById('event-category').value = 'zawody';
            document.getElementById('event-description').value = '';
            document.getElementById('event-featured').checked = false;
            document.getElementById('event-published').checked = true;
        };

        window.toggleEventFeatured = async (id) => {
            try {
                const event = eventsList.find(e => e.id === id);
                if (event) {
                    await setDoc(doc(db, "events", id), { featured: !event.featured }, { merge: true });
                    fetchEvents();
                }
            } catch (err) {
                alert('B≈ÇƒÖd podczas zmiany statusu wyr√≥≈ºnienia');
            }
        };

        window.deleteEvent = async (id) => {
            if (confirm('Czy na pewno chcesz usunƒÖƒá to wydarzenie?')) {
                try {
                    await deleteDoc(doc(db, "events", id));
                    fetchEvents();
                } catch (err) {
                    alert('B≈ÇƒÖd podczas usuwania wydarzenia');
                }
            }
        };

        window.refreshEvents = () => {
            fetchEvents();
        };

        // --- SYSTEM OPERATOR√ìW ---
        async function updateUserPanel() {
            const loginBtn = document.getElementById('login-button');
            const userPanel = document.getElementById('user-panel');

            if (currentUser) {
                // STRZELEC zalogowany
                loginBtn.classList.add('hidden');
                userPanel.classList.remove('hidden');

                try {
                    // Pobierz dane profilu
                    const profileDoc = await getDoc(doc(db, "userProfiles", currentUser.uid));
                    if (profileDoc.exists()) {
                        const profile = profileDoc.data();
                        document.getElementById('user-display-name').textContent = profile.displayName;

                        // Ustaw avatar
                        const avatarEl = document.getElementById('user-avatar');
                        if (profile.avatar) {
                            avatarEl.innerHTML = `<img src="${profile.avatar}" alt="Avatar" class="w-full h-full rounded-full object-cover">`;
                        } else {
                            avatarEl.innerHTML = profile.gender === 'female' ?
                                '<i class="fa-solid fa-user text-white"></i>' :
                                '<i class="fa-solid fa-user text-white"></i>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading user profile:', error);
                }
            } else {
                // STRZELEC niezalogowany
                loginBtn.classList.remove('hidden');
                userPanel.classList.add('hidden');
            }
        }

        // Funkcja wylogowania
        window.logout = async () => {
            try {
                await signOut(auth);
                alert('Zosta≈Çe≈õ wylogowany.');
                location.reload();
            } catch (error) {
                console.error('Error signing out:', error);
                alert('B≈ÇƒÖd podczas wylogowywania.');
            }
        };

        // --- ZARZƒÑDZANIE OPERATORAMI ---
        async function fetchUsers() {
            try {
                const q = query(collection(db, "userProfiles"), orderBy("createdAt", "desc"));
                const snap = await getDocs(q);
                const list = document.getElementById('users-list');
                list.innerHTML = "";
                usersList = [];

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-zinc-500 py-8">Brak STRZELC√ìW</div>';
                    return;
                }

                snap.forEach(d => {
                    const user = d.data();
                    usersList.push({ id: d.id, ...user });

                    const status = user.status || 'active';
                    const role = user.role || 'user';
                    const isCurrentUser = currentUser && currentUser.uid === user.uid;

                    // Odszyfruj wra≈ºliwe dane dla wy≈õwietlania
                    const decryptedUser = {
                        ...user,
                        phone: user.phone ? atob(user.phone) : '',
                        parcelLocker: user.parcelLocker ? atob(user.parcelLocker) : '',
                        address: {
                            street: user.address?.street ? atob(user.address.street) : '',
                            city: user.address?.city ? atob(user.address.city) : ''
                        }
                    };

                    const statusColors = {
                        active: 'border-l-green-500 bg-green-900/10',
                        blocked: 'border-l-red-500 bg-red-900/10',
                        suspended: 'border-l-yellow-500 bg-yellow-900/10'
                    };

                    const roleColors = {
                        admin: 'bg-red-600',
                        user: 'bg-blue-600'
                    };

                    const shouldShow = currentUserFilter === 'all' ||
                                     (currentUserFilter === 'admin' && role === 'admin') ||
                                     (currentUserFilter === 'active' && status === 'active') ||
                                     (currentUserFilter === 'blocked' && status === 'blocked');

                    if (shouldShow) {
                        list.innerHTML += `
                        <div class="border-l-4 ${statusColors[status]} bg-zinc-900/30 p-4 rounded-r-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <h4 class="text-white font-bold">${decryptedUser.displayName}</h4>
                                        <span class="px-2 py-1 text-xs rounded ${roleColors[role]} text-white">${role.toUpperCase()}</span>
                                        <span class="px-2 py-1 text-xs rounded bg-gray-600 text-white">${status.toUpperCase()}</span>
                                        ${isCurrentUser ? '<span class="px-2 py-1 text-xs rounded bg-purple-600 text-white">TY</span>' : ''}
                                    </div>
                                    <div class="text-sm text-zinc-400 space-y-1">
                                        <div>üìß ${decryptedUser.email}</div>
                                        <div>üì± ${decryptedUser.phone || 'Brak'}</div>
                                        <div>üè† ${decryptedUser.address.city || 'Brak adresu'}</div>
                                        <div>üìÖ ${new Date(decryptedUser.createdAt).toLocaleDateString('pl-PL')}</div>
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="window.viewUserDetails('${d.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Szczeg√≥≈Çy</button>
                                    ${!isCurrentUser ? `
                                    <button onclick="window.toggleUserBlock('${d.id}')" class="text-${status === 'blocked' ? 'green' : 'yellow'}-400 hover:text-${status === 'blocked' ? 'green' : 'yellow'}-300 px-2 py-1 border border-${status === 'blocked' ? 'green' : 'yellow'}-400 rounded text-xs">
                                        ${status === 'blocked' ? 'Odblokuj' : 'Zablokuj'}
                                    </button>
                                    <button onclick="window.resetUserPassword('${d.id}', '${decryptedUser.email}')" class="text-orange-400 hover:text-orange-300 px-2 py-1 border border-orange-400 rounded text-xs">Reset has≈Ça</button>
                                    <button onclick="window.deleteUser('${d.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usu≈Ñ</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>`;
                    }
                });
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania u≈ºytkownik√≥w:', err);
                document.getElementById('users-list').innerHTML = '<div class="text-center text-red-500 py-8">B≈ÇƒÖd ≈Çadowania STRZELC√ìW</div>';
            }
        }

        let currentUserFilter = 'all';

        window.showUserFilter = (filter) => {
            currentUserFilter = filter;
            document.querySelectorAll('.user-filter-btn').forEach(btn => {
                btn.classList.remove('active', 'border-coyote', 'text-coyote');
                btn.classList.add('border-zinc-700');
            });
            document.querySelector(`[data-filter="${filter}"]`).classList.add('active', 'border-coyote', 'text-coyote');
            fetchUsers();
        };

        window.viewUserDetails = (userId) => {
            const user = usersList.find(u => u.id === userId);
            if (!user) return;

            // Odszyfruj wszystkie dane wra≈ºliwe
            const decryptedUser = {
                ...user,
                phone: user.phone ? atob(user.phone) : '',
                parcelLocker: user.parcelLocker ? atob(user.parcelLocker) : '',
                address: {
                    street: user.address?.street ? atob(user.address.street) : '',
                    buildingNumber: user.address?.buildingNumber ? atob(user.address.buildingNumber) : '',
                    postalCode: user.address?.postalCode ? atob(user.address.postalCode) : '',
                    city: user.address?.city ? atob(user.address.city) : ''
                }
            };

            const details = `
                <strong>Nazwa profilu:</strong> ${decryptedUser.displayName}<br>
                <strong>Email:</strong> ${decryptedUser.email}<br>
                <strong>Imiƒô:</strong> ${decryptedUser.firstName}<br>
                <strong>Nazwisko:</strong> ${decryptedUser.lastName}<br>
                <strong>Telefon:</strong> ${decryptedUser.phone}<br>
                <strong>Paczkomat:</strong> ${decryptedUser.parcelLocker}<br>
                <strong>Adres:</strong> ${decryptedUser.address.street} ${decryptedUser.address.buildingNumber}, ${decryptedUser.address.postalCode} ${decryptedUser.address.city}<br>
                <strong>P≈Çeƒá:</strong> ${decryptedUser.gender}<br>
                <strong>Newsletter:</strong> ${decryptedUser.newsletter ? 'Tak' : 'Nie'}<br>
                <strong>Data rejestracji:</strong> ${new Date(decryptedUser.createdAt).toLocaleString('pl-PL')}<br>
                <strong>Rola:</strong> ${decryptedUser.role}<br>
                <strong>Status:</strong> ${decryptedUser.status}
            `;

                alert(`Szczeg√≥≈Çy STRZELCA:\n\n${details.replace(/<br>/g, '\n').replace(/<strong>/g, '').replace(/<\/strong>/g, '')}`);
        };

        window.toggleUserBlock = async (userId) => {
            try {
                const user = usersList.find(u => u.id === userId);
                if (!user) return;

                const newStatus = user.status === 'blocked' ? 'active' : 'blocked';
                await updateDoc(doc(db, "userProfiles", userId), { status: newStatus });

                alert(`STRZELEC zosta≈Ç ${newStatus === 'blocked' ? 'zablokowany' : 'odblokowany'}`);
                fetchUsers();
            } catch (err) {
                alert('B≈ÇƒÖd podczas zmiany statusu STRZELCA');
            }
        };

        window.resetUserPassword = async (userId, email) => {
            if (confirm(`Czy wys≈Çaƒá link resetowania has≈Ça na adres: ${email}?`)) {
                try {
                    // W Firebase mo≈ºna wys≈Çaƒá reset has≈Ça przez admin SDK lub przez klienta
                    // Tutaj u≈ºyjemy metody klienta - u≈ºytkownik musi byƒá zalogowany, ale mo≈ºemy to obej≈õƒá
                    await fetch('/api/reset-password', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, userId })
                    });
                    alert('Link resetowania has≈Ça zosta≈Ç wys≈Çany');
                } catch (err) {
                    alert('B≈ÇƒÖd podczas wysy≈Çania linku resetowania. Funkcja zostanie zaimplementowana wkr√≥tce.');
                }
            }
        };

        window.deleteUser = async (userId) => {
            const user = usersList.find(u => u.id === userId);
            if (!user) return;

            const isCurrentUser = currentUser && currentUser.uid === userId;

            if (isCurrentUser) {
                alert('Nie mo≈ºesz usunƒÖƒá w≈Çasnego konta!');
                return;
            }

            const confirmMessage = `Czy na pewno chcesz usunƒÖƒá STRZELCA ${user.displayName}?\n\nWybierz opcjƒô usuniƒôcia:`;
            const options = confirm(confirmMessage + '\n\nOK - Usu≈Ñ konto i wszystkie dane\nCancel - Anuluj');

            if (!options) return;

            try {
                // Usu≈Ñ wszystkie dane u≈ºytkownika
                const batch = [];

                // Usu≈Ñ profil
                batch.push(deleteDoc(doc(db, "userProfiles", userId)));

                // Usu≈Ñ wiadomo≈õci u≈ºytkownika
                const messagesQuery = query(collection(db, "messages"), where("senderId", "==", userId));
                const messagesSnap = await getDocs(messagesQuery);
                messagesSnap.forEach(doc => batch.push(deleteDoc(doc.ref)));

                // Usu≈Ñ oferty z bazaru
                const offersQuery = query(collection(db, "offers"), where("sellerId", "==", userId));
                const offersSnap = await getDocs(offersQuery);
                offersSnap.forEach(doc => batch.push(deleteDoc(doc.ref)));

                // Wykonaj wszystkie usuniƒôcia
                await Promise.all(batch);

                alert('U≈ºytkownik i wszystkie jego dane zosta≈Çy usuniƒôte');
                fetchUsers();
            } catch (err) {
                console.error('B≈ÇƒÖd podczas usuwania u≈ºytkownika:', err);
                alert('B≈ÇƒÖd podczas usuwania STRZELCA');
            }
        };

        window.refreshUsers = () => {
            fetchUsers();
        };

        // --- SYSTEM CZAT√ìW ---
        async function fetchConversations() {
            try {
                const q = query(collection(db, "conversations"), orderBy("lastMessageTime", "desc"));
                const snap = await getDocs(q);
                const list = document.getElementById('conversations-list');
                list.innerHTML = "";
                conversationsList = [];

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-zinc-500 py-8">Brak konwersacji</div>';
                    return;
                }

                for (const docSnap of snap.docs) {
                    const conversation = docSnap.data();
                    conversationsList.push({ id: docSnap.id, ...conversation });

                    // Pobierz nazwƒô partnera konwersacji
                    let partnerName = 'Nieznany';
                    let partnerType = '';

                    if (conversation.type === 'user_admin') {
                        // Znajd≈∫ u≈ºytkownika
                        const userId = conversation.participants.find(p => p !== 'admin');
                        if (userId) {
                            try {
                                const userDoc = await getDoc(doc(db, "userProfiles", userId));
                                if (userDoc.exists()) {
                                    partnerName = userDoc.data().displayName;
                                    partnerType = 'STRZELEC';
                                }
                            } catch (err) {
                                console.error('Error fetching user:', err);
                            }
                        }
                    } else if (conversation.type === 'guest_admin') {
                        partnerName = conversation.guestName || 'Go≈õƒá';
                        partnerType = 'Go≈õƒá';
                    }

                    const unreadCount = conversation.unreadCount?.admin || 0;
                    const lastMessageTime = new Date(conversation.lastMessageTime).toLocaleString('pl-PL');

                    list.innerHTML += `
                    <div onclick="window.openChat('${docSnap.id}')" class="p-3 rounded-lg bg-zinc-800/50 hover:bg-zinc-700/50 cursor-pointer transition ${unreadCount > 0 ? 'border-l-4 border-l-coyote' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <span class="font-semibold text-white">${partnerName}</span>
                                    <span class="text-xs text-zinc-400">${partnerType}</span>
                                    ${unreadCount > 0 ? `<span class="bg-coyote text-black text-xs px-2 py-1 rounded-full">${unreadCount}</span>` : ''}
                                </div>
                                <div class="text-sm text-zinc-400 truncate">${conversation.lastMessage}</div>
                                <div class="text-xs text-zinc-500">${lastMessageTime}</div>
                            </div>
                        </div>
                    </div>`;
                }
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania konwersacji:', err);
                document.getElementById('conversations-list').innerHTML = '<div class="text-center text-red-500 py-8">B≈ÇƒÖd ≈Çadowania konwersacji</div>';
            }
        }

        window.openChat = async (conversationId) => {
            currentConversationId = conversationId;
            const conversation = conversationsList.find(c => c.id === conversationId);

            if (!conversation) return;

            // Ustaw tytu≈Ç czatu
            let partnerName = 'Nieznany';
            if (conversation.type === 'user_admin') {
                const userId = conversation.participants.find(p => p !== 'admin');
                if (userId) {
                    try {
                        const userDoc = await getDoc(doc(db, "userProfiles", userId));
                        if (userDoc.exists()) {
                            partnerName = userDoc.data().displayName;
                        }
                    } catch (err) {
                        console.error('Error fetching user for chat:', err);
                    }
                }
            } else if (conversation.type === 'guest_admin') {
                partnerName = conversation.guestName || 'Go≈õƒá';
            }

            document.getElementById('chat-partner').textContent = `Czat z ${partnerName}`;
            document.getElementById('chat-placeholder').classList.add('hidden');
            document.getElementById('chat-window').classList.remove('hidden');

            // Za≈Çaduj wiadomo≈õci
            await fetchChatMessages(conversationId);

            // Oznacz wiadomo≈õci jako przeczytane
            await updateDoc(doc(db, "conversations", conversationId), {
                'unreadCount.admin': 0
            });

            // Od≈õwie≈º listƒô konwersacji
            fetchConversations();
        };

        async function fetchChatMessages(conversationId) {
            try {
                const q = query(
                    collection(db, "chatMessages"),
                    where("conversationId", "==", conversationId),
                    orderBy("timestamp", "asc")
                );
                const snap = await getDocs(q);
                const messagesDiv = document.getElementById('chat-messages');
                messagesDiv.innerHTML = "";

                snap.forEach(doc => {
                    const message = doc.data();
                    const isFromAdmin = message.senderId === 'admin' || message.recipientId === 'admin';
                    const messageTime = new Date(message.timestamp).toLocaleString('pl-PL');

                    messagesDiv.innerHTML += `
                    <div class="flex ${isFromAdmin ? 'justify-end' : 'justify-start'}">
                        <div class="max-w-[70%] ${isFromAdmin ? 'bg-coyote text-black' : 'bg-zinc-700 text-white'} rounded-lg p-3">
                            <div class="text-sm">${message.content}</div>
                            <div class="text-xs ${isFromAdmin ? 'text-black/70' : 'text-zinc-400'} mt-1">${messageTime}</div>
                        </div>
                    </div>`;
                });

                // Scroll do ko≈Ñca
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania wiadomo≈õci:', err);
            }
        }

        window.sendMessage = async () => {
            if (!currentConversationId) return;

            const input = document.getElementById('chat-input');
            const content = input.value.trim();

            if (!content) return;

            try {
                const conversation = conversationsList.find(c => c.id === currentConversationId);
                let recipientId, recipientType;

                if (conversation.type === 'user_admin') {
                    recipientId = conversation.participants.find(p => p !== 'admin');
                    recipientType = 'user';
                } else {
                    recipientId = 'guest';
                    recipientType = 'guest';
                }

                const messageData = {
                    conversationId: currentConversationId,
                    senderId: 'admin',
                    senderType: 'admin',
                    senderName: 'Administrator',
                    recipientId: recipientId,
                    recipientType: recipientType,
                    content: content,
                    timestamp: Date.now(),
                    isRead: false
                };

                await setDoc(doc(collection(db, "chatMessages")), messageData);

                // Zaktualizuj konwersacjƒô
                await updateDoc(doc(db, "conversations", currentConversationId), {
                    lastMessage: content.substring(0, 100),
                    lastMessageTime: Date.now(),
                    'unreadCount': {
                        ...conversation.unreadCount,
                        [recipientId]: (conversation.unreadCount?.[recipientId] || 0) + 1
                    }
                });

                input.value = '';
                await fetchChatMessages(currentConversationId);
                fetchConversations();
            } catch (err) {
                console.error('B≈ÇƒÖd wysy≈Çania wiadomo≈õci:', err);
                alert('B≈ÇƒÖd podczas wysy≈Çania wiadomo≈õci');
            }
        };

        window.closeChat = () => {
            currentConversationId = null;
            document.getElementById('chat-window').classList.add('hidden');
            document.getElementById('chat-placeholder').classList.remove('hidden');
        };

        // === ZARZƒÑDZANIE TEMATAMI ===
        window.fetchTopicsAdmin = async () => {
            try {
                const docSnap = await getDoc(doc(db, "config", "contact"));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    renderTopicsAdmin(data.topics || []);
                } else {
                    renderTopicsAdmin([]);
                }
            } catch (err) {
                console.error('B≈ÇƒÖd pobierania temat√≥w:', err);
                renderTopicsAdmin([]);
            }
        };

        window.renderTopicsAdmin = (topics) => {
            const container = document.getElementById('admin-topics-list');
            container.innerHTML = '';

            if (!topics || topics.length === 0) {
                container.innerHTML = '<p class="text-zinc-500 text-sm">Brak temat√≥w do wy≈õwietlenia</p>';
                return;
            }

            // Sortuj tematy po kolejno≈õci
            const sortedTopics = [...topics].sort((a, b) => (a.order || 99) - (b.order || 99));

            sortedTopics.forEach((topic, index) => {
                const topicItem = document.createElement('div');
                topicItem.className = 'flex items-center justify-between p-3 bg-zinc-800 rounded-lg';
                topicItem.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-zinc-400 text-xs w-6">${index + 1}.</span>
                        <span class="text-zinc-300">${topic.name || topic}</span>
                        ${topic.order ? `<span class="text-zinc-500 text-xs">(kolejno≈õƒá: ${topic.order})</span>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.editTopic('${topic.id || topic}', '${topic.name || topic}', '${topic.order || ''}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 text-xs">Edytuj</button>
                        <button onclick="window.moveTopic('${topic.id || topic}', 'up')" class="text-zinc-400 hover:text-zinc-300 px-2 py-1 text-xs">‚Üë</button>
                        <button onclick="window.moveTopic('${topic.id || topic}', 'down')" class="text-zinc-400 hover:text-zinc-300 px-2 py-1 text-xs">‚Üì</button>
                        <button onclick="window.deleteTopic('${topic.id || topic}')" class="text-red-400 hover:text-red-300 px-2 py-1 text-xs">Usu≈Ñ</button>
                    </div>
                `;
                container.appendChild(topicItem);
            });
        };

        window.addTopicAdmin = async () => {
            const name = document.getElementById('topic-name').value.trim();
            const order = parseInt(document.getElementById('topic-order').value) || 99;

            if (!name) {
                alert('Nazwa tematu jest wymagana');
                return;
            }

            try {
                const docRef = doc(db, "config", "contact");
                const docSnap = await getDoc(docRef);
                let currentTopics = [];

                if (docSnap.exists()) {
                    currentTopics = docSnap.data().topics || [];
                }

                // Sprawd≈∫ czy temat ju≈º istnieje
                if (currentTopics.some(t => (t.name || t) === name)) {
                    alert('Temat o tej nazwie ju≈º istnieje');
                    return;
                }

                // Dodaj nowy temat z ID i kolejno≈õciƒÖ
                const newTopic = {
                    id: Date.now().toString(),
                    name: name,
                    order: order
                };

                currentTopics.push(newTopic);

                await updateDoc(docRef, { topics: currentTopics });

                document.getElementById('topic-name').value = '';
                document.getElementById('topic-order').value = '';

                fetchTopicsAdmin();
                alert('Temat zosta≈Ç dodany!');
            } catch (err) {
                console.error('B≈ÇƒÖd dodawania tematu:', err);
                alert('B≈ÇƒÖd podczas dodawania tematu');
            }
        };

        window.editTopic = (id, name, order) => {
            document.getElementById('edit-topic-id').value = id;
            document.getElementById('edit-topic-name').value = name;
            document.getElementById('edit-topic-order').value = order;
        };

        window.updateTopic = async () => {
            const id = document.getElementById('edit-topic-id').value;
            const name = document.getElementById('edit-topic-name').value.trim();
            const order = parseInt(document.getElementById('edit-topic-order').value) || 99;

            if (!name) {
                alert('Nazwa tematu jest wymagana');
                return;
            }

            try {
                const docRef = doc(db, "config", "contact");
                const docSnap = await getDoc(docRef);
                let currentTopics = [];

                if (docSnap.exists()) {
                    currentTopics = docSnap.data().topics || [];
                }

                // Znajd≈∫ i zaktualizuj temat
                const topicIndex = currentTopics.findIndex(t => t.id === id || t === id);
                if (topicIndex !== -1) {
                    if (typeof currentTopics[topicIndex] === 'string') {
                        // Konwertuj stary format na nowy
                        currentTopics[topicIndex] = {
                            id: id,
                            name: name,
                            order: order
                        };
                    } else {
                        currentTopics[topicIndex].name = name;
                        currentTopics[topicIndex].order = order;
                    }

                    await updateDoc(docRef, { topics: currentTopics });

                    document.getElementById('edit-topic-id').value = '';
                    document.getElementById('edit-topic-name').value = '';
                    document.getElementById('edit-topic-order').value = '';

                    fetchTopicsAdmin();
                    alert('Temat zosta≈Ç zaktualizowany!');
                }
            } catch (err) {
                console.error('B≈ÇƒÖd aktualizacji tematu:', err);
                alert('B≈ÇƒÖd podczas aktualizacji tematu');
            }
        };

        window.deleteTopic = async (id) => {
            if (!confirm('Czy na pewno chcesz usunƒÖƒá ten temat?')) return;

            try {
                const docRef = doc(db, "config", "contact");
                const docSnap = await getDoc(docRef);
                let currentTopics = [];

                if (docSnap.exists()) {
                    currentTopics = docSnap.data().topics || [];
                }

                // Usu≈Ñ temat
                const filteredTopics = currentTopics.filter(t => t.id !== id && t !== id);

                await updateDoc(docRef, { topics: filteredTopics });

                fetchTopicsAdmin();
                alert('Temat zosta≈Ç usuniƒôty!');
            } catch (err) {
                console.error('B≈ÇƒÖd usuwania tematu:', err);
                alert('B≈ÇƒÖd podczas usuwania tematu');
            }
        };

        window.moveTopic = async (id, direction) => {
            try {
                const docRef = doc(db, "config", "contact");
                const docSnap = await getDoc(docRef);
                let currentTopics = [];

                if (docSnap.exists()) {
                    currentTopics = docSnap.data().topics || [];
                }

                const topicIndex = currentTopics.findIndex(t => t.id === id || t === id);
                if (topicIndex === -1) return;

                // Zamie≈Ñ kolejno≈õciƒÖ z sƒÖsiednim tematem
                let swapIndex;
                if (direction === 'up' && topicIndex > 0) {
                    swapIndex = topicIndex - 1;
                } else if (direction === 'down' && topicIndex < currentTopics.length - 1) {
                    swapIndex = topicIndex + 1;
                } else {
                    return; // Nie mo≈ºna przesunƒÖƒá
                }

                // Zamie≈Ñ miejscami
                [currentTopics[topicIndex], currentTopics[swapIndex]] = [currentTopics[swapIndex], currentTopics[topicIndex]];

                await updateDoc(docRef, { topics: currentTopics });

                fetchTopicsAdmin();
            } catch (err) {
                console.error('B≈ÇƒÖd przesuwania tematu:', err);
                alert('B≈ÇƒÖd podczas przesuwania tematu');
            }
        };

        window.clearTopicForm = () => {
            document.getElementById('topic-name').value = '';
            document.getElementById('topic-order').value = '';
        };

        window.cancelEditTopic = () => {
            document.getElementById('edit-topic-id').value = '';
            document.getElementById('edit-topic-name').value = '';
            document.getElementById('edit-topic-order').value = '';
        };

        window.refreshTopics = () => {
            fetchTopicsAdmin();
        };

        // Obs≈Çuga klawisza Enter w polu wiadomo≈õci
        document.addEventListener('DOMContentLoaded', () => {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        window.sendMessage();
                    }
                });
            }
        });

        // Sprawd≈∫ stan autoryzacji przy ≈Çadowaniu strony
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            updateUserPanel();
        });

        // === ZARZƒÑDZANIE AKCJAMI CHARYTATYWNYMI ===
        let charityList = [];

        window.refreshCharity = () => {
            fetchCharity();
        };

        async function fetchCharity() {
            try {
                const q = query(collection(db, "charity"), orderBy("order", "asc"));
                const snap = await getDocs(q);
                const list = document.getElementById('charity-list');
                list.innerHTML = "";
                charityList = [];

                if (snap.empty) {
                    list.innerHTML = '<div class="text-center text-zinc-500 py-8">Brak akcji charytatywnych</div>';
                    return;
                }

                snap.forEach(d => {
                    const charity = d.data();
                    charityList.push({ id: d.id, ...charity });

                    const eventDate = new Date(charity.date);
                    const isPast = eventDate < new Date();
                    const statusBadge = charity.active ? 'bg-green-600' : 'bg-gray-600';
                    const statusText = charity.active ? 'AKTYWNA' : 'NIEAKTYWNA';

                    list.innerHTML += `
                    <div class="bg-zinc-900/30 p-4 rounded-lg border-l-4 ${charity.active ? 'border-l-coyote' : 'border-l-zinc-600'}">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-white font-bold">${charity.title}</h4>
                                    <span class="px-2 py-1 text-xs rounded ${statusBadge} text-white">${statusText}</span>
                                    ${isPast ? '<span class="px-2 py-1 text-xs rounded bg-red-600 text-white">PRZESZ≈ÅA</span>' : ''}
                                </div>
                                <div class="text-sm text-zinc-400 space-y-1">
                                    <div>üìÖ ${eventDate.toLocaleString('pl-PL')}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="window.editCharity('${d.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Edytuj</button>
                                <button onclick="window.moveCharity('${d.id}', 'up')" class="text-zinc-400 hover:text-zinc-300 px-2 py-1 text-xs">‚Üë</button>
                                <button onclick="window.moveCharity('${d.id}', 'down')" class="text-zinc-400 hover:text-zinc-300 px-2 py-1 text-xs">‚Üì</button>
                                <button onclick="window.deleteCharity('${d.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usu≈Ñ</button>
                            </div>
                        </div>
                        <div class="text-sm text-zinc-300 mt-2">
                            ${charity.description.length > 150 ? charity.description.substring(0, 150) + '...' : charity.description}
                        </div>
                    </div>`;
                });
            } catch (err) {
                console.error('B≈ÇƒÖd ≈Çadowania akcji:', err);
                document.getElementById('charity-list').innerHTML = '<div class="text-center text-red-500 py-8">B≈ÇƒÖd ≈Çadowania akcji</div>';
            }
        }

        window.saveCharity = async () => {
            const id = document.getElementById('charity-id').value || Date.now().toString();
            const file = document.getElementById('charity-image').files[0];

            try {
                let imageUrl = "";
                if(file) {
                    // Kompresja obrazka
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    imageUrl = await new Promise((resolve) => {
                        reader.onload = (e) => {
                            const img = new Image(); img.src = e.target.result;
                            img.onload = () => {
                                const canvas = document.createElement('canvas');
                                const MAX_W = 800; let w = img.width, h = img.height;
                                if (w > MAX_W) { h *= MAX_W / w; w = MAX_W; }
                                canvas.width = w; canvas.height = h;
                                const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
                                resolve(canvas.toDataURL('image/jpeg', 0.7));
                            };
                        };
                    });
                } else if(document.getElementById('charity-id').value) {
                    const existing = charityList.find(c => c.id === id);
                    imageUrl = existing ? existing.image : "";
                }

                const charityData = {
                    title: document.getElementById('charity-title').value,
                    date: document.getElementById('charity-date').value,
                    description: document.getElementById('charity-description').value,
                    image: imageUrl,
                    active: document.getElementById('charity-active').checked,
                    order: charityList.length,
                    created: Date.now()
                };

                if (!charityData.title || !charityData.date || !charityData.description) {
                    alert('Wype≈Çnij wszystkie wymagane pola (tytu≈Ç, data, opis)');
                    return;
                }

                await setDoc(doc(db, "charity", id), charityData);
                alert('Akcja charytatywna zosta≈Ça zapisana!');
                clearCharityForm();
                fetchCharity();
            } catch (err) {
                console.error('B≈ÇƒÖd zapisywania akcji:', err);
                alert('B≈ÇƒÖd podczas zapisywania akcji');
            }
        };

        window.editCharity = (id) => {
            const charity = charityList.find(c => c.id === id);
            if (charity) {
                document.getElementById('charity-id').value = charity.id;
                document.getElementById('charity-title').value = charity.title;
                document.getElementById('charity-date').value = charity.date;
                document.getElementById('charity-description').value = charity.description;
                document.getElementById('charity-active').checked = charity.active !== false;
                document.getElementById('charity-image').value = ''; // Reset file input
            }
        };

        window.clearCharityForm = () => {
            document.getElementById('charity-id').value = '';
            document.getElementById('charity-title').value = '';
            document.getElementById('charity-date').value = '';
            document.getElementById('charity-description').value = '';
            document.getElementById('charity-active').checked = true;
            document.getElementById('charity-image').value = '';
        };

        window.moveCharity = async (id, direction) => {
            try {
                const charityIndex = charityList.findIndex(c => c.id === id);
                if (charityIndex === -1) return;

                let swapIndex;
                if (direction === 'up' && charityIndex > 0) {
                    swapIndex = charityIndex - 1;
                } else if (direction === 'down' && charityIndex < charityList.length - 1) {
                    swapIndex = charityIndex + 1;
                } else {
                    return;
                }

                // Zamie≈Ñ kolejno≈õciƒÖ w tablicy
                [charityList[charityIndex], charityList[swapIndex]] = [charityList[swapIndex], charityList[charityIndex]];

                // Zaktualizuj kolejno≈õƒá w bazie danych
                const batch = [];
                charityList.forEach((charity, index) => {
                    batch.push(updateDoc(doc(db, "charity", charity.id), { order: index }));
                });

                await Promise.all(batch);
                fetchCharity();
            } catch (err) {
                console.error('B≈ÇƒÖd przesuwania akcji:', err);
                alert('B≈ÇƒÖd podczas przesuwania akcji');
            }
        };

        window.deleteCharity = async (id) => {
            if (confirm('Czy na pewno chcesz usunƒÖƒá tƒô akcjƒô charytatywnƒÖ?')) {
                try {
                    await deleteDoc(doc(db, "charity", id));
                    fetchCharity();
                } catch (err) {
                    alert('B≈ÇƒÖd podczas usuwania akcji');
                }
            }
        };

    </script>
</body>
</html>/
