<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://strzelca.pl/ikona.svg"
    />
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg" />

    <title>Panel Administracyjny - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --coyote: #c19a6b;
      }

      /* Ustawienie tła na elemencie html dla Safari */
      html {
        background-color: #0a0a0a;
        background-image:
          linear-gradient(rgba(10,10,10,0.1) 0%, rgba(10,10,10,0.4) 50%, #0a0a0a 100%),
          url("https://strzelca.pl/tlo.png");
        background-size: cover;
        background-position: top center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        height: 100vh; /* Stała wysokość zamiast min-height */
        /* Safari viewport height fix */
        height: -webkit-fill-available;
        height: 100dvh; /* Dynamic viewport height for modern browsers */
        overflow: auto; /* Pozwól na scroll gdy potrzebne */
      }

      body {
        font-family: "Inter", sans-serif;
        background: transparent; /* Pozwól html pokazać tło */
        color: #e5e5e5;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh; /* Stała wysokość zamiast min-height */
        /* Safari viewport height fix */
        height: -webkit-fill-available;
        height: 100dvh; /* Dynamic viewport height for modern browsers */
        overflow-y: auto; /* Pozwól na pionowy scroll gdy potrzebne */
        overflow-x: hidden; /* Blokuj poziomy scroll */
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }
      .admin-text {
        color: #dc2626;
        font-family: "Orbitron";
      }

      input,
      select,
      textarea {
        background: #111 !important;
        border: 1px solid #222 !important;
        color: white !important;
        padding: 12px 16px !important;
        border-radius: 8px;
        width: 100%;
        outline: none;
        transition: 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--coyote) !important;
        background: #161616 !important;
      }

      .btn-admin {
        background: var(--coyote);
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 12px 24px;
        border-radius: 8px;
        transition: 0.3s;
        cursor: pointer;
      }
      .btn-admin:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(193, 154, 107, 0.3);
      }
      .btn-admin:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      .admin-card {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 24px;
        transition: 0.3s;
      }
      .admin-card:hover {
        border-color: var(--coyote);
      }

      .sidebar-nav {
        background: #111;
        border-right: 1px solid #222;
        min-height: calc(100vh - 73px);
      }

      .nav-item {
        padding: 12px 16px;
        border-bottom: 1px solid #222;
        cursor: pointer;
        transition: 0.3s;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .nav-item:hover,
      .nav-item.active {
        background: var(--coyote);
        color: black;
        border-color: var(--coyote);
      }

      .admin-name {
        color: var(--coyote);
        font-family: "Orbitron";
        font-weight: 700;
      }

      .editor-content {
        background: #161616;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 16px;
        min-height: 200px;
        color: white;
      }

      .toolbar {
        background: #111;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
      }
      .toolbar button {
        background: #222;
        border: none;
        color: white;
        padding: 8px 12px;
        margin: 0 2px;
        border-radius: 4px;
        cursor: pointer;
        transition: 0.3s;
      }
      .toolbar button:hover {
        background: var(--coyote);
        color: black;
      }

      .status-active {
        border-left: 4px solid #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
      .status-blocked {
        border-left: 4px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }
      .status-suspended {
        border-left: 4px solid #f59e0b;
        background: rgba(245, 158, 11, 0.1);
      }

      .role-admin {
        background: #dc2626;
        color: white;
      }
      .role-user {
        background: white;
        color: black;
      }
      .role-company {
        background: var(--coyote);
        color: black;
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Style dla checkbox "Zapamiętaj STRZELCA" */
      input[type="checkbox"] {
        width: auto !important;
      }

      .text-stacked {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Nawigacja -->
    <nav
      class="h-[73px] border-b border-zinc-900 sticky top-0 bg-black/95 z-50 backdrop-blur-md flex items-center relative"
    >
      <a
        href="https://admin.strzelca.pl"
        class="absolute left-4 md:left-8 text-zinc-500 hover:text-white transition text-xl"
      >
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div class="container mx-auto px-6 flex justify-center">
        <div
          class="uppercase font-bold text-[11px] tracking-[0.3em] font-[Orbitron] text-zinc-400"
        >
          ADMIN.<span class="coyote-text">STRZELCA</span>.PL
        </div>
      </div>
    </nav>

    <!-- Sekcja logowania -->
    <div
      id="login-section"
      class="h-full flex items-start justify-center p-6 pt-20"
    >
      <div class="admin-card max-w-md w-full">
        <h1
          class="text-3xl font-black uppercase italic font-[Orbitron] text-center mb-8"
        >
          <span class="coyote-text">PANEL</span>
          <span class="admin-text">ADMINISTRATORA</span>
        </h1>

        <form id="admin-login-form" class="space-y-6">
          <div>
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Login administratora</label
            >
            <input
              type="text"
              id="admin-email"
              placeholder="Login administratora"
              required
            />
          </div>

          <div>
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Hasło administratora</label
            >
            <input
              type="password"
              id="admin-password"
              placeholder="Hasło administratora"
              required
            />
          </div>

          <div class="flex items-center justify-center mb-6">
            <input type="checkbox" id="admin-remember-me" class="hidden">
            <div class="flex flex-col items-center cursor-pointer" id="admin-remember-toggle">
              <span id="admin-remember-text-1" class="text-[10px] uppercase tracking-[0.15em] font-medium text-zinc-400 block text-center transition-colors">Zapamiętaj</span>
              <span id="admin-remember-text-2" class="text-[10px] uppercase tracking-[0.15em] font-medium text-zinc-400 block text-center w-full transition-colors">STRZELCA</span>
            </div>
          </div>

          <button type="submit" class="btn-admin w-full">
            <i class="fa-solid fa-sign-in-alt mr-2"></i>
            ZALOGUJ
          </button>
        </form>

        <div
          id="login-status"
          class="mt-6 p-4 rounded-lg text-center text-sm hidden"
        ></div>
      </div>
    </div>

    <!-- Główny panel administracyjny -->
    <div id="admin-panel" class="hidden h-full flex">
      <!-- Sidebar nawigacji -->
      <div class="sidebar-nav w-64">
        <div class="p-6 border-b border-zinc-800">
          <div class="flex items-center space-x-3 mb-4">
            <i class="fa-solid fa-user-shield text-coyote text-xl"></i>
            <div>
              <div id="admin-display-name" class="text-white text-lg"></div>
              <div id="admin-role" class="admin-text text-sm">
                @Administrator
              </div>
            </div>
          </div>
          <button
            onclick="logoutAdmin()"
            class="w-full bg-red-700 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition text-sm"
          >
            <i class="fa-solid fa-sign-out-alt mr-2"></i>
            Wyloguj
          </button>
        </div>

        <nav class="py-4">
          <div class="nav-item" data-tab="dashboard">
            <i class="fa-solid fa-tachometer-alt mr-3"></i>
            Dashboard
          </div>
          <div class="nav-item" data-tab="czat">
            <i class="fa-solid fa-comments mr-3"></i>
            Czat
          </div>
          <div class="nav-item" data-tab="konta">
            <i class="fa-solid fa-users mr-3"></i>
            Konta
          </div>
          <div class="nav-item" data-tab="sklep">
            <i class="fa-solid fa-shopping-cart mr-3"></i>
            Sklep
          </div>
          <div class="nav-item" data-tab="bazar">
            <i class="fa-solid fa-store mr-3"></i>
            Bazar
          </div>
          <div class="nav-item" data-tab="szkolenia">
            <i class="fa-solid fa-graduation-cap mr-3"></i>
            Szkolenia
          </div>
          <div class="nav-item" data-tab="wydarzenia">
            <i class="fa-solid fa-calendar-alt mr-3"></i>
            Wydarzenia
          </div>
          <div class="nav-item" data-tab="blog">
            <i class="fa-solid fa-blog mr-3"></i>
            Blog
          </div>
          <div class="nav-item" data-tab="pomoc">
            <i class="fa-solid fa-heart mr-3"></i>
            Pomoc
          </div>
          <div class="nav-item" data-tab="dokumenty">
            <i class="fa-solid fa-file-alt mr-3"></i>
            Dokumenty
          </div>
          <div class="nav-item" data-tab="kontakt">
            <i class="fa-solid fa-envelope mr-3"></i>
            Kontakt
          </div>
        </nav>
      </div>

      <!-- Główna zawartość -->
      <div class="flex-1 p-8">
        <!-- Dashboard -->
        <div id="tab-dashboard" class="tab-content active">
          <h1 class="text-3xl font-bold coyote-text mb-8 text-center">
            Dashboard Administratora
          </h1>

          <!-- Sekcja 1: Aktywność -->
          <div class="admin-card mb-8">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold coyote-text">Aktywność</h2>
              <button
                onclick="refreshActivitySection()"
                class="btn-admin text-sm px-3 py-1"
                title="Odśwież sekcję Aktywność"
              >
                <i class="fa-solid fa-sync-alt mr-1"></i>
                Odśwież
              </button>
              </div>

            <!-- Główny kontener z podziałem na sekcje -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6" style="height: 280px;">
              <!-- Lewa część: Aktywność użytkowników (50% szer, 70% wys) -->
              <div class="bg-zinc-800/50 rounded-lg p-4 flex flex-col justify-center">
                <h3 class="text-lg font-semibold text-white mb-4 text-center">Aktywność</h3>
                <div class="space-y-4 flex-1 flex flex-col justify-center">
                  <div class="text-center">
                    <div class="text-2xl font-bold coyote-text mb-1" id="active-logged-users">0</div>
                    <div class="text-sm text-zinc-400">Zalogowani</div>
              </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold coyote-text mb-1" id="active-guests">0</div>
                    <div class="text-sm text-zinc-400">Goście</div>
            </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-400 mb-1" id="active-total">0</div>
                    <div class="text-sm text-zinc-400">Razem</div>
              </div>
              </div>
            </div>

              <!-- Prawa część: Sprawy (50% szer, 70% wys) -->
              <div class="bg-zinc-800/50 rounded-lg p-4 flex flex-col justify-center">
                <h3 class="text-lg font-semibold text-white mb-4 text-center">Sprawy</h3>
                <div class="space-y-4 flex-1 flex flex-col justify-center">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-red-400 mb-1" id="pending-issues">0</div>
                    <div class="text-sm text-zinc-400">Niezakończone</div>
              </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-400 mb-1" id="new-forms-today">0</div>
                    <div class="text-sm text-zinc-400">Nowe formularze</div>
              </div>
                  <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400 mb-1" id="total-issues">0</div>
                    <div class="text-sm text-zinc-400">Razem</div>
            </div>
            </div>
              </div>
            </div>

            <!-- Dolna część: Odwiedziny (100% szer, 30% wys) -->
            <div class="bg-zinc-800/50 rounded-lg p-4" style="height: 120px;">
              <h3 class="text-lg font-semibold text-white mb-4 text-center">Odwiedziny</h3>
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 h-full">
                <div class="text-center">
                  <div class="text-xl font-bold text-blue-400 mb-1" id="visits-today">0</div>
                  <div class="text-xs text-zinc-400">Dziś</div>
                </div>
                <div class="text-center">
                  <div class="text-xl font-bold text-blue-400 mb-1" id="visits-week">0</div>
                  <div class="text-xs text-zinc-400">Tydzień</div>
                </div>
                <div class="text-center">
                  <div class="text-xl font-bold text-blue-400 mb-1" id="visits-month">0</div>
                  <div class="text-xs text-zinc-400">Miesiąc</div>
                </div>
                <div class="text-center">
                  <div class="text-xl font-bold text-blue-400 mb-1" id="visits-year">0</div>
                  <div class="text-xs text-zinc-400">Rok</div>
                </div>
                <div class="text-center">
                  <div class="text-xl font-bold text-blue-400 mb-1" id="visits-total">0</div>
                  <div class="text-xs text-zinc-400">Ogółem</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Sekcja 2: System Serwera -->
          <div class="admin-card mb-8">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold coyote-text">System Serwera</h2>
              <button
                onclick="checkMainServicesStatus()"
                class="btn-admin text-sm px-3 py-1"
              >
                <i class="fa-solid fa-sync-alt mr-1"></i>
                Odśwież
              </button>
              </div>

            <!-- Główny status serwera - kompaktowy design -->
            <div class="bg-zinc-800/50 rounded-xl p-6 mb-8">

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Status bazy danych -->
                <div class="text-center">
                  <div class="flex items-center justify-center space-x-3 mb-2">
                    <i class="fa-solid fa-database text-lg text-zinc-400"></i>
                    <span class="text-sm font-medium text-zinc-300">Baza danych</span>
              </div>
                  <div class="flex items-center justify-center space-x-2" id="firestore-status">
                    <span class="text-green-400"><i class="fa-solid fa-check-circle text-lg"></i></span>
                    <span class="text-green-400 font-semibold text-sm">Online</span>
            </div>
          </div>

                <!-- Status logowania -->
                <div class="text-center">
                  <div class="flex items-center justify-center space-x-3 mb-2">
                    <i class="fa-solid fa-user-shield text-lg text-zinc-400"></i>
                    <span class="text-sm font-medium text-zinc-300">Logowanie</span>
                  </div>
                  <div class="flex items-center justify-center space-x-2" id="auth-status">
                    <span class="text-green-400"><i class="fa-solid fa-check-circle text-lg"></i></span>
                    <span class="text-green-400 font-semibold text-sm">Połączony</span>
              </div>
            </div>

                <!-- Status domeny -->
                <div class="text-center">
                  <div class="flex items-center justify-center space-x-3 mb-2">
                    <i class="fa-solid fa-globe text-lg text-zinc-400"></i>
                    <span class="text-sm font-medium text-zinc-300">Domena</span>
                  </div>
                  <div class="flex items-center justify-center space-x-2" id="domain-status">
                    <span class="text-green-400"><i class="fa-solid fa-check-circle text-lg"></i></span>
                    <span class="text-green-400 font-semibold text-sm">Online</span>
                  </div>
                </div>
              </div>
            </div>

            <h3 class="text-lg font-bold mb-4">Status wszystkich subdomen</h3>
            <div
              class="grid grid-cols-1 md:grid-cols-2 gap-3"
              id="sites-status"
            >
              <!-- Status stron będzie ładowany dynamicznie -->
                </div>

            <div class="mt-4 text-sm text-zinc-400 text-center">
              <span
                >Ostatnie sprawdzenie:
                <span id="last-status-check">Teraz</span></span
                  >
                </div>
          </div>


          <!-- Sekcja 3: Zdarzenia -->
          <div class="admin-card">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-2xl font-bold coyote-text">Zdarzenia</h2>
              <div class="flex space-x-2">
                <button
                  onclick="refreshEvents()"
                  class="btn-admin text-sm px-3 py-1"
                >
                  <i class="fa-solid fa-sync-alt mr-1"></i>
                  Odśwież
                </button>
                <button
                  onclick="openEventsPanel()"
                  class="btn-admin text-sm px-3 py-1"
                >
                  <i class="fa-solid fa-list mr-1"></i>
                  Wszystkie
                </button>
                </div>
                </div>

            <div id="recent-events" class="space-y-3">
              <!-- Najnowsze zdarzenia będą ładowane dynamicznie -->
              </div>

            <div class="mt-4 text-sm text-zinc-400 text-center">
              <span
                >Ostatnia aktualizacja:
                <span id="last-events-update">Teraz</span></span
                  >
            </div>
          </div>
        </div>

        <!-- Zarządzanie użytkownikami -->
        <div id="tab-users" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              Zarządzanie Użytkownikami
            </h1>
            <button
              onclick="refreshUsers()"
              class="btn-admin text-sm px-3 py-2"
            >
              <i class="fa-solid fa-sync-alt mr-1"></i>
              Odśwież
            </button>
          </div>

          <!-- Sekcja najnowszych użytkowników -->
          <div class="admin-card mb-8">
            <h3 class="text-xl font-bold mb-4">Najnowsi użytkownicy</h3>
            <div id="recent-users" class="flex gap-3 overflow-x-auto pb-2">
              <!-- Najnowsi użytkownicy będą ładowani dynamicznie jako kafelki -->
            </div>
          </div>

          <div class="admin-card mb-6">
            <div class="flex flex-wrap gap-4 mb-4">
              <button
                onclick="filterUsers('all')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase active border-coyote text-coyote"
                data-filter="all"
              >
                Wszyscy
              </button>
              <button
                onclick="filterUsers('active')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="active"
              >
                Aktywni
              </button>
              <button
                onclick="filterUsers('blocked')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="blocked"
              >
                Zablokowani
              </button>
              <button
                onclick="filterUsers('admin')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="admin"
              >
                Admini
              </button>
              <button
                onclick="filterUsers('company')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="company"
              >
                Firmy
              </button>
            </div>
            <div
              id="users-list"
              class="space-y-4 max-h-[600px] overflow-y-auto"
            >
              <!-- Lista użytkowników będzie ładowana dynamicznie -->
            </div>
          </div>
        </div>

        <!-- Zarządzanie produktami -->
        <div id="tab-products" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              Zarządzanie Produktami
            </h1>
            <button onclick="refreshProducts()" class="btn-admin">
              <i class="fa-solid fa-sync-alt mr-2"></i>
              Odśwież
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Dodaj/Edytuj Produkt</h3>
              <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id" />
                <input
                  type="text"
                  id="product-title"
                  placeholder="Nazwa produktu"
                  required
                />
                <input
                  type="text"
                  id="product-price"
                  placeholder="Cena (np. 299.99)"
                  required
                />

                <div class="toolbar">
                  <button type="button" onclick="formatText('bold')">
                    <i class="fa-solid fa-bold"></i>
                  </button>
                  <button
                    type="button"
                    onclick="formatText('insertUnorderedList')"
                  >
                    <i class="fa-solid fa-list-ul"></i>
                  </button>
                  <button type="button" onclick="formatText('justifyCenter')">
                    <i class="fa-solid fa-align-center"></i>
                  </button>
                  <button type="button" onclick="insertImage()">
                    <i class="fa-solid fa-image"></i>
                  </button>
                </div>

                <div
                  id="product-description"
                  class="editor-content"
                  contenteditable="true"
                  placeholder="Opis produktu..."
                ></div>

                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Zdjęcie główne:</label
                  >
                  <input
                    type="file"
                    id="product-image"
                    accept="image/*"
                    class="text-sm"
                  />
                </div>

                <button type="submit" class="btn-admin w-full">
                  <i class="fa-solid fa-save mr-2"></i>
                  Zapisz produkt
                </button>
              </form>
            </div>

            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Lista Produktów</h3>
              <div
                id="products-list"
                class="space-y-3 max-h-[500px] overflow-y-auto"
              >
                <!-- Lista produktów będzie ładowana dynamicznie -->
              </div>
            </div>
          </div>
        </div>

        <!-- Wiadomości -->
        <div id="tab-messages" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Zarządzanie Wiadomościami
          </h1>
          <div class="admin-card">
            <div id="messages-list" class="space-y-4">
              <!-- Lista wiadomości będzie ładowana dynamicznie -->
            </div>
          </div>
        </div>

        <!-- Czaty -->
        <div id="tab-chats" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Zarządzanie Czatami
          </h1>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[600px]">
            <!-- Lista konwersacji -->
            <div class="admin-card">
              <h3 class="text-lg font-bold mb-4">Konwersacje</h3>
              <div
                id="conversations-list"
                class="space-y-2 overflow-y-auto max-h-[500px]"
              >
                <!-- Lista konwersacji będzie ładowana dynamicznie -->
              </div>
            </div>

            <!-- Okno czatu -->
            <div class="admin-card lg:col-span-2">
              <div id="chat-header" class="border-b border-zinc-700 pb-4 mb-4">
                <h3 class="text-lg font-bold">Wybierz konwersację</h3>
              </div>
              <div
                id="chat-messages"
                class="space-y-3 max-h-[400px] overflow-y-auto mb-4"
              >
                <!-- Wiadomości będą ładowane dynamicznie -->
              </div>
              <div id="chat-input" class="flex space-x-2 hidden">
                <input
                  type="text"
                  id="message-input"
                  placeholder="Wpisz wiadomość..."
                  class="flex-1"
                />
                <button onclick="sendMessage()" class="btn-admin px-4">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Wydarzenia -->
        <div id="tab-events" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Zarządzanie Wydarzeniami
          </h1>
          <div class="admin-card">
            <div id="events-list" class="space-y-4">
              <!-- Lista wydarzeń będzie ładowana dynamicznie -->
            </div>
          </div>
        </div>

        <!-- Pomoc Charytatywna -->
        <div id="tab-charity" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Pomoc Charytatywna
          </h1>
          <div class="admin-card">
            <div id="charity-content">
              <!-- Zawartość pomocy charytatywnej będzie ładowana dynamicznie -->
            </div>
          </div>
        </div>

        <!-- Moderacja opinii użytkowników -->
        <div id="tab-reviews" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Moderacja Opinii Użytkowników
          </h1>

          <div class="admin-card">
            <div class="flex justify-between items-center mb-6">
              <h3 class="text-xl font-bold">Wszystkie opinie</h3>
              <div class="flex space-x-2">
                <select
                  id="reviews-filter"
                  class="px-3 py-2 bg-zinc-800 border border-zinc-600 rounded"
                >
                  <option value="all">Wszystkie</option>
                  <option value="pending">Oczekujące</option>
                  <option value="approved">Zatwierdzone</option>
                  <option value="rejected">Odrzucone</option>
                </select>
              </div>
            </div>

            <div id="reviews-list" class="space-y-4">
              <!-- Opinie będą ładowane dynamicznie -->
            </div>

            <div id="reviews-loading" class="text-center py-8 text-zinc-400">
              <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
              <p>Ładowanie opinii...</p>
            </div>

            <div
              id="reviews-empty"
              class="text-center py-8 text-zinc-400 hidden"
            >
              <i class="fa-solid fa-star text-4xl mb-4 text-zinc-600"></i>
              <p>Brak opinii do wyświetlenia</p>
            </div>
          </div>
        </div>

        <!-- Ustawienia systemu -->
        <div id="tab-settings" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Ustawienia Systemu
          </h1>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Ustawienia Kontaktowe</h3>
              <form id="contact-settings" class="space-y-4">
                <input
                  type="text"
                  id="contact-name"
                  placeholder="Imię i nazwisko"
                />
                <input
                  type="text"
                  id="contact-email"
                  placeholder="Email kontaktowy"
                />
                <textarea
                  id="contact-message"
                  placeholder="Treść wiadomości"
                  rows="3"
                ></textarea>
                <button type="submit" class="btn-admin w-full">
                  <i class="fa-solid fa-save mr-2"></i>
                  Zapisz ustawienia
                </button>
              </form>
            </div>

            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Tematy Wiadomości</h3>
              <div class="flex space-x-2 mb-4">
                <input
                  type="text"
                  id="new-topic"
                  placeholder="Nowy temat..."
                  class="flex-1"
                />
                <button onclick="addTopic()" class="btn-admin px-4">
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>
              <div id="topics-list" class="space-y-2">
                <!-- Lista tematów będzie ładowana dynamicznie -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal szczegółów użytkownika -->
    <div
      id="user-details-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold coyote-text">Szczegóły Użytkownika</h2>
          <div class="flex space-x-2">
            <button
              onclick="editUserDetails()"
              class="btn-admin text-sm px-3 py-1"
            >
              <i class="fa-solid fa-edit mr-1"></i>
              Edytuj
            </button>
          <button
            onclick="closeUserDetails()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6">
          <div class="flex space-x-1 bg-zinc-800 p-1 rounded-lg">
            <button
              onclick="switchUserTab('details')"
              class="user-tab-btn active px-4 py-2 text-sm rounded"
              data-tab="details"
            >
              Szczegóły
            </button>
            <button
              onclick="switchUserTab('activity')"
              class="user-tab-btn px-4 py-2 text-sm rounded"
              data-tab="activity"
            >
              Aktywność
            </button>
          </div>
        </div>

        <div id="user-details-content">
          <!-- Szczegóły użytkownika będą ładowane dynamicznie -->
        </div>
      </div>
    </div>

    <!-- Modal menu akcji użytkownika -->
    <div
      id="user-action-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-md w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">Wybierz akcję</h2>
          <button
            onclick="closeUserActionMenu()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="action-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o użytkowniku będą ładowane dynamicznie -->
        </div>

        <div class="space-y-4">
          <button onclick="openBlockModal()" class="w-full bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded-lg transition-colors">
            <i class="fa-solid fa-ban mr-2"></i>
            Zablokuj użytkownika
          </button>
          <button onclick="openDeleteModal()" class="w-full bg-red-800 hover:bg-red-700 text-white px-4 py-3 rounded-lg transition-colors">
            <i class="fa-solid fa-trash mr-2"></i>
            Usuń użytkownika
          </button>
        </div>
      </div>
    </div>

    <!-- Modal edycji użytkownika -->
    <div
      id="user-edit-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold coyote-text">Edycja Użytkownika</h2>
          <button
            onclick="closeUserEdit()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <form id="user-edit-form" class="space-y-6">
          <!-- Dane podstawowe -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-bold mb-4">Dane podstawowe</h3>
              <div class="space-y-4">
                <input type="hidden" id="edit-user-id" />
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Nazwa wyświetlana</label
                  >
                  <input
                    type="text"
                    id="edit-display-name"
                    placeholder="Nazwa wyświetlana"
                    required
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Email</label>
                  <input
                    type="email"
                    id="edit-email"
                    placeholder="Email"
                    required
                    disabled
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Imię</label>
                  <input type="text" id="edit-first-name" placeholder="Imię" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Nazwisko</label
                  >
                  <input
                    type="text"
                    id="edit-last-name"
                    placeholder="Nazwisko"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Telefon</label
                  >
                  <input type="tel" id="edit-phone" placeholder="Telefon" />
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-4">Adres dostawy</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Ulica</label>
                  <input type="text" id="edit-street" placeholder="Ulica" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Numer budynku</label
                  >
                  <input
                    type="text"
                    id="edit-building-number"
                    placeholder="Numer budynku"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Kod pocztowy</label
                  >
                  <input
                    type="text"
                    id="edit-postal-code"
                    placeholder="Kod pocztowy"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Miasto</label>
                  <input type="text" id="edit-city" placeholder="Miasto" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Paczkomat</label
                  >
                  <input
                    type="text"
                    id="edit-parcel-locker"
                    placeholder="Paczkomat"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Dane firmy (tylko dla roli firma) -->
          <div id="company-fields" class="grid grid-cols-1 md:grid-cols-2 gap-6" style="display: none;">
            <div>
              <h3 class="text-lg font-bold mb-4">Dane Firmy</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Nazwa firmy</label>
                  <input type="text" id="edit-company-name" placeholder="Nazwa firmy" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">NIP</label>
                  <input type="text" id="edit-company-nip" placeholder="Numer NIP" />
                </div>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-bold mb-4">Adres Firmy</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Ulica</label>
                  <input type="text" id="edit-company-street" placeholder="Ulica firmy" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Numer budynku</label>
                  <input type="text" id="edit-company-building-number" placeholder="Numer budynku" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Kod pocztowy</label>
                  <input type="text" id="edit-company-postal-code" placeholder="Kod pocztowy" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Miasto</label>
                  <input type="text" id="edit-company-city" placeholder="Miasto firmy" />
                </div>
              </div>
            </div>
          </div>

          <!-- Preferencje i status -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-bold mb-4">Preferencje</h3>
              <div class="space-y-4">
                <div class="flex items-center space-x-3">
                  <input type="checkbox" id="edit-newsletter" />
                  <label for="edit-newsletter" class="text-sm"
                    >Newsletter</label
                  >
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-4">Status konta</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Rola</label>
                  <select id="edit-role" class="w-full">
                    <option value="user">Użytkownik</option>
                    <option value="company">Firma</option>
                    <option value="admin">Administrator</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Status</label>
                  <select id="edit-status" class="w-full">
                    <option value="active">Aktywny</option>
                    <option value="blocked">Zablokowany</option>
                    <option value="suspended">Zawieszony</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Przyciski -->
          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserEdit()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin">
              <i class="fa-solid fa-save mr-2"></i>
              Zapisz zmiany
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal blokowania użytkownika -->
    <div
      id="user-block-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">
            Blokowanie Użytkownika
          </h2>
          <button
            onclick="closeUserBlock()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="block-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o użytkowniku będą ładowane dynamicznie -->
        </div>

        <form id="user-block-form" class="space-y-6">
          <input type="hidden" id="block-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-2">Czas blokady</label>
            <select id="block-duration" class="w-full" required>
              <option value="15min">15 minut</option>
              <option value="1hour">1 godzina</option>
              <option value="6hours">6 godzin</option>
              <option value="24hours">24 godziny</option>
              <option value="7days">7 dni</option>
              <option value="30days">30 dni</option>
              <option value="permanent">Na zawsze (blokada permanentna)</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-400 block mb-4"
              >Opcje zawartości konta</label
            >
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="keep-content"
                  name="content-action"
                  value="keep"
                  checked
                />
                <label for="keep-content" class="text-sm"
                  >Zachowaj zawartość konta (produkty, czaty, itp.)</label
                >
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="remove-content"
                  name="content-action"
                  value="remove"
                />
                <label for="remove-content" class="text-sm"
                  >Usuń zawartość konta (produkty, czaty, itp.)</label
                >
              </div>
            </div>
          </div>

          <div class="p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-bold mb-2">⚠️ Ostrzeżenie</h4>
            <p class="text-sm text-zinc-300">
              Blokada konta oznacza całkowite "uśmiercenie" konta - brak
              możliwości korzystania ze strony, pisania na czatach, odczytywania
              czatów, dodawania/edycji produktów na bazarze itp. Bez możliwości
              odblokowania przez email.
            </p>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserBlock()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-red-600 hover:bg-red-500">
              <i class="fa-solid fa-ban mr-2"></i>
              Zablokuj użytkownika
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal usuwania użytkownika -->
    <div
      id="user-delete-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">Usuwanie Użytkownika</h2>
          <button
            onclick="closeUserDelete()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="delete-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o użytkowniku będą ładowane dynamicznie -->
        </div>

        <form id="user-delete-form" class="space-y-6">
          <input type="hidden" id="delete-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-4"
              >Opcje zawartości konta</label
            >
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="delete-keep-content"
                  name="delete-content-action"
                  value="keep"
                  checked
                />
                <label for="delete-keep-content" class="text-sm"
                  >Zachowaj zawartość konta (produkty, czaty, komentarze)</label
                >
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="delete-remove-content"
                  name="delete-content-action"
                  value="remove"
                />
                <label for="delete-remove-content" class="text-sm"
                  >Całkowicie usuń zawartość konta</label
                >
              </div>
            </div>
          </div>

          <div class="p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-bold mb-2">⚠️ Ostrzeżenie</h4>
            <p class="text-sm text-zinc-300 mb-2">
              Usunięcie konta jest operacją nieodwracalną. Użytkownik zostanie
              całkowicie usunięty z systemu.
            </p>
            <p class="text-sm text-zinc-300">
              Jeśli wybierzesz "Zachowaj zawartość", produkty, wiadomości i inne
              dane użytkownika pozostaną w systemie, ale będą oznaczone jako "od
              usuniętego użytkownika".
            </p>
          </div>

          <div
            class="flex items-center space-x-3 p-4 bg-yellow-900/20 border border-yellow-700 rounded-lg"
          >
            <input type="checkbox" id="delete-confirm" required />
            <label for="delete-confirm" class="text-sm">
              Potwierdzam, że chcę całkowicie usunąć tego użytkownika z systemu
            </label>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserDelete()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-red-600 hover:bg-red-500">
              <i class="fa-solid fa-trash mr-2"></i>
              Usuń użytkownika
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal zmiany roli użytkownika -->
    <div
      id="user-role-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-purple-400">
            Zmiana Roli Użytkownika
          </h2>
          <button
            onclick="closeUserRole()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="role-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o użytkowniku będą ładowane dynamicznie -->
        </div>

        <form id="user-role-form" class="space-y-6">
          <input type="hidden" id="role-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-4">Nowa rola</label>
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="role-user"
                  name="new-role"
                  value="user"
                  checked
                />
                <label for="role-user" class="text-sm">
                  <span class="font-bold text-white">UŻYTKOWNIK</span> - podstawowe uprawnienia
                </label>
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="role-company"
                  name="new-role"
                  value="company"
                />
                <label for="role-company" class="text-sm">
                  <span class="font-bold text-blue-400">FIRMA</span> - może zarządzać produktami, dodatkowymi polami firmy
                </label>
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="role-admin"
                  name="new-role"
                  value="admin"
                />
                <label for="role-admin" class="text-sm">
                  <span class="font-bold text-red-400">ADMINISTRATOR</span> - pełny dostęp do panelu administracyjnego
                </label>
              </div>
            </div>
          </div>

          <div class="p-4 bg-blue-900/20 border border-blue-700 rounded-lg">
            <h4 class="text-blue-400 font-bold mb-2">ℹ️ Informacja</h4>
            <p class="text-sm text-zinc-300">
              Zmiana roli użytkownika może wpłynąć na jego uprawnienia w systemie.
              Administratorzy mają dostęp do wszystkich funkcji panelu administracyjnego.
            </p>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserRole()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-purple-600 hover:bg-purple-500">
              <i class="fa-solid fa-user-tag mr-2"></i>
              Zmień rolę
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        getDocs,
        collection,
        query,
        orderBy,
        updateDoc,
        deleteDoc,
        setDoc,
        where,
        limit,
        addDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD_gXFh3a4NW9Hzzsr5IQuDADM2GVpPMVc",
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.firebasestorage.app",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let currentTab = "dashboard";
      let activeUserFilters = ["all"]; // Tablica aktywnych filtrów - domyślnie "all"
      let usersList = [];
      let productsList = [];
      let currentConversationId = null;
      let pendingTasksListener = null;

      // Local admin credentials (maximum security - both login and password are separately hashed)
      // This provides additional protection as attackers cannot even determine valid login format
      // TODO: Remove this local account after development is complete
      const LOCAL_ADMIN_LOGIN_SALT = "4466ced4492c60362eee23b352e3cb96";
      const LOCAL_ADMIN_LOGIN_HASH =
        "7bdf6dd287fc736472689a5b15a92965caddb5c8bb29d852900552846501a354";
      const LOCAL_ADMIN_PASSWORD_SALT = "083130d3faf39aef060851b93a7e2e53";
      const LOCAL_ADMIN_PASSWORD_HASH =
        "6cf58636e6399062c47f200860c9f6e67739faa454a4ecfff6fb42e9fd80c4d8";

      // Funkcja hashowania hasła (Web Crypto API dla przeglądarki)
      async function hashPassword(password, salt, iterations = 10000) {
        let hash = password + salt;
        for (let i = 0; i < iterations; i++) {
          const encoder = new TextEncoder();
          const data = encoder.encode(hash);
          const buffer = await crypto.subtle.digest("SHA-256", data);
          hash = Array.from(new Uint8Array(buffer))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
        }
        return hash;
      }

      // Sprawdzanie lokalnego logowania administratora (oba pola zahashowane)
      async function checkLocalAdmin(login, password) {
        // Sprawdź konto testowe (prostsze rozwiązanie dla testów)
        if (login === "test1" && password === "test1") {
          return true;
        }

        // Sprawdź główne konto administratora
        const hashedLogin = await hashPassword(login, LOCAL_ADMIN_LOGIN_SALT);
        if (hashedLogin === LOCAL_ADMIN_LOGIN_HASH) {
        const hashedPassword = await hashPassword(
          password,
          LOCAL_ADMIN_PASSWORD_SALT,
        );
          if (hashedPassword === LOCAL_ADMIN_PASSWORD_HASH) {
            return true;
          }
        }

        return false;
      }

      // Funkcja logowania aktywności
      async function logActivity(
        userId,
        action,
        details = {},
        targetUserId = null,
      ) {
        try {
          const activityData = {
            userId: userId,
            action: action,
            details: details,
            targetUserId: targetUserId,
            timestamp: new Date(),
            adminId: currentUser ? currentUser.uid : null,
            ipAddress: null, // Można dodać jeśli dostępny
            userAgent: navigator.userAgent,
          };

          await addDoc(collection(db, "userActivity"), activityData);
        } catch (error) {
          console.error("Error logging activity:", error);
          // Nie pokazujemy błędu użytkownikowi, żeby nie przeszkadzać w normalnej pracy
        }
      }

      // Funkcje pomocnicze
      function showStatus(message, isError = false) {
        const statusEl = document.getElementById("login-status");
        statusEl.textContent = message;
        statusEl.className = `mt-6 p-4 rounded-lg text-center text-sm ${isError ? "bg-red-900/50 text-red-300 border border-red-700" : "bg-green-900/50 text-green-300 border border-green-700"}`;
        statusEl.style.display = "block";

        setTimeout(() => {
          statusEl.style.display = "none";
        }, 5000);
      }

      function showNotification(message, type = "success") {
        // Prosta implementacja powiadomień - można rozszerzyć
        console.log(`${type}: ${message}`);
      }

      // Funkcje zarządzania sesją administratora
      function saveAdminSession(user, loginType = 'firebase', rememberMe = false) {
        // Czas wygaśnięcia: 2 godziny domyślnie, 1 tydzień jeśli "zapamiętaj mnie"
        const expiryTime = rememberMe
          ? (7 * 24 * 60 * 60 * 1000) // 1 tydzień
          : (2 * 60 * 60 * 1000); // 2 godziny

        const sessionData = {
          user: {
            uid: user.uid,
            email: user.email,
            displayName: user.displayName,
            isLocalAdmin: user.isLocalAdmin || false,
            originalLogin: user.originalLogin || null
          },
          loginType: loginType,
          rememberMe: rememberMe,
          timestamp: Date.now(),
          expiresAt: Date.now() + expiryTime
        };

        try {
          localStorage.setItem('admin_session', JSON.stringify(sessionData));
        } catch (error) {
          console.warn('Nie można zapisać sesji administratora:', error);
        }
      }

      function loadAdminSession() {
        try {
          const sessionData = localStorage.getItem('admin_session');
          if (!sessionData) return null;

          const session = JSON.parse(sessionData);

          // Sprawdź czy sesja nie wygasła
          if (Date.now() > session.expiresAt) {
            clearAdminSession();
            return null;
          }

          return session;
        } catch (error) {
          console.warn('Błąd podczas ładowania sesji:', error);
          clearAdminSession();
          return null;
        }
      }

      function clearAdminSession() {
        try {
          localStorage.removeItem('admin_session');
        } catch (error) {
          console.warn('Nie można usunąć sesji administratora:', error);
        }
      }

      function isSessionExpired() {
        const session = loadAdminSession();
        return session === null;
      }

        function renewAdminSession() {
          const session = loadAdminSession();
          if (session) {
            // Odnów sesję z tym samym czasem wygaśnięcia (zachowaj ustawienie rememberMe)
            const expiryTime = session.rememberMe
              ? (7 * 24 * 60 * 60 * 1000) // 1 tydzień
              : (2 * 60 * 60 * 1000); // 2 godziny

            const sessionData = {
              ...session,
              timestamp: Date.now(),
              lastActivity: Date.now(),
              expiresAt: Date.now() + expiryTime
            };

            try {
              localStorage.setItem('admin_session', JSON.stringify(sessionData));
            } catch (error) {
              console.warn('Nie można odnowić sesji administratora:', error);
            }
          }
        }

      function initActivityTracking() {
        if (!currentUser) return;

        // Lista eventów które będą odnawiać sesję
        const activityEvents = [
          'click', 'keydown', 'scroll', 'mousemove', 'touchstart', 'focus'
        ];

        let lastActivity = Date.now();
        const renewInterval = 5 * 60 * 1000; // 5 minut - odnawiaj co 5 minut aktywności

        // Funkcja do sprawdzania aktywności
        function checkActivity() {
          if (Date.now() - lastActivity > renewInterval) {
            renewAdminSession();
            lastActivity = Date.now();
          }
        }

        // Dodaj event listenery do document
        activityEvents.forEach(eventType => {
          document.addEventListener(eventType, () => {
            lastActivity = Date.now();
          }, { passive: true });
        });

        // Sprawdzaj aktywność co minutę i odnawiaj sesję co 5 minut
        setInterval(() => {
          checkActivity();
          // Odnawiaj sesję co 5 minut aktywności
          if (Date.now() - lastActivity < 5 * 60 * 1000) {
            renewAdminSession();
          }
        }, 60 * 1000);

        // Sprawdź od razu przy inicjalizacji
        checkActivity();
      }

      // Sprawdzanie roli administratora
      async function checkAdminRole(user) {
        try {
          const userDoc = await getDoc(doc(db, "userProfiles", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            return userData.role === "admin";
          }
          return false;
        } catch (error) {
          console.error("Error checking admin role:", error);
          return false;
        }
      }

      // Aktualizacja wyświetlania nazwy administratora
      function updateAdminDisplay(user) {
        const displayName = user.displayName || user.email.split("@")[0];
        // Usuń już istniejący "@Administrator" jeśli jest
        const cleanDisplayName = displayName.replace("@Administrator", "");
        document.getElementById("admin-display-name").textContent =
          cleanDisplayName;
        // @Administrator jest już w HTML-u w osobnym divie
      }

      // Nawigacja między zakładkami
      function switchTab(tabName) {
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active");

        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`tab-${tabName}`).classList.add("active");

        currentTab = tabName;

        // Ładowanie danych dla wybranej zakładki
        switch (tabName) {
          case "dashboard":
            loadDashboardStats();
            break;
          case "konta":
            loadUsers();
            break;
          case "czat":
            window.location.href = 'czat_adm.html';
            break;
          case "sklep":
            window.location.href = 'sklep_adm.html';
            break;
          case "bazar":
            window.location.href = 'bazar_adm.html';
            break;
          case "szkolenia":
            window.location.href = 'szkolenia_adm.html';
            break;
          case "wydarzenia":
            window.location.href = 'wydarzenia_adm.html';
            break;
          case "blog":
            window.location.href = 'blog_adm.html';
            break;
          case "pomoc":
            window.location.href = 'pomoc_adm.html';
            break;
          case "dokumenty":
            window.location.href = 'dokumenty_adm.html';
            break;
          case "kontakt":
            window.location.href = 'kontakt_adm.html';
            break;
        }
      }

      // Inicjalizacja nawigacji
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          const tab = item.getAttribute("data-tab");
          switchTab(tab);
        });
      });

      // Logowanie administratora
      document
        .getElementById("admin-login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const login = document.getElementById("admin-email").value.trim();
          const password = document.getElementById("admin-password").value;
          const rememberMe = document.getElementById("admin-remember-me").checked;

          if (!login || !password) {
            showStatus("Wprowadź login i hasło administratora.", true);
            return;
          }

          try {
            // Najpierw sprawdź lokalne konto administratora
            const isLocalAdmin = await checkLocalAdmin(login, password);
            if (isLocalAdmin) {
              // Utwórz fikcyjnego użytkownika dla lokalnego admina
              currentUser = {
                uid: "local-admin",
                email: login,
                displayName: `${login}@Administrator`,
                isLocalAdmin: true,
                originalLogin: login, // Zachowaj oryginalny login dla wyświetlania
              };

              showStatus("Logowanie lokalnego administratora pomyślne.");
              updateAdminDisplay(currentUser);
              // Zapisz sesję administratora
              saveAdminSession(currentUser, 'local', rememberMe);
              // Inicjalizuj śledzenie aktywności
              initActivityTracking();
              document.getElementById("login-section").classList.add("hidden");
              document.getElementById("admin-panel").classList.remove("hidden");
              switchTab("dashboard");
              return;
            }

            // Jeśli nie jest to lokalny admin, spróbuj Firebase
            const userCredential = await signInWithEmailAndPassword(
              auth,
              login,
              password,
            );
            const user = userCredential.user;

            // Sprawdź czy użytkownik ma rolę administratora
            const isAdmin = await checkAdminRole(user);
            if (!isAdmin) {
              await signOut(auth);
              showStatus(
                "Brak uprawnień administratora. Tylko administratorzy mają dostęp do panelu.",
                true,
              );
              return;
            }

            showStatus("Logowanie administratora (Firebase) pomyślne.");
          } catch (error) {
            console.error("Login error:", error);

            let errorMessage = "Błąd logowania administratora.";
            if (error.code === "auth/user-not-found") {
              errorMessage = "Administrator nie istnieje.";
            } else if (error.code === "auth/wrong-password") {
              errorMessage = "Nieprawidłowe hasło administratora.";
            } else if (error.code === "auth/invalid-email") {
              errorMessage = "Nieprawidłowy format login.";
            }

            showStatus(errorMessage, true);
          }
        });

      // Wylogowanie administratora
      window.logoutAdmin = async () => {
        try {
          // Wyloguj z Firebase jeśli to użytkownik Firebase
          if (currentUser && !currentUser.isLocalAdmin) {
          await signOut(auth);
          }

          // Wyczyść dane lokalnego administratora
          currentUser = null;

          // Wyczyść sesję administratora
          clearAdminSession();

          showNotification("Administrator wylogowany.");

          // Przejdź do sekcji logowania
          document.getElementById("login-section").classList.remove("hidden");
          document.getElementById("admin-panel").classList.add("hidden");
        } catch (error) {
          console.error("Logout error:", error);
        }
      };

      // Monitorowanie stanu autoryzacji
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Sprawdź ponownie rolę administratora (na wypadek zmian)
          const isAdmin = await checkAdminRole(user);
          if (!isAdmin) {
            await signOut(auth);
            showStatus("Utracono uprawnienia administratora.", true);
            return;
          }

          currentUser = user;
          updateAdminDisplay(user);

          // Zapisz sesję administratora
          saveAdminSession(user, 'firebase', document.getElementById("admin-remember-me").checked);

          // Inicjalizuj śledzenie aktywności
          initActivityTracking();

          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("admin-panel").classList.remove("hidden");

          // Załaduj dashboard
          switchTab("dashboard");
        } else {
          currentUser = null;
          document.getElementById("login-section").classList.remove("hidden");
          document.getElementById("admin-panel").classList.add("hidden");
        }
      });

      // Funkcje ładowania danych
      async function loadDashboardStats() {
        try {
          // Inicjalizacja śledzenia odwiedzin
          initVisitsTracking();

          // Ładowanie statusu głównych usług
          await checkMainServicesStatus();

          // Ładowanie statusu stron
          await checkSitesStatus();

          // Ładowanie statystyk aktywności
          await loadActivityStats();
          await loadContactFormsCount();
          await loadPendingTasksCount();

          // Ładowanie statystyk Google Analytics
          await fetchGAStatistics();

          // Załaduj najnowsze zdarzenia
          await loadRecentEvents();

          // Ustawienie listener dla activityLogs (tylko jeśli jeszcze nie jest ustawiony)
          if (!activityLogsListener) {
            setupActivityLogsListener();
          }

          // Ustawienie listener dla pending tasks (tylko jeśli jeszcze nie jest ustawiony)
          if (!pendingTasksListener) {
            setupPendingTasksListener();
          }
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
          showNotification("Błąd ładowania danych dashboard.", "error");
        }
      }

      // Zarządzanie użytkownikami
      async function loadUsers() {
        try {
          const usersSnapshot = await getDocs(collection(db, "userProfiles"));
          usersList = usersSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Dodaj użytkownika testowego jeśli nie istnieje
          const testUserExists = usersList.find(user => user.email === "test@test.com");
          if (!testUserExists) {
            usersList.push({
              id: "test-user-uid",
              displayName: "Użytkownik Testowy",
              email: "test@test.com",
              firstName: "Test",
              lastName: "User",
              role: "user",
              status: "active",
              createdAt: new Date(),
              newsletter: false
            });
          }

          // Dodaj administratora lokalnego jeśli jest zalogowany
          if (currentUser && currentUser.isLocalAdmin) {
            // Sprawdź czy lokalny admin już nie jest na liście
            const localAdminExists = usersList.find(
              (user) => user.id === currentUser.uid,
            );
            if (!localAdminExists) {
              usersList.unshift({
                id: currentUser.uid,
                displayName: currentUser.displayName,
                email: currentUser.email,
                role: "admin",
                status: "active",
                createdAt: new Date(),
                isLocalAdmin: true,
              });
            }
          }

          renderUsersList();
          renderRecentUsers();
        } catch (error) {
          console.error("Error loading users:", error);
          showNotification("Błąd ładowania użytkowników.", "error");
        }
      }

      function renderRecentUsers() {
        // Sortuj użytkowników po dacie rejestracji (najnowsi najpierw)
        const sortedUsers = usersList
          .filter(user => user.createdAt) // Tylko użytkownicy z datą rejestracji
          .sort((a, b) => {
            const aDate = a.createdAt?.toDate?.() || a.createdAt || new Date(0);
            const bDate = b.createdAt?.toDate?.() || b.createdAt || new Date(0);
            return new Date(bDate).getTime() - new Date(aDate).getTime();
          })
          .slice(0, 5); // Pobierz 5 najnowszych

        const recentUsersHtml = sortedUsers.map(user => {
          const createdAt = user.createdAt?.toDate?.() || user.createdAt;
          const formattedDate = createdAt ? new Date(createdAt).toLocaleString("pl-PL", {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) : 'Brak daty';

          return `
            <div onclick="viewUserDetails('${user.id}')" class="flex-shrink-0 bg-zinc-800 hover:bg-zinc-700 rounded-lg p-3 cursor-pointer transition-colors min-w-[180px]">
              <div class="text-white font-semibold text-sm mb-1 truncate">${user.displayName}</div>
              <div class="text-zinc-400 text-xs">${formattedDate}</div>
            </div>
          `;
        }).join('');

        document.getElementById("recent-users").innerHTML = recentUsersHtml || '<div class="text-zinc-500 text-center py-4">Brak użytkowników</div>';
      }

      // Funkcja odświeżania użytkowników
      window.refreshUsers = () => {
        // Pokaż loading state na liście użytkowników
        const usersListElement = document.getElementById("users-list");
        if (usersListElement) {
          usersListElement.innerHTML = `
            <div class="flex justify-center items-center py-12">
              <div class="text-center">
                <i class="fa-solid fa-spinner fa-spin text-3xl text-coyote mb-4"></i>
                <p class="text-zinc-400">Odświeżanie listy użytkowników...</p>
              </div>
            </div>
          `;
        }

        loadUsers();
      };

      function filterUsers(filter) {
        // Toggle filtra - jeśli już jest aktywny, usuń go, jeśli nie - dodaj
        const filterIndex = activeUserFilters.indexOf(filter);
        if (filterIndex > -1) {
          // Filtr jest aktywny, usuń go
          activeUserFilters.splice(filterIndex, 1);
        } else {
          // Filtr nie jest aktywny, dodaj go
          activeUserFilters.push(filter);
        }

        // Jeśli nie ma aktywnych filtrów, ustaw "all"
        if (activeUserFilters.length === 0) {
          activeUserFilters = ["all"];
        } else {
          // Usuń "all" jeśli są inne filtry
          const allIndex = activeUserFilters.indexOf("all");
          if (allIndex > -1) {
            activeUserFilters.splice(allIndex, 1);
          }
        }

        // Aktualizuj wygląd przycisków
        document.querySelectorAll(".user-filter-btn").forEach((btn) => {
          const btnFilter = btn.getAttribute("data-filter");
          if (activeUserFilters.includes(btnFilter) || (activeUserFilters.includes("all") && btnFilter === "all")) {
            btn.classList.add("active", "border-coyote", "text-coyote");
            btn.classList.remove("border-zinc-700");
          } else {
          btn.classList.remove("active", "border-coyote", "text-coyote");
          btn.classList.add("border-zinc-700");
          }
        });

        renderUsersList();
      }

      window.filterUsers = filterUsers;

      function renderUsersList() {
        let filteredUsers = usersList;

        // Jeśli "all" jest w filtrach lub nie ma filtrów, pokaż wszystkich
        if (activeUserFilters.includes("all") || activeUserFilters.length === 0) {
          filteredUsers = usersList;
        } else {
          // Zastosuj wszystkie aktywne filtry (logika AND)
          filteredUsers = usersList.filter((user) => {
            // Sprawdź filtry statusu
            if (activeUserFilters.includes("active")) {
              // Aktywny = ostatni ruch w ciągu ostatniej godziny
              const lastActivity = user.lastActivity?.toDate?.() || user.lastActivity;
              const isActive = lastActivity && (Date.now() - new Date(lastActivity).getTime()) < (60 * 60 * 1000);
              if (!isActive) return false;
            }
            if (activeUserFilters.includes("blocked") && user.status !== "blocked") return false;

            // Sprawdź filtry roli
            if (activeUserFilters.includes("admin") && user.role !== "admin") return false;
            if (activeUserFilters.includes("company") && user.role !== "company") return false;

            return true;
          });
        }

        // Sortuj zawsze po ostatniej aktywności (najnowszy ruch na górze)
        filteredUsers.sort((a, b) => {
          const aActivity = a.lastActivity?.toDate?.() || a.lastActivity || new Date(0);
          const bActivity = b.lastActivity?.toDate?.() || b.lastActivity || new Date(0);
          return new Date(bActivity).getTime() - new Date(aActivity).getTime();
        });

        const usersHtml = filteredUsers
          .map((user) => {
            const isCurrentUser = currentUser && user.id === currentUser.uid;
            const status = user.status || "active";
            const role = user.role || "user";


            const decryptedUser = {
              ...user,
              phone: user.isLocalAdmin
                ? user.phone || ""
                : user.phone
                  ? atob(user.phone)
                  : "",
              address: {
                street: user.isLocalAdmin
                  ? user.address?.street || ""
                  : user.address?.street
                    ? atob(user.address.street)
                    : "",
                city: user.isLocalAdmin
                  ? user.address?.city || ""
                  : user.address?.city
                    ? atob(user.address.city)
                    : "",
              },
            };

            // Sprawdź czy użytkownik był aktywny w ciągu ostatniej godziny
            const lastActivity = user.lastActivity?.toDate?.() || user.lastActivity;
            const isActive = lastActivity && (Date.now() - new Date(lastActivity).getTime()) < (60 * 60 * 1000); // 1 godzina

            // Kolory dla ról
            const roleColors = {
              admin: "text-red-400", // Administrator - czerwony
              company: "text-blue-400", // Firma - niebieski
              user: "text-white", // Użytkownik - biały
            };

            return `
                    <div class="p-3 rounded-lg bg-zinc-800/50 hover:bg-zinc-700/50 transition-colors">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h4 class="font-bold ${roleColors[role] || 'text-white'}">${decryptedUser.displayName}</h4>
                                    ${isCurrentUser ? '<span class="px-2 py-1 text-xs rounded bg-purple-600 text-white">TY</span>' : ""}
                                    ${isActive ? '<span class="px-2 py-1 text-xs rounded bg-green-600 text-white">AKTYWNY</span>' : '<span class="px-2 py-1 text-xs rounded bg-gray-600 text-white">NIEAKTYWNY</span>'}
                                    <span class="text-sm text-zinc-400">•</span>
                                    <span class="text-sm text-zinc-400">${decryptedUser.email}</span>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="viewUserDetails('${user.id}')" class="text-coyote hover:text-white px-2 py-1 border border-coyote rounded text-xs transition-colors">Szczegóły</button>
                                ${
                                  !isCurrentUser
                                    ? `
                                    <button onclick="resetUserPassword('${user.id}', '${decryptedUser.email}')" class="text-orange-400 hover:text-white px-2 py-1 border border-orange-400 rounded text-xs transition-colors">Reset hasła</button>
                                    <button onclick="showUserActionMenu('${user.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Blokady</button>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("users-list").innerHTML =
          usersHtml ||
          '<div class="text-center text-zinc-500 py-8">Brak użytkowników</div>';
      }

      // Szczegóły użytkownika
      window.viewUserDetails = async (userId) => {
        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              createdAt: new Date(),
              isLocalAdmin: true,
            };
          } else if (userId === "test-user-uid") {
            // Sprawdź czy to użytkownik testowy
            user = usersList.find(u => u.id === "test-user-uid");
            if (!user) return;
          } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentEditingUser = user;

          const decryptedUser = {
            ...user,
            phone: user.isLocalAdmin
              ? user.phone || ""
              : user.phone
                ? atob(user.phone)
                : "",
            parcelLocker: user.isLocalAdmin
              ? user.parcelLocker || ""
              : user.parcelLocker
                ? atob(user.parcelLocker)
                : "",
            address: {
              street: user.isLocalAdmin
                ? user.address?.street || ""
                : user.address?.street
                  ? atob(user.address.street)
                  : "",
              buildingNumber: user.isLocalAdmin
                ? user.address?.buildingNumber || ""
                : user.address?.buildingNumber
                ? atob(user.address.buildingNumber)
                : "",
              postalCode: user.isLocalAdmin
                ? user.address?.postalCode || ""
                : user.address?.postalCode
                ? atob(user.address.postalCode)
                : "",
              city: user.isLocalAdmin
                ? user.address?.city || ""
                : user.address?.city
                  ? atob(user.address.city)
                  : "",
            },
          };

          // Przygotuj HTML dla danych firmy jeśli użytkownik ma rolę firma
          let companyHtml = '';
          if (decryptedUser.role === 'company' && decryptedUser.companyData) {
            companyHtml = `
              <h3 class="text-lg font-bold mb-4 mt-6">Dane Firmy</h3>
              <div class="space-y-3">
                <div><strong>Nazwa firmy:</strong> ${decryptedUser.companyData.name || "Nie podano"}</div>
                <div><strong>NIP:</strong> ${decryptedUser.companyData.nip || "Nie podano"}</div>
              </div>

              <h3 class="text-lg font-bold mb-4 mt-6">Adres Firmy</h3>
              <div class="space-y-3">
                <div><strong>Ulica:</strong> ${decryptedUser.companyData.address?.street || "Nie podano"}</div>
                <div><strong>Numer:</strong> ${decryptedUser.companyData.address?.buildingNumber || "Nie podano"}</div>
                <div><strong>Kod pocztowy:</strong> ${decryptedUser.companyData.address?.postalCode || "Nie podano"}</div>
                <div><strong>Miasto:</strong> ${decryptedUser.companyData.address?.city || "Nie podano"}</div>
              </div>
            `;
          }

          const detailsHtml = `
                    <form id="user-details-form" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-bold mb-4 text-coyote">Informacje podstawowe</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Nazwa użytkownika</label>
                                    <input type="text" id="user-details-display-name" value="${decryptedUser.displayName || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Email</label>
                                    <input type="email" id="user-details-email" value="${decryptedUser.email || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Imię</label>
                                    <input type="text" id="user-details-first-name" value="${decryptedUser.firstName || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Nazwisko</label>
                                    <input type="text" id="user-details-last-name" value="${decryptedUser.lastName || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Telefon</label>
                                    <input type="tel" id="user-details-phone" value="${decryptedUser.phone || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Rola</label>
                                    <select id="user-details-role" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                        <option value="user" ${decryptedUser.role === 'user' ? 'selected' : ''}>Użytkownik</option>
                                        <option value="company" ${decryptedUser.role === 'company' ? 'selected' : ''}>Firma</option>
                                        <option value="admin" ${decryptedUser.role === 'admin' ? 'selected' : ''}>Administrator</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Status</label>
                                    <select id="user-details-status" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                        <option value="active" ${decryptedUser.status === 'active' ? 'selected' : ''}>Aktywny</option>
                                        <option value="blocked" ${decryptedUser.status === 'blocked' ? 'selected' : ''}>Zablokowany</option>
                                        <option value="suspended" ${decryptedUser.status === 'suspended' ? 'selected' : ''}>Zawieszony</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-4 text-coyote">Adres dostawy</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Ulica</label>
                                    <input type="text" id="user-details-street" value="${decryptedUser.address?.street || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Numer budynku</label>
                                    <input type="text" id="user-details-building-number" value="${decryptedUser.address?.buildingNumber || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Kod pocztowy</label>
                                    <input type="text" id="user-details-postal-code" value="${decryptedUser.address?.postalCode || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Miasto</label>
                                    <input type="text" id="user-details-city" value="${decryptedUser.address?.city || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                                <div>
                                    <label class="text-sm text-zinc-400 block mb-2">Paczkomat</label>
                                    <input type="text" id="user-details-parcel-locker" value="${decryptedUser.parcelLocker || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                </div>
                            </div>

                            <h3 class="text-lg font-bold mb-4 mt-6 text-coyote">Preferencje</h3>
                            <div class="space-y-4">
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" id="user-details-newsletter" ${decryptedUser.newsletter ? 'checked' : ''} disabled class="bg-zinc-800 border border-zinc-600 rounded cursor-not-allowed">
                                    <label for="user-details-newsletter" class="text-sm text-zinc-400">Newsletter</label>
                                </div>
                            </div>

                            <div class="company-section mt-6" style="display: ${decryptedUser.role === 'company' ? 'block' : 'none'}">
                                <h3 class="text-lg font-bold mb-4 text-coyote">Dane Firmy</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm text-zinc-400 block mb-2">Nazwa firmy</label>
                                        <input type="text" id="user-details-company-name" value="${decryptedUser.companyData?.name || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                    </div>
                                    <div>
                                        <label class="text-sm text-zinc-400 block mb-2">NIP</label>
                                        <input type="text" id="user-details-company-nip" value="${decryptedUser.companyData?.nip || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                    </div>
                                </div>

                                <h3 class="text-lg font-bold mb-4 mt-6 text-coyote">Adres Firmy</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label class="text-sm text-zinc-400 block mb-2">Ulica</label>
                                        <input type="text" id="user-details-company-street" value="${decryptedUser.companyData?.address?.street || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                    </div>
                                    <div>
                                        <label class="text-sm text-zinc-400 block mb-2">Numer budynku</label>
                                        <input type="text" id="user-details-company-building-number" value="${decryptedUser.companyData?.address?.buildingNumber || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                    </div>
                                    <div>
                                        <label class="text-sm text-zinc-400 block mb-2">Kod pocztowy</label>
                                        <input type="text" id="user-details-company-postal-code" value="${decryptedUser.companyData?.address?.postalCode || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                    </div>
                                    <div>
                                        <label class="text-sm text-zinc-400 block mb-2">Miasto</label>
                                        <input type="text" id="user-details-company-city" value="${decryptedUser.companyData?.address?.city || ''}" disabled class="w-full bg-zinc-800 border border-zinc-600 rounded px-3 py-2 text-white cursor-not-allowed">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                `;

          document.getElementById("user-details-content").innerHTML =
            detailsHtml;
          document
            .getElementById("user-details-modal")
            .classList.remove("hidden");
        } catch (error) {
          console.error("Error loading user details:", error);
          showNotification("Błąd ładowania szczegółów użytkownika.", "error");
        }
      };

      window.closeUserDetails = () => {
        // Resetuj stan edycji
        isEditingUser = false;
        const editButton = document.querySelector('[onclick="editUserDetails()"], [onclick="saveUserDetails()"]');
        if (editButton) {
          editButton.innerHTML = '<i class="fa-solid fa-edit mr-1"></i>Edytuj';
          editButton.onclick = editUserDetails;
        }

        document.getElementById("user-details-modal").classList.add("hidden");
      };

      window.switchUserTab = (tabName) => {
        document.querySelectorAll(".user-tab-btn").forEach((btn) => {
          btn.classList.remove("active", "bg-coyote", "text-black");
          btn.classList.add("text-zinc-400");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active", "bg-coyote", "text-black");

        if (tabName === "activity") {
          loadUserActivity();
        } else if (tabName === "details") {
          loadUserDetails();
        }
      };

      async function loadUserDetails() {
        if (!currentEditingUser) return;

        // Ukryj przycisk edycji dla administratora lokalnego
        const editButton = document.querySelector(
          '[onclick="editUserDetails()"]',
        );
        if (editButton) {
          if (currentEditingUser.isLocalAdmin) {
            editButton.style.display = "none";
          } else {
            editButton.style.display = "inline-block";
          }
        }

        const decryptedUser = {
          ...currentEditingUser,
          phone: currentEditingUser.isLocalAdmin
            ? currentEditingUser.phone || ""
            : currentEditingUser.phone
              ? atob(currentEditingUser.phone)
              : "",
          parcelLocker: currentEditingUser.isLocalAdmin
            ? currentEditingUser.parcelLocker || ""
            : currentEditingUser.parcelLocker
              ? atob(currentEditingUser.parcelLocker)
              : "",
          address: {
            street: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.street || ""
              : currentEditingUser.address?.street
                ? atob(currentEditingUser.address.street)
                : "",
            buildingNumber: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.buildingNumber || ""
              : currentEditingUser.address?.buildingNumber
                ? atob(currentEditingUser.address.buildingNumber)
                : "",
            postalCode: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.postalCode || ""
              : currentEditingUser.address?.postalCode
                ? atob(currentEditingUser.address.postalCode)
                : "",
            city: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.city || ""
              : currentEditingUser.address?.city
                ? atob(currentEditingUser.address.city)
                : "",
          },
        };

        const detailsHtml = `
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                          <h3 class="text-lg font-bold mb-4 text-coyote">Informacje podstawowe</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Nazwa użytkownika:</span>
                                  <span class="text-white">${decryptedUser.displayName}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Email:</span>
                                  <span class="text-white">${decryptedUser.email}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Imię:</span>
                                  <span class="text-white">${decryptedUser.firstName || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Nazwisko:</span>
                                  <span class="text-white">${decryptedUser.lastName || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Telefon:</span>
                                  <span class="text-white">${decryptedUser.phone || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Rola:</span>
                                  <span class="text-white">${decryptedUser.role || "user"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Status:</span>
                                  <span class="text-white">${decryptedUser.status || "active"}</span>
                              </div>
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Data rejestracji:</span>
                                  <span class="text-white">${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleString("pl-PL")}</span>
                              </div>
                          </div>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold mb-4 text-coyote">Adres dostawy</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Ulica:</span>
                                  <span class="text-white">${decryptedUser.address.street || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Numer:</span>
                                  <span class="text-white">${decryptedUser.address.buildingNumber || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Kod pocztowy:</span>
                                  <span class="text-white">${decryptedUser.address.postalCode || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Miasto:</span>
                                  <span class="text-white">${decryptedUser.address.city || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Paczkomat:</span>
                                  <span class="text-white">${decryptedUser.parcelLocker || "Nie podano"}</span>
                              </div>
                          </div>

                          <h3 class="text-lg font-bold mb-4 mt-6 text-coyote">Preferencje</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Newsletter:</span>
                                  <span class="text-white">${decryptedUser.newsletter ? "Tak" : "Nie"}</span>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

        document.getElementById("user-details-content").innerHTML = detailsHtml;
      }

      let isEditingUser = false;

      window.editUserDetails = () => {
        const editButton = document.querySelector('[onclick="editUserDetails()"]');
        const userDetailsContent = document.getElementById("user-details-content");

        if (!isEditingUser) {
          // Włącz tryb edycji
          isEditingUser = true;

          // Zmień przycisk na "Zapisz"
          if (editButton) {
            editButton.innerHTML = '<i class="fa-solid fa-save mr-1"></i>Zapisz';
            editButton.onclick = saveUserDetails;
          }

          // Odblokuj wszystkie pola formularza
          const inputs = userDetailsContent.querySelectorAll('input, select, textarea');
          inputs.forEach(input => {
            input.disabled = false;
            input.classList.remove('bg-zinc-800', 'cursor-not-allowed');
            input.classList.add('bg-zinc-700');
          });

          // Pokaż sekcję firmy jeśli użytkownik ma rolę firma
          const roleSelect = document.getElementById('user-details-role');
          if (roleSelect && roleSelect.value === 'company') {
            const companySection = userDetailsContent.querySelector('.company-section');
            if (companySection) companySection.style.display = 'block';
          }

          // Dodaj event listener dla zmiany roli podczas edycji
          if (roleSelect) {
            roleSelect.addEventListener('change', function() {
              const companySection = userDetailsContent.querySelector('.company-section');
              if (companySection) {
                companySection.style.display = this.value === 'company' ? 'block' : 'none';
              }
            });
          }
        } else {
          // Zapisz zmiany
          saveUserDetails();
        }
      };

      async function saveUserDetails() {
        try {
          const userId = currentEditingUser.id;

          // Sprawdź czy to użytkownik testowy lub administrator lokalny
          if (userId === "test-user-uid" || (currentUser && currentUser.isLocalAdmin && userId === currentUser.uid)) {
            showNotification("Nie można edytować tego użytkownika.", "error");
            return;
          }

          // Pobierz dane z formularza
          const selectedRole = document.getElementById('user-details-role').value;
          let companyData = null;
          if (selectedRole === 'company') {
            companyData = {
              name: document.getElementById('user-details-company-name').value.trim(),
              nip: document.getElementById('user-details-company-nip').value.trim(),
              address: {
                street: document.getElementById('user-details-company-street').value.trim(),
                buildingNumber: document.getElementById('user-details-company-building-number').value.trim(),
                postalCode: document.getElementById('user-details-company-postal-code').value.trim(),
                city: document.getElementById('user-details-company-city').value.trim(),
              },
            };
          }

          // Przygotuj dane do zapisania
          const updatedProfile = {
            displayName: document.getElementById('user-details-display-name').value.trim(),
            firstName: document.getElementById('user-details-first-name').value.trim(),
            lastName: document.getElementById('user-details-last-name').value.trim(),
            phone: btoa(document.getElementById('user-details-phone').value.trim()),
            address: {
              street: btoa(document.getElementById('user-details-street').value.trim()),
              buildingNumber: btoa(document.getElementById('user-details-building-number').value.trim()),
              postalCode: btoa(document.getElementById('user-details-postal-code').value.trim()),
              city: btoa(document.getElementById('user-details-city').value.trim()),
            },
            parcelLocker: btoa(document.getElementById('user-details-parcel-locker').value.trim()),
            newsletter: document.getElementById('user-details-newsletter').checked,
            role: selectedRole,
            status: document.getElementById('user-details-status').value,
            updatedAt: new Date(),
            updatedBy: currentUser.uid,
          };

          // Dodaj dane firmy jeśli istnieją
          if (companyData) {
            updatedProfile.companyData = companyData;
          }

          await updateDoc(doc(db, "userProfiles", userId), updatedProfile);

          // Zaloguj edycję profilu
          await logActivity(userId, "PROFILE_EDITED", {
            editedBy: currentUser.uid,
            changes: Object.keys(updatedProfile),
          });

          showNotification("Dane użytkownika zostały zaktualizowane.");

          // Wyłącz tryb edycji
          const editButton = document.querySelector('[onclick="saveUserDetails"]');
          if (editButton) {
            editButton.innerHTML = '<i class="fa-solid fa-edit mr-1"></i>Edytuj';
            editButton.onclick = editUserDetails;
          }

          // Zablokuj wszystkie pola
          const inputs = document.querySelectorAll('#user-details-form input, #user-details-form select, #user-details-form textarea');
          inputs.forEach(input => {
            input.disabled = true;
            input.classList.add('bg-zinc-800', 'cursor-not-allowed');
            input.classList.remove('bg-zinc-700');
          });

          isEditingUser = false;

          // Odśwież dane
          loadUsers();
        } catch (error) {
          console.error("Error updating user details:", error);
          showNotification("Błąd podczas aktualizacji danych użytkownika.", "error");
        }
      }

      async function loadUserActivity() {
        if (!currentEditingUser) return;

        try {
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-zinc-500 py-8">
              <i class="fa-solid fa-spinner fa-spin fa-3x mb-4"></i>
              <p>Ładowanie historii aktywności...</p>
            </div>
          `;

          // Pobierz aktywność użytkownika
          const q = query(
            collection(db, "userActivity"),
            where("userId", "==", currentEditingUser.id),
            orderBy("timestamp", "desc"),
            limit(50),
          );

          const snapshot = await getDocs(q);
          const activities = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Pobierz także aktywność gdzie użytkownik jest celem (np. został zablokowany przez admina)
          const targetQuery = query(
            collection(db, "userActivity"),
            where("targetUserId", "==", currentEditingUser.id),
            orderBy("timestamp", "desc"),
            limit(50),
          );

          const targetSnapshot = await getDocs(targetQuery);
          const targetActivities = targetSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Połącz i posortuj wszystkie aktywności
          const allActivities = [...activities, ...targetActivities]
            .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())
            .slice(0, 50); // Ogranicz do 50 najnowszych

          renderUserActivity(allActivities);
        } catch (error) {
          console.error("Error loading user activity:", error);
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-red-400 py-8">
              <i class="fa-solid fa-exclamation-triangle fa-3x mb-4"></i>
              <p>Błąd ładowania historii aktywności</p>
              <p class="text-sm">${error.message}</p>
            </div>
          `;
        }
      }

      function renderUserActivity(activities) {
        if (activities.length === 0) {
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-zinc-500 py-8">
              <i class="fa-solid fa-inbox fa-3x mb-4"></i>
              <p>Brak zarejestrowanej aktywności</p>
              <p class="text-sm">Historia aktywności użytkownika pojawi się tutaj po wykonaniu jakichkolwiek działań.</p>
            </div>
          `;
          return;
        }

        const activityHtml = activities
          .map((activity) => {
            const timestamp = activity.timestamp.toDate();
            const timeAgo = getTimeAgo(timestamp);

            // Ikony dla różnych typów aktywności
            const activityIcons = {
              ROLE_CHANGE: "fa-user-tag",
              PASSWORD_RESET_REQUEST: "fa-key",
              USER_BLOCKED: "fa-ban",
              USER_UNBLOCKED: "fa-unlock",
              USER_DELETED: "fa-trash",
              PROFILE_EDITED: "fa-edit",
              LOGIN: "fa-sign-in-alt",
              LOGOUT: "fa-sign-out-alt",
              MESSAGE_SENT: "fa-comment",
              PRODUCT_ADDED: "fa-plus-circle",
              PRODUCT_EDITED: "fa-edit",
              LIKE_ADDED: "fa-heart",
              COMMENT_ADDED: "fa-comment-dots",
            };

            const iconClass = activityIcons[activity.action] || "fa-circle";

            // Kolory dla różnych typów aktywności
            const activityColors = {
              USER_BLOCKED: "text-red-400",
              USER_UNBLOCKED: "text-green-400",
              USER_DELETED: "text-red-600",
              ROLE_CHANGE: "text-blue-400",
              PASSWORD_RESET_REQUEST: "text-orange-400",
              PROFILE_EDITED: "text-purple-400",
            };

            const colorClass =
              activityColors[activity.action] || "text-zinc-400";

            // Opis aktywności
            let description = "";
            switch (activity.action) {
              case "ROLE_CHANGE":
                description = `Zmiana roli z ${activity.details.oldRole?.toUpperCase() || "BRAK"} na ${activity.details.newRole?.toUpperCase() || "BRAK"}`;
                break;
              case "PASSWORD_RESET_REQUEST":
                description = "Wysłano link resetowania hasła";
                break;
              case "USER_BLOCKED":
                if (activity.details.isPermanent) {
                  description = "Konto zablokowane na zawsze";
                } else {
                  description = `Konto zablokowane na ${activity.details.duration}`;
                }
                if (activity.details.contentAction === "remove") {
                  description += " (zawartość usunięta)";
                }
                break;
              case "USER_UNBLOCKED":
                description = "Konto odblokowane";
                break;
              case "USER_DELETED":
                description = `Konto usunięte${activity.details.contentAction === "keep" ? " (zawartość zachowana)" : " (zawartość usunięta)"}`;
                break;
              case "PROFILE_EDITED":
                description = `Edycja profilu (${activity.details.changes?.join(", ") || "nieznane zmiany"})`;
                break;
              default:
                description = activity.action.replace(/_/g, " ").toLowerCase();
            }

            // Szczegóły wykonawcy
            let performedBy = "";
            if (activity.adminId && activity.adminId !== activity.userId) {
              performedBy = " przez administratora";
            }

            return `
            <div class="flex items-start space-x-3 p-4 bg-zinc-800 rounded-lg mb-3">
              <div class="${colorClass} mt-1">
                <i class="fa-solid ${iconClass}"></i>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <div class="font-semibold ${colorClass}">${activity.action.replace(/_/g, " ")}</div>
                  <div class="text-xs text-zinc-500">${timeAgo}</div>
                </div>
                <div class="text-sm text-zinc-300 mt-1">${description}${performedBy}</div>
                <div class="text-xs text-zinc-500 mt-1">
                  ${timestamp.toLocaleString("pl-PL")}
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        document.getElementById("user-details-content").innerHTML = `
          <div class="mb-4">
            <h3 class="text-lg font-bold mb-4">Historia Aktywności</h3>
            <p class="text-sm text-zinc-400 mb-4">Pokaż ostatnie 50 działań użytkownika</p>
          </div>
          <div class="space-y-1 max-h-[500px] overflow-y-auto">
            ${activityHtml}
          </div>
        `;
      }

      // Zmienna globalna do przechowywania aktualnie edytowanego użytkownika
      let currentEditingUser = null;

      function showUserEditModal() {
        if (!currentEditingUser) return;

        // Sprawdź czy to administrator lokalny
        if (currentEditingUser.isLocalAdmin) {
          showNotification(
            "Nie można edytować administratora lokalnego.",
            "error",
          );
          return;
        }

        const decryptedUser = {
          ...currentEditingUser,
          phone: currentEditingUser.isLocalAdmin
            ? currentEditingUser.phone || ""
            : currentEditingUser.phone
              ? atob(currentEditingUser.phone)
              : "",
          parcelLocker: currentEditingUser.isLocalAdmin
            ? currentEditingUser.parcelLocker || ""
            : currentEditingUser.parcelLocker
              ? atob(currentEditingUser.parcelLocker)
              : "",
          address: {
            street: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.street || ""
              : currentEditingUser.address?.street
                ? atob(currentEditingUser.address.street)
                : "",
            buildingNumber: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.buildingNumber || ""
              : currentEditingUser.address?.buildingNumber
                ? atob(currentEditingUser.address.buildingNumber)
                : "",
            postalCode: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.postalCode || ""
              : currentEditingUser.address?.postalCode
                ? atob(currentEditingUser.address.postalCode)
                : "",
            city: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.city || ""
              : currentEditingUser.address?.city
                ? atob(currentEditingUser.address.city)
                : "",
          },
        };

        // Wypełnij formularz danymi użytkownika
        document.getElementById("edit-user-id").value = decryptedUser.id;
        document.getElementById("edit-display-name").value =
          decryptedUser.displayName || "";
        document.getElementById("edit-email").value = decryptedUser.email || "";
        document.getElementById("edit-first-name").value =
          decryptedUser.firstName || "";
        document.getElementById("edit-last-name").value =
          decryptedUser.lastName || "";
        document.getElementById("edit-phone").value = decryptedUser.phone || "";
        document.getElementById("edit-street").value =
          decryptedUser.address?.street || "";
        document.getElementById("edit-building-number").value =
          decryptedUser.address?.buildingNumber || "";
        document.getElementById("edit-postal-code").value =
          decryptedUser.address?.postalCode || "";
        document.getElementById("edit-city").value =
          decryptedUser.address?.city || "";
        document.getElementById("edit-parcel-locker").value =
          decryptedUser.parcelLocker || "";
        document.getElementById("edit-newsletter").checked =
          decryptedUser.newsletter || false;
        document.getElementById("edit-role").value =
          decryptedUser.role || "user";
        document.getElementById("edit-status").value =
          decryptedUser.status || "active";

        // Wypełnij pola firmy jeśli użytkownik ma rolę firma
        if (decryptedUser.companyData) {
          document.getElementById("edit-company-name").value =
            decryptedUser.companyData.name || "";
          document.getElementById("edit-company-nip").value =
            decryptedUser.companyData.nip || "";
          document.getElementById("edit-company-street").value =
            decryptedUser.companyData.address?.street || "";
          document.getElementById("edit-company-building-number").value =
            decryptedUser.companyData.address?.buildingNumber || "";
          document.getElementById("edit-company-postal-code").value =
            decryptedUser.companyData.address?.postalCode || "";
          document.getElementById("edit-company-city").value =
            decryptedUser.companyData.address?.city || "";
        }

        // Pokaż/ukryj pola firmy w zależności od roli
        toggleCompanyFields(decryptedUser.role || "user");

        document.getElementById("user-edit-modal").classList.remove("hidden");

        // Dodaj event listener na zmianę roli
        document.getElementById("edit-role").addEventListener("change", (e) => {
          toggleCompanyFields(e.target.value);
        });
      }

      window.closeUserEdit = () => {
        document.getElementById("user-edit-modal").classList.add("hidden");
        currentEditingUser = null;
      };

      // Zmienna globalna dla blokowanego użytkownika
      let currentActionUser = null;
      let currentBlockingUser = null;

      // Menu akcji użytkownika
      window.showUserActionMenu = async (userId) => {
        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else {
            const userDoc = await getDoc(doc(db, "userProfiles", userId));
            if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentActionUser = user;

          const decryptedUser = {
            ...user,
            phone: user.phone
              ? atob(user.phone)
              : "",
            address: {
              city: user.address?.city
                ? atob(user.address.city)
                : "",
            },
          };

          document.getElementById("action-user-info").innerHTML = `
            <div class="flex items-center space-x-3 mb-2">
              <div class="font-bold text-white">${decryptedUser.displayName}</div>
              <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
            </div>
            <div class="text-sm text-zinc-500">
              ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
              ${decryptedUser.phone ? ` • Tel: ${decryptedUser.phone}` : ""}
            </div>
          `;

          document.getElementById("user-action-modal").classList.remove("hidden");
        } catch (error) {
          console.error("Error showing user action menu:", error);
          showNotification("Błąd ładowania menu akcji.", "error");
        }
      };

      window.closeUserActionMenu = () => {
        document.getElementById("user-action-modal").classList.add("hidden");
        currentActionUser = null;
      };

      window.openBlockModal = () => {
        currentBlockingUser = currentActionUser;
        closeUserActionMenu();
        showUserBlockModal();
      };

      window.openDeleteModal = () => {
        currentDeletingUser = currentActionUser;
        closeUserActionMenu();
        showUserDeleteModal();
      };

      // Funkcje zarządzania użytkownikami
      window.toggleUserBlock = async (userId) => {
        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else if (userId === "test-user-uid") {
            // Sprawdź czy to użytkownik testowy
            user = usersList.find(u => u.id === "test-user-uid");
            if (!user) return;
          } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentBlockingUser = user;

          const currentStatus = user.status || "active";

          if (currentStatus === "blocked") {
            // Jeśli użytkownik jest już zablokowany, pokaż opcje odblokowania
            showUserUnblockModal();
          } else {
            // Jeśli użytkownik nie jest zablokowany, pokaż modal blokowania
            showUserBlockModal();
          }
        } catch (error) {
          console.error("Error toggling user block:", error);
          showNotification("Błąd zmiany statusu użytkownika.", "error");
        }
      };

      function showUserBlockModal() {
        if (!currentBlockingUser) return;

        const decryptedUser = {
          ...currentBlockingUser,
          phone: currentBlockingUser.phone
            ? atob(currentBlockingUser.phone)
            : "",
          address: {
            city: currentBlockingUser.address?.city
              ? atob(currentBlockingUser.address.city)
              : "",
          },
        };

        document.getElementById("block-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
            ${decryptedUser.phone ? ` • Tel: ${decryptedUser.phone}` : ""}
          </div>
        `;

        document.getElementById("block-user-id").value = decryptedUser.id;
        document.getElementById("user-block-modal").classList.remove("hidden");
      }

      function showUserUnblockModal() {
        if (!currentBlockingUser) return;

        const confirmUnblock = confirm(
          `Czy na pewno chcesz odblokować użytkownika ${currentBlockingUser.displayName}?\n\nUżytkownik odzyska dostęp do wszystkich funkcji strony.`,
        );

        if (confirmUnblock) {
          unblockUser(currentBlockingUser.id);
        }
      }

      async function unblockUser(userId) {
        try {
          await updateDoc(doc(db, "userProfiles", userId), {
            status: "active",
            unblockedAt: new Date(),
            unblockedBy: currentUser.uid,
          });

          // Zaloguj odblokowanie użytkownika
          await logActivity(userId, "USER_UNBLOCKED", {
            unblockedBy: currentUser.uid,
          });

          showNotification("Użytkownik został odblokowany.");
          loadUsers();
        } catch (error) {
          console.error("Error unblocking user:", error);
          showNotification("Błąd podczas odblokowywania użytkownika.", "error");
        }
      }

      window.closeUserBlock = () => {
        document.getElementById("user-block-modal").classList.add("hidden");
        currentBlockingUser = null;
      };

      function showUserDeleteModal() {
        if (!currentDeletingUser) return;

        const decryptedUser = {
          ...currentDeletingUser,
          phone: currentDeletingUser.phone
            ? atob(currentDeletingUser.phone)
            : "",
          address: {
            city: currentDeletingUser.address?.city
              ? atob(currentDeletingUser.address.city)
              : "",
          },
        };

        document.getElementById("delete-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
            ${decryptedUser.phone ? ` • Tel: ${decryptedUser.phone}` : ""}
          </div>
          <div class="text-sm text-zinc-500 mt-1">
            Konto utworzone: ${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleDateString("pl-PL")}
          </div>
        `;

        document.getElementById("delete-user-id").value = decryptedUser.id;
        document.getElementById("user-delete-modal").classList.remove("hidden");
      }

      window.closeUserDelete = () => {
        document.getElementById("user-delete-modal").classList.add("hidden");
        currentDeletingUser = null;
      };

      window.closeUserRole = () => {
        document.getElementById("user-role-modal").classList.add("hidden");
        currentRoleUser = null;
      };

      window.resetUserPassword = async (userId, email) => {
        // Sprawdź czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie można resetować hasła administratora lokalnego.",
            "error",
          );
          return;
        }

        if (!confirm(`Czy wysłać link resetowania hasła na adres: ${email}?`))
          return;

        try {
          const { sendPasswordResetEmail } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
          await sendPasswordResetEmail(auth, email, {
            url: `${window.location.origin}/konto.strzelca.pl/akcja.html?mode=resetPassword`,
            handleCodeInApp: true,
          });

          // Zaloguj reset hasła
          await logActivity(userId, "PASSWORD_RESET_REQUEST", {
            email: email,
            requestedBy: currentUser.uid,
          });

          showNotification("Link resetowania hasła został wysłany.");
        } catch (error) {
          console.error("Error sending password reset:", error);
          showNotification("Błąd wysyłania linku resetowania.", "error");
        }
      };

      let currentRoleUser = null;

      window.changeUserRole = async (userId, currentRole) => {
        // Sprawdź czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie można zmienić roli administratora lokalnego.",
            "error",
          );
          return;
        }

        // Pobierz dane użytkownika
        let user;
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          user = {
            id: userId,
            displayName: currentUser.displayName,
            email: currentUser.email,
            role: "admin",
            status: "active",
            isLocalAdmin: true,
          };
        } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
          user = { id: userId, ...userDoc.data() };
        }

        currentRoleUser = user;

        const decryptedUser = {
          ...user,
          phone: user.phone
            ? atob(user.phone)
            : "",
          address: {
            city: user.address?.city
              ? atob(user.address.city)
              : "",
          },
        };

        document.getElementById("role-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            Obecna rola: <span class="font-bold ${decryptedUser.role === 'admin' ? 'text-red-400' : decryptedUser.role === 'company' ? 'text-blue-400' : 'text-white'}">${decryptedUser.role.toUpperCase()}</span>
            ${decryptedUser.address.city ? ` • Miasto: ${decryptedUser.address.city}` : ""}
            ${decryptedUser.phone ? ` • Tel: ${decryptedUser.phone}` : ""}
          </div>
        `;

        document.getElementById("role-user-id").value = decryptedUser.id;

        // Zaznacz obecną rolę
        document.querySelector(`input[name="new-role"][value="${decryptedUser.role}"]`).checked = true;

        document.getElementById("user-role-modal").classList.remove("hidden");
      };

      // Zmienna globalna dla usuwanego użytkownika
      let currentDeletingUser = null;

      window.deleteUser = async (userId) => {
        // Sprawdź czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie można usunąć administratora lokalnego.",
            "error",
          );
          return;
        }

        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else {
            const userDoc = await getDoc(doc(db, "userProfiles", userId));
            if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentDeletingUser = user;

          showUserDeleteModal();
        } catch (error) {
          console.error("Error preparing user deletion:", error);
          showNotification(
            "Błąd przygotowania usunięcia użytkownika.",
            "error",
          );
        }
      };

      // Funkcje zarządzania produktami
      async function loadProducts() {
        try {
          const q = query(collection(db, "products"), orderBy("order", "asc"));
          const snapshot = await getDocs(q);
          productsList = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          renderProductsList();
        } catch (error) {
          console.error("Error loading products:", error);
          showNotification("Błąd ładowania produktów.", "error");
        }
      }

      function renderProductsList() {
        const productsHtml = productsList
          .map(
            (product) => `
                <div class="flex justify-between items-center p-3 bg-zinc-800 rounded-lg">
                    <div class="flex-1">
                        <div class="font-semibold">${product.title}</div>
                        <div class="text-sm text-zinc-400">${product.price} zł</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editProduct('${product.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Edytuj</button>
                        <button onclick="deleteProduct('${product.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usuń</button>
                    </div>
                </div>
            `,
          )
          .join("");

        document.getElementById("products-list").innerHTML =
          productsHtml ||
          '<div class="text-center text-zinc-500 py-4">Brak produktów</div>';
      }

      // Funkcje formatowania tekstu w edytorze
      window.formatText = (command) => {
        document.execCommand(command, false, null);
      };

      window.insertImage = () => {
        const url = prompt("Wprowadź URL obrazka:");
        if (url) {
          document.execCommand("insertImage", false, url);
        }
      };

      // Placeholder funkcje - będą zaimplementowane w kolejnych krokach
      async function loadMessages() {
        try {
        document.getElementById("messages-list").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie wiadomości...</div>';

          const q = query(
            collection(db, "contactForms"),
            orderBy("timestamp", "desc"),
          );

          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            document.getElementById("messages-list").innerHTML =
              '<div class="text-center text-zinc-500 py-8">Brak wiadomości kontaktowych</div>';
            return;
          }

          const messagesHtml = snapshot.docs
            .map((doc) => {
              const data = doc.data();
              const date = new Date(data.timestamp).toLocaleString("pl-PL");

              let statusClass = "";
              let statusText = "";
              let actionButton = "";

              switch (data.status) {
                case "in_progress":
                  statusClass = "text-orange-400";
                  statusText = "W trakcie";
                  actionButton = `<button onclick="completeMessage('${doc.id}')" class="btn-admin text-xs px-3 py-1">Zakończ</button>`;
                  break;
                case "completed":
                  statusClass = "text-green-400";
                  statusText = "Zakończona";
                  actionButton =
                    '<span class="text-zinc-500 text-xs">Zakończona</span>';
                  break;
                default:
                  statusClass = "text-zinc-400";
                  statusText = "Nieznany";
                  actionButton = `<button onclick="completeMessage('${doc.id}')" class="btn-admin text-xs px-3 py-1">Zakończ</button>`;
              }

              return `
              <div class="admin-card p-4 mb-4">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="font-bold text-lg coyote-text">${data.topic || "Bez tematu"}</h3>
                    <p class="text-sm text-zinc-400">Od: ${data.senderName} (${data.senderEmail})</p>
                    <p class="text-sm text-zinc-500">${date}</p>
                  </div>
                  <div class="text-right">
                    <span class="text-xs ${statusClass} font-semibold">${statusText}</span>
                    <div class="mt-2">${actionButton}</div>
                  </div>
                </div>
                <div class="bg-zinc-800 p-3 rounded-lg">
                  <p class="text-zinc-300 whitespace-pre-wrap">${data.content}</p>
                </div>
              </div>
            `;
            })
            .join("");

          document.getElementById("messages-list").innerHTML = messagesHtml;
        } catch (error) {
          console.error("Error loading messages:", error);
          document.getElementById("messages-list").innerHTML =
            '<div class="text-center text-red-500 py-8">Błąd ładowania wiadomości</div>';
        }
      }

      async function completeMessage(messageId) {
        try {
          const messageRef = doc(db, "contactForms", messageId);
          await updateDoc(messageRef, {
            status: "completed",
          });

          showNotification("Sprawa została zakończona", "success");
          // Ponownie załaduj wiadomości aby odświeżyć widok
          loadMessages();
        } catch (error) {
          console.error("Error completing message:", error);
          showNotification("Błąd podczas kończenia sprawy", "error");
        }
      }

      async function loadConversations() {
        document.getElementById("conversations-list").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie konwersacji...</div>';
      }

      async function loadEvents() {
        document.getElementById("events-list").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie wydarzeń...</div>';
      }

      async function loadCharity() {
        document.getElementById("charity-content").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie zawartości pomocy charytatywnej...</div>';
      }

      async function loadSettings() {
        // Ładowanie ustawień kontaktowych i tematów
        try {
          // Placeholder - będzie zaimplementowane
          document.getElementById("topics-list").innerHTML =
            '<div class="text-center text-zinc-500 py-4">Ładowanie tematów...</div>';
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      window.refreshProducts = () => {
        loadProducts();
      };

        // Funkcje dashboard
      const SITES_TO_CHECK = [
        "sklep.admin.strzelca.pl",
        "bazar.admin.strzelca.pl",
        "szkolenia.admin.strzelca.pl",
        "wydarzenia.admin.strzelca.pl",
        "blog.admin.strzelca.pl",
        "pomoc.admin.strzelca.pl",
        "dokumenty.admin.strzelca.pl",
        "kontakt.admin.strzelca.pl",
        "konto.admin.strzelca.pl",
        "admin.strzelca.pl",
      ];

      let sitesStatus = {};
      let lastStatusCheck = new Date();
      let visitsData = {
        today: 0,
        week: 0,
        month: 0,
        year: 0,
        total: 0,
        lastUpdate: null
      };

      // Funkcje sprawdzania głównych usług
      async function checkMainServicesStatus() {
        try {
          // Pokaż loading state dla przycisku
          const button = document.querySelector('button[onclick="checkMainServicesStatus()"]');
          if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>Odświeżanie...';
            button.disabled = true;

            // Przywróć przycisk po zakończeniu
            setTimeout(() => {
              button.innerHTML = originalText;
              button.disabled = false;
            }, 1500);
          }

          // Pokaż status sprawdzania (szare lampki)
          showCheckingStatus('firestore-status');
          showCheckingStatus('auth-status');
          showCheckingStatus('domain-status');

          // Sprawdź Firestore
          const firestoreTest = await checkFirestoreStatus();
          updateServiceStatus('firestore-status', firestoreTest);

          // Sprawdź logowanie (Firebase Auth)
          const authTest = await checkAuthStatus();
          updateServiceStatus('auth-status', authTest);

          // Sprawdź domenę główną
          const domainTest = await checkSubdomainStatus('admin.strzelca.pl');
          updateDomainStatus(domainTest);

        } catch (error) {
          console.error('Error checking main services:', error);
        }
      }

      // Sprawdzanie statusu Firestore
      async function checkFirestoreStatus() {
        try {
          // Test połączenia z Firestore przez próbę odczytu dokumentu systemowego
          const testDoc = await getDoc(doc(db, "system", "status"));
          return { online: true, status: 'Połączony' };
        } catch (error) {
          return { online: false, error: error.message };
        }
      }

      // Sprawdzanie statusu Firebase Auth i połączenia z bazą
      async function checkAuthStatus() {
        try {
          // Sprawdź połączenie z Firestore poprzez próbę odczytu
          const testDoc = await getDoc(doc(db, "system", "auth_test"));
          return { online: true, status: 'Połączony' };
        } catch (error) {
          // Jeśli nie ma połączenia z Firestore, Auth też nie działa
          return { online: false, error: 'Brak połączenia z bazą danych' };
        }
      }

      // Aktualizacja statusu usług
      function showCheckingStatus(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return;

        element.innerHTML = `
          <span class="text-zinc-400"><i class="fa-solid fa-spinner fa-spin text-xl"></i></span>
          <span class="text-zinc-400 font-semibold">Sprawdzanie...</span>
        `;
      }

      function updateServiceStatus(elementId, status) {
        const element = document.getElementById(elementId);
        if (!element) return;

        const statusClass = status.online ? 'text-green-400' : 'text-red-400';
        const statusText = status.online ? status.status || 'Online' : 'Offline';
        const icon = status.online ? 'fa-check-circle' : 'fa-times-circle';

        element.innerHTML = `
          <span class="${statusClass}"><i class="fa-solid ${icon} text-xl"></i></span>
          <span class="${statusClass} font-semibold">${statusText}</span>
        `;
      }

      // Aktualizacja statusu domeny
      function updateDomainStatus(status) {
        const element = document.getElementById('domain-status');

        const statusClass = status.online ? 'text-green-400' : 'text-red-400';
        const statusText = status.online ? 'Online' : 'Offline';
        const icon = status.online ? 'fa-check-circle' : 'fa-times-circle';

        element.innerHTML = `
          <span class="${statusClass}"><i class="fa-solid ${icon} text-xl"></i></span>
          <span class="${statusClass} font-semibold">${statusText}</span>
        `;
      }

      // Sprawdzanie pojedynczej subdomeny - pełna implementacja
      async function checkSubdomainStatus(site) {
        const startTime = Date.now();
        const timeout = 10000; // 10 sekund timeout

        try {
          // Próba fetch z timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);

          const response = await fetch(`https://${site}`, {
            method: "HEAD", // HEAD request - tylko headers, bez ciała
            mode: "no-cors", // Omiń CORS dla testów dostępności
            cache: "no-cache",
            signal: controller.signal,
          });

          clearTimeout(timeoutId);
          const responseTime = Date.now() - startTime;

          // W trybie no-cors nie możemy sprawdzić status HTTP, ale jeśli nie było błędu, strona prawdopodobnie działa
          return {
            online: true,
                lastCheck: new Date(),
            responseTime: responseTime,
            status: "OK",
              };
            } catch (error) {
          const responseTime = Date.now() - startTime;

          // Zapisz awarię do localStorage
          const failureKey = `site_failure_${site}`;
          const failureData = {
            site: site,
            timestamp: new Date().toISOString(),
            error: error.message,
            responseTime: responseTime,
          };

          try {
            localStorage.setItem(failureKey, JSON.stringify(failureData));
          } catch (storageError) {
            console.warn("Nie można zapisać do localStorage:", storageError);
          }

          return {
                online: false,
                lastCheck: new Date(),
            responseTime: responseTime,
            error: error.message,
            lastFailure: failureData,
          };
        }
      }

      // Sprawdzanie statusu wszystkich stron
      async function checkSitesStatus() {
        const statusContainer = document.getElementById("sites-status");
        statusContainer.innerHTML =
          '<div class="col-span-full text-center text-zinc-400 py-4">Sprawdzanie statusów...</div>';

        // Sprawdź wszystkie strony równolegle dla lepszej wydajności
        const promises = SITES_TO_CHECK.map((site) =>
          checkSubdomainStatus(site),
        );
        const results = await Promise.allSettled(promises);

        // Zapisz wyniki
        SITES_TO_CHECK.forEach((site, index) => {
          const result = results[index];
          if (result.status === "fulfilled") {
            sitesStatus[site] = result.value;
          } else {
            sitesStatus[site] = {
              online: false,
              lastCheck: new Date(),
              error: result.reason.message,
            };
          }
        });

          renderSitesStatus();
          lastStatusCheck = new Date();
        document.getElementById("last-status-check").textContent =
          lastStatusCheck.toLocaleString("pl-PL");
        }

        function renderSitesStatus() {
        const statusContainer = document.getElementById("sites-status");
        const statusHtml = SITES_TO_CHECK.map((site) => {
            const status = sitesStatus[site];
          if (!status) return "";

          const statusClass = status.online ? "text-green-400" : "text-red-400";
          const statusIcon = status.online
            ? "fa-check-circle"
            : "fa-times-circle";
          const statusText = status.online ? "Online" : "Offline";
          const details = status.online
            ? `${status.responseTime}ms`
            : status.lastCheck.toLocaleString("pl-PL");

            return `
              <div class="flex justify-between items-center p-3 bg-zinc-800 rounded-lg hover:bg-zinc-700 transition">
                <div class="flex items-center space-x-3">
                  <span class="${statusClass}"><i class="fa-solid ${statusIcon}"></i></span>
                  <span class="text-sm font-medium">${site}</span>
                </div>
                <div class="text-right">
                  <div class="${statusClass} font-semibold">${statusText}</div>
                  <div class="text-xs text-zinc-500">${details}</div>
                </div>
              </div>
            `;
        }).join("");

          statusContainer.innerHTML = statusHtml;
        }

        // Funkcje aktywności
        async function loadActivityStats() {
          try {
            // Załaduj dane odwiedzin (już załadowane przez initVisitsTracking)
            updateVisitsDisplay();

            let loggedUsers = 0;
            let activeUsers = 0;
            let firebaseConnected = true;

            try {
              // Pobierz wszystkich użytkowników
              const usersSnapshot = await getDocs(collection(db, "userProfiles"));
              const users = usersSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

              // Zalogowani użytkownicy - ci którzy mają aktywne sesje
              const activeSessions = getActiveSessions();
              loggedUsers = activeSessions.length;

              // Aktywni użytkownicy - ci których sesja była odświeżona w ciągu ostatniej godziny
              const oneHourAgo = Date.now() - (60 * 60 * 1000);
              activeUsers = activeSessions.filter(session => {
                return session.lastActivity && session.lastActivity > oneHourAgo;
              }).length;

            } catch (error) {
              console.warn("Firebase connection error:", error);
              firebaseConnected = false;
              // Nie pokazuj sztucznych danych - zostaw 0
              loggedUsers = 0;
              activeUsers = 0;
            }

            // Goście (niezalogowani) - szacowanie na podstawie odwiedzin
            const guests = Math.max(visitsData.today - loggedUsers, 0);
            const totalActive = activeUsers + guests;

            // Aktualizuj wyświetlanie
            document.getElementById("active-logged-users").textContent = loggedUsers;
            document.getElementById("active-guests").textContent = guests;
            document.getElementById("active-total").textContent = totalActive;

            // Pokaż czerwoną kropkę jeśli brak połączenia z Firebase
            if (!firebaseConnected) {
              showFirebaseError();
            }

          } catch (error) {
            console.error("Error loading activity stats:", error);
            showFirebaseError();
          }
        }

        // Funkcja zwracająca aktywne sesje administratorów
        function getActiveSessions() {
          const sessions = [];
          try {
            // Sprawdź czy istnieje sesja administratora w localStorage
            const sessionData = loadAdminSession();
            if (sessionData && sessionData.user) {
              sessions.push({
                uid: sessionData.user.uid,
                lastActivity: sessionData.lastActivity || sessionData.timestamp
              });
            }

            // W przyszłości można rozszerzyć o sesje innych użytkowników
            // poprzez sprawdzenie kolekcji sessions w Firebase
          } catch (error) {
            console.warn("Error getting active sessions:", error);
          }
          return sessions;
        }

        // Funkcja wyświetlająca błąd połączenia z Firebase
        function showFirebaseError() {
          // Można dodać wizualną wskazówkę o problemie z połączeniem
          console.warn("Brak połączenia z Firebase - niektóre dane mogą być niedostępne");
          // Tutaj można dodać czerwoną kropkę lub komunikat o błędzie
        }

        // Funkcje zdarzeń
        let eventsData = [
          {
            id: 1,
            type: "MESSAGE_SENT",
            user: "AndrzejKowalski",
            description: "wysłał wiadomość do KowalKowal",
            content: "Cześć, jak się masz?",
            timestamp: new Date(Date.now() - 1000 * 60 * 5), // 5 min temu
            details:
              'Użytkownik AndrzejKowalski napisał wiadomość do użytkownika KowalKowal o treści: "Cześć, jak się masz?"',
          },
          {
            id: 2,
            type: "LIKE_BLOG",
            user: "MarekNowak",
            description: "polubił post na blogu",
            content: "Nowe słuchawki firmy XXX",
            timestamp: new Date(Date.now() - 1000 * 60 * 15), // 15 min temu
            details:
              'Użytkownik MarekNowak polubił post na blogu: "Nowe słuchawki firmy XXX"',
          },
          {
            id: 3,
            type: "CONTACT_FORM",
            user: "Anonimowy",
            description: "wypełnił formularz kontaktowy",
            content: "Pytanie o produkty",
            timestamp: new Date(Date.now() - 1000 * 60 * 30), // 30 min temu
            details:
              "Anonimowy użytkownik wypełnił formularz kontaktowy z pytaniem o produkty",
          },
        ];

        async function loadRecentEvents() {
          try {
            // Pokaż loading state dla przycisku
            const button = document.querySelector('button[onclick="refreshEvents()"]');
            if (button) {
              const originalText = button.innerHTML;
              button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>Odświeżanie...';
              button.disabled = true;

              // Przywróć przycisk po krótkim czasie
              setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
              }, 1000);
            }

            // Domyślne dane testowe - w rzeczywistości pobierać z Firebase
            // eventsData już jest zdefiniowany powyżej

            renderRecentEvents();
            document.getElementById("last-events-update").textContent =
              new Date().toLocaleString("pl-PL");
          } catch (error) {
            console.error("Error loading events:", error);
          }
        }

        function renderRecentEvents() {
        const eventsContainer = document.getElementById("recent-events");
          const recentEvents = eventsData.slice(0, 10); // Pokaż 10 najnowszych

        const eventsHtml = recentEvents
          .map((event) => {
            const timeAgo = getTimeAgo(event.timestamp);
            const activityLog = renderActivityLog(event);
            return `
              <div class="p-4 bg-zinc-800 rounded-lg cursor-pointer hover:bg-zinc-700 transition" onclick="showEventDetails('${event.id}')">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-semibold text-white">${event.user || "System"}</div>
                  <div class="text-xs text-zinc-500">${timeAgo}</div>
                </div>
                <div class="text-sm text-zinc-300">${activityLog.description}</div>
                <div class="text-xs text-zinc-500 mt-1">${activityLog.content}</div>
              </div>
            `;
          })
          .join("");

        eventsContainer.innerHTML =
          eventsHtml ||
          '<div class="text-center text-zinc-500 py-4">Brak zdarzeń</div>';
        }

        function getTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          if (diffMins < 60) return `${diffMins} min temu`;
          if (diffHours < 24) return `${diffHours} godz. temu`;
          return `${diffDays} dni temu`;
        }

        // Modal ze szczegółami zdarzenia
        function showEventDetails(eventId, eventData = null) {
          let event = eventData;
          if (!event) {
            event = eventsData.find((e) => e.id === eventId);
          }
          if (!event) return;

        const activityLog = renderActivityLog(event);

          // Utwórz modal
          const modalHtml = `
            <div id="event-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
              <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-700 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold coyote-text">Szczegóły Zdarzenia</h2>
                  <button onclick="closeEventModal()" class="text-zinc-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                  </button>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-zinc-400">Użytkownik:</label>
                    <div class="text-white font-semibold">${event.user || "System"}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Rodzaj zdarzenia:</label>
                    <div class="text-white">${event.type}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Nagłówek:</label>
                    <div class="text-white">${activityLog.description}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Szczegóły:</label>
                    <div class="text-white">${activityLog.details}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Data i czas:</label>
                    <div class="text-white">${event.timestamp?.toDate?.()?.toLocaleString("pl-PL") || new Date(event.timestamp).toLocaleString("pl-PL")}</div>
                  </div>
                </div>
              </div>
            </div>
          `;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        window.closeEventModal = () => {
          const modal = document.getElementById("event-modal");
          if (modal) modal.remove();
        };

        // System logowania odwiedzin
        function initVisitsTracking() {
          // Sprawdź czy to nowa sesja (pierwsze wejście)
          const sessionKey = 'admin_session_' + new Date().toDateString();
          const hasVisited = sessionStorage.getItem(sessionKey);

          if (!hasVisited) {
            // To pierwsze wejście w tej sesji
            sessionStorage.setItem(sessionKey, 'true');
            recordVisit();
          }

          // Załaduj dane odwiedzin
          loadVisitsData();
        }

        function recordVisit() {
          const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
          const visitsKey = `visits_${today}`;

          try {
            // Pobierz dzisiejsze odwiedziny
            let todayVisits = parseInt(localStorage.getItem(visitsKey) || '0');
            todayVisits++;
            localStorage.setItem(visitsKey, todayVisits.toString());

            // Zaktualizuj liczniki
            updateVisitsCounters();
          } catch (error) {
            console.error('Error recording visit:', error);
          }
        }

        function loadVisitsData() {
          try {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // Dzisiejsze odwiedziny
            const todayVisits = parseInt(localStorage.getItem(`visits_${todayStr}`) || '0');

            // Odwiedziny w tygodniu (ostatnie 7 dni)
            let weekVisits = 0;
            for (let i = 0; i < 7; i++) {
              const date = new Date(today);
              date.setDate(date.getDate() - i);
              const dateStr = date.toISOString().split('T')[0];
              weekVisits += parseInt(localStorage.getItem(`visits_${dateStr}`) || '0');
            }

            // Odwiedziny w miesiącu - wszystkie dni od początku miesiąca do dziś
            let monthVisits = 0;
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Iteruj przez wszystkie klucze w localStorage i sumuj wizyty z bieżącego miesiąca
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('visits_')) {
                const dateStr = key.replace('visits_', '');
                const visitDate = new Date(dateStr + 'T00:00:00');
                if (visitDate.getMonth() === currentMonth && visitDate.getFullYear() === currentYear) {
                  monthVisits += parseInt(localStorage.getItem(key) || '0');
                }
              }
            }

            // Odwiedziny w roku - wszystkie dni od początku roku do dziś
            let yearVisits = 0;
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('visits_')) {
                const dateStr = key.replace('visits_', '');
                const visitDate = new Date(dateStr + 'T00:00:00');
                if (visitDate.getFullYear() === currentYear) {
                  yearVisits += parseInt(localStorage.getItem(key) || '0');
                }
              }
            }

            // Całkowite odwiedziny (wszystkie klucze visits_*)
            let totalVisits = 0;
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key && key.startsWith('visits_')) {
                totalVisits += parseInt(localStorage.getItem(key) || '0');
              }
            }

            visitsData = {
              today: todayVisits,
              week: weekVisits,
              month: monthVisits,
              year: yearVisits,
              total: totalVisits,
              lastUpdate: new Date()
            };

            // Zaktualizuj wyświetlanie
            updateVisitsDisplay();

          } catch (error) {
            console.error('Error loading visits data:', error);
          }
        }

        function updateVisitsCounters() {
          loadVisitsData();
        }

        function updateVisitsDisplay() {
          document.getElementById('visits-today').textContent = visitsData.today;
          document.getElementById('visits-week').textContent = visitsData.week;
          document.getElementById('visits-month').textContent = visitsData.month;
          document.getElementById('visits-year').textContent = visitsData.year;
          document.getElementById('visits-total').textContent = visitsData.total;
        }

        window.refreshActivitySection = refreshActivitySection;
        window.checkSitesStatus = checkSitesStatus;
        window.refreshEvents = loadRecentEvents;
        // Panel wszystkich zdarzeń z filtrowaniem
        window.openEventsPanel = () => {
          const modalHtml = `
            <div id="events-panel-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
              <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-700 w-full max-w-6xl max-h-[90vh] overflow-hidden flex flex-col">
                <div class="text-center mb-6">
                  <h2 class="text-3xl font-bold coyote-text uppercase tracking-wider">Wszystkie Zdarzenia</h2>
                  <button onclick="closeEventsPanel()" class="absolute top-4 right-4 text-zinc-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                  </button>
                </div>

                <!-- Filtry -->
                <div class="bg-zinc-800/50 rounded-lg p-4 mb-4">
                  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Rubryka 1: Typ i Użytkownik -->
                    <div class="space-y-2">
                      <div>
                        <label class="text-sm text-zinc-400 block">Typ</label>
                        <select id="filter-type" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-2 text-white w-full">
                          <option value="all">Wszystkie</option>
                          <option value="MESSAGE_SENT">Wiadomości</option>
                          <option value="LIKE_BLOG">Polubienia</option>
                          <option value="CONTACT_FORM">Formularze</option>
                          <option value="USER_REGISTER">Rejestracje</option>
                          <option value="PRODUCT_VIEW">Wyświetlenia produktów</option>
                        </select>
                      </div>
                      <div>
                        <label class="text-sm text-zinc-400 block">Użytkownik</label>
                        <input type="text" id="filter-user" placeholder="Nazwa użytkownika" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-2 text-white w-full">
                      </div>
                    </div>

                    <!-- Rubryka 2: Data od i Data do -->
                    <div class="space-y-2">
                      <div>
                        <label class="text-sm text-zinc-400 block">Data od</label>
                        <input type="date" id="filter-date-from" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-2 text-white w-full">
                      </div>
                      <div>
                        <label class="text-sm text-zinc-400 block">Data do</label>
                        <input type="date" id="filter-date-to" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-2 text-white w-full">
                      </div>
                    </div>

                    <!-- Rubryka 3: Godzina od i Godzina do -->
                    <div class="space-y-2">
                      <div>
                        <label class="text-sm text-zinc-400 block">Godzina od</label>
                        <input type="time" id="filter-time-from" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-2 text-white w-full">
                      </div>
                      <div>
                        <label class="text-sm text-zinc-400 block">Godzina do</label>
                        <input type="time" id="filter-time-to" class="bg-zinc-700 border border-zinc-600 rounded px-3 py-2 text-white w-full">
                      </div>
                    </div>

                    <!-- Rubryka 4: Wyczysc i Wyszukaj -->
                    <div class="space-y-3 flex flex-col justify-end h-full">
                      <button onclick="resetEventFilters()" class="bg-zinc-600 text-white px-3 py-2 rounded hover:bg-zinc-500 w-full text-sm">
                        <i class="fa-solid fa-undo mr-2"></i>
                        Wyczyść
                      </button>
                      <button onclick="applyEventFilters()" class="btn-admin px-3 py-2 w-full text-sm">
                        <i class="fa-solid fa-filter mr-2"></i>
                        Wyszukaj
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Lista zdarzeń -->
                <div class="flex-1 overflow-y-auto bg-zinc-900/30 rounded-lg p-3">
                  <div id="full-events-list" class="space-y-2">
                    <!-- Zdarzenia będą ładowane dynamicznie -->
                  </div>
                </div>

                <!-- Statystyki -->
                <div class="mt-4 pt-4 border-t border-zinc-700">
                  <div class="text-sm text-zinc-400">
                    Łącznie zdarzeń: <span id="events-total-count">0</span> |
                    Wyświetlonych: <span id="events-filtered-count">0</span>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.body.insertAdjacentHTML('beforeend', modalHtml);
          loadFullEventsList();
        };

        window.closeEventsPanel = () => {
          const modal = document.getElementById('events-panel-modal');
          if (modal) modal.remove();
        };

        function loadFullEventsList() {
          // W rzeczywistości pobierać wszystkie zdarzenia z Firestore
          // Na razie użyjemy przykładowych danych
          const allEvents = [
            ...eventsData,
            // Dodaj więcej przykładowych zdarzeń
            {
              id: 4,
              type: 'USER_REGISTER',
              user: 'JanKowalski',
              description: 'zarejestrował się',
              content: 'Nowe konto',
              timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2), // 2 godz temu
              details: 'Użytkownik JanKowalski pomyślnie zarejestrował nowe konto w systemie'
            },
            {
              id: 5,
              type: 'PRODUCT_VIEW',
              user: 'AnnaNowak',
              description: 'przeglądał produkt',
              content: 'Karabin myśliwski XYZ',
              timestamp: new Date(Date.now() - 1000 * 60 * 45), // 45 min temu
              details: 'Użytkownik AnnaNowak przeglądał produkt: Karabin myśliwski XYZ'
            }
          ];

          displayFilteredEvents(allEvents);
        }

        function displayFilteredEvents(events) {
          const container = document.getElementById('full-events-list');
          const totalCount = document.getElementById('events-total-count');
          const filteredCount = document.getElementById('events-filtered-count');

          totalCount.textContent = events.length;

          const eventsHtml = events.map(event => {
            const timeAgo = getTimeAgo(event.timestamp);
            const activityLog = renderActivityLog(event);
            return `
              <div class="p-4 bg-zinc-800 rounded-lg cursor-pointer hover:bg-zinc-700 transition" onclick="showEventDetails('${event.id}', ${JSON.stringify(event).replace(/"/g, '&quot;')})">
                <div class="flex justify-between items-start mb-2">
                  <div class="flex-1">
                    <div class="font-semibold text-white">${event.user || 'System'}</div>
                    <div class="text-sm text-zinc-300">${activityLog.description}</div>
                    <div class="text-xs text-zinc-500 mt-1">${activityLog.content}</div>
                  </div>
                  <div class="text-xs text-zinc-500 ml-4">${timeAgo}</div>
                </div>
                <div class="text-xs text-zinc-600 mt-2">${event.type}</div>
              </div>
            `;
          }).join('');

          container.innerHTML = eventsHtml || '<div class="text-center text-zinc-500 py-4">Brak zdarzeń spełniających kryteria</div>';
          filteredCount.textContent = events.length;
        }

        window.applyEventFilters = () => {
          const typeFilter = document.getElementById('filter-type').value;
          const userFilter = document.getElementById('filter-user').value.toLowerCase();
          const dateFrom = document.getElementById('filter-date-from').value;
          const dateTo = document.getElementById('filter-date-to').value;
          const timeFrom = document.getElementById('filter-time-from').value;
          const timeTo = document.getElementById('filter-time-to').value;

          const allEvents = [
            ...eventsData,
            {
              id: 4,
              type: 'USER_REGISTER',
              user: 'JanKowalski',
              description: 'zarejestrował się',
              content: 'Nowe konto',
              timestamp: new Date(Date.now() - 1000 * 60 * 60 * 2),
              details: 'Użytkownik JanKowalski pomyślnie zarejestrował nowe konto w systemie'
            },
            {
              id: 5,
              type: 'PRODUCT_VIEW',
              user: 'AnnaNowak',
              description: 'przeglądał produkt',
              content: 'Karabin myśliwski XYZ',
              timestamp: new Date(Date.now() - 1000 * 60 * 45),
              details: 'Użytkownik AnnaNowak przeglądał produkt: Karabin myśliwski XYZ'
            }
          ];

          let filteredEvents = allEvents;

          // Filtr typu
          if (typeFilter !== 'all') {
            filteredEvents = filteredEvents.filter(event => event.type === typeFilter);
          }

          // Filtr użytkownika
          if (userFilter) {
            filteredEvents = filteredEvents.filter(event =>
              (event.user || '').toLowerCase().includes(userFilter)
            );
          }

          // Filtr daty
          if (dateFrom) {
            const fromDate = new Date(dateFrom);
            filteredEvents = filteredEvents.filter(event => event.timestamp >= fromDate);
          }

          if (dateTo) {
            const toDate = new Date(dateTo);
            toDate.setHours(23, 59, 59, 999); // Koniec dnia
            filteredEvents = filteredEvents.filter(event => event.timestamp <= toDate);
          }

          // Filtr godziny
          if (timeFrom || timeTo) {
            filteredEvents = filteredEvents.filter(event => {
              const eventTime = event.timestamp.getHours() * 60 + event.timestamp.getMinutes();
              let match = true;

              if (timeFrom) {
                const fromTime = timeFrom.split(':').map(Number);
                const fromMinutes = fromTime[0] * 60 + fromTime[1];
                match = match && eventTime >= fromMinutes;
              }

              if (timeTo) {
                const toTime = timeTo.split(':').map(Number);
                const toMinutes = toTime[0] * 60 + toTime[1];
                match = match && eventTime <= toMinutes;
              }

              return match;
            });
          }

          displayFilteredEvents(filteredEvents);
        };

        window.resetEventFilters = () => {
          document.getElementById('filter-type').value = 'all';
          document.getElementById('filter-user').value = '';
          document.getElementById('filter-date-from').value = '';
          document.getElementById('filter-date-to').value = '';
          document.getElementById('filter-time-from').value = '';
          document.getElementById('filter-time-to').value = '';
          loadFullEventsList();
        };
        window.showEventDetails = showEventDetails;

        // Funkcja odświeżania sekcji Aktywność
        async function refreshActivitySection() {
          try {
            // Pokaż loading state dla przycisku
            const button = document.querySelector('button[onclick="refreshActivitySection()"]');
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>Odświeżanie...';
            button.disabled = true;

            // Pokaż loading state dla wszystkich elementów sekcji Aktywność
            showActivityLoadingState();

            // Odśwież dane
            await loadActivityStats();
            await loadContactFormsCount();
            await loadPendingTasksCount();
            await fetchGAStatistics();

            // Przywróć przycisk
            setTimeout(() => {
              button.innerHTML = originalText;
              button.disabled = false;
            }, 1000);

            showNotification("Sekcja Aktywność została odświeżona.", "success");
          } catch (error) {
            console.error("Error refreshing activity section:", error);
            showNotification("Błąd podczas odświeżania sekcji.", "error");
            hideActivityLoadingState(); // Ukryj loading state w przypadku błędu
          }
        }

        // Funkcje do pokazywania/ukrywania stanu ładowania w sekcji Aktywność
        function showActivityLoadingState() {
          const elementsToUpdate = [
            'active-logged-users', 'active-guests', 'active-total',
            'pending-issues', 'new-forms-today', 'total-issues',
            'visits-today', 'visits-week', 'visits-month', 'visits-year', 'visits-total'
          ];

          elementsToUpdate.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
              element.innerHTML = '<i class="fa-solid fa-spinner fa-spin text-zinc-400"></i>';
              element.classList.add('text-zinc-400');
              element.classList.remove('coyote-text', 'text-green-400', 'text-red-400', 'text-blue-400');
            }
          });
        }

        function hideActivityLoadingState() {
          // Funkcja przywraca normalne klasy CSS, ale zostawia aktualne wartości
          const elementsToRestore = [
            'active-logged-users', 'active-guests', 'active-total',
            'pending-issues', 'new-forms-today', 'total-issues',
            'visits-today', 'visits-week', 'visits-month', 'visits-year', 'visits-total'
          ];

          elementsToRestore.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
              element.classList.remove('text-zinc-400');
              // Dodaj odpowiednie klasy w zależności od typu elementu
              if (id.includes('active-logged-users') || id.includes('active-guests')) {
                element.classList.add('coyote-text');
              } else if (id.includes('active-total') || id.includes('new-forms-today')) {
                element.classList.add('text-green-400');
              } else if (id.includes('pending-issues')) {
                element.classList.add('text-red-400');
              } else {
                element.classList.add('text-blue-400');
              }
            }
          });
        }

        // Automatyczne odświeżanie sekcji Aktywność co 30 minut
        setInterval(async () => {
          if (currentUser && !currentUser.isLocalAdmin) {
            // Tylko dla administratorów Firebase (nie lokalnych)
            try {
              await loadActivityStats();
              await loadContactFormsCount();
              await loadPendingTasksCount();
              console.log('Activity section auto-refreshed at', new Date().toLocaleString('pl-PL'));
            } catch (error) {
              console.error('Auto-refresh activity section error:', error);
            }
          }
        }, 30 * 60 * 1000); // 30 minut

        // Integracja z activityLogs - Firestore listener
      function setupActivityLogsListener() {
        if (activityLogsListener) {
          activityLogsListener(); // Odłącz poprzedni listener
        }

        activityLogsListener = onSnapshot(
          query(
            collection(db, "activityLogs"),
            orderBy("timestamp", "desc"),
            limit(10),
          ),
          (snapshot) => {
            if (snapshot.docs.length > 0) {
              // Jeśli są dane z Firestore, użyj ich
              eventsData = snapshot.docs.map((doc) => ({
                id: doc.id,
                ...doc.data(),
              }));
            } else {
              // Jeśli nie ma danych z Firestore, użyj domyślnych danych testowych
              eventsData = [
                {
                  id: 1,
                  type: "MESSAGE_SENT",
                  user: "AndrzejKowalski",
                  description: "wysłał wiadomość do KowalKowal",
                  content: "Cześć, jak się masz?",
                  timestamp: new Date(Date.now() - 1000 * 60 * 5),
                  details: 'Użytkownik AndrzejKowalski napisał wiadomość do użytkownika KowalKowal o treści: "Cześć, jak się masz?"',
                },
                {
                  id: 2,
                  type: "LIKE_BLOG",
                  user: "MarekNowak",
                  description: "polubił post na blogu",
                  content: "Nowe słuchawki firmy XXX",
                  timestamp: new Date(Date.now() - 1000 * 60 * 15),
                  details: 'Użytkownik MarekNowak polubił post na blogu: "Nowe słuchawki firmy XXX"',
                },
                {
                  id: 3,
                  type: "CONTACT_FORM",
                  user: "Anonimowy",
                  description: "wypełnił formularz kontaktowy",
                  content: "Pytanie o produkty",
                  timestamp: new Date(Date.now() - 1000 * 60 * 30),
                  details: "Anonimowy użytkownik wypełnił formularz kontaktowy z pytaniem o produkty",
                },
              ];
            }

            renderRecentEvents();
            document.getElementById("last-events-update").textContent =
              new Date().toLocaleString("pl-PL");
          },
          (error) => {
            console.error("Activity logs listener error:", error);
            // W przypadku błędu, użyj domyślnych danych
            eventsData = [
              {
                id: 1,
                type: "MESSAGE_SENT",
                user: "AndrzejKowalski",
                description: "wysłał wiadomość do KowalKowal",
                content: "Cześć, jak się masz?",
                timestamp: new Date(Date.now() - 1000 * 60 * 5),
                details: 'Użytkownik AndrzejKowalski napisał wiadomość do użytkownika KowalKowal o treści: "Cześć, jak się masz?"',
              },
              {
                id: 2,
                type: "LIKE_BLOG",
                user: "MarekNowak",
                description: "polubił post na blogu",
                content: "Nowe słuchawki firmy XXX",
                timestamp: new Date(Date.now() - 1000 * 60 * 15),
                details: 'Użytkownik MarekNowak polubił post na blogu: "Nowe słuchawki firmy XXX"',
              },
              {
                id: 3,
                type: "CONTACT_FORM",
                user: "Anonimowy",
                description: "wypełnił formularz kontaktowy",
                content: "Pytanie o produkty",
                timestamp: new Date(Date.now() - 1000 * 60 * 30),
                details: "Anonimowy użytkownik wypełnił formularz kontaktowy z pytaniem o produkty",
              },
            ];
            renderRecentEvents();
            document.getElementById("last-events-update").textContent =
              new Date().toLocaleString("pl-PL");
          },
        );
      }

      function setupPendingTasksListener() {
        if (pendingTasksListener) {
          pendingTasksListener(); // Odłącz poprzedni listener
        }

        pendingTasksListener = onSnapshot(
          query(
            collection(db, "contactForms"),
            where("status", "==", "in_progress"),
          ),
          (snapshot) => {
            document.getElementById("pending-tasks").textContent =
              snapshot.size;
          },
          (error) => {
            console.error("Pending tasks listener error:", error);
          },
        );
      }

      // Funkcja renderowania pojedynczego logu aktywności
      function renderActivityLog(event) {
        let description = "";
        let content = "";
        let details = "";

        switch (event.type) {
          case "MESSAGE_SENT":
            // Wyciągnij odbiorcę z description jeśli jest dostępny
            const recipientMatch = event.description.match(/do\s+([^\s]+)/);
            const recipient = recipientMatch ? recipientMatch[1] : "innego użytkownika";
            description = `${event.user} wysłał wiadomość do ${recipient}`;
            content = event.content || "Treść niedostępna";
            details = `Użytkownik ${event.user} wysłał wiadomość do użytkownika ${recipient} o treści: "${event.content || "Treść niedostępna"}"`;
            break;
          case "LIKE_BLOG":
            description = `${event.user} polubił post`;
            content = event.content || "Tytuł niedostępny";
            details = `Użytkownik ${event.user} polubił post na blogu: "${event.content || "Tytuł niedostępny"}"`;
            break;
          case "CONTACT_FORM":
            description = `${event.user} wypełnił formularz kontaktowy`;
            content = event.subject || "Zapytanie";
            details = `Użytkownik ${event.user} wypełnił formularz kontaktowy z tematem: "${event.subject || "Zapytanie"}"`;
            break;
          case "USER_REGISTER":
            description = `${event.user} zarejestrował się`;
            content = "Nowe konto";
            details = `Użytkownik ${event.user} pomyślnie zarejestrował nowe konto w systemie`;
            break;
          case "PRODUCT_VIEW":
            description = `${event.user} przeglądał produkt`;
            content = event.productName || "Produkt";
            details = `Użytkownik ${event.user} przeglądał produkt: "${event.productName || "Produkt"}"`;
            break;
          default:
            description = `${event.user} wykonał akcję ${event.type}`;
            content = event.content || "Szczegóły niedostępne";
            details = `Użytkownik ${event.user} wykonał akcję typu ${event.type}: ${event.content || "Szczegóły niedostępne"}`;
        }

        return { description, content, details };
      }

      // Funkcje liczników formularzy i niezakończonych spraw
      async function loadContactFormsCount() {
        try {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);

          const q = query(
            collection(db, "contactForms"),
            where("timestamp", ">=", today),
            where("timestamp", "<", tomorrow),
          );

          const snapshot = await getDocs(q);
          document.getElementById("new-forms-today").textContent = snapshot.size;
        } catch (error) {
          console.error("Error loading contact forms count:", error);
          document.getElementById("today-contacts").textContent = "0";
        }
      }

      async function loadPendingTasksCount() {
        try {
          // Niezakończone sprawy
          const pendingQuery = query(
            collection(db, "contactForms"),
            where("status", "==", "in_progress")
          );
          const pendingSnapshot = await getDocs(pendingQuery);
          const pendingCount = pendingSnapshot.size;

          // Wszystkie sprawy (nowe + zakończone)
          const allQuery = query(collection(db, "contactForms"));
          const allSnapshot = await getDocs(allQuery);
          const totalCount = allSnapshot.size;

          document.getElementById("pending-issues").textContent = pendingCount;
          document.getElementById("total-issues").textContent = totalCount;
        } catch (error) {
          console.error("Error loading pending tasks count:", error);
          document.getElementById("pending-issues").textContent = "0";
          document.getElementById("total-issues").textContent = "0";
        }
      }

      // Placeholder dla Google Analytics - przygotowanie do integracji
      async function fetchGAStatistics() {
        try {
          // TODO: Integracja z Google Analytics Data API
          // Wymaga Service Account i odpowiednich uprawnień

          const today = new Date().toISOString().split("T")[0];
          const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const yearAgo = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];

          // Placeholder - w rzeczywistości pobierać z GA API
          document.getElementById("today-visits").textContent =
            Math.floor(Math.random() * 500) + 100;
          document.getElementById("week-visits").textContent =
            Math.floor(Math.random() * 2000) + 500;
          document.getElementById("month-visits").textContent =
            Math.floor(Math.random() * 8000) + 2000;
          document.getElementById("year-visits").textContent =
            Math.floor(Math.random() * 50000) + 10000;

          console.log("GA Statistics fetched (placeholder implementation)");
        } catch (error) {
          console.error("Error fetching GA statistics:", error);
          // Fallback wartości
          document.getElementById("today-visits").textContent = "0";
          document.getElementById("week-visits").textContent = "0";
          document.getElementById("month-visits").textContent = "0";
          document.getElementById("year-visits").textContent = "0";
        }
      }

      window.editProduct = (productId) => {
        const product = productsList.find((p) => p.id === productId);
        if (!product) return;

        document.getElementById("product-id").value = product.id;
        document.getElementById("product-title").value = product.title || "";
        document.getElementById("product-price").value = product.price || "";
        document.getElementById("product-description").innerHTML =
          product.description || "";

        // Scroll do formularza
        document
          .querySelector("#tab-products")
          .scrollIntoView({ behavior: "smooth" });
      };

      window.deleteProduct = async (productId) => {
        if (!confirm("Czy na pewno chcesz usunąć ten produkt?")) return;

        try {
          await deleteDoc(doc(db, "products", productId));
          showNotification("Produkt został usunięty.");
          loadProducts();
        } catch (error) {
          console.error("Error deleting product:", error);
          showNotification("Błąd usuwania produktu.", "error");
        }
      };

      window.sendMessage = () => {
        // Placeholder - implementacja wysyłania wiadomości
        showNotification(
          "Funkcja wysyłania wiadomości będzie dostępna wkrótce.",
        );
      };

      window.addTopic = () => {
        // Placeholder - implementacja dodawania tematu
        showNotification("Funkcja dodawania tematu będzie dostępna wkrótce.");
      };

      // Obsługa formularza produktu
      document
        .getElementById("product-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const productId = document.getElementById("product-id").value;
          const title = document.getElementById("product-title").value.trim();
          const price = document.getElementById("product-price").value.trim();
          const description = document.getElementById(
            "product-description",
          ).innerHTML;

          if (!title || !price) {
            showNotification("Wypełnij wszystkie wymagane pola.", "error");
            return;
          }

          try {
            const productData = {
              title,
              price,
              description,
              date: Date.now(),
              order: productsList.length,
            };

            if (productId) {
              // Aktualizacja istniejącego produktu
              await updateDoc(doc(db, "products", productId), productData);
              showNotification("Produkt został zaktualizowany.");
            } else {
              // Dodanie nowego produktu
              await addDoc(collection(db, "products"), productData);
              showNotification("Produkt został dodany.");
            }

            // Wyczyść formularz
            document.getElementById("product-form").reset();
            document.getElementById("product-description").innerHTML = "";
            document.getElementById("product-id").value = "";

            loadProducts();
          } catch (error) {
            console.error("Error saving product:", error);
            showNotification("Błąd zapisywania produktu.", "error");
          }
        });

      // Obsługa formularza edycji użytkownika
      document
        .getElementById("user-edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("edit-user-id").value;
          if (!userId) return;

          const saveBtn = e.target.querySelector('button[type="submit"]');
          saveBtn.disabled = true;
          saveBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zapisywanie...';

          try {
            // Pobierz rolę przed zapisaniem
            const selectedRole = document.getElementById("edit-role").value;

            // Przygotuj dane firmy jeśli rola to firma
            let companyData = null;
            if (selectedRole === "company") {
              companyData = {
                name: document.getElementById("edit-company-name").value.trim(),
                nip: document.getElementById("edit-company-nip").value.trim(),
                address: {
                  street: document.getElementById("edit-company-street").value.trim(),
                  buildingNumber: document.getElementById("edit-company-building-number").value.trim(),
                  postalCode: document.getElementById("edit-company-postal-code").value.trim(),
                  city: document.getElementById("edit-company-city").value.trim(),
                },
              };
            }

            // Zaszyfruj wrażliwe dane przed zapisaniem
            const updatedProfile = {
              displayName: document
                .getElementById("edit-display-name")
                .value.trim(),
              firstName: document
                .getElementById("edit-first-name")
                .value.trim(),
              lastName: document.getElementById("edit-last-name").value.trim(),
              phone: btoa(document.getElementById("edit-phone").value.trim()),
              address: {
                street: btoa(
                  document.getElementById("edit-street").value.trim(),
                ),
                buildingNumber: btoa(
                  document.getElementById("edit-building-number").value.trim(),
                ),
                postalCode: btoa(
                  document.getElementById("edit-postal-code").value.trim(),
                ),
                city: btoa(document.getElementById("edit-city").value.trim()),
              },
              parcelLocker: btoa(
                document.getElementById("edit-parcel-locker").value.trim(),
              ),
              newsletter: document.getElementById("edit-newsletter").checked,
              role: selectedRole,
              status: document.getElementById("edit-status").value,
              updatedAt: new Date(),
              updatedBy: currentUser.uid,
            };

            // Dodaj dane firmy jeśli istnieją
            if (companyData) {
              updatedProfile.companyData = companyData;
            }

            await updateDoc(doc(db, "userProfiles", userId), updatedProfile);

            // Zaloguj edycję profilu
            await logActivity(userId, "PROFILE_EDITED", {
              editedBy: currentUser.uid,
              changes: Object.keys(updatedProfile),
            });

            showNotification("Dane użytkownika zostały zaktualizowane.");
            closeUserEdit();
            loadUsers(); // Odśwież listę użytkowników
          } catch (error) {
            console.error("Error updating user:", error);
            showNotification(
              "Błąd podczas aktualizacji danych użytkownika.",
              "error",
            );
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML =
              '<i class="fa-solid fa-save mr-2"></i>Zapisz zmiany';
          }
        });

      // Obsługa formularza blokowania użytkownika
      document
        .getElementById("user-block-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("block-user-id").value;
          if (!userId) return;

          const duration = document.getElementById("block-duration").value;
          const contentAction = document.querySelector(
            'input[name="content-action"]:checked',
          ).value;

          const blockBtn = e.target.querySelector('button[type="submit"]');
          blockBtn.disabled = true;
          blockBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Blokowanie...';

          try {
            // Oblicz datę zakończenia blokady
            let blockedUntil = null;
            const now = new Date();

            switch (duration) {
              case "15min":
                blockedUntil = new Date(now.getTime() + 15 * 60 * 1000);
                break;
              case "1hour":
                blockedUntil = new Date(now.getTime() + 60 * 60 * 1000);
                break;
              case "6hours":
                blockedUntil = new Date(now.getTime() + 6 * 60 * 60 * 1000);
                break;
              case "24hours":
                blockedUntil = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                break;
              case "7days":
                blockedUntil = new Date(
                  now.getTime() + 7 * 24 * 60 * 60 * 1000,
                );
                break;
              case "30days":
                blockedUntil = new Date(
                  now.getTime() + 30 * 24 * 60 * 60 * 1000,
                );
                break;
              case "permanent":
                blockedUntil = null; // Blokada permanentna
                break;
            }

            const blockData = {
              status: "blocked",
              blockedAt: now,
              blockedUntil: blockedUntil,
              blockedBy: currentUser.uid,
              blockDuration: duration,
              contentAction: contentAction,
              isPermanentBlock: duration === "permanent",
            };

            await updateDoc(doc(db, "userProfiles", userId), blockData);

            // Zaloguj blokadę użytkownika
            await logActivity(userId, "USER_BLOCKED", {
              duration: duration,
              blockedUntil: blockedUntil,
              contentAction: contentAction,
              isPermanent: duration === "permanent",
              blockedBy: currentUser.uid,
            });

            // Jeśli wybrano usunięcie zawartości, tutaj należałoby dodać logikę usuwania
            // (produkty, wiadomości, itp.) - będzie implementowane w następnych krokach

            showNotification(
              `Użytkownik został zablokowany${blockedUntil ? " do " + blockedUntil.toLocaleString("pl-PL") : " na zawsze"}.`,
            );
            closeUserBlock();
            loadUsers();
          } catch (error) {
            console.error("Error blocking user:", error);
            showNotification("Błąd podczas blokowania użytkownika.", "error");
          } finally {
            blockBtn.disabled = false;
            blockBtn.innerHTML =
              '<i class="fa-solid fa-ban mr-2"></i>Zablokuj użytkownika';
          }
        });

      // Obsługa formularza usuwania użytkownika
      document
        .getElementById("user-delete-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("delete-user-id").value;
          if (!userId) return;

          const contentAction = document.querySelector(
            'input[name="delete-content-action"]:checked',
          ).value;

          const deleteBtn = e.target.querySelector('button[type="submit"]');
          deleteBtn.disabled = true;
          deleteBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Usuwanie...';

          try {
            if (contentAction === "remove") {
              // Usuń całą zawartość użytkownika - tutaj należałoby dodać logikę usuwania
              // produktów, wiadomości, komentarzy itp. z innych kolekcji
              // Na razie tylko oznaczamy, że zawartość została usunięta
              console.log("Usuwanie zawartości użytkownika:", userId);
            }

            // Usuń profil użytkownika
            await deleteDoc(doc(db, "userProfiles", userId));

            // Zaloguj usunięcie użytkownika PRZED faktycznym usunięciem
            await logActivity(userId, "USER_DELETED", {
              contentAction: contentAction,
              deletedBy: currentUser.uid,
              userEmail: currentDeletingUser.email,
              userDisplayName: currentDeletingUser.displayName,
            });

            // Usuń z listy mailingowej jeśli był zapisany
            try {
              await deleteDoc(
                doc(db, "mailingList", currentDeletingUser.email),
              );
            } catch (error) {
              // Ignoruj błąd jeśli użytkownik nie był na liście mailingowej
            }

            showNotification(
              `Użytkownik został całkowicie usunięty z systemu${contentAction === "keep" ? " (zawartość zachowana)" : " (zawartość usunięta)"}.`,
            );
            closeUserDelete();
            loadUsers();
          } catch (error) {
            console.error("Error deleting user:", error);
            showNotification("Błąd podczas usuwania użytkownika.", "error");
          } finally {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML =
              '<i class="fa-solid fa-trash mr-2"></i>Usuń użytkownika';
          }
        });

      // Obsługa formularza zmiany roli użytkownika
      document
        .getElementById("user-role-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("role-user-id").value;
          if (!userId || !currentRoleUser) return;

          const newRole = document.querySelector(
            'input[name="new-role"]:checked',
          ).value;
          const currentRole = currentRoleUser.role;

          if (newRole === currentRole) {
            showNotification("Wybrana rola jest już przypisana użytkownikowi.", "error");
            return;
          }

          const roleBtn = e.target.querySelector('button[type="submit"]');
          roleBtn.disabled = true;
          roleBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zmienianie roli...';

          try {
            await updateDoc(doc(db, "userProfiles", userId), { role: newRole });

            // Zaloguj zmianę roli
            await logActivity(userId, "ROLE_CHANGE", {
              oldRole: currentRole,
              newRole: newRole,
              changedBy: currentUser.uid,
            });

            showNotification(
              `Rola użytkownika została zmieniona na: ${newRole === "company" ? "FIRMA" : newRole === "admin" ? "ADMINISTRATOR" : "UŻYTKOWNIK"}.`,
            );
            closeUserRole();
            loadUsers();
          } catch (error) {
            console.error("Error changing user role:", error);
            showNotification("Błąd zmiany roli użytkownika.", "error");
          } finally {
            roleBtn.disabled = false;
            roleBtn.innerHTML =
              '<i class="fa-solid fa-user-tag mr-2"></i>Zmień rolę';
          }
        });

      // Automatyczne odświeżanie listy użytkowników co 30 minut (tylko gdy nie jesteśmy w zakładce użytkowników)
      setInterval(() => {
        if (currentTab !== "users" && currentUser) {
          console.log("Auto-refreshing users list at", new Date().toLocaleString("pl-PL"));
          loadUsers();
        }
      }, 30 * 60 * 1000); // 30 minut

      // Automatyczne odświeżanie co 1 godzinę (aby nie tracić limitów Firebase)
      setInterval(
        async () => {
          if (currentUser && !currentUser.isLocalAdmin) {
            // Tylko dla administratorów Firebase (nie lokalnych)
          try {
            await checkSitesStatus();
              // Activity logs są automatycznie aktualizowane przez listener
              console.log(
                "Dashboard auto-refreshed at",
                new Date().toLocaleString("pl-PL"),
              );
          } catch (error) {
              console.error("Auto-refresh error:", error);
            }
          }
        },
        60 * 60 * 1000,
      ); // 1 godzina

      // ===== FUNKCJE DO MODERACJI OPINII =====

      // Ładowanie opinii do moderacji
      async function loadReviews() {
        try {
          document.getElementById("reviews-loading").classList.remove("hidden");
          document.getElementById("reviews-empty").classList.add("hidden");

          const reviewsQuery = query(
            collection(db, "userReviews"),
            orderBy("timestamp", "desc"),
          );

          const reviewsSnapshot = await getDocs(reviewsQuery);
          const reviews = reviewsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          displayReviewsForModeration(reviews);
        } catch (error) {
          console.error("Błąd ładowania opinii:", error);
          showNotification("Błąd ładowania opinii", "error");
        } finally {
          document.getElementById("reviews-loading").classList.add("hidden");
        }
      }

      // Wyświetlanie opinii do moderacji
      function displayReviewsForModeration(reviews) {
        const reviewsList = document.getElementById("reviews-list");
        const reviewsEmpty = document.getElementById("reviews-empty");

        if (reviews.length === 0) {
          reviewsEmpty.classList.remove("hidden");
          reviewsList.innerHTML = "";
          return;
        }

        reviewsEmpty.classList.add("hidden");

        reviewsList.innerHTML = reviews
          .map(
            (review) => `
          <div class="admin-card" data-review-id="${review.id}">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="font-bold text-lg">${review.raterName} → ${review.ratedName}</div>
                <div class="text-sm text-zinc-400">${formatDate(review.timestamp)}</div>
              </div>
              <div class="flex items-center space-x-2">
                <span class="status-badge status-${review.status || "pending"}">
                  ${getStatusText(review.status || "pending")}
                </span>
                <div class="flex space-x-1">
                  ${generateStars(review.rating)}
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 p-4 rounded-lg mb-4">
              <p class="text-zinc-300">${review.comment}</p>
            </div>

            ${
              review.status === "pending"
                ? `
              <div class="flex space-x-2">
                <button onclick="approveReview('${review.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  <i class="fa-solid fa-check mr-2"></i>
                  Zatwierdź
                </button>
                <button onclick="rejectReview('${review.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                  <i class="fa-solid fa-times mr-2"></i>
                  Odrzuć
                </button>
              </div>
            `
                : review.status === "approved"
                  ? `
              <div class="flex space-x-2">
                <button onclick="rejectReview('${review.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                  <i class="fa-solid fa-times mr-2"></i>
                  Odrzuć
                </button>
              </div>
            `
                  : `
              <div class="flex space-x-2">
                <button onclick="approveReview('${review.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  <i class="fa-solid fa-check mr-2"></i>
                  Zatwierdź
                </button>
              </div>
            `
            }
          </div>
        `,
          )
          .join("");

        // Obsługa filtra
        document
          .getElementById("reviews-filter")
          .addEventListener("change", (e) => {
            const filter = e.target.value;
            filterReviews(reviews, filter);
          });
      }

      // Filtrowanie opinii
      function filterReviews(reviews, status) {
        let filteredReviews = reviews;

        if (status !== "all") {
          filteredReviews = reviews.filter(
            (review) => (review.status || "pending") === status,
          );
        }

        displayReviewsForModeration(filteredReviews);
      }

      // Generowanie gwiazdek dla opinii
      function generateStars(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += `<i class="fa-solid fa-star ${i <= rating ? "text-yellow-400" : "text-zinc-600"}"></i>`;
        }
        return stars;
      }

      // Pobieranie tekstu statusu
      function getStatusText(status) {
        switch (status) {
          case "pending":
            return "Oczekuje";
          case "approved":
            return "Zatwierdzona";
          case "rejected":
            return "Odrzucona";
          default:
            return "Nieznany";
        }
      }

      // Zatwierdzanie opinii
      async function approveReview(reviewId) {
        try {
          await updateDoc(doc(db, "userReviews", reviewId), {
            status: "approved",
          });

          showNotification("Opinia została zatwierdzona", "success");
          loadReviews(); // Odśwież listę
        } catch (error) {
          console.error("Błąd zatwierdzania opinii:", error);
          showNotification("Błąd zatwierdzania opinii", "error");
        }
      }

      // Odrzucanie opinii
      async function rejectReview(reviewId) {
        try {
          await updateDoc(doc(db, "userReviews", reviewId), {
            status: "rejected",
          });

          showNotification("Opinia została odrzucona", "success");
          loadReviews(); // Odśwież listę
        } catch (error) {
          console.error("Błąd odrzucania opinii:", error);
          showNotification("Błąd odrzucania opinii", "error");
        }
      }

      // ===== KONIEC FUNKCJI MODERACJI OPINII =====

      // Inicjalizacja - sprawdź czy istnieje zapisana sesja administratora
      const savedSession = loadAdminSession();
      if (savedSession) {
        // Przywróć użytkownika z sesji
        currentUser = savedSession.user;
        updateAdminDisplay(currentUser);
        // Inicjalizuj śledzenie aktywności
        initActivityTracking();
        document.getElementById("login-section").classList.add("hidden");
        document.getElementById("admin-panel").classList.remove("hidden");
        switchTab("dashboard");
        showNotification("Przywrócono sesję administratora.");
      } else if (auth.currentUser) {
        // Sprawdź Firebase tylko jeśli nie ma zapisanej sesji
        onAuthStateChanged(auth, async (user) => {
          if (user && (await checkAdminRole(user))) {
            currentUser = user;
            updateAdminDisplay(user);
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("admin-panel").classList.remove("hidden");
            switchTab("dashboard");
          }
        });
      }

      // Obsługa checkbox "Zapamiętaj STRZELCA" dla admin panelu
      document.addEventListener('DOMContentLoaded', function() {
        const adminToggleElement = document.getElementById('admin-remember-toggle');
        if (adminToggleElement) {
          adminToggleElement.addEventListener('click', adminToggleRemember);
          adminToggleElement.addEventListener('mouseenter', adminHandleMouseEnter);
          adminToggleElement.addEventListener('mouseleave', adminHandleMouseLeave);
        }
      });

      // Funkcje obsługi interakcji z "Zapamiętaj STRZELCA" dla admin panelu
      function adminHandleMouseEnter() {
        const text1 = document.getElementById('admin-remember-text-1');
        const text2 = document.getElementById('admin-remember-text-2');

        text1.classList.add('text-green-500');
        text1.classList.remove('text-zinc-500');
        text2.classList.add('text-green-500');
        text2.classList.remove('text-zinc-500');
      }

      function adminHandleMouseLeave() {
        const checkbox = document.getElementById('admin-remember-me');
        const text1 = document.getElementById('admin-remember-text-1');
        const text2 = document.getElementById('admin-remember-text-2');

        // Wróć do szarego tylko jeśli checkbox nie jest zaznaczony
        if (!checkbox.checked) {
          text1.classList.add('text-zinc-400');
          text1.classList.remove('text-green-500');
          text2.classList.add('text-zinc-400');
          text2.classList.remove('text-green-500');
        }
      }

      function adminToggleRemember() {
        const checkbox = document.getElementById('admin-remember-me');
        const text1 = document.getElementById('admin-remember-text-1');
        const text2 = document.getElementById('admin-remember-text-2');

        if (!checkbox || !text1 || !text2) {
          console.error('Admin remember elements not found');
          return;
        }

        checkbox.checked = !checkbox.checked;

        if (checkbox.checked) {
          text1.classList.add('text-green-500');
          text1.classList.remove('text-zinc-400');
          text2.classList.add('text-green-500');
          text2.classList.remove('text-zinc-400');
        } else {
          text1.classList.add('text-zinc-400');
          text1.classList.remove('text-green-500');
          text2.classList.add('text-zinc-400');
          text2.classList.remove('text-green-500');
        }
      }
    </script>
  </body>
</html>
