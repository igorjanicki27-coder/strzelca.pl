<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://strzelca.pl/ikona.svg"
    />
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg" />

    <title>Panel Administracyjny - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --coyote: #c19a6b;
      }

      /* Ustawienie tła na elemencie html dla Safari */
      html {
        background-color: #0a0a0a;
        background-image:
          linear-gradient(rgba(10, 10, 10, 0.6), #0a0a0a),
          url("https://strzelca.pl/tlo.png");
        background-size: 120% auto;
        background-position: center top;
        background-attachment: fixed;
        background-repeat: no-repeat;
        height: 100vh; /* Stała wysokość zamiast min-height */
        /* Safari viewport height fix */
        height: -webkit-fill-available;
        height: 100dvh; /* Dynamic viewport height for modern browsers */
        overflow: hidden; /* Blokuj scroll na poziomie html */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: transparent; /* Przejrzyste tło, żeby pokazać tło html */
        color: #e5e5e5;
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100vh; /* Stała wysokość zamiast min-height */
        /* Safari viewport height fix */
        height: -webkit-fill-available;
        height: 100dvh; /* Dynamic viewport height for modern browsers */
        overflow: hidden; /* Blokuj scroll na poziomie body */
      }

      /* Sekcja logowania zajmuje całą wysokość, żeby nie było czarnego paska */
      #login-section {
        min-height: 100vh;
        min-height: 100dvh; /* Dynamic viewport height */
        min-height: -webkit-fill-available; /* Safari */
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }
      .admin-text {
        color: #dc2626;
        font-family: "Orbitron";
      }

      input,
      select,
      textarea {
        background: #111 !important;
        border: 1px solid #222 !important;
        color: white !important;
        padding: 12px 16px !important;
        border-radius: 8px;
        width: 100%;
        outline: none;
        transition: 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--coyote) !important;
        background: #161616 !important;
      }

      .btn-admin {
        background: var(--coyote);
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 12px 24px;
        border-radius: 8px;
        transition: 0.3s;
        cursor: pointer;
      }
      .btn-admin:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(193, 154, 107, 0.3);
      }
      .btn-admin:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Loading states */
      .loading-spinner {
        position: relative;
        overflow: hidden;
      }

      .loading-spinner::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(193, 154, 107, 0.4), transparent);
        animation: shimmer 1.5s ease-in-out infinite;
      }

      .loading-spinner i.fa-sync-alt {
        animation: spin 1s linear infinite;
        color: rgba(0, 0, 0, 0.8) !important;
      }

      /* Globalny loading overlay dla dashboardu */
      .dashboard-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 10, 10, 0.7);
        backdrop-filter: blur(2px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .dashboard-loading-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .loading-content {
        background: #111;
        border: 1px solid var(--coyote);
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 0 30px rgba(193, 154, 107, 0.3);
      }

      .loading-spinner-large {
        font-size: 2em;
        color: var(--coyote);
        margin-bottom: 16px;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        color: white;
        font-family: "Orbitron";
        font-size: 1.1em;
        margin: 0;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .admin-card {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 24px;
        transition: 0.3s;
      }
      .admin-card:hover {
        border-color: var(--coyote);
      }

      /* Styl dla górnego paska nawigacji */
      .top-nav {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      /* Style dla zakładek w poziomie */
      #tabs-container .nav-item {
        padding: 8px 12px;
        border-radius: 12px;
        margin: 2px 0;
        font-size: 13px;
        white-space: nowrap;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #tabs-container .nav-pages-toggle {
        padding: 8px 12px;
        border-radius: 12px;
        margin: 2px 0;
        font-size: 13px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      #tabs-container .nav-section-title {
        margin: 0 8px 0 0;
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        font-size: 10px;
      }

      /* Rozwijane menu stron w poziomie */
      .nav-submenu {
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .nav-submenu.open {
        max-height: 200px;
      }

      .nav-submenu-item {
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 8px;
        margin: 2px;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.05);
      }

      .nav-submenu-item:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateY(-1px);
      }

      .nav-submenu-item.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow: 0 0 16px rgba(193, 154, 107, 0.2);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      /* Scrollbar hide utility */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      /* Kompaktowy sidebar */
      .compact-sidebar {
        width: 64px;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
      }

      .nav-item {
        padding: 10px 13px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 16px;
        margin: 3px 12px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }
      .nav-item:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateX(2px) scale(1.01);
        box-shadow:
          0 4px 16px rgba(193, 154, 107, 0.12),
          0 0 0 1px rgba(193, 154, 107, 0.1);
      }
      .nav-item.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow:
          0 0 24px rgba(193, 154, 107, 0.15),
          0 2px 8px rgba(193, 154, 107, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      .admin-name {
        color: var(--coyote);
        font-family: "Orbitron";
        font-weight: 700;
      }

      .coyote {
        color: var(--coyote);
      }

      .editor-content {
        background: #161616;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 16px;
        min-height: 200px;
        color: white;
      }

      .toolbar {
        background: #111;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
      }
      .toolbar button {
        background: #222;
        border: none;
        color: white;
        padding: 8px 12px;
        margin: 0 2px;
        border-radius: 4px;
        cursor: pointer;
        transition: 0.3s;
      }
      .toolbar button:hover {
        background: var(--coyote);
        color: black;
      }

      .status-active {
        border-left: 4px solid #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
      .status-blocked {
        border-left: 4px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }
      .status-suspended {
        border-left: 4px solid #f59e0b;
        background: rgba(245, 158, 11, 0.1);
      }

      .role-admin {
        background: #dc2626;
        color: white;
      }
      .role-user {
        background: white;
        color: black;
      }
      .role-company {
        background: var(--coyote);
        color: black;
      }

      .nav-section-title {
        margin-top: 16px;
        padding: 8px 16px 4px 16px;
        font-weight: 500;
        font-size: 11px;
        opacity: 0.7;
      }
      .nav-section-title:first-child {
        margin-top: 0;
        padding-top: 4px;
      }

      .nav-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: rgba(193, 154, 107, 0.05);
        border-radius: 12px;
        margin: 4px 12px;
      }

      .nav-submenu.open {
        max-height: 500px;
      }

      .nav-submenu-item {
        padding: 10px 16px 10px 40px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 8px;
        margin: 2px 4px;
        font-size: 13px;
      }

      .nav-submenu-item:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateX(2px);
      }

      .nav-submenu-item.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow:
          0 0 24px rgba(193, 154, 107, 0.15),
          0 2px 8px rgba(193, 154, 107, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      .nav-pages-toggle:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateX(2px) scale(1.01);
        box-shadow:
          0 4px 16px rgba(193, 154, 107, 0.12),
          0 0 0 1px rgba(193, 154, 107, 0.1);
      }

      .nav-pages-toggle.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow:
          0 0 24px rgba(193, 154, 107, 0.15),
          0 2px 8px rgba(193, 154, 107, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
    </style>
  </head>
  <body>

    <!-- Sekcja logowania -->
    <div
      id="login-section"
      class="h-full flex items-start justify-center p-6 pt-16 md:pt-20 lg:pt-24"
    >
      <div class="admin-card max-w-md w-full">
        <h1
          class="text-3xl font-black uppercase italic font-[Orbitron] text-center mb-8"
        >
          <span class="coyote-text">PANEL</span>
          <span class="admin-text">ADMINISTRATORA</span>
        </h1>

        <form id="admin-login-form" class="space-y-6">
          <div>
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Login</label
            >
            <input type="text" id="admin-email" placeholder="Login" required />
          </div>

          <div>
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Hasło</label
            >
            <input
              type="password"
              id="admin-password"
              placeholder="Hasło"
              required
            />
          </div>

          <div class="flex items-center justify-center mb-6">
            <input type="checkbox" id="admin-remember" class="hidden" />
            <div
              class="flex flex-col items-center cursor-pointer hover:scale-105 transition-transform duration-200"
              id="admin-remember-toggle"
            >
              <span
                id="admin-remember-text-1"
                class="text-[10px] uppercase tracking-[0.15em] font-medium text-zinc-400 block text-center transition-colors"
                >Zapamiętaj</span
              >
              <span
                id="admin-remember-text-2"
                class="text-[10px] uppercase tracking-[0.15em] font-medium text-zinc-400 block text-center w-full transition-colors"
              ></span>
            </div>
          </div>

          <button type="submit" class="btn-admin w-full" id="admin-login-btn">
            <i class="fa-solid fa-sign-in-alt mr-2"></i>
            ZALOGUJ
          </button>
        </form>

        <div
          id="login-status"
          class="mt-6 p-4 rounded-lg text-center text-sm hidden"
        ></div>
      </div>
    </div>

    <!-- Główny panel administracyjny -->
    <div id="admin-panel" class="hidden h-full flex flex-col">
      <!-- Górny pasek nawigacji -->
      <div class="bg-black/40 backdrop-blur-xl border-b border-zinc-700/50 sticky top-0 z-50">
        <div class="flex items-center justify-between px-4 py-3">
          <!-- Logo i nazwa -->
          <div class="flex items-center space-x-4">
            <button
              onclick="toggleSidebar()"
              class="md:hidden text-zinc-400 hover:text-white transition p-2"
              id="mobile-menu-btn"
            >
              <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="hidden md:flex items-center space-x-3">
              <i class="fa-solid fa-crown text-coyote text-xl"></i>
              <span class="text-white font-bold text-lg">Admin Panel</span>
              </div>
            </div>

          <!-- Profil administratora (kompaktowy) -->
          <div class="flex items-center space-x-3">
            <div class="hidden sm:flex items-center space-x-2 text-sm">
              <span id="admin-display-name-compact" class="text-white font-medium"></span>
              <span class="text-zinc-400">@Admin</span>
            </div>
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-coyote/20 to-zinc-600/40 flex items-center justify-center border border-zinc-500/20">
              <i class="fa-solid fa-user-shield text-coyote text-sm"></i>
          </div>
          <button
            onclick="logoutAdmin()"
              class="text-zinc-400 hover:text-red-400 transition p-2"
              title="Wyloguj"
          >
              <i class="fa-solid fa-sign-out-alt text-sm"></i>
          </button>
          </div>
        </div>

        <!-- Pasek zakładek -->
        <nav class="px-4 pb-3">
          <!-- Pierwsza linia: Zarządzanie po lewej, status po prawej -->
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center space-x-4">
              <div class="nav-item" data-tab="dashboard">
                <i class="fa-solid fa-tachometer-alt mr-2"></i>
                Dashboard
              </div>
              <div class="nav-item" data-tab="messages">
                <i class="fa-solid fa-comments mr-2"></i>
                Wiadomości
              </div>
              <div class="nav-item" data-tab="users">
                <i class="fa-solid fa-users mr-2"></i>
                Użytkownicy
              </div>
              <div class="nav-item" data-tab="newsletter">
                <i class="fa-solid fa-envelope-open mr-2"></i>
                Newsletter
              </div>
            </div>
            <div class="nav-item" data-tab="status">
              <i class="fa-solid fa-server mr-2"></i>
              <span id="status-tab-text">Status</span>
            </div>
          </div>

          <!-- Druga linia: Zakładki stron -->
          <div class="flex items-center justify-start space-x-8 overflow-x-auto scrollbar-hide" id="tabs-container">
            <div class="nav-item" data-tab="products">
              <i class="fa-solid fa-shopping-cart mr-2"></i>
              Sklep
            </div>
            <div class="nav-item" data-tab="bazar">
              <i class="fa-solid fa-store mr-2"></i>
              Bazar
            </div>
            <div class="nav-item" data-tab="szkolenia">
              <i class="fa-solid fa-graduation-cap mr-2"></i>
              Szkolenia
            </div>
            <div class="nav-item" data-tab="events">
              <i class="fa-solid fa-calendar-alt mr-2"></i>
              Wydarzenia
            </div>
            <div class="nav-item" data-tab="blog">
              <i class="fa-solid fa-blog mr-2"></i>
              Blog
            </div>
            <div class="nav-item" data-tab="charity">
              <i class="fa-solid fa-heart mr-2"></i>
              Pomoc
            </div>
            <div class="nav-item" data-tab="dokumenty">
              <i class="fa-solid fa-file-pdf mr-2"></i>
              Dokumenty
            </div>
            <div class="nav-item" data-tab="kontakt">
              <i class="fa-solid fa-address-book mr-2"></i>
              Kontakt
            </div>
          </div>
        </nav>
      </div>

      <!-- Główna zawartość -->
      <div class="flex flex-1 min-h-0">
        <!-- Zawartość główna -->
        <div class="flex-1 p-4 md:p-8 overflow-y-auto" id="main-content">
          <!-- Status -->
          <div id="tab-status" class="tab-content">

            <!-- Sekcja System Serwera -->
          <div class="admin-card mb-8">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold coyote-text">Monitoring usług</h2>
                <button
                  onclick="checkMainServicesStatus()"
                  class="btn-admin text-sm px-3 py-1"
                >
                  <i class="fa-solid fa-sync-alt mr-1"></i>
                  Odśwież
                </button>
                </div>

              <!-- Główny status serwera - kompaktowy design -->
              <div class="bg-zinc-800/50 rounded-xl p-6 mb-8">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <!-- Status bazy danych -->
                  <div class="text-center">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                      <i class="fa-solid fa-database text-lg text-zinc-400"></i>
                      <span class="text-sm font-medium text-zinc-300"
                        >Baza danych</span
                      >
                    </div>
                    <div
                      class="flex items-center justify-center space-x-2 animate-fade-in"
                      id="firestore-status"
                    >
                <span class="text-green-400"
                        ><i class="fa-solid fa-check-circle text-lg"></i
                      ></span>
                      <span class="text-green-400 font-semibold text-sm"
                        >Online</span
                      >
                    </div>
                  </div>

                  <!-- Status logowania -->
                  <div class="text-center">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                      <i class="fa-solid fa-user-shield text-lg text-zinc-400"></i>
                      <span class="text-sm font-medium text-zinc-300"
                        >Logowanie</span
                      >
                    </div>
                    <div
                      class="flex items-center justify-center space-x-2 animate-fade-in"
                      id="auth-status"
                    >
                      <span class="text-green-400"
                        ><i class="fa-solid fa-check-circle text-lg"></i
                      ></span>
                      <span class="text-green-400 font-semibold text-sm"
                        >Połączony</span
                      >
                    </div>
                  </div>

                  <!-- Status domeny -->
                  <div class="text-center">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                      <i class="fa-solid fa-globe text-lg text-zinc-400"></i>
                      <span class="text-sm font-medium text-zinc-300"
                        >Domena</span
                      >
                    </div>
                    <div
                      class="flex items-center justify-center space-x-2 animate-fade-in"
                      id="domain-status"
                    >
                      <span class="text-green-400"
                        ><i class="fa-solid fa-check-circle text-lg"></i
                      ></span>
                      <span class="text-green-400 font-semibold text-sm"
                        >Online</span
                      >
                    </div>
                  </div>
              </div>
            </div>

            <div
                class="grid grid-cols-1 md:grid-cols-2 gap-3"
              id="sites-status"
            >
              <!-- Status stron będzie ładowany dynamicznie -->
            </div>

            <div class="mt-4 text-sm text-zinc-400 text-center">
              <span
                >Ostatnie sprawdzenie:
                <span id="last-status-check">Teraz</span></span
              >
              </div>
            </div>
          </div>

        <!-- Dashboard -->
          <div id="tab-dashboard" class="tab-content active">

            <!-- Sekcja 1: Aktywność -->
            <div class="admin-card mb-8">

              <!-- Główny kontener z podziałem na sekcje -->
              <div
                class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6"
                style="height: 280px"
              >
                <!-- Lewa część: Aktywność użytkowników (50% szer, 70% wys) -->
                <div
                  class="bg-zinc-800/50 rounded-lg p-4 flex flex-col justify-center"
                >
                  <h3 class="text-lg font-semibold text-white mb-4 text-center">
                    Aktywność
                  </h3>
                  <div class="space-y-4 flex-1 flex flex-col justify-center">
              <div class="text-center">
                <div
                        class="text-2xl font-bold coyote-text mb-1"
                        id="active-logged-users"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Zalogowani</div>
              </div>
              <div class="text-center">
                <div
                        class="text-2xl font-bold coyote-text mb-1"
                        id="active-guests"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Goście</div>
              </div>
              <div class="text-center">
                <div
                        class="text-2xl font-bold text-green-400 mb-1"
                        id="active-total"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Razem</div>
                </div>
              </div>
                </div>

                <!-- Prawa część: Sprawy (50% szer, 70% wys) -->
                <div
                  class="bg-zinc-800/50 rounded-lg p-4 flex flex-col justify-center"
                >
                  <h3 class="text-lg font-semibold text-white mb-4 text-center">
                    Sprawy
                  </h3>
                  <div class="space-y-4 flex-1 flex flex-col justify-center">
              <div class="text-center">
                <div
                        class="text-2xl font-bold text-red-400 mb-1"
                        id="pending-issues"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Niezakończone</div>
                    </div>
                    <div class="text-center">
                      <div
                        class="text-2xl font-bold text-green-400 mb-1"
                        id="new-forms-today"
                      >
                        0
                      </div>
                      <div class="text-sm text-zinc-400">Nowe formularze</div>
                    </div>
                    <div class="text-center">
                      <div
                        class="text-2xl font-bold text-blue-400 mb-1"
                        id="total-issues"
                      >
                        0
                      </div>
                      <div class="text-sm text-zinc-400">Razem</div>
                    </div>
                  </div>
              </div>
            </div>

              <!-- Dolna część: Odwiedziny (100% szer, 30% wys) -->
              <div class="bg-zinc-800/50 rounded-lg p-4" style="height: 120px">
                <h3 class="text-lg font-semibold text-white mb-4 text-center">
                  Odwiedziny
                </h3>
                <div
                  class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 h-full"
                >
              <div class="text-center">
                <div
                  class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-today"
                >
                  0
                </div>
                    <div class="text-xs text-zinc-400">Dziś</div>
              </div>
              <div class="text-center">
                <div
                  class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-week"
                >
                  0
                </div>
                    <div class="text-xs text-zinc-400">Tydzień</div>
              </div>
              <div class="text-center">
                <div
                  class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-month"
                >
                  0
                </div>
                    <div class="text-xs text-zinc-400">Miesiąc</div>
              </div>
                  <div class="text-center">
                    <div
                      class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-year"
                    >
                      0
                    </div>
                    <div class="text-xs text-zinc-400">Rok</div>
                  </div>
                  <div class="text-center">
                    <div
                      class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-total"
                    >
                      0
                    </div>
                    <div class="text-xs text-zinc-400">Ogółem</div>
                  </div>
            </div>
          </div>

              <!-- Sekcja zdarzeń -->
              <div class="mt-6">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold coyote-text">Najnowsze zdarzenia</h3>
              <div class="flex space-x-2">
                <button
                  id="dashboard-refresh-btn"
                  onclick="refreshDashboardWithLoading()"
                      class="btn-admin text-xs px-3 py-1"
                >
                  <i class="fa-solid fa-sync-alt mr-1"></i>
                  Odśwież
                </button>
              </div>
            </div>

            <div id="recent-events" class="space-y-3">
              <!-- Najnowsze zdarzenia będą ładowane dynamicznie -->
            </div>

            <div class="mt-4 text-sm text-zinc-400 text-center">
              <span
                >Ostatnia aktualizacja:
                <span id="last-events-update">Teraz</span></span
              >
            </div>
          </div>
            </div>
        </div>

        <!-- Zarządzanie użytkownikami -->
        <div id="tab-users" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              Zarządzanie Użytkownikami
            </h1>
              <button
                onclick="refreshUsers()"
                class="btn-admin text-sm px-3 py-2"
              >
              <i class="fa-solid fa-sync-alt mr-1"></i>
              Odśwież
            </button>
          </div>

          <!-- Sekcja najnowszych użytkowników -->
          <div class="admin-card mb-8">
            <h3 class="text-xl font-bold mb-4">Najnowsi użytkownicy</h3>
            <div id="recent-users" class="space-y-3">
              <!-- Najnowsi użytkownicy będą ładowani dynamicznie -->
            </div>
          </div>

          <div class="admin-card mb-6">
            <div class="flex flex-wrap gap-4 mb-4">
              <button
                onclick="filterUsers('all')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase active border-coyote text-coyote"
                data-filter="all"
              >
                Wszyscy
              </button>
              <button
                onclick="filterUsers('active')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="active"
              >
                Aktywni
              </button>
              <button
                  onclick="filterUsers('inactive')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                  data-filter="inactive"
              >
                  Nieaktywni
              </button>
              <button
                  onclick="filterUsers('blocked')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                  data-filter="blocked"
              >
                  Zablokowani
              </button>
              <button
                onclick="filterUsers('company')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="company"
              >
                Firmy
              </button>
            </div>

              <div class="mb-4">
                <input
                  type="text"
                  id="user-search"
                  placeholder="Szukaj użytkowników..."
                  class="w-full"
                />
              </div>

              <div id="users-list" class="space-y-3">
                <!-- Lista użytkowników będzie ładowana dynamicznie -->
              </div>

              <div id="users-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie użytkowników...</p>
              </div>

              <div
                id="users-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i class="fa-solid fa-users text-4xl mb-4 text-zinc-600"></i>
                <p>Brak użytkowników do wyświetlenia</p>
            </div>
          </div>
        </div>

        <!-- Zarządzanie produktami -->
        <div id="tab-products" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              Zarządzanie Produktami
            </h1>
            <button onclick="refreshProducts()" class="btn-admin">
              <i class="fa-solid fa-sync-alt mr-2"></i>
              Odśwież
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Dodaj/Edytuj Produkt</h3>
              <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id" />
                <input
                  type="text"
                  id="product-title"
                  placeholder="Nazwa produktu"
                  required
                />
                <input
                  type="text"
                  id="product-price"
                  placeholder="Cena (np. 299.99)"
                  required
                />

                <div class="toolbar">
                  <button type="button" onclick="formatText('bold')">
                    <i class="fa-solid fa-bold"></i>
                  </button>
                  <button
                    type="button"
                    onclick="formatText('insertUnorderedList')"
                  >
                    <i class="fa-solid fa-list-ul"></i>
                  </button>
                  <button type="button" onclick="formatText('justifyCenter')">
                    <i class="fa-solid fa-align-center"></i>
                  </button>
                  <button type="button" onclick="insertImage()">
                    <i class="fa-solid fa-image"></i>
                  </button>
                </div>

                <div
                  id="product-description"
                  class="editor-content"
                  contenteditable="true"
                  placeholder="Opis produktu..."
                ></div>

                  <div class="flex space-x-4">
                    <button type="submit" class="btn-admin flex-1">
                  <i class="fa-solid fa-save mr-2"></i>
                  Zapisz produkt
                </button>
                    <button
                      type="button"
                      onclick="clearProductForm()"
                      class="btn-admin flex-1"
                    >
                      <i class="fa-solid fa-plus mr-2"></i>
                      Nowy produkt
                    </button>
                  </div>
              </form>
            </div>

            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Lista Produktów</h3>
                <div id="products-list" class="space-y-4">
                  <!-- Produkty będą ładowane dynamicznie -->
                </div>

                <div id="products-loading" class="text-center py-8 text-zinc-400">
                  <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>Ładowanie produktów...</p>
                </div>

                <div
                  id="products-empty"
                  class="text-center py-8 text-zinc-400 hidden"
                >
                  <i class="fa-solid fa-shopping-cart text-4xl mb-4 text-zinc-600"></i>
                  <p>Brak produktów do wyświetlenia</p>
              </div>
            </div>
          </div>
        </div>

          <!-- Wiadomości (Czat WhatsApp-style) -->
        <div id="tab-messages" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              Czat z Użytkownikami
          </h1>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 h-[700px]">
              <!-- Lista konwersacji -->
          <div class="admin-card">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-lg font-bold">Konwersacje</h3>
                  <span id="conversations-count" class="text-sm text-zinc-400"
                    >0</span
                  >
            </div>

                <div class="mb-4">
                  <input
                    type="text"
                    id="conversations-search"
                    placeholder="Szukaj konwersacji..."
                    class="w-full text-sm"
                  />
        </div>

              <div
                id="conversations-list"
                  class="space-y-2 overflow-y-auto max-h-[580px]"
              >
                <!-- Lista konwersacji będzie ładowana dynamicznie -->
              </div>

                <div
                  id="conversations-empty"
                  class="text-center py-8 text-zinc-400 hidden"
                >
                  <i class="fa-solid fa-comments text-3xl mb-3 text-zinc-600"></i>
                  <p class="text-sm">Brak konwersacji</p>
              </div>
            </div>

            <!-- Okno czatu -->
              <div class="admin-card lg:col-span-3 flex flex-col">
                <div
                  id="chat-header"
                  class="border-b border-zinc-700 pb-4 mb-4 flex justify-between items-center"
                >
                  <div>
                    <h3 id="chat-user-name" class="text-lg font-bold">
                      Wybierz konwersację
                    </h3>
                    <p id="chat-user-status" class="text-sm text-zinc-400 hidden">
                      Online
                    </p>
              </div>
                  <div class="flex space-x-2">
                    <button
                      onclick="archiveConversation()"
                      class="text-zinc-400 hover:text-white p-2"
                      title="Archiwizuj"
                    >
                      <i class="fa-solid fa-archive"></i>
                    </button>
                    <button
                      onclick="deleteConversation()"
                      class="text-zinc-400 hover:text-red-400 p-2"
                      title="Usuń"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  </div>
                </div>

              <div
                id="chat-messages"
                  class="flex-1 space-y-3 max-h-[500px] overflow-y-auto mb-4 p-4 bg-zinc-900/50 rounded-lg"
                >
                  <div id="chat-empty" class="text-center py-12 text-zinc-500">
                    <i
                      class="fa-solid fa-comments text-4xl mb-4 text-zinc-600"
                    ></i>
                    <p>Wybierz konwersację, aby rozpocząć czat</p>
                  </div>
                <!-- Wiadomości będą ładowane dynamicznie -->
              </div>

                <div id="chat-input-area" class="flex space-x-2 hidden">
                  <div class="flex-1 relative">
                    <textarea
                  id="message-input"
                  placeholder="Wpisz wiadomość..."
                      class="w-full resize-none"
                      rows="2"
                      onkeydown="handleEnterKey(event)"
                    ></textarea>
                    <button
                      onclick="attachFile()"
                      class="absolute right-3 top-2 text-zinc-400 hover:text-white"
                      title="Załącz plik"
                    >
                      <i class="fa-solid fa-paperclip"></i>
                    </button>
                  </div>
                  <button onclick="sendMessage()" class="btn-admin px-4 self-end">
                  <i class="fa-solid fa-paper-plane"></i>
                </button>
              </div>
            </div>
          </div>

            <!-- Statystyki czatu -->
            <div class="admin-card mt-6">
              <h3 class="text-xl font-bold mb-6">Statystyki Czatu</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div
                    class="text-2xl font-bold coyote-text"
                    id="total-conversations"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem konwersacji</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="active-conversations"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Aktywne</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-blue-400"
                    id="messages-today"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Wiadomości dziś</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="unread-messages"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Nieuzytane</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Wydarzenia -->
        <div id="tab-events" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            Zarządzanie Wydarzeniami
          </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                Zarządzaj wydarzeniami na stronie. Dodawaj nowe wydarzenia z datą
                i godziną, pozycjonuj je i przypinaj ważne.
              </p>
              <button onclick="addNewEvent()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj wydarzenie
              </button>
            </div>

            <!-- Filtry wydarzeń -->
            <div class="admin-card mb-8">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Status</label>
                  <select id="events-status-filter" class="w-full">
                    <option value="all">Wszystkie</option>
                    <option value="upcoming">Nadchodzące</option>
                    <option value="past">Przeszłe</option>
                    <option value="pinned">Przypięte</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Kategoria</label>
                  <select id="events-category-filter" class="w-full">
                    <option value="all">Wszystkie kategorie</option>
                    <option value="training">Szkolenia</option>
                    <option value="meeting">Spotkania</option>
                    <option value="competition">Zawody</option>
                    <option value="other">Inne</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Sortowanie</label>
                  <select id="events-sort-filter" class="w-full">
                    <option value="date-asc">Data ↑</option>
                    <option value="date-desc">Data ↓</option>
                    <option value="title">Tytuł</option>
                    <option value="pinned">Przypięte pierwsze</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button onclick="applyEventsFilters()" class="btn-admin w-full">
                    <i class="fa-solid fa-filter mr-2"></i>
                    Filtruj
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista wydarzeń -->
          <div class="admin-card">
            <div id="events-list" class="space-y-4">
                <!-- Wydarzenia będą ładowane dynamicznie -->
            </div>

              <div id="events-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie wydarzeń...</p>
              </div>

              <div
                id="events-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i
                  class="fa-solid fa-calendar-alt text-4xl mb-4 text-zinc-600"
                ></i>
                <p>Brak wydarzeń do wyświetlenia</p>
              </div>
            </div>

            <!-- Statystyki wydarzeń -->
            <div class="admin-card mt-6">
              <h3 class="text-xl font-bold mb-6">Statystyki Wydarzeń</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div class="text-2xl font-bold coyote-text" id="total-events">
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem wydarzeń</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="upcoming-events"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Nadchodzących</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400" id="past-events">
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Przeszłych</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="pinned-events"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Przypiętych</div>
                </div>
              </div>
          </div>
        </div>

        <!-- Pomoc Charytatywna -->
        <div id="tab-charity" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Pomocą Charytatywną
          </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                Zarządzaj akcjami charytatywnymi. Dodawaj zdjęcia, linki,
                przyciski i treści w dowolny sposób.
              </p>
              <button onclick="addNewCharityAction()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj akcję
              </button>
            </div>

            <!-- Lista akcji charytatywnych -->
          <div class="admin-card">
              <div id="charity-actions-list" class="space-y-4">
                <!-- Akcje będą ładowane dynamicznie -->
            </div>

              <div id="charity-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie akcji...</p>
              </div>

              <div
                id="charity-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i class="fa-solid fa-heart text-4xl mb-4 text-zinc-600"></i>
                <p>Brak akcji charytatywnych</p>
          </div>
        </div>

            <!-- Statystyki pomocy -->
            <div class="admin-card mt-6">
              <h3 class="text-xl font-bold mb-6">Statystyki Pomocy</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div
                    class="text-2xl font-bold coyote-text"
                    id="total-charity-actions"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem akcji</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="active-charity-actions"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Aktywnych</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-blue-400"
                    id="total-donations"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Zebranych środków</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="charity-views"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Wyświetleń</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Newsletter -->
          <div id="tab-newsletter" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Newsletter'em
          </h1>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Edytor newsletter'a -->
          <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Edytor Newsletter'a</h3>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Temat wiadomości</label
                    >
                    <input
                      type="text"
                      id="newsletter-subject"
                      placeholder="Wprowadź temat newsletter'a..."
                      class="w-full"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Treść wiadomości</label
                    >
                    <div class="toolbar mb-2">
                      <button onclick="formatText('bold')" title="Pogrubienie">
                        <i class="fa-solid fa-bold"></i>
                      </button>
                      <button onclick="formatText('italic')" title="Kursywa">
                        <i class="fa-solid fa-italic"></i>
                      </button>
                      <button onclick="formatText('underline')" title="Podkreślenie">
                        <i class="fa-solid fa-underline"></i>
                      </button>
                      <button onclick="insertLink()" title="Wstaw link">
                        <i class="fa-solid fa-link"></i>
                      </button>
                      <button onclick="insertImage()" title="Wstaw obraz">
                        <i class="fa-solid fa-image"></i>
                      </button>
                    </div>
                    <div
                      id="newsletter-editor"
                      class="editor-content min-h-[300px]"
                      contenteditable="true"
                      placeholder="Wpisz treść newsletter'a..."
                    ></div>
                  </div>

                  <div class="flex space-x-4">
                    <button
                      onclick="previewNewsletter()"
                      class="btn-admin flex-1"
                    >
                      <i class="fa-solid fa-eye mr-2"></i>
                      Podgląd
                    </button>
                    <button
                      onclick="saveNewsletterDraft()"
                      class="btn-admin flex-1"
                    >
                      <i class="fa-solid fa-save mr-2"></i>
                      Zapisz wersję roboczą
                    </button>
                  </div>
                </div>
              </div>

              <!-- Lista subskrybentów -->
              <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Subskrybenci Newsletter'a</h3>

                <div class="mb-4">
                  <input
                    type="text"
                    id="newsletter-search"
                    placeholder="Szukaj subskrybentów..."
                    class="w-full mb-4"
                  />
                </div>

                <div
                  id="newsletter-subscribers"
                  class="space-y-3 max-h-[400px] overflow-y-auto"
                >
                  <!-- Lista subskrybentów będzie ładowana dynamicznie -->
                </div>

                <div class="mt-6 pt-4 border-t border-zinc-700">
                  <div
                    class="flex justify-between items-center text-sm text-zinc-400"
                  >
                    <span>Łącznie subskrybentów:</span>
                    <span id="subscribers-count">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Przyciski akcji -->
            <div class="mt-8 flex justify-center space-x-4">
              <button onclick="sendNewsletter()" class="btn-admin px-8 py-3">
                <i class="fa-solid fa-paper-plane mr-2"></i>
                Wyślij Newsletter
              </button>
              <button onclick="exportNewsletter()" class="btn-admin px-8 py-3">
                <i class="fa-solid fa-download mr-2"></i>
                Eksportuj do Email
              </button>
            </div>
          </div>

          <!-- Bazar -->
          <div id="tab-bazar" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Bazarem
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                Zarządzaj ofertami na bazarze. Zatwierdzaj nowe oferty i moderuj
                istniejące.
              </p>
              <button onclick="refreshBazar()" class="btn-admin">
                <i class="fa-solid fa-sync-alt mr-2"></i>
                Odśwież
              </button>
            </div>

            <!-- Filtry i wyszukiwanie -->
            <div class="admin-card mb-8">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2"
                    >Status oferty</label
                  >
                  <select id="bazar-status-filter" class="w-full">
                  <option value="all">Wszystkie</option>
                  <option value="pending">Oczekujące</option>
                  <option value="approved">Zatwierdzone</option>
                  <option value="rejected">Odrzucone</option>
                </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Kategoria</label>
                  <select id="bazar-category-filter" class="w-full">
                    <option value="all">Wszystkie kategorie</option>
                    <option value="elektronika">Elektronika</option>
                    <option value="odziez">Odzież</option>
                    <option value="motoryzacja">Motoryzacja</option>
                    <option value="dom">Dom i ogród</option>
                    <option value="inne">Inne</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Szukaj</label>
                  <input
                    type="text"
                    id="bazar-search"
                    placeholder="Tytuł oferty..."
                    class="w-full"
                  />
                </div>
                <div class="flex items-end">
                  <button onclick="applyBazarFilters()" class="btn-admin w-full">
                    <i class="fa-solid fa-filter mr-2"></i>
                    Filtruj
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista ofert -->
            <div class="admin-card">
              <div id="bazar-offers-list" class="space-y-4">
                <!-- Oferty będą ładowane dynamicznie -->
            </div>

              <div id="bazar-loading" class="text-center py-8 text-zinc-400">
              <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie ofert...</p>
              </div>

              <div id="bazar-empty" class="text-center py-8 text-zinc-400 hidden">
                <i class="fa-solid fa-store text-4xl mb-4 text-zinc-600"></i>
                <p>Brak ofert do wyświetlenia</p>
              </div>
            </div>
          </div>

          <!-- Szkolenia -->
          <div id="tab-szkolenia" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Szkolenia
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                Zarządzaj szkoleniami. Dodawaj nowe szkolenia, edytuj istniejące i
                kontroluj dostępność.
              </p>
              <button onclick="addNewTraining()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj szkolenie
              </button>
            </div>

            <!-- Lista szkoleń -->
            <div class="admin-card">
              <div id="trainings-list" class="space-y-4">
                <!-- Szkolenia będą ładowane dynamicznie -->
              </div>

              <div id="trainings-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie szkoleń...</p>
            </div>

            <div
                id="trainings-empty"
              class="text-center py-8 text-zinc-400 hidden"
            >
                <i
                  class="fa-solid fa-graduation-cap text-4xl mb-4 text-zinc-600"
                ></i>
                <p>Brak szkoleń do wyświetlenia</p>
            </div>
          </div>
        </div>

          <!-- Blog -->
          <div id="tab-blog" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Blogiem
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                Zarządzaj wpisami na blogu. Dodawaj nowe artykuły, moderuj
                komentarze i pozycjonuj treści.
              </p>
              <button onclick="addNewBlogPost()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj wpis
              </button>
            </div>

            <!-- Filtry -->
            <div class="admin-card mb-8">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Status</label>
                  <select id="blog-status-filter" class="w-full">
                    <option value="all">Wszystkie</option>
                    <option value="published">Opublikowane</option>
                    <option value="draft">Szkice</option>
                    <option value="archived">Zarchiwizowane</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Kategoria</label>
                  <select id="blog-category-filter" class="w-full">
                    <option value="all">Wszystkie kategorie</option>
                    <option value="news">Aktualności</option>
                    <option value="tips">Porady</option>
                    <option value="tutorials">Poradniki</option>
                    <option value="reviews">Recenzje</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button onclick="applyBlogFilters()" class="btn-admin w-full">
                    <i class="fa-solid fa-filter mr-2"></i>
                    Filtruj
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista wpisów -->
            <div class="admin-card">
              <div id="blog-posts-list" class="space-y-4">
                <!-- Wpisy będą ładowane dynamicznie -->
              </div>

              <div id="blog-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie wpisów...</p>
              </div>

              <div id="blog-empty" class="text-center py-8 text-zinc-400 hidden">
                <i class="fa-solid fa-blog text-4xl mb-4 text-zinc-600"></i>
                <p>Brak wpisów do wyświetlenia</p>
              </div>
            </div>
          </div>

          <!-- Dokumenty -->
          <div id="tab-dokumenty" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Dokumentami
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                Zarządzaj dokumentami PDF. Dodawaj nowe pliki, organizuj kategorie
                i kontroluj dostępność.
              </p>
              <button onclick="addNewDocument()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj dokument
              </button>
            </div>

            <!-- Lista dokumentów -->
            <div class="admin-card">
              <div id="documents-list" class="space-y-4">
                <!-- Dokumenty będą ładowane dynamicznie -->
              </div>

              <div id="documents-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>Ładowanie dokumentów...</p>
              </div>

              <div
                id="documents-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i class="fa-solid fa-file-pdf text-4xl mb-4 text-zinc-600"></i>
                <p>Brak dokumentów do wyświetlenia</p>
              </div>
            </div>
          </div>

          <!-- Kontakt -->
          <div id="tab-kontakt" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              Zarządzanie Formularzem Kontaktowym
          </h1>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Ustawienia formularza -->
            <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Ustawienia Formularza</h3>

                <div class="space-y-6">
                  <div>
                    <label class="flex items-center space-x-3 cursor-pointer">
                <input
                        type="checkbox"
                        id="contact-form-enabled"
                        checked
                        class="w-4 h-4"
                      />
                      <span class="text-sm font-medium">Formularz włączony</span>
                    </label>
                    <p class="text-xs text-zinc-500 mt-1">
                      Wyłącz, aby ukryć formularz kontaktowy na stronie
                    </p>
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Email odbiorcy</label
                    >
                    <input
                      type="email"
                      id="contact-recipient-email"
                      placeholder="admin@strzelca.pl"
                      class="w-full"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Temat powiadomień</label
                    >
                <input
                  type="text"
                      id="contact-notification-subject"
                      placeholder="Nowa wiadomość z formularza kontaktowego"
                      class="w-full"
                    />
                  </div>
                </div>
            </div>

              <!-- Zarządzanie tematami -->
            <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Tematy Rozmów</h3>

                <div class="space-y-4">
                  <div class="flex space-x-2">
                <input
                  type="text"
                      id="new-contact-topic"
                      placeholder="Nowy temat rozmowy..."
                  class="flex-1"
                />
                    <button onclick="addContactTopic()" class="btn-admin px-4">
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>

                  <div
                    id="contact-topics-list"
                    class="space-y-2 max-h-[300px] overflow-y-auto"
                  >
                    <!-- Tematy będą ładowane dynamicznie -->
              </div>
            </div>
          </div>
        </div>

            <!-- Statystyki wiadomości -->
            <div class="admin-card mt-8">
              <h3 class="text-xl font-bold mb-6">Statystyki Wiadomości</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div
                    class="text-2xl font-bold coyote-text"
                    id="contact-total-messages"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem wiadomości</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="contact-unread-messages"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Nieuzytane</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-blue-400"
                    id="contact-this-week"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">W tym tygodniu</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="contact-pending-replies"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Oczekujące na odpowiedź</div>
                </div>
      </div>
    </div>

            <!-- Przyciski akcji -->
            <div class="mt-8 flex justify-center">
              <button onclick="saveContactSettings()" class="btn-admin px-8 py-3">
                <i class="fa-solid fa-save mr-2"></i>
                Zapisz ustawienia
              </button>
            </div>
          </div>
        </div>
      </div>

    <div
      id="user-details-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold coyote-text">Szczegóły Użytkownika</h2>
          <div class="flex space-x-2">
            <button
              onclick="editUserDetails()"
              class="btn-admin text-sm px-3 py-1"
            >
              <i class="fa-solid fa-edit mr-1"></i>
              Edytuj
            </button>
          <button
            onclick="closeUserDetails()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6">
          <div class="flex space-x-1 bg-zinc-800 p-1 rounded-lg">
            <button
              onclick="switchUserTab('details')"
              class="user-tab-btn active px-4 py-2 text-sm rounded"
              data-tab="details"
            >
              Szczegóły
            </button>
            <button
              onclick="switchUserTab('activity')"
              class="user-tab-btn px-4 py-2 text-sm rounded"
              data-tab="activity"
            >
              Aktywność
            </button>
          </div>
        </div>

        <div id="user-details-content">
          <!-- Szczegóły użytkownika będą ładowane dynamicznie -->
        </div>
      </div>
    </div>

    <!-- Modal edycji użytkownika -->
    <div
      id="user-edit-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold coyote-text">Edycja Użytkownika</h2>
          <button
            onclick="closeUserEdit()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <form id="user-edit-form" class="space-y-6">
          <!-- Dane podstawowe -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-bold mb-4">Dane podstawowe</h3>
              <div class="space-y-4">
                <input type="hidden" id="edit-user-id" />
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Nazwa wyświetlana</label
                  >
                  <input
                    type="text"
                    id="edit-display-name"
                    placeholder="Nazwa wyświetlana"
                    required
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Email</label>
                  <input
                    type="email"
                    id="edit-email"
                    placeholder="Email"
                    required
                    disabled
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Imię</label>
                  <input type="text" id="edit-first-name" placeholder="Imię" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Nazwisko</label
                  >
                  <input
                    type="text"
                    id="edit-last-name"
                    placeholder="Nazwisko"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Telefon</label
                  >
                  <input type="tel" id="edit-phone" placeholder="Telefon" />
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-4">Adres dostawy</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Ulica</label>
                  <input type="text" id="edit-street" placeholder="Ulica" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Numer budynku</label
                  >
                  <input
                    type="text"
                    id="edit-building-number"
                    placeholder="Numer budynku"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Kod pocztowy</label
                  >
                  <input
                    type="text"
                    id="edit-postal-code"
                    placeholder="Kod pocztowy"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Miasto</label>
                  <input type="text" id="edit-city" placeholder="Miasto" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Paczkomat</label
                  >
                  <input
                    type="text"
                    id="edit-parcel-locker"
                    placeholder="Paczkomat"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Preferencje i status -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-bold mb-4">Preferencje</h3>
              <div class="space-y-4">
                <div class="flex items-center space-x-3">
                  <input type="checkbox" id="edit-newsletter" />
                  <label for="edit-newsletter" class="text-sm"
                    >Newsletter</label
                  >
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-4">Status konta</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Rola</label>
                  <select id="edit-role" class="w-full">
                    <option value="user">Użytkownik</option>
                    <option value="company">Firma</option>
                    <option value="admin">Administrator</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Status</label>
                  <select id="edit-status" class="w-full">
                    <option value="active">Aktywny</option>
                    <option value="blocked">Zablokowany</option>
                    <option value="suspended">Zawieszony</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Przyciski -->
          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserEdit()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin">
              <i class="fa-solid fa-save mr-2"></i>
              Zapisz zmiany
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal blokowania użytkownika -->
    <div
      id="user-block-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">
            Blokowanie Użytkownika
          </h2>
          <button
            onclick="closeUserBlock()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="block-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o użytkowniku będą ładowane dynamicznie -->
        </div>

        <form id="user-block-form" class="space-y-6">
          <input type="hidden" id="block-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-2">Czas blokady</label>
            <select id="block-duration" class="w-full" required>
              <option value="15min">15 minut</option>
              <option value="1hour">1 godzina</option>
              <option value="6hours">6 godzin</option>
              <option value="24hours">24 godziny</option>
              <option value="7days">7 dni</option>
              <option value="30days">30 dni</option>
              <option value="permanent">Na zawsze (blokada permanentna)</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-400 block mb-4"
              >Opcje zawartości konta</label
            >
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="keep-content"
                  name="content-action"
                  value="keep"
                  checked
                />
                <label for="keep-content" class="text-sm"
                  >Zachowaj zawartość konta (produkty, czaty, itp.)</label
                >
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="remove-content"
                  name="content-action"
                  value="remove"
                />
                <label for="remove-content" class="text-sm"
                  >Usuń zawartość konta (produkty, czaty, itp.)</label
                >
              </div>
            </div>
          </div>

          <div class="p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-bold mb-2">⚠️ Ostrzeżenie</h4>
            <p class="text-sm text-zinc-300">
              Blokada konta oznacza całkowite "uśmiercenie" konta - brak
              możliwości korzystania ze strony, pisania na czatach, odczytywania
              czatów, dodawania/edycji produktów na bazarze itp. Bez możliwości
              odblokowania przez email.
            </p>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserBlock()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-red-600 hover:bg-red-500">
              <i class="fa-solid fa-ban mr-2"></i>
              Zablokuj użytkownika
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal usuwania użytkownika -->
    <div
      id="user-delete-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">Usuwanie Użytkownika</h2>
          <button
            onclick="closeUserDelete()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="delete-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o użytkowniku będą ładowane dynamicznie -->
        </div>

        <form id="user-delete-form" class="space-y-6">
          <input type="hidden" id="delete-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-4"
              >Opcje zawartości konta</label
            >
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="delete-keep-content"
                  name="delete-content-action"
                  value="keep"
                  checked
                />
                <label for="delete-keep-content" class="text-sm"
                  >Zachowaj zawartość konta (produkty, czaty, komentarze)</label
                >
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="delete-remove-content"
                  name="delete-content-action"
                  value="remove"
                />
                <label for="delete-remove-content" class="text-sm"
                  >Całkowicie usuń zawartość konta</label
                >
              </div>
            </div>
          </div>

          <div class="p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-bold mb-2">⚠️ Ostrzeżenie</h4>
            <p class="text-sm text-zinc-300 mb-2">
              Usunięcie konta jest operacją nieodwracalną. Użytkownik zostanie
              całkowicie usunięty z systemu.
            </p>
            <p class="text-sm text-zinc-300">
              Jeśli wybierzesz "Zachowaj zawartość", produkty, wiadomości i inne
              dane użytkownika pozostaną w systemie, ale będą oznaczone jako "od
              usuniętego użytkownika".
            </p>
          </div>

          <div
            class="flex items-center space-x-3 p-4 bg-yellow-900/20 border border-yellow-700 rounded-lg"
          >
            <input type="checkbox" id="delete-confirm" required />
            <label for="delete-confirm" class="text-sm">
              Potwierdzam, że chcę całkowicie usunąć tego użytkownika z systemu
            </label>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserDelete()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-red-600 hover:bg-red-500">
              <i class="fa-solid fa-trash mr-2"></i>
              Usuń użytkownika
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        getDocs,
        collection,
        query,
        orderBy,
        updateDoc,
        deleteDoc,
        setDoc,
        where,
        limit,
        addDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD_gXFh3a4NW9Hzzsr5IQuDADM2GVpPMVc",
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.firebasestorage.app",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let currentTab = "dashboard";
      let currentUserFilter = "all";
      let usersList = [];
      let productsList = [];
      let currentConversationId = null;
      let pendingTasksListener = null;

      // Local admin credentials (maximum security - both login and password are separately hashed)
      // This provides additional protection as attackers cannot even determine valid login format
      // TODO: Remove this local account after development is complete
      const LOCAL_ADMIN_LOGIN_SALT = "4466ced4492c60362eee23b352e3cb96";
      const LOCAL_ADMIN_LOGIN_HASH =
        "7bdf6dd287fc736472689a5b15a92965caddb5c8bb29d852900552846501a354";
      const LOCAL_ADMIN_PASSWORD_SALT = "083130d3faf39aef060851b93a7e2e53";
      const LOCAL_ADMIN_PASSWORD_HASH =
        "6cf58636e6399062c47f200860c9f6e67739faa454a4ecfff6fb42e9fd80c4d8";

      // Funkcja hashowania hasła (Web Crypto API dla przeglądarki)
      async function hashPassword(password, salt, iterations = 10000) {
        let hash = password + salt;
        for (let i = 0; i < iterations; i++) {
          const encoder = new TextEncoder();
          const data = encoder.encode(hash);
          const buffer = await crypto.subtle.digest("SHA-256", data);
          hash = Array.from(new Uint8Array(buffer))
            .map((b) => b.toString(16).padStart(2, "0"))
            .join("");
        }
        return hash;
      }

      // Sprawdzanie lokalnego logowania administratora (oba pola zahashowane)
      async function checkLocalAdmin(login, password) {
        // Sprawdź konto testowe (prostsze rozwiązanie dla testów)
        if (login === "test1" && password === "test1") {
          return true;
        }

        // Sprawdź stare konto administratora (zachowaj kompatybilność wsteczną)
        if (
          login === "admin.strzelca" &&
          password === "admin.strzelca@123QWEasd"
        ) {
          return true;
        }

        // Dla kompatybilności wstecznej sprawdź też zahashowane dane
        const hashedLogin = await hashPassword(login, LOCAL_ADMIN_LOGIN_SALT);
        if (hashedLogin === LOCAL_ADMIN_LOGIN_HASH) {
          const hashedPassword = await hashPassword(
            password,
            LOCAL_ADMIN_PASSWORD_SALT,
          );
          if (hashedPassword === LOCAL_ADMIN_PASSWORD_HASH) {
            return true;
          }
        }

        // Sprawdź nowe konto administratora (proste porównanie dla testów)
        if (login === "admin" && password === "admin") {
          return true;
        }

          return false;
        }

      // Funkcja logowania aktywności
      async function logActivity(
        userId,
        action,
        details = {},
        targetUserId = null,
      ) {
        try {
          const activityData = {
            userId: userId,
            action: action,
            details: details,
            targetUserId: targetUserId,
            timestamp: new Date(),
            adminId: currentUser ? currentUser.uid : null,
            ipAddress: null, // Można dodać jeśli dostępny
            userAgent: navigator.userAgent,
          };

          await addDoc(collection(db, "userActivity"), activityData);
        } catch (error) {
          console.error("Error logging activity:", error);
          // Nie pokazujemy błędu użytkownikowi, żeby nie przeszkadzać w normalnej pracy
        }
      }

      // Funkcje pomocnicze
      function showStatus(message, isError = false) {
        const statusEl = document.getElementById("login-status");
        statusEl.textContent = message;
        statusEl.className = `mt-6 p-4 rounded-lg text-center text-sm ${isError ? "bg-red-900/50 text-red-300 border border-red-700" : "bg-green-900/50 text-green-300 border border-green-700"}`;
        statusEl.style.display = "block";

        setTimeout(() => {
          statusEl.style.display = "none";
        }, 5000);
      }

      function showNotification(message, type = "success") {
        // Prosta implementacja powiadomień - można rozszerzyć
        console.log(`${type}: ${message}`);
      }

      // Sprawdzanie roli administratora
      async function checkAdminRole(user) {
        try {
          const userDoc = await getDoc(doc(db, "userProfiles", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            return userData.role === "admin";
          }
          return false;
        } catch (error) {
          console.error("Error checking admin role:", error);
          return false;
        }
      }

      // Aktualizacja wyświetlania nazwy administratora
      function updateAdminDisplay(user) {
        // Aktualizuj kompaktowy widok (to jest jedyny element dostępny w obecnym layout)
        updateCompactAdminDisplay(user);
      }

      // Nawigacja między zakładkami
      function switchTab(tabName) {
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document.querySelectorAll(".nav-submenu-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Sprawdź czy to zakładka z submenu
        const mainTab = document.querySelector(`[data-tab="${tabName}"]`);
        const submenuItem = document.querySelector(`.nav-submenu-item[data-tab="${tabName}"]`);

        if (submenuItem) {
          submenuItem.classList.add("active");
          // Oznacz główną zakładkę "Strony" jako aktywną jeśli otwieramy podstronę
          document.querySelector(".nav-pages-toggle").classList.add("active");
        } else if (mainTab) {
          mainTab.classList.add("active");
        }

        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`tab-${tabName}`).classList.add("active");

        currentTab = tabName;

        // Ładowanie danych dla wybranej zakładki
        switch (tabName) {
          case "status":
            checkMainServicesStatus();
            break;
          case "dashboard":
            loadDashboardStats();
            break;
          case "users":
            loadUsers();
            break;
          case "products":
            loadProducts();
            break;
          case "messages":
            loadMessages();
            break;
          case "chats":
            loadConversations();
            break;
          case "events":
            loadEvents();
            break;
          case "reviews":
            loadReviews();
            break;
          case "charity":
            loadCharity();
            break;
          case "bazar":
            // Brak specjalnej funkcji ładowania dla tej zakładki
            break;
          case "szkolenia":
            // Brak specjalnej funkcji ładowania dla tej zakładki
            break;
          case "blog":
            // Brak specjalnej funkcji ładowania dla tej zakładki
            break;
          case "dokumenty":
            // Brak specjalnej funkcji ładowania dla tej zakładki
            break;
          case "kontakt":
            // Brak specjalnej funkcji ładowania dla tej zakładki
            break;
          case "settings":
            loadSettings();
            break;
        }
      }


      // Funkcja do przełączania sidebar na mobile
      function toggleSidebar() {
        const sidebar = document.getElementById("mobile-sidebar");
        const overlay = document.getElementById("mobile-overlay");

        if (sidebar && overlay) {
          if (sidebar.classList.contains("open")) {
            sidebar.classList.remove("open");
            overlay.classList.add("hidden");
          } else {
            sidebar.classList.add("open");
            overlay.classList.remove("hidden");
          }
        }
      }

      // Funkcja do aktualizacji kompaktowego wyświetlania nazwy admina
      function updateCompactAdminDisplay(user) {
        const compactName = document.getElementById("admin-display-name-compact");
        if (compactName && user) {
          const displayName = user.displayName || user.email || "Administrator";
          compactName.textContent = displayName;
        }
      }


      // Inicjalizacja nawigacji
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          const tab = item.getAttribute("data-tab");
          switchTab(tab);
        });
      });

      // Logowanie administratora
      document
        .getElementById("admin-login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const login = document.getElementById("admin-email").value.trim();
          const password = document.getElementById("admin-password").value;
          const rememberMe = document.getElementById("admin-remember").checked;

          if (!login || !password) {
            showStatus("Wprowadź login i hasło administratora.", true);
            return;
          }

          try {
            // Najpierw sprawdź lokalne konto administratora
            const isLocalAdmin = await checkLocalAdmin(login, password);
            if (isLocalAdmin) {
              try {
              // Utwórz fikcyjnego użytkownika dla lokalnego admina
              currentUser = {
                uid: "local-admin",
                email: login,
                displayName: `${login}@Administrator`,
                isLocalAdmin: true,
                originalLogin: login, // Zachowaj oryginalny login dla wyświetlania
              };

                // Zaloguj udane logowanie administratora
                await logActivity("system", "ADMIN_LOGIN_SUCCESS", {
                  login: login,
                  method: "local_admin",
                  ip: "unknown", // Można dodać wykrywanie IP jeśli potrzebne
                  userAgent: navigator.userAgent,
                });

              showStatus("Logowanie lokalnego administratora pomyślne.");
              updateAdminDisplay(currentUser);
              document.getElementById("login-section").classList.add("hidden");
              document.getElementById("admin-panel").classList.remove("hidden");

                // Zapisz sesję jeśli remember jest zaznaczone
                if (rememberMe) {
                  const sessionData = {
                    userId: "local-admin",
                    loginTime: new Date(),
                    userAgent: navigator.userAgent,
                    isLocalAdmin: true,
                    expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 dni
                  };
                  localStorage.setItem(
                    "admin_session",
                    JSON.stringify(sessionData),
                  );
              }

              switchTab("dashboard");

                // Sprawdź status usług od razu po zalogowaniu
                setTimeout(() => {
                  checkMainServicesStatus();
                }, 1000);

                return;
              } catch (adminSetupError) {
                console.error('Admin setup error:', adminSetupError);
                alert('Błąd podczas konfiguracji panelu admin: ' + adminSetupError.message);
                showStatus("Błąd podczas konfiguracji panelu administratora.", true);
              return;
              }
            }

            // Zaloguj nieudane logowanie lokalnego administratora
            await logActivity("system", "ADMIN_LOGIN_FAILED", {
              login: login,
              reason: "invalid_local_credentials",
              method: "local_admin",
              ip: "unknown",
              userAgent: navigator.userAgent,
            });

            // Jeśli nie jest to lokalny admin, spróbuj Firebase
            const userCredential = await signInWithEmailAndPassword(
              auth,
              login,
              password,
            );
            const user = userCredential.user;

            // Sprawdź czy użytkownik ma rolę administratora
            const isAdmin = await checkAdminRole(user);
            if (!isAdmin) {
              await signOut(auth);
              // Zaloguj nieudane logowanie - brak uprawnień
              await logActivity("system", "ADMIN_LOGIN_FAILED", {
                login: login,
                reason: "insufficient_permissions",
                method: "firebase",
                ip: "unknown",
                userAgent: navigator.userAgent,
              });
              showStatus(
                "Brak uprawnień administratora. Tylko administratorzy mają dostęp do panelu.",
                true,
              );
              return;
            }

            // Zaloguj udane logowanie Firebase
            await logActivity("system", "ADMIN_LOGIN_SUCCESS", {
              login: login,
              method: "firebase",
              userId: user.uid,
              ip: "unknown",
              userAgent: navigator.userAgent,
            });

            showStatus("Logowanie administratora (Firebase) pomyślne.");
          } catch (error) {
            console.error("Login error:", error);

            let errorMessage = "Błąd logowania administratora.";
            let errorReason = "unknown_error";

            if (error.code === "auth/user-not-found") {
              errorMessage = "Administrator nie istnieje.";
              errorReason = "user_not_found";
            } else if (error.code === "auth/wrong-password") {
              errorMessage = "Nieprawidłowe hasło administratora.";
              errorReason = "wrong_password";
            } else if (error.code === "auth/invalid-email") {
              errorMessage = "Nieprawidłowy format login.";
              errorReason = "invalid_email_format";
            } else if (error.code === "auth/too-many-requests") {
              errorMessage =
                "Zbyt wiele prób logowania. Spróbuj ponownie później.";
              errorReason = "too_many_attempts";
            }

            // Zaloguj nieudane logowanie
            await logActivity("system", "ADMIN_LOGIN_FAILED", {
              login: login,
              reason: errorReason,
              method: "firebase",
              errorCode: error.code,
              ip: "unknown",
              userAgent: navigator.userAgent,
            });

            showStatus(errorMessage, true);
          }
        });

      // Wylogowanie administratora
      window.logoutAdmin = async () => {
        try {
          // Wyloguj z Firebase jeśli to użytkownik Firebase
          if (currentUser && !currentUser.isLocalAdmin) {
            await signOut(auth);
          }

          // Wyczyść dane lokalnego administratora
          currentUser = null;

          showNotification("Administrator wylogowany.");

          // Przejdź do sekcji logowania
          document.getElementById("login-section").classList.remove("hidden");
          document.getElementById("admin-panel").classList.add("hidden");
        } catch (error) {
          console.error("Logout error:", error);
        }
      };

      // Monitorowanie stanu autoryzacji
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Sprawdź ponownie rolę administratora (na wypadek zmian)
          const isAdmin = await checkAdminRole(user);
          if (!isAdmin) {
            await signOut(auth);
            showStatus("Utracono uprawnienia administratora.", true);
            return;
          }

          currentUser = user;
          updateAdminDisplay(user);

          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("admin-panel").classList.remove("hidden");

          // Załaduj dashboard
          switchTab("dashboard");
        } else {
          currentUser = null;
          document.getElementById("login-section").classList.remove("hidden");
          document.getElementById("admin-panel").classList.add("hidden");
        }
      });

      // Funkcja odświeżania dashboardu z animacją ładowania
      async function refreshDashboardWithLoading() {
        const refreshBtn = document.getElementById("dashboard-refresh-btn");

        // Dodaj klasę loading do przycisku
        refreshBtn.classList.add("loading-spinner");
        refreshBtn.disabled = true;

        try {
          // Pokaż loading overlay dla całego dashboardu
          showDashboardLoadingStates();

          // Odśwież dane
          await loadDashboardStats();

          // Aktualizuj timestamp ostatniej aktualizacji
          document.getElementById("last-events-update").textContent = new Date().toLocaleString("pl-PL");

          showNotification("Dashboard został odświeżony", "success");
        } catch (error) {
          console.error("Error refreshing dashboard:", error);
          showNotification("Błąd odświeżania dashboardu", "error");
        } finally {
          // Ukryj loading overlay
          hideDashboardLoadingStates();

          // Usuń klasę loading z przycisku
          refreshBtn.classList.remove("loading-spinner");
          refreshBtn.disabled = false;
        }
      }

      // Udostępnij funkcję globalnie
      window.refreshDashboardWithLoading = refreshDashboardWithLoading;

      // Funkcje ładowania danych
      async function loadDashboardStats() {
        try {
          // Ładowanie statusu stron
          await checkSitesStatus();

          // Ładowanie statystyk aktywności
          await loadActivityStats();
          await loadContactFormsCount();

          // Ładowanie statystyk Google Analytics
          await fetchGAStatistics();

          // Ustawienie listener dla activityLogs (tylko jeśli jeszcze nie jest ustawiony)
          if (!activityLogsListener) {
            setupActivityLogsListener();
          }

          // Ustawienie listener dla pending tasks (tylko jeśli jeszcze nie jest ustawiony)
          if (!pendingTasksListener) {
            setupPendingTasksListener();
          }
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
          showNotification("Błąd ładowania danych dashboard.", "error");
        }
      }

      // Funkcje do zarządzania stanami ładowania dashboardu
      function showDashboardLoadingStates() {
        const overlay = document.getElementById("dashboard-loading-overlay");
        overlay.classList.add("active");
      }

      function hideDashboardLoadingStates() {
        const overlay = document.getElementById("dashboard-loading-overlay");
        overlay.classList.remove("active");
      }

      // Zarządzanie użytkownikami
      async function loadUsers() {
        try {
          const usersSnapshot = await getDocs(collection(db, "userProfiles"));
          usersList = usersSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Dodaj administratora lokalnego jeśli jest zalogowany
          if (currentUser && currentUser.isLocalAdmin) {
            // Sprawdź czy lokalny admin już nie jest na liście
            const localAdminExists = usersList.find(
              (user) => user.id === currentUser.uid,
            );
            if (!localAdminExists) {
              usersList.unshift({
                id: currentUser.uid,
                displayName: currentUser.displayName,
                email: currentUser.email,
                role: "admin",
                status: "active",
                createdAt: new Date(),
                isLocalAdmin: true,
              });
            }
          }

          renderUsersList();
        } catch (error) {
          console.error("Error loading users:", error);
          showNotification("Błąd ładowania użytkowników.", "error");
        }
      }

      function filterUsers(filter) {
        currentUserFilter = filter;

        document.querySelectorAll(".user-filter-btn").forEach((btn) => {
          btn.classList.remove("active", "border-coyote", "text-coyote");
          btn.classList.add("border-zinc-700");
        });

        document
          .querySelector(`[data-filter="${filter}"]`)
          .classList.add("active", "border-coyote", "text-coyote");

        renderUsersList();
      }

      function renderUsersList() {
        let filteredUsers = usersList;

        switch (currentUserFilter) {
          case "active":
            filteredUsers = usersList.filter((u) => u.status === "active");
            break;
          case "blocked":
            filteredUsers = usersList.filter((u) => u.status === "blocked");
            break;
          case "admin":
            filteredUsers = usersList.filter((u) => u.role === "admin");
            break;
          case "company":
            filteredUsers = usersList.filter((u) => u.role === "company");
            break;
        }

        const usersHtml = filteredUsers
          .map((user) => {
            const isCurrentUser = currentUser && user.id === currentUser.uid;
            const status = user.status || "active";
            const role = user.role || "user";
            const roleDisplay = {
              admin: "ADMINISTRATOR",
              company: "FIRMA",
              user: "UŻYTKOWNIK",
            };

            const statusClasses = {
              active: "status-active",
              blocked: "status-blocked",
              suspended: "status-suspended",
            };

            const roleClasses = {
              admin: "role-admin",
              user: "role-user",
              company: "role-company",
            };

            const decryptedUser = {
              ...user,
              phone: user.isLocalAdmin
                ? user.phone || ""
                : user.phone
                  ? atob(user.phone)
                  : "",
              address: {
                street: user.isLocalAdmin
                  ? user.address?.street || ""
                  : user.address?.street
                    ? atob(user.address.street)
                    : "",
                city: user.isLocalAdmin
                  ? user.address?.city || ""
                  : user.address?.city
                    ? atob(user.address.city)
                    : "",
              },
            };

            return `
                    <div class="border-l-4 ${statusClasses[status]} p-4 rounded-r-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-white font-bold">${decryptedUser.displayName}</h4>
                                    <span class="px-2 py-1 text-xs rounded font-bold ${roleClasses[role]}">${roleDisplay[role] || role.toUpperCase()}</span>
                                    <span class="px-2 py-1 text-xs rounded bg-gray-600 text-white">${status.toUpperCase()}</span>
                                    ${isCurrentUser ? '<span class="px-2 py-1 text-xs rounded bg-purple-600 text-white">TY</span>' : ""}
                                </div>
                                <div class="text-sm text-zinc-400 space-y-1">
                                    <div>📧 ${decryptedUser.email}</div>
                                    <div>📱 ${decryptedUser.phone || "Brak"}</div>
                                    <div>🏠 ${decryptedUser.address.city || "Brak adresu"}</div>
                                    <div>📅 ${new Date(user.createdAt?.toDate?.() || user.createdAt).toLocaleDateString("pl-PL")}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="viewUserDetails('${user.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Szczegóły</button>
                                ${
                                  !isCurrentUser
                                    ? `
                                    <button onclick="toggleUserBlock('${user.id}')" class="text-${status === "blocked" ? "green" : "yellow"}-400 hover:text-${status === "blocked" ? "green" : "yellow"}-300 px-2 py-1 border border-${status === "blocked" ? "green" : "yellow"}-400 rounded text-xs">
                                        ${status === "blocked" ? "Odblokuj" : "Zablokuj"}
                                    </button>
                                    <button onclick="changeUserRole('${user.id}', '${role}')" class="text-purple-400 hover:text-purple-300 px-2 py-1 border border-purple-400 rounded text-xs">Zmień rolę</button>
                                    <button onclick="resetUserPassword('${user.id}', '${decryptedUser.email}')" class="text-orange-400 hover:text-orange-300 px-2 py-1 border border-orange-400 rounded text-xs">Reset hasła</button>
                                    <button onclick="deleteUser('${user.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usuń</button>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("users-list").innerHTML =
          usersHtml ||
          '<div class="text-center text-zinc-500 py-8">Brak użytkowników</div>';
      }

      // Szczegóły użytkownika
      window.viewUserDetails = async (userId) => {
        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              createdAt: new Date(),
              isLocalAdmin: true,
            };
          } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentEditingUser = user;

          const decryptedUser = {
            ...user,
            phone: user.isLocalAdmin
              ? user.phone || ""
              : user.phone
                ? atob(user.phone)
                : "",
            parcelLocker: user.isLocalAdmin
              ? user.parcelLocker || ""
              : user.parcelLocker
                ? atob(user.parcelLocker)
                : "",
            address: {
              street: user.isLocalAdmin
                ? user.address?.street || ""
                : user.address?.street
                  ? atob(user.address.street)
                  : "",
              buildingNumber: user.isLocalAdmin
                ? user.address?.buildingNumber || ""
                : user.address?.buildingNumber
                  ? atob(user.address.buildingNumber)
                  : "",
              postalCode: user.isLocalAdmin
                ? user.address?.postalCode || ""
                : user.address?.postalCode
                  ? atob(user.address.postalCode)
                  : "",
              city: user.isLocalAdmin
                ? user.address?.city || ""
                : user.address?.city
                  ? atob(user.address.city)
                  : "",
            },
          };

          const detailsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-bold mb-4">Informacje podstawowe</h3>
                            <div class="space-y-3">
                                <div><strong>Nazwa użytkownika:</strong> ${decryptedUser.displayName}</div>
                                <div><strong>Email:</strong> ${decryptedUser.email}</div>
                                <div><strong>Imię:</strong> ${decryptedUser.firstName || "Nie podano"}</div>
                                <div><strong>Nazwisko:</strong> ${decryptedUser.lastName || "Nie podano"}</div>
                                <div><strong>Telefon:</strong> ${decryptedUser.phone || "Nie podano"}</div>
                                <div><strong>Rola:</strong> ${decryptedUser.role || "user"}</div>
                                <div><strong>Status:</strong> ${decryptedUser.status || "active"}</div>
                                <div><strong>Data rejestracji:</strong> ${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleString("pl-PL")}</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-4">Adres dostawy</h3>
                            <div class="space-y-3">
                                <div><strong>Ulica:</strong> ${decryptedUser.address.street || "Nie podano"}</div>
                                <div><strong>Numer:</strong> ${decryptedUser.address.buildingNumber || "Nie podano"}</div>
                                <div><strong>Kod pocztowy:</strong> ${decryptedUser.address.postalCode || "Nie podano"}</div>
                                <div><strong>Miasto:</strong> ${decryptedUser.address.city || "Nie podano"}</div>
                                <div><strong>Paczkomat:</strong> ${decryptedUser.parcelLocker || "Nie podano"}</div>
                            </div>

                            <h3 class="text-lg font-bold mb-4 mt-6">Preferencje</h3>
                            <div class="space-y-3">
                                <div><strong>Newsletter:</strong> ${decryptedUser.newsletter ? "Tak" : "Nie"}</div>
                            </div>
                        </div>
                    </div>
                `;

          document.getElementById("user-details-content").innerHTML =
            detailsHtml;
          document
            .getElementById("user-details-modal")
            .classList.remove("hidden");
        } catch (error) {
          console.error("Error loading user details:", error);
          showNotification("Błąd ładowania szczegółów użytkownika.", "error");
        }
      };

      window.closeUserDetails = () => {
        document.getElementById("user-details-modal").classList.add("hidden");
      };

      window.switchUserTab = (tabName) => {
        document.querySelectorAll(".user-tab-btn").forEach((btn) => {
          btn.classList.remove("active", "bg-coyote", "text-black");
          btn.classList.add("text-zinc-400");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active", "bg-coyote", "text-black");

        if (tabName === "activity") {
          loadUserActivity();
        } else if (tabName === "details") {
          loadUserDetails();
        }
      };

      async function loadUserDetails() {
        if (!currentEditingUser) return;

        // Ukryj przycisk edycji dla administratora lokalnego
        const editButton = document.querySelector(
          '[onclick="editUserDetails()"]',
        );
        if (editButton) {
          if (currentEditingUser.isLocalAdmin) {
            editButton.style.display = "none";
          } else {
            editButton.style.display = "inline-block";
          }
        }

        const decryptedUser = {
          ...currentEditingUser,
          phone: currentEditingUser.isLocalAdmin
            ? currentEditingUser.phone || ""
            : currentEditingUser.phone
              ? atob(currentEditingUser.phone)
              : "",
          parcelLocker: currentEditingUser.isLocalAdmin
            ? currentEditingUser.parcelLocker || ""
            : currentEditingUser.parcelLocker
              ? atob(currentEditingUser.parcelLocker)
              : "",
          address: {
            street: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.street || ""
              : currentEditingUser.address?.street
                ? atob(currentEditingUser.address.street)
                : "",
            buildingNumber: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.buildingNumber || ""
              : currentEditingUser.address?.buildingNumber
                ? atob(currentEditingUser.address.buildingNumber)
                : "",
            postalCode: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.postalCode || ""
              : currentEditingUser.address?.postalCode
                ? atob(currentEditingUser.address.postalCode)
                : "",
            city: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.city || ""
              : currentEditingUser.address?.city
                ? atob(currentEditingUser.address.city)
                : "",
          },
        };

        const detailsHtml = `
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                          <h3 class="text-lg font-bold mb-4 text-coyote">Informacje podstawowe</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Nazwa użytkownika:</span>
                                  <span class="text-white">${decryptedUser.displayName}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Email:</span>
                                  <span class="text-white">${decryptedUser.email}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Imię:</span>
                                  <span class="text-white">${decryptedUser.firstName || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Nazwisko:</span>
                                  <span class="text-white">${decryptedUser.lastName || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Telefon:</span>
                                  <span class="text-white">${decryptedUser.phone || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Rola:</span>
                                  <span class="text-white">${decryptedUser.role || "user"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Status:</span>
                                  <span class="text-white">${decryptedUser.status || "active"}</span>
                              </div>
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Data rejestracji:</span>
                                  <span class="text-white">${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleString("pl-PL")}</span>
                              </div>
                          </div>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold mb-4 text-coyote">Adres dostawy</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Ulica:</span>
                                  <span class="text-white">${decryptedUser.address.street || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Numer:</span>
                                  <span class="text-white">${decryptedUser.address.buildingNumber || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Kod pocztowy:</span>
                                  <span class="text-white">${decryptedUser.address.postalCode || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Miasto:</span>
                                  <span class="text-white">${decryptedUser.address.city || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Paczkomat:</span>
                                  <span class="text-white">${decryptedUser.parcelLocker || "Nie podano"}</span>
                              </div>
                          </div>

                          <h3 class="text-lg font-bold mb-4 mt-6 text-coyote">Preferencje</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Newsletter:</span>
                                  <span class="text-white">${decryptedUser.newsletter ? "Tak" : "Nie"}</span>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

        document.getElementById("user-details-content").innerHTML = detailsHtml;
      }

      window.editUserDetails = () => {
        showUserEditModal();
      };

      async function loadUserActivity() {
        if (!currentEditingUser) return;

        try {
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-zinc-500 py-8">
              <i class="fa-solid fa-spinner fa-spin fa-3x mb-4"></i>
              <p>Ładowanie historii aktywności...</p>
            </div>
          `;

          // Pobierz aktywność użytkownika
          const q = query(
            collection(db, "userActivity"),
            where("userId", "==", currentEditingUser.id),
            orderBy("timestamp", "desc"),
            limit(50),
          );

          const snapshot = await getDocs(q);
          const activities = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Pobierz także aktywność gdzie użytkownik jest celem (np. został zablokowany przez admina)
          const targetQuery = query(
            collection(db, "userActivity"),
            where("targetUserId", "==", currentEditingUser.id),
            orderBy("timestamp", "desc"),
            limit(50),
          );

          const targetSnapshot = await getDocs(targetQuery);
          const targetActivities = targetSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Połącz i posortuj wszystkie aktywności
          const allActivities = [...activities, ...targetActivities]
            .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())
            .slice(0, 50); // Ogranicz do 50 najnowszych

          renderUserActivity(allActivities);
        } catch (error) {
          console.error("Error loading user activity:", error);
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-red-400 py-8">
              <i class="fa-solid fa-exclamation-triangle fa-3x mb-4"></i>
              <p>Błąd ładowania historii aktywności</p>
              <p class="text-sm">${error.message}</p>
            </div>
          `;
        }
      }

      function renderUserActivity(activities) {
        if (activities.length === 0) {
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-zinc-500 py-8">
              <i class="fa-solid fa-inbox fa-3x mb-4"></i>
              <p>Brak zarejestrowanej aktywności</p>
              <p class="text-sm">Historia aktywności użytkownika pojawi się tutaj po wykonaniu jakichkolwiek działań.</p>
            </div>
          `;
          return;
        }

        const activityHtml = activities
          .map((activity) => {
            const timestamp = activity.timestamp.toDate();
            const timeAgo = getTimeAgo(timestamp);

            // Ikony dla różnych typów aktywności
            const activityIcons = {
              ROLE_CHANGE: "fa-user-tag",
              PASSWORD_RESET_REQUEST: "fa-key",
              USER_BLOCKED: "fa-ban",
              USER_UNBLOCKED: "fa-unlock",
              USER_DELETED: "fa-trash",
              PROFILE_EDITED: "fa-edit",
              LOGIN: "fa-sign-in-alt",
              LOGOUT: "fa-sign-out-alt",
              MESSAGE_SENT: "fa-comment",
              PRODUCT_ADDED: "fa-plus-circle",
              PRODUCT_EDITED: "fa-edit",
              LIKE_ADDED: "fa-heart",
              COMMENT_ADDED: "fa-comment-dots",
            };

            const iconClass = activityIcons[activity.action] || "fa-circle";

            // Kolory dla różnych typów aktywności
            const activityColors = {
              USER_BLOCKED: "text-red-400",
              USER_UNBLOCKED: "text-green-400",
              USER_DELETED: "text-red-600",
              ROLE_CHANGE: "text-blue-400",
              PASSWORD_RESET_REQUEST: "text-orange-400",
              PROFILE_EDITED: "text-purple-400",
            };

            const colorClass =
              activityColors[activity.action] || "text-zinc-400";

            // Opis aktywności
            let description = "";
            switch (activity.action) {
              case "ROLE_CHANGE":
                description = `Zmiana roli z ${activity.details.oldRole?.toUpperCase() || "BRAK"} na ${activity.details.newRole?.toUpperCase() || "BRAK"}`;
                break;
              case "PASSWORD_RESET_REQUEST":
                description = "Wysłano link resetowania hasła";
                break;
              case "USER_BLOCKED":
                if (activity.details.isPermanent) {
                  description = "Konto zablokowane na zawsze";
                } else {
                  description = `Konto zablokowane na ${activity.details.duration}`;
                }
                if (activity.details.contentAction === "remove") {
                  description += " (zawartość usunięta)";
                }
                break;
              case "USER_UNBLOCKED":
                description = "Konto odblokowane";
                break;
              case "USER_DELETED":
                description = `Konto usunięte${activity.details.contentAction === "keep" ? " (zawartość zachowana)" : " (zawartość usunięta)"}`;
                break;
              case "PROFILE_EDITED":
                description = `Edycja profilu (${activity.details.changes?.join(", ") || "nieznane zmiany"})`;
                break;
              default:
                description = activity.action.replace(/_/g, " ").toLowerCase();
            }

            // Szczegóły wykonawcy
            let performedBy = "";
            if (activity.adminId && activity.adminId !== activity.userId) {
              performedBy = " przez administratora";
            }

            return `
            <div class="flex items-start space-x-3 p-4 bg-zinc-800 rounded-lg mb-3">
              <div class="${colorClass} mt-1">
                <i class="fa-solid ${iconClass}"></i>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <div class="font-semibold ${colorClass}">${activity.action.replace(/_/g, " ")}</div>
                  <div class="text-xs text-zinc-500">${timeAgo}</div>
                </div>
                <div class="text-sm text-zinc-300 mt-1">${description}${performedBy}</div>
                <div class="text-xs text-zinc-500 mt-1">
                  ${timestamp.toLocaleString("pl-PL")}
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        document.getElementById("user-details-content").innerHTML = `
          <div class="mb-4">
            <h3 class="text-lg font-bold mb-4">Historia Aktywności</h3>
            <p class="text-sm text-zinc-400 mb-4">Pokaż ostatnie 50 działań użytkownika</p>
          </div>
          <div class="space-y-1 max-h-[500px] overflow-y-auto">
            ${activityHtml}
          </div>
        `;
      }

      // Zmienna globalna do przechowywania aktualnie edytowanego użytkownika
      let currentEditingUser = null;

      function showUserEditModal() {
        if (!currentEditingUser) return;

        // Sprawdź czy to administrator lokalny
        if (currentEditingUser.isLocalAdmin) {
          showNotification(
            "Nie można edytować administratora lokalnego.",
            "error",
          );
          return;
        }

        const decryptedUser = {
          ...currentEditingUser,
          phone: currentEditingUser.isLocalAdmin
            ? currentEditingUser.phone || ""
            : currentEditingUser.phone
              ? atob(currentEditingUser.phone)
              : "",
          parcelLocker: currentEditingUser.isLocalAdmin
            ? currentEditingUser.parcelLocker || ""
            : currentEditingUser.parcelLocker
              ? atob(currentEditingUser.parcelLocker)
              : "",
          address: {
            street: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.street || ""
              : currentEditingUser.address?.street
                ? atob(currentEditingUser.address.street)
                : "",
            buildingNumber: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.buildingNumber || ""
              : currentEditingUser.address?.buildingNumber
                ? atob(currentEditingUser.address.buildingNumber)
                : "",
            postalCode: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.postalCode || ""
              : currentEditingUser.address?.postalCode
                ? atob(currentEditingUser.address.postalCode)
                : "",
            city: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.city || ""
              : currentEditingUser.address?.city
                ? atob(currentEditingUser.address.city)
                : "",
          },
        };

        // Wypełnij formularz danymi użytkownika
        document.getElementById("edit-user-id").value = decryptedUser.id;
        document.getElementById("edit-display-name").value =
          decryptedUser.displayName || "";
        document.getElementById("edit-email").value = decryptedUser.email || "";
        document.getElementById("edit-first-name").value =
          decryptedUser.firstName || "";
        document.getElementById("edit-last-name").value =
          decryptedUser.lastName || "";
        document.getElementById("edit-phone").value = decryptedUser.phone || "";
        document.getElementById("edit-street").value =
          decryptedUser.address?.street || "";
        document.getElementById("edit-building-number").value =
          decryptedUser.address?.buildingNumber || "";
        document.getElementById("edit-postal-code").value =
          decryptedUser.address?.postalCode || "";
        document.getElementById("edit-city").value =
          decryptedUser.address?.city || "";
        document.getElementById("edit-parcel-locker").value =
          decryptedUser.parcelLocker || "";
        document.getElementById("edit-newsletter").checked =
          decryptedUser.newsletter || false;
        document.getElementById("edit-role").value =
          decryptedUser.role || "user";
        document.getElementById("edit-status").value =
          decryptedUser.status || "active";

        document.getElementById("user-edit-modal").classList.remove("hidden");
      }

      window.closeUserEdit = () => {
        document.getElementById("user-edit-modal").classList.add("hidden");
        currentEditingUser = null;
      };

      // Zmienna globalna dla blokowanego użytkownika
      let currentBlockingUser = null;

      // Funkcje zarządzania użytkownikami
      window.toggleUserBlock = async (userId) => {
        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentBlockingUser = user;

          const currentStatus = user.status || "active";

          if (currentStatus === "blocked") {
            // Jeśli użytkownik jest już zablokowany, pokaż opcje odblokowania
            showUserUnblockModal();
          } else {
            // Jeśli użytkownik nie jest zablokowany, pokaż modal blokowania
            showUserBlockModal();
          }
        } catch (error) {
          console.error("Error toggling user block:", error);
          showNotification("Błąd zmiany statusu użytkownika.", "error");
        }
      };

      function showUserBlockModal() {
        if (!currentBlockingUser) return;

        const decryptedUser = {
          ...currentBlockingUser,
          phone: currentBlockingUser.phone
            ? atob(currentBlockingUser.phone)
            : "",
          address: {
            city: currentBlockingUser.address?.city
              ? atob(currentBlockingUser.address.city)
              : "",
          },
        };

        document.getElementById("block-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
            ${decryptedUser.phone ? ` • Tel: ${decryptedUser.phone}` : ""}
          </div>
        `;

        document.getElementById("block-user-id").value = decryptedUser.id;
        document.getElementById("user-block-modal").classList.remove("hidden");
      }

      function showUserUnblockModal() {
        if (!currentBlockingUser) return;

        const confirmUnblock = confirm(
          `Czy na pewno chcesz odblokować użytkownika ${currentBlockingUser.displayName}?\n\nUżytkownik odzyska dostęp do wszystkich funkcji strony.`,
        );

        if (confirmUnblock) {
          unblockUser(currentBlockingUser.id);
        }
      }

      async function unblockUser(userId) {
        try {
          await updateDoc(doc(db, "userProfiles", userId), {
            status: "active",
            unblockedAt: new Date(),
            unblockedBy: currentUser.uid,
          });

          // Zaloguj odblokowanie użytkownika
          await logActivity(userId, "USER_UNBLOCKED", {
            unblockedBy: currentUser.uid,
          });

          showNotification("Użytkownik został odblokowany.");
          loadUsers();
        } catch (error) {
          console.error("Error unblocking user:", error);
          showNotification("Błąd podczas odblokowywania użytkownika.", "error");
        }
      }

      window.closeUserBlock = () => {
        document.getElementById("user-block-modal").classList.add("hidden");
        currentBlockingUser = null;
      };

      function showUserDeleteModal() {
        if (!currentDeletingUser) return;

        const decryptedUser = {
          ...currentDeletingUser,
          phone: currentDeletingUser.phone
            ? atob(currentDeletingUser.phone)
            : "",
          address: {
            city: currentDeletingUser.address?.city
              ? atob(currentDeletingUser.address.city)
              : "",
          },
        };

        document.getElementById("delete-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
            ${decryptedUser.phone ? ` • Tel: ${decryptedUser.phone}` : ""}
          </div>
          <div class="text-sm text-zinc-500 mt-1">
            Konto utworzone: ${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleDateString("pl-PL")}
          </div>
        `;

        document.getElementById("delete-user-id").value = decryptedUser.id;
        document.getElementById("user-delete-modal").classList.remove("hidden");
      }

      window.closeUserDelete = () => {
        document.getElementById("user-delete-modal").classList.add("hidden");
        currentDeletingUser = null;
      };

      window.resetUserPassword = async (userId, email) => {
        // Sprawdź czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie można resetować hasła administratora lokalnego.",
            "error",
          );
          return;
        }

        if (!confirm(`Czy wysłać link resetowania hasła na adres: ${email}?`))
          return;

        try {
          const { sendPasswordResetEmail } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
          await sendPasswordResetEmail(auth, email, {
            url: `${window.location.origin}/konto.strzelca.pl/akcja.html?mode=resetPassword`,
            handleCodeInApp: true,
          });

          // Zaloguj reset hasła
          await logActivity(userId, "PASSWORD_RESET_REQUEST", {
            email: email,
            requestedBy: currentUser.uid,
          });

          showNotification("Link resetowania hasła został wysłany.");
        } catch (error) {
          console.error("Error sending password reset:", error);
          showNotification("Błąd wysyłania linku resetowania.", "error");
        }
      };

      window.changeUserRole = async (userId, currentRole) => {
        // Sprawdź czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie można zmienić roli administratora lokalnego.",
            "error",
          );
          return;
        }

        let newRole;
        let confirmMessage;

        if (currentRole === "user") {
          newRole = "company";
          confirmMessage =
            "Czy na pewno chcesz zmienić rolę tego użytkownika na FIRMA?";
        } else if (currentRole === "company") {
          newRole = "admin";
          confirmMessage =
            "Czy na pewno chcesz nadać temu użytkownikowi uprawnienia ADMINISTRATORA?";
        } else if (currentRole === "admin") {
          newRole = "user";
          confirmMessage =
            "Czy na pewno chcesz odebrać temu użytkownikowi uprawnienia administratora?";
        }

        if (!confirm(confirmMessage)) return;

        try {
          await updateDoc(doc(db, "userProfiles", userId), { role: newRole });

          // Zaloguj zmianę roli
          await logActivity(userId, "ROLE_CHANGE", {
            oldRole: currentRole,
            newRole: newRole,
            changedBy: currentUser.uid,
          });

          showNotification(
            `Rola użytkownika została zmieniona na: ${newRole === "company" ? "FIRMA" : newRole === "admin" ? "ADMINISTRATOR" : "UŻYTKOWNIK"}.`,
          );
          loadUsers();
        } catch (error) {
          console.error("Error changing user role:", error);
          showNotification("Błąd zmiany roli użytkownika.", "error");
        }
      };

      // Zmienna globalna dla usuwanego użytkownika
      let currentDeletingUser = null;

      window.deleteUser = async (userId) => {
        // Sprawdź czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie można usunąć administratora lokalnego.",
            "error",
          );
          return;
        }

        try {
          let user;

          // Sprawdź czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else {
            const userDoc = await getDoc(doc(db, "userProfiles", userId));
            if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentDeletingUser = user;

          showUserDeleteModal();
        } catch (error) {
          console.error("Error preparing user deletion:", error);
          showNotification(
            "Błąd przygotowania usunięcia użytkownika.",
            "error",
          );
        }
      };

      window.refreshUsers = () => {
        loadUsers();
      };

      // Funkcje zarządzania produktami
      async function loadProducts() {
        try {
          const q = query(collection(db, "products"), orderBy("order", "asc"));
          const snapshot = await getDocs(q);
          productsList = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          renderProductsList();
        } catch (error) {
          console.error("Error loading products:", error);
          showNotification("Błąd ładowania produktów.", "error");
        }
      }

      function renderProductsList() {
        const productsHtml = productsList
          .map(
            (product) => `
                <div class="flex justify-between items-center p-3 bg-zinc-800 rounded-lg">
                    <div class="flex-1">
                        <div class="font-semibold">${product.title}</div>
                        <div class="text-sm text-zinc-400">${product.price} zł</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editProduct('${product.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Edytuj</button>
                        <button onclick="deleteProduct('${product.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usuń</button>
                    </div>
                </div>
            `,
          )
          .join("");

        document.getElementById("products-list").innerHTML =
          productsHtml ||
          '<div class="text-center text-zinc-500 py-4">Brak produktów</div>';
      }

      // Funkcje formatowania tekstu w edytorze
      window.formatText = (command) => {
        document.execCommand(command, false, null);
      };

      window.insertImage = () => {
        const url = prompt("Wprowadź URL obrazka:");
        if (url) {
          document.execCommand("insertImage", false, url);
        }
      };

      // Placeholder funkcje - będą zaimplementowane w kolejnych krokach
      async function loadMessages() {
        try {
          document.getElementById("messages-list").innerHTML =
            '<div class="text-center text-zinc-500 py-8">Ładowanie wiadomości...</div>';

          const q = query(
            collection(db, "contactForms"),
            orderBy("timestamp", "desc"),
          );

          const snapshot = await getDocs(q);

          if (snapshot.empty) {
            document.getElementById("messages-list").innerHTML =
              '<div class="text-center text-zinc-500 py-8">Brak wiadomości kontaktowych</div>';
            return;
          }

          const messagesHtml = snapshot.docs
            .map((doc) => {
            const data = doc.data();
              const date = new Date(data.timestamp).toLocaleString("pl-PL");

              let statusClass = "";
              let statusText = "";
              let actionButton = "";

              switch (data.status) {
                case "in_progress":
                  statusClass = "text-orange-400";
                  statusText = "W trakcie";
                actionButton = `<button onclick="completeMessage('${doc.id}')" class="btn-admin text-xs px-3 py-1">Zakończ</button>`;
                break;
                case "completed":
                  statusClass = "text-green-400";
                  statusText = "Zakończona";
                  actionButton =
                    '<span class="text-zinc-500 text-xs">Zakończona</span>';
                break;
              default:
                  statusClass = "text-zinc-400";
                  statusText = "Nieznany";
                actionButton = `<button onclick="completeMessage('${doc.id}')" class="btn-admin text-xs px-3 py-1">Zakończ</button>`;
            }

            return `
              <div class="admin-card p-4 mb-4">
                <div class="flex justify-between items-start mb-3">
                  <div>
                    <h3 class="font-bold text-lg coyote-text">${data.topic || "Bez tematu"}</h3>
                    <p class="text-sm text-zinc-400">Od: ${data.senderName} (${data.senderEmail})</p>
                    <p class="text-sm text-zinc-500">${date}</p>
                  </div>
                  <div class="text-right">
                    <span class="text-xs ${statusClass} font-semibold">${statusText}</span>
                    <div class="mt-2">${actionButton}</div>
                  </div>
                </div>
                <div class="bg-zinc-800 p-3 rounded-lg">
                  <p class="text-zinc-300 whitespace-pre-wrap">${data.content}</p>
                </div>
              </div>
            `;
            })
            .join("");

          document.getElementById("messages-list").innerHTML = messagesHtml;
        } catch (error) {
          console.error("Error loading messages:", error);
          document.getElementById("messages-list").innerHTML =
            '<div class="text-center text-red-500 py-8">Błąd ładowania wiadomości</div>';
        }
      }

      async function completeMessage(messageId) {
        try {
          const messageRef = doc(db, "contactForms", messageId);
          await updateDoc(messageRef, {
            status: "completed",
          });

          showNotification("Sprawa została zakończona", "success");
          // Ponownie załaduj wiadomości aby odświeżyć widok
          loadMessages();
        } catch (error) {
          console.error("Error completing message:", error);
          showNotification("Błąd podczas kończenia sprawy", "error");
        }
      }

      async function loadConversations() {
        document.getElementById("conversations-list").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie konwersacji...</div>';
      }

      async function loadEvents() {
        document.getElementById("events-list").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie wydarzeń...</div>';
      }

      async function loadCharity() {
        document.getElementById("charity-content").innerHTML =
          '<div class="text-center text-zinc-500 py-8">Ładowanie zawartości pomocy charytatywnej...</div>';
      }

      async function loadSettings() {
        // Ładowanie ustawień kontaktowych i tematów
        try {
          // Placeholder - będzie zaimplementowane
          document.getElementById("topics-list").innerHTML =
            '<div class="text-center text-zinc-500 py-4">Ładowanie tematów...</div>';
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

        window.refreshProducts = () => {
          loadProducts();
        };

        // Funkcje dashboard
        const SITES_TO_CHECK = [
        "strzelca.pl",
        "sklep.strzelca.pl",
        "bazar.strzelca.pl",
        "szkolenia.strzelca.pl",
        "wydarzenia.strzelca.pl",
        "blog.strzelca.pl",
        "pomoc.strzelca.pl",
        "dokumenty.strzelca.pl",
        "kontakt.strzelca.pl",
        "konto.strzelca.pl",
        ];

        let sitesStatus = {};
        let lastStatusCheck = new Date();

      // Sprawdzanie pojedynczej subdomeny - pełna implementacja
      async function checkSubdomainStatus(site) {
        const startTime = Date.now();
        const timeout = 10000; // 10 sekund timeout

        try {
          // Próba fetch z timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);

          const response = await fetch(`https://${site}`, {
            method: "HEAD", // HEAD request - tylko headers, bez ciała
            mode: "no-cors", // Omiń CORS dla testów dostępności
            cache: "no-cache",
            signal: controller.signal,
          });

          clearTimeout(timeoutId);
          const responseTime = Date.now() - startTime;

          // W trybie no-cors nie możemy sprawdzić status HTTP, ale jeśli nie było błędu, strona prawdopodobnie działa
          return {
            online: true,
                lastCheck: new Date(),
            responseTime: responseTime,
            status: "OK",
              };
            } catch (error) {
          const responseTime = Date.now() - startTime;

          // Zapisz awarię do localStorage
          const failureKey = `site_failure_${site}`;
          const failureData = {
            site: site,
            timestamp: new Date().toISOString(),
            error: error.message,
            responseTime: responseTime,
          };

          try {
            localStorage.setItem(failureKey, JSON.stringify(failureData));
          } catch (storageError) {
            console.warn("Nie można zapisać do localStorage:", storageError);
          }

          return {
                online: false,
                lastCheck: new Date(),
            responseTime: responseTime,
            error: error.message,
            lastFailure: failureData,
          };
        }
      }

      // Sprawdzanie statusu wszystkich stron
      async function checkSitesStatus() {
        const statusContainer = document.getElementById("sites-status");
        statusContainer.innerHTML =
          '<div class="col-span-full text-center text-zinc-400 py-4"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Sprawdzanie statusów...</div>';

        // Sprawdź wszystkie strony równolegle dla lepszej wydajności
        const promises = SITES_TO_CHECK.map((site) =>
          checkSubdomainStatus(site),
        );
        const results = await Promise.allSettled(promises);

        // Zapisz wyniki
        SITES_TO_CHECK.forEach((site, index) => {
          const result = results[index];
          if (result.status === "fulfilled") {
            sitesStatus[site] = result.value;
          } else {
            sitesStatus[site] = {
              online: false,
              lastCheck: new Date(),
              error: result.reason.message,
            };
          }
        });

          renderSitesStatus();
          lastStatusCheck = new Date();
        document.getElementById("last-status-check").textContent =
          lastStatusCheck.toLocaleString("pl-PL");
        }

        function renderSitesStatus() {
        const statusContainer = document.getElementById("sites-status");
        const statusHtml = SITES_TO_CHECK.map((site) => {
            const status = sitesStatus[site];
          if (!status) return "";

          const statusClass = status.online ? "text-green-400" : "text-red-400";
          const statusIcon = status.online
            ? "fa-check-circle"
            : "fa-times-circle";
          const statusText = status.online ? "Online" : "Offline";
          const details = status.online
            ? `${status.responseTime}ms`
            : status.lastCheck.toLocaleString("pl-PL");

            return `
              <div class="flex justify-between items-center p-3 bg-zinc-800 rounded-lg animate-fade-in">
                <span class="text-sm">${site}</span>
                <div class="flex items-center space-x-2">
                  <span class="${statusClass}"><i class="fa-solid ${statusIcon}"></i> ${statusText}</span>
                  <span class="text-xs text-zinc-500 w-16 text-right">${details}</span>
                </div>
              </div>
            `;
        }).join("");

          statusContainer.innerHTML = statusHtml;
        }

        // Funkcje aktywności
        async function loadActivityStats() {
          try {
            // Symulacja danych - w rzeczywistości pobierać z Firebase
          document.getElementById("active-users-count").textContent =
            Math.floor(Math.random() * 50) + 10;
          document.getElementById("today-visits").textContent =
            Math.floor(Math.random() * 500) + 100;
          document.getElementById("today-contacts").textContent =
            Math.floor(Math.random() * 20) + 5;
          document.getElementById("pending-tasks").textContent =
            Math.floor(Math.random() * 15) + 3;
          document.getElementById("week-visits").textContent =
            Math.floor(Math.random() * 2000) + 500;
          document.getElementById("month-visits").textContent =
            Math.floor(Math.random() * 8000) + 2000;
          document.getElementById("year-visits").textContent =
            Math.floor(Math.random() * 50000) + 10000;
          } catch (error) {
          console.error("Error loading activity stats:", error);
          }
        }

        // Funkcje zdarzeń
        let eventsData = [];

        async function loadRecentEvents() {
          try {
            // Symulacja zdarzeń - w rzeczywistości pobierać z Firebase
            eventsData = [
              {
                id: 1,
              type: "MESSAGE_SENT",
              user: "AndrzejKowalski",
              description: "wysłał wiadomość do KowalKowal",
              content: "Cześć, jak się masz?",
                timestamp: new Date(Date.now() - 1000 * 60 * 5), // 5 min temu
              details:
                'Użytkownik AndrzejKowalski napisał wiadomość do użytkownika KowalKowal o treści: "Cześć, jak się masz?"',
              },
              {
                id: 2,
              type: "LIKE_BLOG",
              user: "MarekNowak",
              description: "polubił post na blogu",
              content: "Nowe słuchawki firmy XXX",
                timestamp: new Date(Date.now() - 1000 * 60 * 15), // 15 min temu
              details:
                'Użytkownik MarekNowak polubił post na blogu: "Nowe słuchawki firmy XXX"',
              },
              {
                id: 3,
              type: "CONTACT_FORM",
              user: "Anonimowy",
              description: "wypełnił formularz kontaktowy",
              content: "Pytanie o produkty",
                timestamp: new Date(Date.now() - 1000 * 60 * 30), // 30 min temu
              details:
                "Anonimowy użytkownik wypełnił formularz kontaktowy z pytaniem o produkty",
            },
            ];

            renderRecentEvents();
          document.getElementById("last-events-update").textContent =
            new Date().toLocaleString("pl-PL");
          } catch (error) {
          console.error("Error loading events:", error);
          }
        }

        function renderRecentEvents() {
        const eventsContainer = document.getElementById("recent-events");
          const recentEvents = eventsData.slice(0, 10); // Pokaż 10 najnowszych

        const eventsHtml = recentEvents
          .map((event) => {
            const timeAgo = getTimeAgo(event.timestamp);
            const activityLog = renderActivityLog(event);
            return `
              <div class="p-4 bg-zinc-800 rounded-lg cursor-pointer hover:bg-zinc-700 transition" onclick="showEventDetails('${event.id}')">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-semibold text-white">${event.user || "System"}</div>
                  <div class="text-xs text-zinc-500">${timeAgo}</div>
                </div>
                <div class="text-sm text-zinc-300">${activityLog.description}</div>
                <div class="text-xs text-zinc-500 mt-1">${activityLog.content}</div>
              </div>
            `;
          })
          .join("");

        eventsContainer.innerHTML =
          eventsHtml ||
          '<div class="text-center text-zinc-500 py-4">Brak zdarzeń</div>';
        }

        function getTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          if (diffMins < 60) return `${diffMins} min temu`;
          if (diffHours < 24) return `${diffHours} godz. temu`;
          return `${diffDays} dni temu`;
        }

        // Modal ze szczegółami zdarzenia
        function showEventDetails(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
          if (!event) return;

        const activityLog = renderActivityLog(event);

          // Utwórz modal
          const modalHtml = `
            <div id="event-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
              <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-700 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold coyote-text">Szczegóły Zdarzenia</h2>
                  <button onclick="closeEventModal()" class="text-zinc-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                  </button>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-zinc-400">Użytkownik:</label>
                    <div class="text-white font-semibold">${event.user || "System"}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Rodzaj zdarzenia:</label>
                    <div class="text-white">${event.type}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Nagłówek:</label>
                    <div class="text-white">${activityLog.description}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Szczegóły:</label>
                    <div class="text-white">${activityLog.details}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Data i czas:</label>
                    <div class="text-white">${event.timestamp?.toDate?.()?.toLocaleString("pl-PL") || new Date(event.timestamp).toLocaleString("pl-PL")}</div>
                  </div>
                </div>
              </div>
            </div>
          `;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        window.closeEventModal = () => {
        const modal = document.getElementById("event-modal");
          if (modal) modal.remove();
        };

        // Funkcja sprawdzania głównych usług serwera
        async function checkMainServicesStatus() {
          try {
            // Sprawdź Firestore
          const firestoreStatus = document.getElementById("firestore-status");
          const firestoreIcon = firestoreStatus.querySelector("i");
          const firestoreText =
            firestoreStatus.querySelector("span:last-child");

          // Pokaż ładowanie dla Firestore
          firestoreIcon.className = "fa-solid fa-spinner fa-spin text-lg text-zinc-400";
          firestoreText.className = "text-zinc-400 font-semibold text-sm";
          firestoreText.textContent = "Sprawdzanie...";

            // Sprawdź Auth
          const authStatus = document.getElementById("auth-status");
          const authIcon = authStatus.querySelector("i");
          const authText = authStatus.querySelector("span:last-child");

          // Pokaż ładowanie dla Auth
          authIcon.className = "fa-solid fa-spinner fa-spin text-lg text-zinc-400";
          authText.className = "text-zinc-400 font-semibold text-sm";
          authText.textContent = "Sprawdzanie...";

            // Sprawdź domenę
          const domainStatus = document.getElementById("domain-status");
          const domainIcon = domainStatus.querySelector("i");
          const domainText = domainStatus.querySelector("span:last-child");

          // Pokaż ładowanie dla domeny
          domainIcon.className = "fa-solid fa-spinner fa-spin text-lg text-zinc-400";
          domainText.className = "text-zinc-400 font-semibold text-sm";
          domainText.textContent = "Sprawdzanie...";

            let allServicesOnline = true;

            // Sprawdź Firestore
            try {
              const testDoc = await getDoc(doc(db, "test", "connection"));
            firestoreIcon.className =
              "fa-solid fa-check-circle text-lg text-green-400";
              firestoreText.className = "text-green-400 font-semibold text-sm";
              firestoreText.textContent = "Online";
            } catch (error) {
              console.error("Firestore error:", error);
            firestoreIcon.className =
              "fa-solid fa-times-circle text-lg text-red-400";
              firestoreText.className = "text-red-400 font-semibold text-sm";
              firestoreText.textContent = "Offline";
              allServicesOnline = false;
            }

            // Sprawdź Auth
            try {
              if (auth.currentUser) {
              authIcon.className =
                "fa-solid fa-check-circle text-lg text-green-400";
                authText.className = "text-green-400 font-semibold text-sm";
                authText.textContent = "Połączony";
              } else {
              authIcon.className =
                "fa-solid fa-times-circle text-lg text-red-400";
                authText.className = "text-red-400 font-semibold text-sm";
                authText.textContent = "Rozłączony";
                allServicesOnline = false;
              }
            } catch (error) {
              console.error("Auth error:", error);
            authIcon.className =
              "fa-solid fa-times-circle text-lg text-red-400";
              authText.className = "text-red-400 font-semibold text-sm";
              authText.textContent = "Błąd";
              allServicesOnline = false;
            }

            // Sprawdź domenę (prosty ping)
            try {
              const response = await fetch(window.location.origin, {
              method: "HEAD",
              mode: "no-cors",
              });
            domainIcon.className =
              "fa-solid fa-check-circle text-lg text-green-400";
              domainText.className = "text-green-400 font-semibold text-sm";
              domainText.textContent = "Online";
            } catch (error) {
              console.error("Domain error:", error);
            domainIcon.className =
              "fa-solid fa-times-circle text-lg text-red-400";
              domainText.className = "text-red-400 font-semibold text-sm";
              domainText.textContent = "Offline";
              allServicesOnline = false;
            }

            // Aktualizuj kolor zakładki status
          const statusTabText = document.getElementById("status-tab-text");
            if (allServicesOnline) {
              statusTabText.className = "text-green-400";
            } else {
              statusTabText.className = "text-red-400";
            }

            // Aktualizuj czas ostatniego sprawdzenia
          document.getElementById("last-status-check").textContent =
            new Date().toLocaleString("pl-PL");

            // Sprawdź również status subdomen
            await checkSitesStatus();

            showNotification("Status wszystkich usług został zaktualizowany", "success");
          } catch (error) {
            console.error("Error checking main services:", error);
            showNotification("Błąd sprawdzania statusu usług", "error");
          }
        }


        window.checkSitesStatus = checkSitesStatus;
        window.checkMainServicesStatus = checkMainServicesStatus;
        window.refreshEvents = loadRecentEvents;
        window.openEventsPanel = () => {
          // TODO: Implement full events panel with filtering
        alert("Panel wszystkich zdarzeń będzie dostępny wkrótce");
        };
        window.showEventDetails = showEventDetails;

      // Integracja z activityLogs - Firestore listener
      function setupActivityLogsListener() {
        if (activityLogsListener) {
          activityLogsListener(); // Odłącz poprzedni listener
        }

        activityLogsListener = onSnapshot(
          query(
            collection(db, "activityLogs"),
            orderBy("timestamp", "desc"),
            limit(10),
          ),
          (snapshot) => {
            eventsData = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));

            renderRecentEvents();
            document.getElementById("last-events-update").textContent =
              new Date().toLocaleString("pl-PL");
          },
          (error) => {
            console.error("Activity logs listener error:", error);
            showNotification("Błąd ładowania logów aktywności.", "error");
          },
        );
      }

      function setupPendingTasksListener() {
        if (pendingTasksListener) {
          pendingTasksListener(); // Odłącz poprzedni listener
        }

        pendingTasksListener = onSnapshot(
          query(
            collection(db, "contactForms"),
            where("status", "==", "in_progress"),
          ),
          (snapshot) => {
            document.getElementById("pending-tasks").textContent =
              snapshot.size;
          },
          (error) => {
            console.error("Pending tasks listener error:", error);
          },
        );
      }

      // Funkcja renderowania pojedynczego logu aktywności
      function renderActivityLog(event) {
        let description = "";
        let content = "";
        let details = "";

        switch (event.type) {
          case "MESSAGE_SENT":
            description = `${event.user} wysłał wiadomość`;
            content = event.content || "Treść niedostępna";
            details = `Użytkownik ${event.user} wysłał wiadomość do ${event.recipient || "innego użytkownika"} o treści: "${event.content || "Treść niedostępna"}"`;
            break;
          case "LIKE_BLOG":
            description = `${event.user} polubił post`;
            content = event.content || "Tytuł niedostępny";
            details = `Użytkownik ${event.user} polubił post na blogu: "${event.content || "Tytuł niedostępny"}"`;
            break;
          case "CONTACT_FORM":
            description = `${event.user} wypełnił formularz kontaktowy`;
            content = event.subject || "Zapytanie";
            details = `Użytkownik ${event.user} wypełnił formularz kontaktowy z tematem: "${event.subject || "Zapytanie"}"`;
            break;
          case "USER_REGISTER":
            description = `${event.user} zarejestrował się`;
            content = "Nowe konto";
            details = `Użytkownik ${event.user} pomyślnie zarejestrował nowe konto w systemie`;
            break;
          case "PRODUCT_VIEW":
            description = `${event.user} przeglądał produkt`;
            content = event.productName || "Produkt";
            details = `Użytkownik ${event.user} przeglądał produkt: "${event.productName || "Produkt"}"`;
            break;
          default:
            description = `${event.user} wykonał akcję ${event.type}`;
            content = event.content || "Szczegóły niedostępne";
            details = `Użytkownik ${event.user} wykonał akcję typu ${event.type}: ${event.content || "Szczegóły niedostępne"}`;
        }

        return { description, content, details };
      }

      // Funkcje liczników formularzy i niezakończonych spraw
      async function loadContactFormsCount() {
        try {
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);

          const q = query(
            collection(db, "contactForms"),
            where("timestamp", ">=", today),
            where("timestamp", "<", tomorrow),
          );

          const snapshot = await getDocs(q);
          document.getElementById("today-contacts").textContent = snapshot.size;
        } catch (error) {
          console.error("Error loading contact forms count:", error);
          document.getElementById("today-contacts").textContent = "0";
        }
      }

      async function loadPendingTasksCount() {
        try {
          const q = query(
            collection(db, "contactForms"),
            where("status", "==", "in_progress"),
          );

          const snapshot = await getDocs(q);
          document.getElementById("pending-tasks").textContent = snapshot.size;
        } catch (error) {
          console.error("Error loading pending tasks count:", error);
          document.getElementById("pending-tasks").textContent = "0";
        }
      }

      // Placeholder dla Google Analytics - przygotowanie do integracji
      async function fetchGAStatistics() {
        try {
          // TODO: Integracja z Google Analytics Data API
          // Wymaga Service Account i odpowiednich uprawnień

          const today = new Date().toISOString().split("T")[0];
          const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const yearAgo = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];

          // Placeholder - w rzeczywistości pobierać z GA API
          document.getElementById("today-visits").textContent =
            Math.floor(Math.random() * 500) + 100;
          document.getElementById("week-visits").textContent =
            Math.floor(Math.random() * 2000) + 500;
          document.getElementById("month-visits").textContent =
            Math.floor(Math.random() * 8000) + 2000;
          document.getElementById("year-visits").textContent =
            Math.floor(Math.random() * 50000) + 10000;

          console.log("GA Statistics fetched (placeholder implementation)");
        } catch (error) {
          console.error("Error fetching GA statistics:", error);
          // Fallback wartości
          document.getElementById("today-visits").textContent = "0";
          document.getElementById("week-visits").textContent = "0";
          document.getElementById("month-visits").textContent = "0";
          document.getElementById("year-visits").textContent = "0";
        }
      }

      window.editProduct = (productId) => {
        const product = productsList.find((p) => p.id === productId);
        if (!product) return;

        document.getElementById("product-id").value = product.id;
        document.getElementById("product-title").value = product.title || "";
        document.getElementById("product-price").value = product.price || "";
        document.getElementById("product-description").innerHTML =
          product.description || "";

        // Scroll do formularza
        document
          .querySelector("#tab-products")
          .scrollIntoView({ behavior: "smooth" });
      };

      window.deleteProduct = async (productId) => {
        if (!confirm("Czy na pewno chcesz usunąć ten produkt?")) return;

        try {
          await deleteDoc(doc(db, "products", productId));
          showNotification("Produkt został usunięty.");
          loadProducts();
        } catch (error) {
          console.error("Error deleting product:", error);
          showNotification("Błąd usuwania produktu.", "error");
        }
      };

      window.sendMessage = () => {
        // Placeholder - implementacja wysyłania wiadomości
        showNotification(
          "Funkcja wysyłania wiadomości będzie dostępna wkrótce.",
        );
      };

      window.addTopic = () => {
        // Placeholder - implementacja dodawania tematu
        showNotification("Funkcja dodawania tematu będzie dostępna wkrótce.");
      };

      // Obsługa formularza produktu
      document
        .getElementById("product-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const productId = document.getElementById("product-id").value;
          const title = document.getElementById("product-title").value.trim();
          const price = document.getElementById("product-price").value.trim();
          const description = document.getElementById(
            "product-description",
          ).innerHTML;

          if (!title || !price) {
            showNotification("Wypełnij wszystkie wymagane pola.", "error");
            return;
          }

          try {
            const productData = {
              title,
              price,
              description,
              date: Date.now(),
              order: productsList.length,
            };

            if (productId) {
              // Aktualizacja istniejącego produktu
              await updateDoc(doc(db, "products", productId), productData);
              showNotification("Produkt został zaktualizowany.");
            } else {
              // Dodanie nowego produktu
              await addDoc(collection(db, "products"), productData);
              showNotification("Produkt został dodany.");
            }

            // Wyczyść formularz
            document.getElementById("product-form").reset();
            document.getElementById("product-description").innerHTML = "";
            document.getElementById("product-id").value = "";

            loadProducts();
          } catch (error) {
            console.error("Error saving product:", error);
            showNotification("Błąd zapisywania produktu.", "error");
          }
        });

      // Obsługa formularza edycji użytkownika
      document
        .getElementById("user-edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("edit-user-id").value;
          if (!userId) return;

          const saveBtn = e.target.querySelector('button[type="submit"]');
          saveBtn.disabled = true;
          saveBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zapisywanie...';

          try {
            // Zaszyfruj wrażliwe dane przed zapisaniem
            const updatedProfile = {
              displayName: document
                .getElementById("edit-display-name")
                .value.trim(),
              firstName: document
                .getElementById("edit-first-name")
                .value.trim(),
              lastName: document.getElementById("edit-last-name").value.trim(),
              phone: btoa(document.getElementById("edit-phone").value.trim()),
              address: {
                street: btoa(
                  document.getElementById("edit-street").value.trim(),
                ),
                buildingNumber: btoa(
                  document.getElementById("edit-building-number").value.trim(),
                ),
                postalCode: btoa(
                  document.getElementById("edit-postal-code").value.trim(),
                ),
                city: btoa(document.getElementById("edit-city").value.trim()),
              },
              parcelLocker: btoa(
                document.getElementById("edit-parcel-locker").value.trim(),
              ),
              newsletter: document.getElementById("edit-newsletter").checked,
              role: document.getElementById("edit-role").value,
              status: document.getElementById("edit-status").value,
              updatedAt: new Date(),
              updatedBy: currentUser.uid,
            };

            await updateDoc(doc(db, "userProfiles", userId), updatedProfile);

            // Zaloguj edycję profilu
            await logActivity(userId, "PROFILE_EDITED", {
              editedBy: currentUser.uid,
              changes: Object.keys(updatedProfile),
            });

            showNotification("Dane użytkownika zostały zaktualizowane.");
            closeUserEdit();
            loadUsers(); // Odśwież listę użytkowników
          } catch (error) {
            console.error("Error updating user:", error);
            showNotification(
              "Błąd podczas aktualizacji danych użytkownika.",
              "error",
            );
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML =
              '<i class="fa-solid fa-save mr-2"></i>Zapisz zmiany';
          }
        });

      // Obsługa formularza blokowania użytkownika
      document
        .getElementById("user-block-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("block-user-id").value;
          if (!userId) return;

          const duration = document.getElementById("block-duration").value;
          const contentAction = document.querySelector(
            'input[name="content-action"]:checked',
          ).value;

          const blockBtn = e.target.querySelector('button[type="submit"]');
          blockBtn.disabled = true;
          blockBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Blokowanie...';

          try {
            // Oblicz datę zakończenia blokady
            let blockedUntil = null;
            const now = new Date();

            switch (duration) {
              case "15min":
                blockedUntil = new Date(now.getTime() + 15 * 60 * 1000);
                break;
              case "1hour":
                blockedUntil = new Date(now.getTime() + 60 * 60 * 1000);
                break;
              case "6hours":
                blockedUntil = new Date(now.getTime() + 6 * 60 * 60 * 1000);
                break;
              case "24hours":
                blockedUntil = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                break;
              case "7days":
                blockedUntil = new Date(
                  now.getTime() + 7 * 24 * 60 * 60 * 1000,
                );
                break;
              case "30days":
                blockedUntil = new Date(
                  now.getTime() + 30 * 24 * 60 * 60 * 1000,
                );
                break;
              case "permanent":
                blockedUntil = null; // Blokada permanentna
                break;
            }

            const blockData = {
              status: "blocked",
              blockedAt: now,
              blockedUntil: blockedUntil,
              blockedBy: currentUser.uid,
              blockDuration: duration,
              contentAction: contentAction,
              isPermanentBlock: duration === "permanent",
            };

            await updateDoc(doc(db, "userProfiles", userId), blockData);

            // Zaloguj blokadę użytkownika
            await logActivity(userId, "USER_BLOCKED", {
              duration: duration,
              blockedUntil: blockedUntil,
              contentAction: contentAction,
              isPermanent: duration === "permanent",
              blockedBy: currentUser.uid,
            });

            // Jeśli wybrano usunięcie zawartości, tutaj należałoby dodać logikę usuwania
            // (produkty, wiadomości, itp.) - będzie implementowane w następnych krokach

            showNotification(
              `Użytkownik został zablokowany${blockedUntil ? " do " + blockedUntil.toLocaleString("pl-PL") : " na zawsze"}.`,
            );
            closeUserBlock();
            loadUsers();
          } catch (error) {
            console.error("Error blocking user:", error);
            showNotification("Błąd podczas blokowania użytkownika.", "error");
          } finally {
            blockBtn.disabled = false;
            blockBtn.innerHTML =
              '<i class="fa-solid fa-ban mr-2"></i>Zablokuj użytkownika';
          }
        });

      // Obsługa formularza usuwania użytkownika
      document
        .getElementById("user-delete-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("delete-user-id").value;
          if (!userId) return;

          const contentAction = document.querySelector(
            'input[name="delete-content-action"]:checked',
          ).value;

          const deleteBtn = e.target.querySelector('button[type="submit"]');
          deleteBtn.disabled = true;
          deleteBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Usuwanie...';

          try {
            if (contentAction === "remove") {
              // Usuń całą zawartość użytkownika - tutaj należałoby dodać logikę usuwania
              // produktów, wiadomości, komentarzy itp. z innych kolekcji
              // Na razie tylko oznaczamy, że zawartość została usunięta
              console.log("Usuwanie zawartości użytkownika:", userId);
            }

            // Usuń profil użytkownika
            await deleteDoc(doc(db, "userProfiles", userId));

            // Zaloguj usunięcie użytkownika PRZED faktycznym usunięciem
            await logActivity(userId, "USER_DELETED", {
              contentAction: contentAction,
              deletedBy: currentUser.uid,
              userEmail: currentDeletingUser.email,
              userDisplayName: currentDeletingUser.displayName,
            });

            // Usuń z listy mailingowej jeśli był zapisany
            try {
              await deleteDoc(
                doc(db, "mailingList", currentDeletingUser.email),
              );
            } catch (error) {
              // Ignoruj błąd jeśli użytkownik nie był na liście mailingowej
            }

            showNotification(
              `Użytkownik został całkowicie usunięty z systemu${contentAction === "keep" ? " (zawartość zachowana)" : " (zawartość usunięta)"}.`,
            );
            closeUserDelete();
            loadUsers();
          } catch (error) {
            console.error("Error deleting user:", error);
            showNotification("Błąd podczas usuwania użytkownika.", "error");
          } finally {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML =
              '<i class="fa-solid fa-trash mr-2"></i>Usuń użytkownika';
          }
        });

      // Automatyczne odświeżanie co 1 godzinę (aby nie tracić limitów Firebase)
      setInterval(
        async () => {
          if (currentUser && !currentUser.isLocalAdmin) {
            // Tylko dla administratorów Firebase (nie lokalnych)
          try {
            await checkSitesStatus();
              // Activity logs są automatycznie aktualizowane przez listener
              console.log(
                "Dashboard auto-refreshed at",
                new Date().toLocaleString("pl-PL"),
              );
          } catch (error) {
              console.error("Auto-refresh error:", error);
            }
          }
        },
        60 * 60 * 1000,
      ); // 1 godzina

      // ===== FUNKCJE DO MODERACJI OPINII =====

      // Ładowanie opinii do moderacji
      async function loadReviews() {
        try {
          document.getElementById("reviews-loading").classList.remove("hidden");
          document.getElementById("reviews-empty").classList.add("hidden");

          const reviewsQuery = query(
            collection(db, "userReviews"),
            orderBy("timestamp", "desc"),
          );

          const reviewsSnapshot = await getDocs(reviewsQuery);
          const reviews = reviewsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          displayReviewsForModeration(reviews);
        } catch (error) {
          console.error("Błąd ładowania opinii:", error);
          showNotification("Błąd ładowania opinii", "error");
        } finally {
          document.getElementById("reviews-loading").classList.add("hidden");
        }
      }

      // Wyświetlanie opinii do moderacji
      function displayReviewsForModeration(reviews) {
        const reviewsList = document.getElementById("reviews-list");
        const reviewsEmpty = document.getElementById("reviews-empty");

        if (reviews.length === 0) {
          reviewsEmpty.classList.remove("hidden");
          reviewsList.innerHTML = "";
          return;
        }

        reviewsEmpty.classList.add("hidden");

        reviewsList.innerHTML = reviews
          .map(
            (review) => `
          <div class="admin-card" data-review-id="${review.id}">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="font-bold text-lg">${review.raterName} → ${review.ratedName}</div>
                <div class="text-sm text-zinc-400">${formatDate(review.timestamp)}</div>
              </div>
              <div class="flex items-center space-x-2">
                <span class="status-badge status-${review.status || "pending"}">
                  ${getStatusText(review.status || "pending")}
                </span>
                <div class="flex space-x-1">
                  ${generateStars(review.rating)}
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 p-4 rounded-lg mb-4">
              <p class="text-zinc-300">${review.comment}</p>
            </div>

            ${
              review.status === "pending"
                ? `
              <div class="flex space-x-2">
                <button onclick="approveReview('${review.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  <i class="fa-solid fa-check mr-2"></i>
                  Zatwierdź
                </button>
                <button onclick="rejectReview('${review.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                  <i class="fa-solid fa-times mr-2"></i>
                  Odrzuć
                </button>
              </div>
            `
                : review.status === "approved"
                  ? `
              <div class="flex space-x-2">
                <button onclick="rejectReview('${review.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                  <i class="fa-solid fa-times mr-2"></i>
                  Odrzuć
                </button>
              </div>
            `
                  : `
              <div class="flex space-x-2">
                <button onclick="approveReview('${review.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  <i class="fa-solid fa-check mr-2"></i>
                  Zatwierdź
                </button>
              </div>
            `
            }
          </div>
        `,
          )
          .join("");

        // Obsługa filtra
        document
          .getElementById("reviews-filter")
          .addEventListener("change", (e) => {
            const filter = e.target.value;
            filterReviews(reviews, filter);
          });
      }

      // Filtrowanie opinii
      function filterReviews(reviews, status) {
        let filteredReviews = reviews;

        if (status !== "all") {
          filteredReviews = reviews.filter(
            (review) => (review.status || "pending") === status,
          );
        }

        displayReviewsForModeration(filteredReviews);
      }

      // Generowanie gwiazdek dla opinii
      function generateStars(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += `<i class="fa-solid fa-star ${i <= rating ? "text-yellow-400" : "text-zinc-600"}"></i>`;
        }
        return stars;
      }

      // Pobieranie tekstu statusu
      function getStatusText(status) {
        switch (status) {
          case "pending":
            return "Oczekuje";
          case "approved":
            return "Zatwierdzona";
          case "rejected":
            return "Odrzucona";
          default:
            return "Nieznany";
        }
      }

      // Zatwierdzanie opinii
      async function approveReview(reviewId) {
        try {
          await updateDoc(doc(db, "userReviews", reviewId), {
            status: "approved",
          });

          showNotification("Opinia została zatwierdzona", "success");
          loadReviews(); // Odśwież listę
        } catch (error) {
          console.error("Błąd zatwierdzania opinii:", error);
          showNotification("Błąd zatwierdzania opinii", "error");
        }
      }

      // Odrzucanie opinii
      async function rejectReview(reviewId) {
        try {
          await updateDoc(doc(db, "userReviews", reviewId), {
            status: "rejected",
          });

          showNotification("Opinia została odrzucona", "success");
          loadReviews(); // Odśwież listę
        } catch (error) {
          console.error("Błąd odrzucania opinii:", error);
          showNotification("Błąd odrzucania opinii", "error");
        }
      }

      // ===== KONIEC FUNKCJI MODERACJI OPINII =====

      // Inicjalizacja - sprawdź czy użytkownik już jest zalogowany
      if (auth.currentUser) {
        onAuthStateChanged(auth, async (user) => {
          if (user && (await checkAdminRole(user))) {
            currentUser = user;
            updateAdminDisplay(user);
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("admin-panel").classList.remove("hidden");
            switchTab("dashboard");
          }
        });
      }

      // Obsługa checkboxa "Zapamiętaj ADMIN"
      document.addEventListener("DOMContentLoaded", function () {
        const toggleElement = document.getElementById("admin-remember-toggle");
        if (toggleElement) {
          toggleElement.addEventListener("click", function () {
            const checkbox = document.getElementById("admin-remember");
            const text1 = document.getElementById("admin-remember-text-1");
            const text2 = document.getElementById("admin-remember-text-2");

            if (!checkbox || !text1 || !text2) return;

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
              text1.classList.add("text-green-500");
              text1.classList.remove("text-zinc-400");
              text2.classList.add("text-green-500");
              text2.classList.remove("text-zinc-400");
            } else {
              text1.classList.add("text-zinc-400");
              text1.classList.remove("text-green-500");
              text2.classList.add("text-zinc-400");
              text2.classList.remove("text-green-500");
            }
          });

          // Hover efekty
          toggleElement.addEventListener("mouseenter", function () {
            const text1 = document.getElementById("admin-remember-text-1");
            const text2 = document.getElementById("admin-remember-text-2");

            text1.classList.add("text-green-500");
            text1.classList.remove("text-zinc-400");
            text2.classList.add("text-green-500");
            text2.classList.remove("text-zinc-400");
          });

          toggleElement.addEventListener("mouseleave", function () {
            const checkbox = document.getElementById("admin-remember");
            const text1 = document.getElementById("admin-remember-text-1");
            const text2 = document.getElementById("admin-remember-text-2");

            if (!checkbox.checked) {
              text1.classList.add("text-zinc-400");
              text1.classList.remove("text-green-500");
              text2.classList.add("text-zinc-400");
              text2.classList.remove("text-green-500");
            }
          });
        }
      });
    </script>

    <!-- Global loading overlay -->
    <div id="dashboard-loading-overlay" class="dashboard-loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner-large">
          <i class="fa-solid fa-sync-alt"></i>
        </div>
        <p class="loading-text">Odświeżanie dashboardu...</p>
      </div>
    </div>
  </body>
</html>
