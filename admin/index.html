<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="https://strzelca.pl/ikona.svg"
    />
    <link rel="apple-touch-icon" href="https://strzelca.pl/ikona.svg" />

    <title>Panel Administracyjny - strzelca.pl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <style>
      :root {
        --coyote: #c19a6b;
      }

      /* Ustawienie t≈Ça na elemencie html dla Safari */
      html {
        background-color: #0a0a0a;
        background-image:
          linear-gradient(rgba(10, 10, 10, 0.6), #0a0a0a),
          url("https://strzelca.pl/tlo.png");
        background-size: cover;
        background-position: center top;
        background-attachment: fixed;
        background-repeat: no-repeat;
        min-height: 100vh; /* Minimalna wysoko≈õƒá zamiast sta≈Çej */
        /* Safari viewport height fix */
        min-height: -webkit-fill-available;
        min-height: 100dvh; /* Dynamic viewport height for modern browsers */
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", sans-serif;
        background: transparent; /* Przejrzyste t≈Ço, ≈ºeby pokazaƒá t≈Ço html */
        color: #e5e5e5;
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh; /* Minimalna wysoko≈õƒá zamiast sta≈Çej */
        /* Safari viewport height fix */
        min-height: -webkit-fill-available;
        min-height: 100dvh; /* Dynamic viewport height for modern browsers */
      }

      /* Sekcja logowania zajmuje ca≈ÇƒÖ wysoko≈õƒá, ≈ºeby nie by≈Ço czarnego paska */
      #login-section {
        min-height: 100vh;
        min-height: 100dvh; /* Dynamic viewport height */
        min-height: -webkit-fill-available; /* Safari */
      }
      .coyote-text {
        color: var(--coyote);
        font-family: "Orbitron";
      }
      .admin-text {
        color: #dc2626;
        font-family: "Orbitron";
      }

      input,
      select,
      textarea {
        background: #111 !important;
        border: 1px solid #222 !important;
        color: white !important;
        padding: 12px 16px !important;
        border-radius: 8px;
        width: 100%;
        outline: none;
        transition: 0.3s;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--coyote) !important;
        background: #161616 !important;
      }

      .btn-admin {
        background: var(--coyote);
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 12px 24px;
        border-radius: 8px;
        transition: 0.3s;
        cursor: pointer;
      }
      .btn-admin:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(193, 154, 107, 0.3);
      }
      .btn-admin:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
      }

      /* Loading states */
      .loading-spinner {
        position: relative;
        overflow: hidden;
      }

      .loading-spinner::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(193, 154, 107, 0.4), transparent);
        animation: shimmer 1.5s ease-in-out infinite;
      }

      .loading-spinner i.fa-sync-alt {
        animation: spin 1s linear infinite;
        color: rgba(0, 0, 0, 0.8) !important;
      }

      /* Globalny loading overlay dla dashboardu */
      .dashboard-loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(10, 10, 10, 0.7);
        backdrop-filter: blur(2px);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
      }

      .dashboard-loading-overlay.active {
        opacity: 1;
        pointer-events: auto;
      }

      .loading-content {
        background: #111;
        border: 1px solid var(--coyote);
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        box-shadow: 0 0 30px rgba(193, 154, 107, 0.3);
      }

      .loading-spinner-large {
        font-size: 2em;
        color: var(--coyote);
        margin-bottom: 16px;
        animation: spin 1s linear infinite;
      }

      .loading-text {
        color: white;
        font-family: "Orbitron";
        font-size: 1.1em;
        margin: 0;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
      }

      @keyframes fadeIn {
        0% { opacity: 0; transform: translateY(10px); }
        100% { opacity: 1; transform: translateY(0); }
      }

      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }

      .admin-card {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 24px;
        transition: 0.3s;
      }
      .admin-card:hover {
        border-color: var(--coyote);
      }

      /* Styl dla g√≥rnego paska nawigacji */
      .top-nav {
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      /* Style dla zak≈Çadek w poziomie */
      #tabs-container .nav-item {
        padding: 8px 12px;
        border-radius: 12px;
        margin: 2px 0;
        font-size: 13px;
        white-space: nowrap;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      #tabs-container .nav-pages-toggle {
        padding: 8px 12px;
        border-radius: 12px;
        margin: 2px 0;
        font-size: 13px;
        white-space: nowrap;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
      }

      #tabs-container .nav-section-title {
        margin: 0 8px 0 0;
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        font-size: 10px;
      }

      /* Rozwijane menu stron w poziomie */
      .nav-submenu {
        background: rgba(0, 0, 0, 0.95);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .nav-submenu.open {
        max-height: 200px;
      }

      .nav-submenu-item {
        padding: 8px 16px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 8px;
        margin: 2px;
        font-size: 12px;
        background: rgba(255, 255, 255, 0.05);
      }

      .nav-submenu-item:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateY(-1px);
      }

      .nav-submenu-item.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow: 0 0 16px rgba(193, 154, 107, 0.2);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      /* Scrollbar hide utility */
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      /* Kompaktowy sidebar */
      .compact-sidebar {
        width: 64px;
        background: rgba(0, 0, 0, 0.2);
        backdrop-filter: blur(20px);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
      }

      .nav-item {
        padding: 10px 13px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 16px;
        margin: 3px 12px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }
      .nav-item:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateX(2px) scale(1.01);
        box-shadow:
          0 4px 16px rgba(193, 154, 107, 0.12),
          0 0 0 1px rgba(193, 154, 107, 0.1);
      }
      .nav-item.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow:
          0 0 24px rgba(193, 154, 107, 0.15),
          0 2px 8px rgba(193, 154, 107, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      .admin-name {
        color: var(--coyote);
        font-family: "Orbitron";
        font-weight: 700;
      }

      .coyote {
        color: var(--coyote);
      }

      .editor-content {
        background: #161616;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 16px;
        min-height: 200px;
        color: white;
      }

      .toolbar {
        background: #111;
        border: 1px solid #222;
        border-radius: 8px;
        padding: 8px;
        margin-bottom: 8px;
      }
      .toolbar button {
        background: #222;
        border: none;
        color: white;
        padding: 8px 12px;
        margin: 0 2px;
        border-radius: 4px;
        cursor: pointer;
        transition: 0.3s;
      }
      .toolbar button:hover {
        background: var(--coyote);
        color: black;
      }

      .status-active {
        border-left: 4px solid #10b981;
        background: rgba(16, 185, 129, 0.1);
      }
      .status-blocked {
        border-left: 4px solid #ef4444;
        background: rgba(239, 68, 68, 0.1);
      }
      .status-suspended {
        border-left: 4px solid #f59e0b;
        background: rgba(245, 158, 11, 0.1);
      }

      .role-admin {
        background: #dc2626;
        color: white;
      }
      .role-user {
        background: white;
        color: black;
      }
      .role-company {
        background: var(--coyote);
        color: black;
      }

      .nav-section-title {
        margin-top: 16px;
        padding: 8px 16px 4px 16px;
        font-weight: 500;
        font-size: 11px;
        opacity: 0.7;
      }
      .nav-section-title:first-child {
        margin-top: 0;
        padding-top: 4px;
      }

      .nav-submenu {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background: rgba(193, 154, 107, 0.05);
        border-radius: 12px;
        margin: 4px 12px;
      }

      .nav-submenu.open {
        max-height: 500px;
      }

      .nav-submenu-item {
        padding: 10px 16px 10px 40px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-weight: 300;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-radius: 8px;
        margin: 2px 4px;
        font-size: 13px;
      }

      .nav-submenu-item:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateX(2px);
      }

      .nav-submenu-item.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow:
          0 0 24px rgba(193, 154, 107, 0.15),
          0 2px 8px rgba(193, 154, 107, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      .nav-pages-toggle:hover {
        background: rgba(193, 154, 107, 0.08);
        color: rgba(193, 154, 107, 0.95);
        transform: translateX(2px) scale(1.01);
        box-shadow:
          0 4px 16px rgba(193, 154, 107, 0.12),
          0 0 0 1px rgba(193, 154, 107, 0.1);
      }

      .nav-pages-toggle.active {
        background: rgba(193, 154, 107, 0.06);
        color: rgba(193, 154, 107, 0.9);
        box-shadow:
          0 0 24px rgba(193, 154, 107, 0.15),
          0 2px 8px rgba(193, 154, 107, 0.1),
          inset 0 1px 0 rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(193, 154, 107, 0.15);
      }

      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      /* Animacja ≈Çadowania dla przycisk√≥w */
      .loading-spinner {
        position: relative;
        pointer-events: none;
      }

      .loading-spinner::before {
        content: '';
        position: absolute;
        left: 50%;
        top: 50%;
        width: 16px;
        height: 16px;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-spinner > * {
        opacity: 0.7;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      /* Style dla element√≥w konwersacji */
      .conversation-item:hover {
        transform: translateX(2px);
      }
    </style>
  </head>
  <body>

    <!-- Sekcja logowania -->
    <div
      id="login-section"
      class="h-full flex items-start justify-center p-6 pt-16 md:pt-20 lg:pt-24"
    >
      <div class="admin-card max-w-md w-full">
        <h1
          class="text-3xl font-black uppercase italic font-[Orbitron] text-center mb-8"
        >
          <span class="coyote-text">PANEL</span>
          <span class="admin-text">ADMINISTRATORA</span>
        </h1>

        <form id="admin-login-form" class="space-y-6">
          <div>
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Login</label
            >
            <input type="text" id="admin-email" placeholder="Login" required />
          </div>

          <div>
            <label
              class="text-[10px] uppercase font-bold text-zinc-500 ml-2 mb-2 block tracking-widest"
              >Has≈Ço</label
            >
            <input
              type="password"
              id="admin-password"
              placeholder="Has≈Ço"
              required
            />
          </div>

          <div class="flex items-center justify-center mb-6">
            <input type="checkbox" id="admin-remember" class="hidden" />
            <div
              class="flex flex-col items-center cursor-pointer hover:scale-105 transition-transform duration-200"
              id="admin-remember-toggle"
            >
              <span
                id="admin-remember-text-1"
                class="text-[10px] uppercase tracking-[0.15em] font-medium text-zinc-400 block text-center transition-colors"
                >Zapamiƒôtaj</span
              >
              <span
                id="admin-remember-text-2"
                class="text-[10px] uppercase tracking-[0.15em] font-medium text-zinc-400 block text-center w-full transition-colors"
              ></span>
            </div>
          </div>

          <button type="submit" class="btn-admin w-full" id="admin-login-btn">
            <i class="fa-solid fa-sign-in-alt mr-2"></i>
            ZALOGUJ
          </button>
        </form>

        <div
          id="login-status"
          class="mt-6 p-4 rounded-lg text-center text-sm hidden"
        ></div>
      </div>
    </div>

    <!-- G≈Ç√≥wny panel administracyjny -->
    <div id="admin-panel" class="hidden h-full flex flex-col">
      <!-- G√≥rny pasek nawigacji -->
      <div class="bg-black/40 backdrop-blur-xl border-b border-zinc-700/50 sticky top-0 z-50">
        <div class="flex items-center justify-between px-4 py-3">
          <!-- Logo i nazwa -->
          <div class="flex items-center space-x-4">
            <button
              onclick="toggleSidebar()"
              class="md:hidden text-zinc-400 hover:text-white transition p-2"
              id="mobile-menu-btn"
            >
              <i class="fa-solid fa-bars text-lg"></i>
            </button>
            <div class="hidden md:flex items-center space-x-3">
              <i class="fa-solid fa-crown text-coyote text-xl"></i>
              <span class="text-white font-bold text-lg">Admin Panel</span>
              </div>
            </div>

          <!-- Profil administratora (kompaktowy) -->
          <div class="flex items-center space-x-3">
            <div class="hidden sm:flex items-center space-x-2 text-sm">
              <span id="admin-display-name-compact" class="text-white font-medium"></span>
              <span id="admin-session-time-compact" class="text-zinc-400 text-xs"></span>
            </div>
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-coyote/20 to-zinc-600/40 flex items-center justify-center border border-zinc-500/20">
              <i class="fa-solid fa-user-shield text-coyote text-sm"></i>
          </div>
          <button
            onclick="logoutAdmin()"
              class="text-zinc-400 hover:text-red-400 transition p-2"
              title="Wyloguj"
          >
              <i class="fa-solid fa-sign-out-alt text-sm"></i>
          </button>
          </div>
        </div>

        <!-- Pasek zak≈Çadek -->
        <nav class="px-4 pb-3">
          <!-- Pierwsza linia: ZarzƒÖdzanie po lewej, status po prawej -->
          <div class="flex items-center justify-between mb-2">
            <div class="flex items-center space-x-4">
              <div class="nav-item" data-tab="dashboard">
                <i class="fa-solid fa-tachometer-alt mr-2"></i>
                Dashboard
              </div>
              <div class="nav-item" data-tab="messages">
                <i class="fa-solid fa-comments mr-2"></i>
                Wiadomo≈õci
              </div>
              <div class="nav-item" data-tab="users">
                <i class="fa-solid fa-users mr-2"></i>
                U≈ºytkownicy
              </div>
              <div class="nav-item" data-tab="newsletter">
                <i class="fa-solid fa-envelope-open mr-2"></i>
                Newsletter
              </div>
            </div>
            <div class="nav-item" data-tab="status">
              <i class="fa-solid fa-server mr-2"></i>
              <span id="status-tab-text">Status</span>
            </div>
          </div>

          <!-- Druga linia: Zak≈Çadki stron -->
          <div class="flex items-center justify-start space-x-8 overflow-x-auto scrollbar-hide" id="tabs-container">
            <div class="nav-item" data-tab="products">
              <i class="fa-solid fa-shopping-cart mr-2"></i>
              Sklep
            </div>
            <div class="nav-item" data-tab="bazar">
              <i class="fa-solid fa-store mr-2"></i>
              Bazar
            </div>
            <div class="nav-item" data-tab="szkolenia">
              <i class="fa-solid fa-graduation-cap mr-2"></i>
              Szkolenia
            </div>
            <div class="nav-item" data-tab="events">
              <i class="fa-solid fa-calendar-alt mr-2"></i>
              Wydarzenia
            </div>
            <div class="nav-item" data-tab="blog">
              <i class="fa-solid fa-blog mr-2"></i>
              Blog
            </div>
            <div class="nav-item" data-tab="charity">
              <i class="fa-solid fa-heart mr-2"></i>
              Pomoc
            </div>
            <div class="nav-item" data-tab="dokumenty">
              <i class="fa-solid fa-file-pdf mr-2"></i>
              Dokumenty
            </div>
            <div class="nav-item" data-tab="kontakt">
              <i class="fa-solid fa-address-book mr-2"></i>
              Kontakt
            </div>
          </div>
        </nav>
      </div>

      <!-- G≈Ç√≥wna zawarto≈õƒá -->
      <div class="flex flex-1 min-h-0">
        <!-- Zawarto≈õƒá g≈Ç√≥wna -->
        <div class="flex-1 p-4 md:p-8 overflow-y-auto" id="main-content">
          <!-- Status -->
          <div id="tab-status" class="tab-content">

            <!-- Sekcja System Serwera -->
          <div class="admin-card mb-8 mt-6">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold coyote-text">Monitoring us≈Çug</h2>
                <button
                  onclick="checkMainServicesStatus()"
                  class="btn-admin text-sm px-3 py-1"
                >
                  <i class="fa-solid fa-sync-alt mr-1"></i>
                  Od≈õwie≈º
                </button>
                </div>

              <!-- G≈Ç√≥wny status serwera - kompaktowy design -->
              <div class="bg-zinc-800/50 rounded-xl p-6 mb-8">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                  <!-- Status bazy danych -->
                  <div class="text-center">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                      <i class="fa-solid fa-database text-lg text-zinc-400"></i>
                      <span class="text-sm font-medium text-zinc-300"
                        >Baza danych</span
                      >
                    </div>
                    <div
                      class="flex items-center justify-center space-x-2 animate-fade-in"
                      id="firestore-status"
                    >
                <span class="text-green-400"
                        ><i class="fa-solid fa-check-circle text-lg"></i
                      ></span>
                      <span class="text-green-400 font-semibold text-sm"
                        >Online</span
                      >
                    </div>
                  </div>

                  <!-- Status logowania -->
                  <div class="text-center">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                      <i class="fa-solid fa-user-shield text-lg text-zinc-400"></i>
                      <span class="text-sm font-medium text-zinc-300"
                        >Logowanie</span
                      >
                    </div>
                    <div
                      class="flex items-center justify-center space-x-2 animate-fade-in"
                      id="auth-status"
                    >
                      <span class="text-green-400"
                        ><i class="fa-solid fa-check-circle text-lg"></i
                      ></span>
                      <span class="text-green-400 font-semibold text-sm"
                        >Po≈ÇƒÖczony</span
                      >
                    </div>
                  </div>

                  <!-- Status domeny -->
                  <div class="text-center">
                    <div class="flex items-center justify-center space-x-3 mb-2">
                      <i class="fa-solid fa-globe text-lg text-zinc-400"></i>
                      <span class="text-sm font-medium text-zinc-300"
                        >Domena</span
                      >
                    </div>
                    <div
                      class="flex items-center justify-center space-x-2 animate-fade-in"
                      id="domain-status"
                    >
                      <span class="text-green-400"
                        ><i class="fa-solid fa-check-circle text-lg"></i
                      ></span>
                      <span class="text-green-400 font-semibold text-sm"
                        >Online</span
                      >
                    </div>
                  </div>
              </div>
            </div>

            <div
                class="grid grid-cols-1 lg:grid-cols-2 gap-3"
              id="sites-status"
            >
              <!-- Status stron bƒôdzie ≈Çadowany dynamicznie -->
            </div>

            <div class="mt-4 text-sm text-zinc-400 text-center">
              <span
                >Ostatnie sprawdzenie:
                <span id="last-status-check">Teraz</span></span
              >
              </div>
            </div>

            <!-- Sekcja Zdarzenia -->
            <div class="admin-card mb-8">
              <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold coyote-text">Zdarzenia</h2>
                <div class="flex space-x-2">
                <button
                  onclick="loadEventsLog()"
                  id="refresh-events-btn"
                  class="btn-admin text-sm px-3 py-1"
                >
                  <i class="fa-solid fa-refresh mr-1"></i>
                  Od≈õwie≈º
                </button>
                  <button
                    onclick="clearAllEvents()"
                    class="btn-danger text-sm px-3 py-1"
                  >
                    <i class="fa-solid fa-trash mr-1"></i>
                    Usu≈Ñ wszystkie
                </button>
                </div>
              </div>

              <div id="events-log-container">
                <!-- Tabela zdarze≈Ñ bƒôdzie ≈Çadowana dynamicznie -->
                <div class="text-center text-zinc-400 py-4">
                  <i class="fa-solid fa-spinner fa-spin mr-2"></i>≈Åadowanie log√≥w...
                </div>
              </div>
            </div>
          </div>

        <!-- Dashboard -->
          <div id="tab-dashboard" class="tab-content active">

            <!-- Sekcja 1: Aktywno≈õƒá -->
            <div class="admin-card mb-8">

              <!-- G≈Ç√≥wny kontener z podzia≈Çem na sekcje -->
              <div
                class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-2 gap-6 mb-6 min-h-[280px]"
              >
                <!-- Lewa czƒô≈õƒá: Aktywno≈õƒá u≈ºytkownik√≥w (50% szer, 70% wys) -->
                <div
                  class="bg-zinc-800/50 rounded-lg p-4 flex flex-col justify-center"
                >
                  <h3 class="text-lg font-semibold text-white mb-4 text-center">
                    Aktywno≈õƒá
                  </h3>
                  <div class="space-y-4 flex-1 flex flex-col justify-center">
              <div class="text-center">
                <div
                        class="text-2xl font-bold coyote-text mb-1"
                        id="active-logged-users"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Zalogowani</div>
              </div>
              <div class="text-center">
                <div
                        class="text-2xl font-bold coyote-text mb-1"
                        id="active-guests"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Go≈õcie</div>
              </div>
              <div class="text-center">
                <div
                        class="text-2xl font-bold text-green-400 mb-1"
                        id="active-total"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Razem</div>
                </div>
              </div>
                </div>

                <!-- Prawa czƒô≈õƒá: Sprawy (50% szer, 70% wys) -->
                <div
                  class="bg-zinc-800/50 rounded-lg p-4 flex flex-col justify-center"
                >
                  <h3 class="text-lg font-semibold text-white mb-4 text-center">
                    Sprawy
                  </h3>
                  <div class="space-y-4 flex-1 flex flex-col justify-center">
              <div class="text-center">
                <div
                        class="text-2xl font-bold text-red-400 mb-1"
                        id="pending-issues"
                >
                  0
                </div>
                      <div class="text-sm text-zinc-400">Niezako≈Ñczone</div>
                    </div>
                    <div class="text-center">
                      <div
                        class="text-2xl font-bold text-green-400 mb-1"
                        id="new-forms-today"
                      >
                        0
                      </div>
                      <div class="text-sm text-zinc-400">Nowe formularze</div>
                    </div>
                    <div class="text-center">
                      <div
                        class="text-2xl font-bold text-blue-400 mb-1"
                        id="total-issues"
                      >
                        0
                      </div>
                      <div class="text-sm text-zinc-400">Razem</div>
                    </div>
                  </div>
              </div>
            </div>

              <!-- Dolna czƒô≈õƒá: Odwiedziny (100% szer, 30% wys) -->
              <div class="bg-zinc-800/50 rounded-lg p-4 min-h-[120px]">
                <h3 class="text-lg font-semibold text-white mb-4 text-center">
                  Odwiedziny
                </h3>
                <div
                  class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 h-full"
                >
              <div class="text-center">
                <div
                  class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-today"
                >
                  0
                </div>
                    <div class="text-xs text-zinc-400">Dzi≈õ</div>
              </div>
              <div class="text-center">
                <div
                  class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-week"
                >
                  0
                </div>
                    <div class="text-xs text-zinc-400">Tydzie≈Ñ</div>
              </div>
              <div class="text-center">
                <div
                  class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-month"
                >
                  0
                </div>
                    <div class="text-xs text-zinc-400">MiesiƒÖc</div>
              </div>
                  <div class="text-center">
                    <div
                      class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-year"
                    >
                      0
                    </div>
                    <div class="text-xs text-zinc-400">Rok</div>
                  </div>
                  <div class="text-center">
                    <div
                      class="text-xl font-bold text-blue-400 mb-1"
                      id="visits-total"
                    >
                      0
                    </div>
                    <div class="text-xs text-zinc-400">Og√≥≈Çem</div>
                  </div>
            </div>
          </div>

            </div>
        </div>

        <!-- ZarzƒÖdzanie u≈ºytkownikami -->
        <div id="tab-users" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              ZarzƒÖdzanie U≈ºytkownikami
            </h1>
              <button
                onclick="refreshUsers()"
                class="btn-admin text-sm px-3 py-2"
              >
              <i class="fa-solid fa-sync-alt mr-1"></i>
              Od≈õwie≈º
            </button>
          </div>

          <!-- Sekcja najnowszych u≈ºytkownik√≥w -->
          <div class="admin-card mb-8">
            <h3 class="text-xl font-bold mb-4">Najnowsi u≈ºytkownicy</h3>
            <div id="recent-users" class="space-y-3">
              <!-- Najnowsi u≈ºytkownicy bƒôdƒÖ ≈Çadowani dynamicznie -->
            </div>
          </div>

          <div class="admin-card mb-6">
            <div class="flex flex-wrap gap-4 mb-4">
              <button
                onclick="filterUsers('all')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase active border-coyote text-coyote"
                data-filter="all"
              >
                Wszyscy
              </button>
              <button
                onclick="filterUsers('active')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="active"
              >
                Aktywni
              </button>
              <button
                  onclick="filterUsers('inactive')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                  data-filter="inactive"
              >
                  Nieaktywni
              </button>
              <button
                  onclick="filterUsers('blocked')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                  data-filter="blocked"
              >
                  Zablokowani
              </button>
              <button
                onclick="filterUsers('company')"
                class="user-filter-btn px-4 py-2 border border-zinc-700 rounded text-sm uppercase"
                data-filter="company"
              >
                Firmy
              </button>
            </div>

              <div class="mb-4">
                <input
                  type="text"
                  id="user-search"
                  placeholder="Szukaj u≈ºytkownik√≥w..."
                  class="w-full"
                />
              </div>

              <div id="users-list" class="space-y-3">
                <!-- Lista u≈ºytkownik√≥w bƒôdzie ≈Çadowana dynamicznie -->
              </div>

              <div id="users-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie u≈ºytkownik√≥w...</p>
              </div>

              <div
                id="users-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i class="fa-solid fa-users text-4xl mb-4 text-zinc-600"></i>
                <p>Brak u≈ºytkownik√≥w do wy≈õwietlenia</p>
            </div>
          </div>
        </div>

        <!-- ZarzƒÖdzanie produktami -->
        <div id="tab-products" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              ZarzƒÖdzanie Produktami
            </h1>
            <button onclick="refreshProducts()" class="btn-admin">
              <i class="fa-solid fa-sync-alt mr-2"></i>
              Od≈õwie≈º
            </button>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Dodaj/Edytuj Produkt</h3>
              <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id" />
                <input
                  type="text"
                  id="product-title"
                  placeholder="Nazwa produktu"
                  required
                />
                <input
                  type="text"
                  id="product-price"
                  placeholder="Cena (np. 299.99)"
                  required
                />

                <div class="toolbar">
                  <button type="button" onclick="formatText('bold')">
                    <i class="fa-solid fa-bold"></i>
                  </button>
                  <button
                    type="button"
                    onclick="formatText('insertUnorderedList')"
                  >
                    <i class="fa-solid fa-list-ul"></i>
                  </button>
                  <button type="button" onclick="formatText('justifyCenter')">
                    <i class="fa-solid fa-align-center"></i>
                  </button>
                  <button type="button" onclick="insertImage()">
                    <i class="fa-solid fa-image"></i>
                  </button>
                </div>

                <div
                  id="product-description"
                  class="editor-content"
                  contenteditable="true"
                  placeholder="Opis produktu..."
                ></div>

                  <div class="flex space-x-4">
                    <button type="submit" class="btn-admin flex-1">
                  <i class="fa-solid fa-save mr-2"></i>
                  Zapisz produkt
                </button>
                    <button
                      type="button"
                      onclick="clearProductForm()"
                      class="btn-admin flex-1"
                    >
                      <i class="fa-solid fa-plus mr-2"></i>
                      Nowy produkt
                    </button>
                  </div>
              </form>
            </div>

            <div class="admin-card">
              <h3 class="text-xl font-bold mb-4">Lista Produkt√≥w</h3>
                <div id="products-list" class="space-y-4">
                  <!-- Produkty bƒôdƒÖ ≈Çadowane dynamicznie -->
                </div>

                <div id="products-loading" class="text-center py-8 text-zinc-400">
                  <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                  <p>≈Åadowanie produkt√≥w...</p>
                </div>

                <div
                  id="products-empty"
                  class="text-center py-8 text-zinc-400 hidden"
                >
                  <i class="fa-solid fa-shopping-cart text-4xl mb-4 text-zinc-600"></i>
                  <p>Brak produkt√≥w do wy≈õwietlenia</p>
              </div>
            </div>
          </div>
        </div>

          <!-- Czat -->
        <div id="tab-messages" class="tab-content">
          <div class="flex justify-between items-center mb-8">
            <h1 class="text-3xl font-bold coyote-text">
              Czat
            </h1>
            <div class="flex space-x-3">
              <button onclick="startNewChat()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Nowy czat
              </button>
              <button onclick="loadMessages()" class="btn-admin" id="refresh-messages-btn">
                <i class="fa-solid fa-sync-alt mr-2"></i>
                <span id="refresh-text">Od≈õwie≈º</span>
              </button>
              <button onclick="console.log('Test loadMessages'); loadMessages()" class="btn-secondary text-sm px-3 py-2">
                üîß Test
            </button>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-250px)] min-h-[500px]">
                <!-- Lista konwersacji -->
            <div class="lg:col-span-1">
              <div class="admin-card h-full overflow-hidden">
                <div class="p-4 border-b border-zinc-700">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">Konwersacje</h3>
                    <span id="conversations-count" class="text-sm text-zinc-400">0</span>
            </div>
                  <div class="flex space-x-2 mb-3">
                      <input
                        type="text"
                      id="chat-search"
                    placeholder="Szukaj konwersacji..."
                      class="flex-1 bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white placeholder-zinc-400 text-sm focus:outline-none focus:ring-2 focus:ring-coyote"
                    >
                    <button onclick="filterConversations()" class="btn-admin text-sm px-3 py-2">
                      <i class="fa-solid fa-search"></i>
                    </button>
              </div>
                </div>
                <div class="overflow-y-auto h-[calc(100%-120px)]">
                  <div id="conversations-list" class="space-y-1">
                    <!-- Konwersacje bƒôdƒÖ ≈Çadowane dynamicznie -->
                    <div class="text-center text-zinc-500 py-8">
                      <i class="fa-solid fa-spinner fa-spin text-xl mb-3 text-zinc-600"></i>
                      <p class="text-sm">≈Åadowanie czat√≥w...</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Okno czatu -->
            <div class="lg:col-span-2">
              <div id="chat-window" class="admin-card h-full flex flex-col">
                <!-- Nag≈Ç√≥wek czatu -->
                <div id="chat-header" class="p-4 border-b border-zinc-700 hidden">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                      <div class="w-10 h-10 bg-coyote rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-user text-black text-sm"></i>
                      </div>
                  <div>
                        <h4 id="chat-user-name-header" class="font-semibold text-white"></h4>
                        <p id="chat-user-status" class="text-sm text-zinc-400">Aktywny</p>
                      </div>
              </div>
                  <div class="flex space-x-2">
                      <button onclick="closeCurrentChat()" class="text-zinc-400 hover:text-white transition-colors p-2">
                        <i class="fa-solid fa-times"></i>
                      </button>
                  </div>
                </div>
                  </div>

                <!-- Wiadomo≈õci -->
                <div id="chat-messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 hidden">
                <!-- Wiadomo≈õci bƒôdƒÖ ≈Çadowane dynamicznie -->
                  <div class="text-center text-zinc-500 py-12">
                    <i class="fa-solid fa-comments text-4xl mb-4 text-zinc-600"></i>
                    <h3 class="text-lg font-semibold mb-2">Wybierz konwersacjƒô</h3>
                    <p class="text-sm">Kliknij na czat z listy, aby rozpoczƒÖƒá rozmowƒô</p>
                  </div>
              </div>

                <!-- Pole do pisania -->
                <div id="chat-input-container" class="p-4 border-t border-zinc-700 hidden">
                  <div class="flex space-x-3">
                    <textarea
                      id="chat-reply-input"
                  placeholder="Wpisz wiadomo≈õƒá..."
                      class="flex-1 bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-coyote resize-none"
                      rows="2"
                    ></textarea>
                      <button
                      onclick="sendChatReply()"
                      id="send-message-btn"
                      class="btn-admin px-4 py-2 h-auto self-end disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                  <i class="fa-solid fa-paper-plane"></i>
                      </button>
                    </div>
                  <p class="text-xs text-zinc-500 mt-2">Naci≈õnij Enter, aby wys≈Çaƒá ‚Ä¢ Shift+Enter dla nowej linii</p>
                      </div>
                    </div>
                  </div>
                  </div>

          <!-- Modal czatu -->
          <div id="chat-modal" class="fixed inset-0 bg-black/80 hidden z-50">
            <div class="flex items-center justify-center min-h-screen p-4">
              <div class="bg-zinc-900 rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
                <!-- Nag≈Ç√≥wek czatu -->
                <div class="flex items-center justify-between p-4 border-b border-zinc-700">
                  <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-coyote rounded-full flex items-center justify-center">
                      <i class="fa-solid fa-user text-black text-sm"></i>
                  </div>
                  <div>
                      <h3 id="chat-user-name" class="font-semibold text-white"></h3>
                      <p id="chat-user-email" class="text-sm text-zinc-400"></p>
                </div>
                  </div>
                  <button onclick="closeChatModal()" class="text-zinc-400 hover:text-white transition-colors">
                    <i class="fa-solid fa-times text-xl"></i>
                    </button>
                </div>

                <!-- Wiadomo≈õci -->
                <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
                <!-- Wiadomo≈õci bƒôdƒÖ ≈Çadowane dynamicznie -->
              </div>

                <!-- Pole do odpowiedzi -->
                <div class="p-4 border-t border-zinc-700">
                  <div class="flex space-x-3">
                    <textarea
                      id="chat-reply-input"
                      placeholder="Wpisz swojƒÖ odpowied≈∫..."
                      class="flex-1 bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-coyote resize-none"
                      rows="3"
                    ></textarea>
                    <button
                      onclick="sendChatReply()"
                      class="btn-admin px-6 py-2 h-auto self-end"
                    >
                      <i class="fa-solid fa-paper-plane mr-2"></i>
                      Wy≈õlij
                    </button>
                  </div>
              </div>
            </div>
          </div>
          </div>
        </div>

        <!-- Wydarzenia -->
        <div id="tab-events" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
            ZarzƒÖdzanie Wydarzeniami
          </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                ZarzƒÖdzaj wydarzeniami na stronie. Dodawaj nowe wydarzenia z datƒÖ
                i godzinƒÖ, pozycjonuj je i przypinaj wa≈ºne.
              </p>
              <button onclick="addNewEvent()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj wydarzenie
              </button>
            </div>

            <!-- Filtry wydarze≈Ñ -->
            <div class="admin-card mb-8">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Status</label>
                  <select id="events-status-filter" class="w-full">
                    <option value="all">Wszystkie</option>
                    <option value="upcoming">NadchodzƒÖce</option>
                    <option value="past">Przesz≈Çe</option>
                    <option value="pinned">Przypiƒôte</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Kategoria</label>
                  <select id="events-category-filter" class="w-full">
                    <option value="all">Wszystkie kategorie</option>
                    <option value="training">Szkolenia</option>
                    <option value="meeting">Spotkania</option>
                    <option value="competition">Zawody</option>
                    <option value="other">Inne</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Sortowanie</label>
                  <select id="events-sort-filter" class="w-full">
                    <option value="date-asc">Data ‚Üë</option>
                    <option value="date-desc">Data ‚Üì</option>
                    <option value="title">Tytu≈Ç</option>
                    <option value="pinned">Przypiƒôte pierwsze</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button onclick="applyEventsFilters()" class="btn-admin w-full">
                    <i class="fa-solid fa-filter mr-2"></i>
                    Filtruj
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista wydarze≈Ñ -->
          <div class="admin-card">
            <div id="events-list" class="space-y-4">
                <!-- Wydarzenia bƒôdƒÖ ≈Çadowane dynamicznie -->
            </div>

              <div id="events-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie wydarze≈Ñ...</p>
              </div>

              <div
                id="events-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i
                  class="fa-solid fa-calendar-alt text-4xl mb-4 text-zinc-600"
                ></i>
                <p>Brak wydarze≈Ñ do wy≈õwietlenia</p>
              </div>
            </div>

            <!-- Statystyki wydarze≈Ñ -->
            <div class="admin-card mt-6">
              <h3 class="text-xl font-bold mb-6">Statystyki Wydarze≈Ñ</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div class="text-2xl font-bold coyote-text" id="total-events">
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem wydarze≈Ñ</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="upcoming-events"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">NadchodzƒÖcych</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400" id="past-events">
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Przesz≈Çych</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="pinned-events"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Przypiƒôtych</div>
                </div>
              </div>
          </div>
        </div>

        <!-- Pomoc Charytatywna -->
        <div id="tab-charity" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie PomocƒÖ CharytatywnƒÖ
          </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                ZarzƒÖdzaj akcjami charytatywnymi. Dodawaj zdjƒôcia, linki,
                przyciski i tre≈õci w dowolny spos√≥b.
              </p>
              <button onclick="addNewCharityAction()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj akcjƒô
              </button>
            </div>

            <!-- Lista akcji charytatywnych -->
          <div class="admin-card">
              <div id="charity-actions-list" class="space-y-4">
                <!-- Akcje bƒôdƒÖ ≈Çadowane dynamicznie -->
            </div>

              <div id="charity-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie akcji...</p>
              </div>

              <div
                id="charity-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i class="fa-solid fa-heart text-4xl mb-4 text-zinc-600"></i>
                <p>Brak akcji charytatywnych</p>
          </div>
        </div>

            <!-- Statystyki pomocy -->
            <div class="admin-card mt-6">
              <h3 class="text-xl font-bold mb-6">Statystyki Pomocy</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div
                    class="text-2xl font-bold coyote-text"
                    id="total-charity-actions"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem akcji</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="active-charity-actions"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Aktywnych</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-blue-400"
                    id="total-donations"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Zebranych ≈õrodk√≥w</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="charity-views"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Wy≈õwietle≈Ñ</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Newsletter -->
          <div id="tab-newsletter" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie Newsletter'em
          </h1>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Edytor newsletter'a -->
          <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Edytor Newsletter'a</h3>

                <div class="space-y-4">
                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Temat wiadomo≈õci</label
                    >
                    <input
                      type="text"
                      id="newsletter-subject"
                      placeholder="Wprowad≈∫ temat newsletter'a..."
                      class="w-full"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Tre≈õƒá wiadomo≈õci</label
                    >
                    <div class="toolbar mb-2">
                      <button onclick="formatText('bold')" title="Pogrubienie">
                        <i class="fa-solid fa-bold"></i>
                      </button>
                      <button onclick="formatText('italic')" title="Kursywa">
                        <i class="fa-solid fa-italic"></i>
                      </button>
                      <button onclick="formatText('underline')" title="Podkre≈õlenie">
                        <i class="fa-solid fa-underline"></i>
                      </button>
                      <button onclick="insertLink()" title="Wstaw link">
                        <i class="fa-solid fa-link"></i>
                      </button>
                      <button onclick="insertImage()" title="Wstaw obraz">
                        <i class="fa-solid fa-image"></i>
                      </button>
                    </div>
                    <div
                      id="newsletter-editor"
                      class="editor-content min-h-[300px]"
                      contenteditable="true"
                      placeholder="Wpisz tre≈õƒá newsletter'a..."
                    ></div>
                  </div>

                  <div class="flex space-x-4">
                    <button
                      onclick="previewNewsletter()"
                      class="btn-admin flex-1"
                    >
                      <i class="fa-solid fa-eye mr-2"></i>
                      PodglƒÖd
                    </button>
                    <button
                      onclick="saveNewsletterDraft()"
                      class="btn-admin flex-1"
                    >
                      <i class="fa-solid fa-save mr-2"></i>
                      Zapisz wersjƒô roboczƒÖ
                    </button>
                  </div>
                </div>
              </div>

              <!-- Lista subskrybent√≥w -->
              <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Subskrybenci Newsletter'a</h3>

                <div class="mb-4">
                  <input
                    type="text"
                    id="newsletter-search"
                    placeholder="Szukaj subskrybent√≥w..."
                    class="w-full mb-4"
                  />
                </div>

                <div
                  id="newsletter-subscribers"
                  class="space-y-3 max-h-[400px] overflow-y-auto"
                >
                  <!-- Lista subskrybent√≥w bƒôdzie ≈Çadowana dynamicznie -->
                </div>

                <div class="mt-6 pt-4 border-t border-zinc-700">
                  <div
                    class="flex justify-between items-center text-sm text-zinc-400"
                  >
                    <span>≈ÅƒÖcznie subskrybent√≥w:</span>
                    <span id="subscribers-count">0</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Przyciski akcji -->
            <div class="mt-8 flex justify-center space-x-4">
              <button onclick="sendNewsletter()" class="btn-admin px-8 py-3">
                <i class="fa-solid fa-paper-plane mr-2"></i>
                Wy≈õlij Newsletter
              </button>
              <button onclick="exportNewsletter()" class="btn-admin px-8 py-3">
                <i class="fa-solid fa-download mr-2"></i>
                Eksportuj do Email
              </button>
            </div>
          </div>

          <!-- Bazar -->
          <div id="tab-bazar" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie Bazarem
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                ZarzƒÖdzaj ofertami na bazarze. Zatwierdzaj nowe oferty i moderuj
                istniejƒÖce.
              </p>
              <button onclick="refreshBazar()" class="btn-admin">
                <i class="fa-solid fa-sync-alt mr-2"></i>
                Od≈õwie≈º
              </button>
            </div>

            <!-- Filtry i wyszukiwanie -->
            <div class="admin-card mb-8">
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2"
                    >Status oferty</label
                  >
                  <select id="bazar-status-filter" class="w-full">
                  <option value="all">Wszystkie</option>
                  <option value="pending">OczekujƒÖce</option>
                  <option value="approved">Zatwierdzone</option>
                  <option value="rejected">Odrzucone</option>
                </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Kategoria</label>
                  <select id="bazar-category-filter" class="w-full">
                    <option value="all">Wszystkie kategorie</option>
                    <option value="elektronika">Elektronika</option>
                    <option value="odziez">Odzie≈º</option>
                    <option value="motoryzacja">Motoryzacja</option>
                    <option value="dom">Dom i ogr√≥d</option>
                    <option value="inne">Inne</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Szukaj</label>
                  <input
                    type="text"
                    id="bazar-search"
                    placeholder="Tytu≈Ç oferty..."
                    class="w-full"
                  />
                </div>
                <div class="flex items-end">
                  <button onclick="applyBazarFilters()" class="btn-admin w-full">
                    <i class="fa-solid fa-filter mr-2"></i>
                    Filtruj
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista ofert -->
            <div class="admin-card">
              <div id="bazar-offers-list" class="space-y-4">
                <!-- Oferty bƒôdƒÖ ≈Çadowane dynamicznie -->
            </div>

              <div id="bazar-loading" class="text-center py-8 text-zinc-400">
              <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie ofert...</p>
              </div>

              <div id="bazar-empty" class="text-center py-8 text-zinc-400 hidden">
                <i class="fa-solid fa-store text-4xl mb-4 text-zinc-600"></i>
                <p>Brak ofert do wy≈õwietlenia</p>
              </div>
            </div>
          </div>

          <!-- Szkolenia -->
          <div id="tab-szkolenia" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie Szkolenia
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                ZarzƒÖdzaj szkoleniami. Dodawaj nowe szkolenia, edytuj istniejƒÖce i
                kontroluj dostƒôpno≈õƒá.
              </p>
              <button onclick="addNewTraining()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj szkolenie
              </button>
            </div>

            <!-- Lista szkole≈Ñ -->
            <div class="admin-card">
              <div id="trainings-list" class="space-y-4">
                <!-- Szkolenia bƒôdƒÖ ≈Çadowane dynamicznie -->
              </div>

              <div id="trainings-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie szkole≈Ñ...</p>
            </div>

            <div
                id="trainings-empty"
              class="text-center py-8 text-zinc-400 hidden"
            >
                <i
                  class="fa-solid fa-graduation-cap text-4xl mb-4 text-zinc-600"
                ></i>
                <p>Brak szkole≈Ñ do wy≈õwietlenia</p>
            </div>
          </div>
        </div>

          <!-- Blog -->
          <div id="tab-blog" class="tab-content">
          <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie Blogiem
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                ZarzƒÖdzaj wpisami na blogu. Dodawaj nowe artyku≈Çy, moderuj
                komentarze i pozycjonuj tre≈õci.
              </p>
              <button onclick="addNewBlogPost()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj wpis
              </button>
            </div>

            <!-- Filtry -->
            <div class="admin-card mb-8">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Status</label>
                  <select id="blog-status-filter" class="w-full">
                    <option value="all">Wszystkie</option>
                    <option value="published">Opublikowane</option>
                    <option value="draft">Szkice</option>
                    <option value="archived">Zarchiwizowane</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Kategoria</label>
                  <select id="blog-category-filter" class="w-full">
                    <option value="all">Wszystkie kategorie</option>
                    <option value="news">Aktualno≈õci</option>
                    <option value="tips">Porady</option>
                    <option value="tutorials">Poradniki</option>
                    <option value="reviews">Recenzje</option>
                  </select>
                </div>
                <div class="flex items-end">
                  <button onclick="applyBlogFilters()" class="btn-admin w-full">
                    <i class="fa-solid fa-filter mr-2"></i>
                    Filtruj
                  </button>
                </div>
              </div>
            </div>

            <!-- Lista wpis√≥w -->
            <div class="admin-card">
              <div id="blog-posts-list" class="space-y-4">
                <!-- Wpisy bƒôdƒÖ ≈Çadowane dynamicznie -->
              </div>

              <div id="blog-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie wpis√≥w...</p>
              </div>

              <div id="blog-empty" class="text-center py-8 text-zinc-400 hidden">
                <i class="fa-solid fa-blog text-4xl mb-4 text-zinc-600"></i>
                <p>Brak wpis√≥w do wy≈õwietlenia</p>
              </div>
            </div>
          </div>

          <!-- Dokumenty -->
          <div id="tab-dokumenty" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie Dokumentami
            </h1>

            <div class="flex justify-between items-center mb-8">
              <p class="text-zinc-400">
                ZarzƒÖdzaj dokumentami PDF. Dodawaj nowe pliki, organizuj kategorie
                i kontroluj dostƒôpno≈õƒá.
              </p>
              <button onclick="addNewDocument()" class="btn-admin">
                <i class="fa-solid fa-plus mr-2"></i>
                Dodaj dokument
              </button>
            </div>

            <!-- Lista dokument√≥w -->
            <div class="admin-card">
              <div id="documents-list" class="space-y-4">
                <!-- Dokumenty bƒôdƒÖ ≈Çadowane dynamicznie -->
              </div>

              <div id="documents-loading" class="text-center py-8 text-zinc-400">
                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                <p>≈Åadowanie dokument√≥w...</p>
              </div>

              <div
                id="documents-empty"
                class="text-center py-8 text-zinc-400 hidden"
              >
                <i class="fa-solid fa-file-pdf text-4xl mb-4 text-zinc-600"></i>
                <p>Brak dokument√≥w do wy≈õwietlenia</p>
              </div>
            </div>
          </div>

          <!-- Kontakt -->
          <div id="tab-kontakt" class="tab-content">
            <h1 class="text-3xl font-bold coyote-text mb-8">
              ZarzƒÖdzanie Formularzem Kontaktowym
          </h1>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Ustawienia formularza -->
            <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Ustawienia Formularza</h3>

                <div class="space-y-6">
                  <div>
                    <label class="flex items-center space-x-3 cursor-pointer">
                <input
                        type="checkbox"
                        id="contact-form-enabled"
                        checked
                        class="w-4 h-4"
                      />
                      <span class="text-sm font-medium">Formularz w≈ÇƒÖczony</span>
                    </label>
                    <p class="text-xs text-zinc-500 mt-1">
                      Wy≈ÇƒÖcz, aby ukryƒá formularz kontaktowy na stronie
                    </p>
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Email odbiorcy</label
                    >
                    <input
                      type="email"
                      id="contact-recipient-email"
                      placeholder="admin@strzelca.pl"
                      class="w-full"
                    />
                  </div>

                  <div>
                    <label class="block text-sm font-medium mb-2"
                      >Temat powiadomie≈Ñ</label
                    >
                <input
                  type="text"
                      id="contact-notification-subject"
                      placeholder="Nowa wiadomo≈õƒá z formularza kontaktowego"
                      class="w-full"
                    />
                  </div>
                </div>
            </div>

              <!-- ZarzƒÖdzanie tematami -->
            <div class="admin-card">
                <h3 class="text-xl font-bold mb-6">Tematy Rozm√≥w</h3>

                <div class="space-y-4">
                  <div class="flex space-x-2">
                <input
                  type="text"
                      id="new-contact-topic"
                      placeholder="Nowy temat rozmowy..."
                  class="flex-1"
                />
                    <button onclick="addContactTopic()" class="btn-admin px-4">
                  <i class="fa-solid fa-plus"></i>
                </button>
              </div>

                  <div
                    id="contact-topics-list"
                    class="space-y-2 max-h-[300px] overflow-y-auto"
                  >
                    <!-- Tematy bƒôdƒÖ ≈Çadowane dynamicznie -->
              </div>
            </div>
          </div>
        </div>

            <!-- Statystyki wiadomo≈õci -->
            <div class="admin-card mt-8">
              <h3 class="text-xl font-bold mb-6">Statystyki Wiadomo≈õci</h3>

              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <div
                    class="text-2xl font-bold coyote-text"
                    id="contact-total-messages"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Razem wiadomo≈õci</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-green-400"
                    id="contact-unread-messages"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">Nieuzytane</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-blue-400"
                    id="contact-this-week"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">W tym tygodniu</div>
                </div>
                <div class="text-center">
                  <div
                    class="text-2xl font-bold text-yellow-400"
                    id="contact-pending-replies"
                  >
                    0
                  </div>
                  <div class="text-sm text-zinc-400">OczekujƒÖce na odpowied≈∫</div>
                </div>
      </div>
    </div>

            <!-- Przyciski akcji -->
            <div class="mt-8 flex justify-center">
              <button onclick="saveContactSettings()" class="btn-admin px-8 py-3">
                <i class="fa-solid fa-save mr-2"></i>
                Zapisz ustawienia
              </button>
            </div>
          </div>
        </div>
      </div>

    <div
      id="user-details-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold coyote-text">Szczeg√≥≈Çy U≈ºytkownika</h2>
          <div class="flex space-x-2">
            <button
              onclick="editUserDetails()"
              class="btn-admin text-sm px-3 py-1"
            >
              <i class="fa-solid fa-edit mr-1"></i>
              Edytuj
            </button>
          <button
            onclick="closeUserDetails()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>
        </div>

        <!-- Tabs -->
        <div class="mb-6">
          <div class="flex space-x-1 bg-zinc-800 p-1 rounded-lg">
            <button
              onclick="switchUserTab('details')"
              class="user-tab-btn active px-4 py-2 text-sm rounded"
              data-tab="details"
            >
              Szczeg√≥≈Çy
            </button>
            <button
              onclick="switchUserTab('activity')"
              class="user-tab-btn px-4 py-2 text-sm rounded"
              data-tab="activity"
            >
              Aktywno≈õƒá
            </button>
          </div>
        </div>

        <div id="user-details-content">
          <!-- Szczeg√≥≈Çy u≈ºytkownika bƒôdƒÖ ≈Çadowane dynamicznie -->
        </div>
      </div>
    </div>

    <!-- Modal edycji u≈ºytkownika -->
    <div
      id="user-edit-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold coyote-text">Edycja U≈ºytkownika</h2>
          <button
            onclick="closeUserEdit()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <form id="user-edit-form" class="space-y-6">
          <!-- Dane podstawowe -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-bold mb-4">Dane podstawowe</h3>
              <div class="space-y-4">
                <input type="hidden" id="edit-user-id" />
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Nazwa wy≈õwietlana</label
                  >
                  <input
                    type="text"
                    id="edit-display-name"
                    placeholder="Nazwa wy≈õwietlana"
                    required
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Email</label>
                  <input
                    type="email"
                    id="edit-email"
                    placeholder="Email"
                    required
                    disabled
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Imiƒô</label>
                  <input type="text" id="edit-first-name" placeholder="Imiƒô" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Nazwisko</label
                  >
                  <input
                    type="text"
                    id="edit-last-name"
                    placeholder="Nazwisko"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Telefon</label
                  >
                  <input type="tel" id="edit-phone" placeholder="Telefon" />
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-4">Adres dostawy</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Ulica</label>
                  <input type="text" id="edit-street" placeholder="Ulica" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Numer budynku</label
                  >
                  <input
                    type="text"
                    id="edit-building-number"
                    placeholder="Numer budynku"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Kod pocztowy</label
                  >
                  <input
                    type="text"
                    id="edit-postal-code"
                    placeholder="Kod pocztowy"
                  />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Miasto</label>
                  <input type="text" id="edit-city" placeholder="Miasto" />
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2"
                    >Paczkomat</label
                  >
                  <input
                    type="text"
                    id="edit-parcel-locker"
                    placeholder="Paczkomat"
                  />
                </div>
              </div>
            </div>
          </div>

          <!-- Preferencje i status -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h3 class="text-lg font-bold mb-4">Preferencje</h3>
              <div class="space-y-4">
                <div class="flex items-center space-x-3">
                  <input type="checkbox" id="edit-newsletter" />
                  <label for="edit-newsletter" class="text-sm"
                    >Newsletter</label
                  >
                </div>
              </div>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-4">Status konta</h3>
              <div class="space-y-4">
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Rola</label>
                  <select id="edit-role" class="w-full">
                    <option value="user">U≈ºytkownik</option>
                    <option value="company">Firma</option>
                    <option value="admin">Administrator</option>
                  </select>
                </div>
                <div>
                  <label class="text-sm text-zinc-400 block mb-2">Status</label>
                  <select id="edit-status" class="w-full">
                    <option value="active">Aktywny</option>
                    <option value="blocked">Zablokowany</option>
                    <option value="suspended">Zawieszony</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

          <!-- Przyciski -->
          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserEdit()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin">
              <i class="fa-solid fa-save mr-2"></i>
              Zapisz zmiany
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal blokowania u≈ºytkownika -->
    <div
      id="user-block-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">
            Blokowanie U≈ºytkownika
          </h2>
          <button
            onclick="closeUserBlock()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="block-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o u≈ºytkowniku bƒôdƒÖ ≈Çadowane dynamicznie -->
        </div>

        <form id="user-block-form" class="space-y-6">
          <input type="hidden" id="block-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-2">Czas blokady</label>
            <select id="block-duration" class="w-full" required>
              <option value="15min">15 minut</option>
              <option value="1hour">1 godzina</option>
              <option value="6hours">6 godzin</option>
              <option value="24hours">24 godziny</option>
              <option value="7days">7 dni</option>
              <option value="30days">30 dni</option>
              <option value="permanent">Na zawsze (blokada permanentna)</option>
            </select>
          </div>

          <div>
            <label class="text-sm text-zinc-400 block mb-4"
              >Opcje zawarto≈õci konta</label
            >
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="keep-content"
                  name="content-action"
                  value="keep"
                  checked
                />
                <label for="keep-content" class="text-sm"
                  >Zachowaj zawarto≈õƒá konta (produkty, czaty, itp.)</label
                >
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="remove-content"
                  name="content-action"
                  value="remove"
                />
                <label for="remove-content" class="text-sm"
                  >Usu≈Ñ zawarto≈õƒá konta (produkty, czaty, itp.)</label
                >
              </div>
            </div>
          </div>

          <div class="p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-bold mb-2">‚ö†Ô∏è Ostrze≈ºenie</h4>
            <p class="text-sm text-zinc-300">
              Blokada konta oznacza ca≈Çkowite "u≈õmiercenie" konta - brak
              mo≈ºliwo≈õci korzystania ze strony, pisania na czatach, odczytywania
              czat√≥w, dodawania/edycji produkt√≥w na bazarze itp. Bez mo≈ºliwo≈õci
              odblokowania przez email.
            </p>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserBlock()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-red-600 hover:bg-red-500">
              <i class="fa-solid fa-ban mr-2"></i>
              Zablokuj u≈ºytkownika
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal usuwania u≈ºytkownika -->
    <div
      id="user-delete-modal"
      class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl"
    >
      <div class="admin-card max-w-2xl w-full">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-red-400">Usuwanie U≈ºytkownika</h2>
          <button
            onclick="closeUserDelete()"
            class="text-zinc-400 hover:text-white"
          >
            <i class="fa-solid fa-times text-xl"></i>
          </button>
        </div>

        <div id="delete-user-info" class="mb-6 p-4 bg-zinc-800 rounded-lg">
          <!-- Informacje o u≈ºytkowniku bƒôdƒÖ ≈Çadowane dynamicznie -->
        </div>

        <form id="user-delete-form" class="space-y-6">
          <input type="hidden" id="delete-user-id" />

          <div>
            <label class="text-sm text-zinc-400 block mb-4"
              >Opcje zawarto≈õci konta</label
            >
            <div class="space-y-3">
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="delete-keep-content"
                  name="delete-content-action"
                  value="keep"
                  checked
                />
                <label for="delete-keep-content" class="text-sm"
                  >Zachowaj zawarto≈õƒá konta (produkty, czaty, komentarze)</label
                >
              </div>
              <div class="flex items-center space-x-3">
                <input
                  type="radio"
                  id="delete-remove-content"
                  name="delete-content-action"
                  value="remove"
                />
                <label for="delete-remove-content" class="text-sm"
                  >Ca≈Çkowicie usu≈Ñ zawarto≈õƒá konta</label
                >
              </div>
            </div>
          </div>

          <div class="p-4 bg-red-900/20 border border-red-700 rounded-lg">
            <h4 class="text-red-400 font-bold mb-2">‚ö†Ô∏è Ostrze≈ºenie</h4>
            <p class="text-sm text-zinc-300 mb-2">
              Usuniƒôcie konta jest operacjƒÖ nieodwracalnƒÖ. U≈ºytkownik zostanie
              ca≈Çkowicie usuniƒôty z systemu.
            </p>
            <p class="text-sm text-zinc-300">
              Je≈õli wybierzesz "Zachowaj zawarto≈õƒá", produkty, wiadomo≈õci i inne
              dane u≈ºytkownika pozostanƒÖ w systemie, ale bƒôdƒÖ oznaczone jako "od
              usuniƒôtego u≈ºytkownika".
            </p>
          </div>

          <div
            class="flex items-center space-x-3 p-4 bg-yellow-900/20 border border-yellow-700 rounded-lg"
          >
            <input type="checkbox" id="delete-confirm" required />
            <label for="delete-confirm" class="text-sm">
              Potwierdzam, ≈ºe chcƒô ca≈Çkowicie usunƒÖƒá tego u≈ºytkownika z systemu
            </label>
          </div>

          <div class="flex justify-end space-x-4 pt-6 border-t border-zinc-700">
            <button
              type="button"
              onclick="closeUserDelete()"
              class="px-6 py-2 border border-zinc-600 rounded-lg hover:bg-zinc-700 transition"
            >
              Anuluj
            </button>
            <button type="submit" class="btn-admin bg-red-600 hover:bg-red-500">
              <i class="fa-solid fa-trash mr-2"></i>
              Usu≈Ñ u≈ºytkownika
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Session Manager -->
    <script src="../session-manager.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        getDocs,
        collection,
        query,
        orderBy,
        updateDoc,
        deleteDoc,
        setDoc,
        where,
        limit,
        addDoc,
        onSnapshot,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD_gXFh3a4NW9Hzzsr5IQuDADM2GVpPMVc",
        authDomain: "strzelca-pl.firebaseapp.com",
        projectId: "strzelca-pl",
        storageBucket: "strzelca-pl.firebasestorage.app",
        messagingSenderId: "511362047688",
        appId: "1:511362047688:web:9b82c0a4d19c1a3a878ffd",
        measurementId: "G-9EJ2R3JPVD",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      let currentUser = null;
      let currentTab = "dashboard";
      let currentUserFilter = "all";
      let usersList = [];
      let productsList = [];
      let currentConversationId = null;
      let pendingTasksListener = null;
      let activityLogsListener = null;
      let conversationsAutoRefreshInterval = null;

      // Local admin credentials are now stored securely in the database
      // Authentication is handled via /api/admin/verify endpoint

      // Bezpieczna funkcja hashowania u≈ºywajƒÖca PBKDF2-SHA256 (Web Crypto API)
      async function hashPassword(password, salt, iterations = 100000) {
          const encoder = new TextEncoder();
        const passwordBuffer = encoder.encode(password);
        const saltBuffer = encoder.encode(salt);
        const keyLength = 32; // 256 bits

        const key = await crypto.subtle.importKey(
          'raw',
          passwordBuffer,
          { name: 'PBKDF2' },
          false,
          ['deriveBits']
        );

        const derivedBits = await crypto.subtle.deriveBits(
          {
            name: 'PBKDF2',
            salt: saltBuffer,
            iterations: iterations,
            hash: 'SHA-256'
          },
          key,
          keyLength * 8
        );

        const hashArray = Array.from(new Uint8Array(derivedBits));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      }

      // Sprawdzanie lokalnego logowania administratora poprzez API
      async function checkLocalAdmin(login, password) {
        try {
          const response = await fetch('/api/admin/verify', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              username: login,
              password: password
            })
          });

          const result = await response.json();

          if (result.success) {
            return result.admin;
          } else {
            console.log('Admin verification failed:', result.error);
            return false;
          }
        } catch (error) {
          console.error('Error verifying admin credentials:', error);
          return false;
        }
        }

      // Funkcja logowania aktywno≈õci
      async function logActivity(
        userId,
        action,
        details = {},
        targetUserId = null,
      ) {
        try {
          const activityData = {
            userId: userId,
            action: action,
            details: details,
            targetUserId: targetUserId,
            timestamp: new Date(),
            adminId: currentUser ? currentUser.uid : null,
            ipAddress: null, // Mo≈ºna dodaƒá je≈õli dostƒôpny
            userAgent: navigator.userAgent,
          };

          await addDoc(collection(db, "userActivity"), activityData);
        } catch (error) {
          console.error("Error logging activity:", error);
          // Nie pokazujemy b≈Çƒôdu u≈ºytkownikowi, ≈ºeby nie przeszkadzaƒá w normalnej pracy
        }
      }

      // Funkcje pomocnicze
      function showStatus(message, isError = false) {
        const statusEl = document.getElementById("login-status");
        statusEl.innerHTML = message;
        statusEl.className = `mt-6 p-4 rounded-lg text-center text-sm ${isError ? "bg-red-900/50 text-red-300 border border-red-700" : "bg-green-900/50 text-green-300 border border-green-700"}`;
        statusEl.style.display = "block";

        setTimeout(() => {
          statusEl.style.display = "none";
        }, 5000);
      }

      function showNotification(message, type = "success") {
        // Prosta implementacja powiadomie≈Ñ - mo≈ºna rozszerzyƒá
        console.log(`${type}: ${message}`);
      }

      // Sprawdzanie roli administratora
      async function checkAdminRole(user) {
        try {
          const userDoc = await getDoc(doc(db, "userProfiles", user.uid));
          if (userDoc.exists()) {
            const userData = userDoc.data();
            return userData.role === "admin";
          }
          return false;
        } catch (error) {
          console.error("Error checking admin role:", error);
          return false;
        }
      }

      // Aktualizacja wy≈õwietlania nazwy administratora
      function updateAdminDisplay(user) {
        // Aktualizuj kompaktowy widok (to jest jedyny element dostƒôpny w obecnym layout)
        updateCompactAdminDisplay(user);
      }

      // Nawigacja miƒôdzy zak≈Çadkami
      function switchTab(tabName) {
        document.querySelectorAll(".nav-item").forEach((item) => {
          item.classList.remove("active");
        });
        document.querySelectorAll(".nav-submenu-item").forEach((item) => {
          item.classList.remove("active");
        });

        // Sprawd≈∫ czy to zak≈Çadka z submenu
        const mainTab = document.querySelector(`[data-tab="${tabName}"]`);
        const submenuItem = document.querySelector(`.nav-submenu-item[data-tab="${tabName}"]`);

        if (submenuItem) {
          submenuItem.classList.add("active");
          // Oznacz g≈Ç√≥wnƒÖ zak≈Çadkƒô "Strony" jako aktywnƒÖ je≈õli otwieramy podstronƒô
          document.querySelector(".nav-pages-toggle").classList.add("active");
        } else if (mainTab) {
          mainTab.classList.add("active");
        }

        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(`tab-${tabName}`).classList.add("active");

        // Dodatkowe akcje dla konkretnych zak≈Çadek
        if (tabName === "status") {
          loadEventsLog();
        }

        currentTab = tabName;

        // ≈Åadowanie danych dla wybranej zak≈Çadki
        switch (tabName) {
          case "status":
            checkMainServicesStatus();
            break;
          case "dashboard":
            loadDashboardStats();
            break;
          case "users":
            loadUsers();
            break;
          case "products":
            loadProducts();
            break;
          case "messages":
            console.log('üì± Switching to messages tab, loading messages...');
            // Daj czas na update DOM
            setTimeout(() => loadMessages(), 100);
            break;
          case "chats":
            loadConversations();
            break;
          case "events":
            loadEvents();
            break;
          case "reviews":
            loadReviews();
            break;
          case "charity":
            loadCharity();
            break;
          case "bazar":
            // Brak specjalnej funkcji ≈Çadowania dla tej zak≈Çadki
            break;
          case "szkolenia":
            // Brak specjalnej funkcji ≈Çadowania dla tej zak≈Çadki
            break;
          case "blog":
            // Brak specjalnej funkcji ≈Çadowania dla tej zak≈Çadki
            break;
          case "dokumenty":
            // Brak specjalnej funkcji ≈Çadowania dla tej zak≈Çadki
            break;
          case "kontakt":
            // Brak specjalnej funkcji ≈Çadowania dla tej zak≈Çadki
            break;
          case "settings":
            loadSettings();
            break;
        }

        // Zatrzymaj automatyczne od≈õwie≈ºanie konwersacji je≈õli nie jeste≈õmy w zak≈Çadce messages
        if (tabName !== "messages") {
          stopConversationsAutoRefresh();
        }
      }


      // Funkcja do prze≈ÇƒÖczania sidebar na mobile
      function toggleSidebar() {
        const sidebar = document.getElementById("mobile-sidebar");
        const overlay = document.getElementById("mobile-overlay");

        if (sidebar && overlay) {
          if (sidebar.classList.contains("open")) {
            sidebar.classList.remove("open");
            overlay.classList.add("hidden");
          } else {
            sidebar.classList.add("open");
            overlay.classList.remove("hidden");
          }
        }
      }

      // Funkcja do aktualizacji kompaktowego wy≈õwietlania nazwy admina
      function updateCompactAdminDisplay(user) {
        const compactName = document.getElementById("admin-display-name-compact");
        const compactTime = document.getElementById("admin-session-time-compact");

        if (compactName && user) {
          const displayName = user.displayName || user.email || "Administrator";
          compactName.textContent = displayName;
        }

        // Aktualizuj czas pozosta≈Çy do wyga≈õniƒôcia sesji
        updateSessionTimeDisplay();
      }

      // Funkcja przed≈Çu≈ºajƒÖca sesjƒô przy interakcjach u≈ºytkownika
      function extendAdminSession() {
        const adminSession = localStorage.getItem('admin_session');
        if (adminSession) {
          try {
            const sessionData = JSON.parse(adminSession);
            // Przed≈Çu≈º sesjƒô o kolejne 2 godziny
            sessionData.expiresAt = Date.now() + (2 * 60 * 60 * 1000);
            localStorage.setItem('admin_session', JSON.stringify(sessionData));

            console.log('üîÑ Admin session extended by 2 hours');
            updateSessionTimeDisplay(); // Od≈õwie≈º wy≈õwietlanie czasu
          } catch (error) {
            console.warn('Error extending admin session:', error);
          }
        }
      }

      // Funkcja do aktualizacji wy≈õwietlania pozosta≈Çego czasu sesji
      function updateSessionTimeDisplay() {
        const timeElement = document.getElementById("admin-session-time-compact");
        if (!timeElement) return;

        const remainingTime = getAdminSessionRemainingTime();
        if (remainingTime > 0) {
          const hours = Math.floor(remainingTime / (1000 * 60 * 60));
          const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));

          let timeString;
          if (hours > 0) {
            timeString = `${hours}h ${minutes}min`;
          } else {
            timeString = `${minutes}min`;
          }

          timeElement.textContent = timeString;
          timeElement.className = "text-zinc-400 text-xs";

          // Zmiana koloru przy ko≈ÑczƒÖcej siƒô sesji
          if (remainingTime < 15 * 60 * 1000) { // mniej ni≈º 15 minut
            timeElement.className = "text-yellow-400 text-xs animate-pulse";
          }
          if (remainingTime < 5 * 60 * 1000) { // mniej ni≈º 5 minut
            timeElement.className = "text-red-400 text-xs animate-pulse";
          }
        } else {
          timeElement.textContent = "Wygas≈Ça";
          timeElement.className = "text-red-400 text-xs";
        }
      }

      // Funkcja do obliczania pozosta≈Çego czasu sesji administratora
      function getAdminSessionRemainingTime() {
        try {
          const adminSession = sessionStorage.getItem('admin_session') || localStorage.getItem('admin_session');
          if (adminSession) {
            const sessionData = JSON.parse(adminSession);
            const now = Date.now();
            const expiresAt = sessionData.expiresAt || (sessionData.loginTime + 2 * 60 * 60 * 1000); // domy≈õlnie 2h

            return Math.max(0, expiresAt - now);
          }
        } catch (error) {
          console.warn('B≈ÇƒÖd podczas obliczania czasu sesji administratora:', error);
        }
        return 0;
      }


      // Inicjalizacja nawigacji
      document.querySelectorAll(".nav-item").forEach((item) => {
        item.addEventListener("click", () => {
          const tab = item.getAttribute("data-tab");
          switchTab(tab);
        });
      });

      // Logowanie administratora
      document
        .getElementById("admin-login-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const login = document.getElementById("admin-email").value.trim();
          const password = document.getElementById("admin-password").value;
          const rememberMe = document.getElementById("admin-remember").checked;

          if (!login || !password) {
            showStatus("Wprowad≈∫ login i has≈Ço administratora.", true);
            return;
          }

          try {
            // Najpierw sprawd≈∫ lokalne konto administratora
            const adminData = await checkLocalAdmin(login, password);
            if (adminData) {
              try {
              // Utw√≥rz fikcyjnego u≈ºytkownika dla lokalnego admina
              currentUser = {
                uid: `local-admin-${adminData.id}`,
                email: login,
                displayName: `${login}@Administrator`,
                isLocalAdmin: true,
                originalLogin: login, // Zachowaj oryginalny login dla wy≈õwietlania
                adminRole: adminData.role,
                adminId: adminData.id
              };

                // Zaloguj udane logowanie administratora
                await logActivity("system", "ADMIN_LOGIN_SUCCESS", {
                  login: login,
                  method: "local_admin",
                  ip: "unknown", // Mo≈ºna dodaƒá wykrywanie IP je≈õli potrzebne
                  userAgent: navigator.userAgent,
                });

              showStatus("Logowanie lokalnego administratora pomy≈õlne.");
              updateAdminDisplay(currentUser);
              startSessionTimeUpdater();
              document.getElementById("login-section").classList.add("hidden");
              document.getElementById("admin-panel").classList.remove("hidden");

                // Zawsze zapisz sesjƒô w sessionStorage (dla session manager)
                  const sessionData = {
                  uid: "local-admin",
                  email: login,
                  login: login,
                  displayName: `${login}@Administrator`,
                  loginTime: Date.now(),
                    userAgent: navigator.userAgent,
                    isLocalAdmin: true,
                  expiresAt: Date.now() + (rememberMe ? 7 * 24 * 60 * 60 * 1000 : 2 * 60 * 60 * 1000), // 7 dni lub 2 godziny
                };

                // Dla lokalnych administrator√≥w zawsze zapisuj w localStorage
                // (sessionStorage jest czyszczony po od≈õwie≈ºeniu strony)
                localStorage.setItem("admin_session", JSON.stringify(sessionData));

                // Dodatkowo zapisz w sessionStorage je≈õli rememberMe (zachowaj kompatybilno≈õƒá)
                if (rememberMe) {
                  sessionStorage.setItem("admin_session", JSON.stringify(sessionData));
              }

              switchTab("dashboard");

                // Sprawd≈∫ status us≈Çug od razu po zalogowaniu
                setTimeout(() => {
                  checkMainServicesStatus();
                }, 1000);

                return;
              } catch (adminSetupError) {
                console.error('Admin setup error:', adminSetupError);
                alert('B≈ÇƒÖd podczas konfiguracji panelu admin: ' + adminSetupError.message);
                showStatus("B≈ÇƒÖd podczas konfiguracji panelu administratora.", true);
              return;
              }
            }
            const userCredential = await signInWithEmailAndPassword(
              auth,
              login,
              password,
            );
            const user = userCredential.user;

            // Sprawd≈∫ czy u≈ºytkownik ma rolƒô administratora
            const isAdmin = await checkAdminRole(user);
            if (!isAdmin) {
              await signOut(auth);
              // Zaloguj nieudane logowanie - brak uprawnie≈Ñ
              await logActivity("system", "ADMIN_LOGIN_FAILED", {
                login: login,
                reason: "insufficient_permissions",
                method: "firebase",
                ip: "unknown",
                userAgent: navigator.userAgent,
              });
              showStatus(
                "Brak uprawnie≈Ñ administratora. Tylko administratorzy majƒÖ dostƒôp do panelu.",
                true,
              );
              return;
            }

            // Zaloguj udane logowanie Firebase
            await logActivity("system", "ADMIN_LOGIN_SUCCESS", {
              login: login,
              method: "firebase",
              userId: user.uid,
              ip: "unknown",
              userAgent: navigator.userAgent,
            });

            showStatus("Logowanie administratora (Firebase) pomy≈õlne.");
          } catch (error) {
            console.error("Login error:", error);

            let errorMessage = "B≈Çƒôdne dane logowania<br>NIEUPOWA≈ªNIONYM WSTƒòP WZBRONIONY.";
            let errorReason = "unknown_error";

            if (error.code === "auth/user-not-found") {
              errorReason = "user_not_found";
            } else if (error.code === "auth/wrong-password") {
              errorReason = "wrong_password";
            } else if (error.code === "auth/invalid-email") {
              errorReason = "invalid_email_format";
            } else if (error.code === "auth/too-many-requests") {
              errorMessage =
                "Zbyt wiele pr√≥b logowania. Spr√≥buj ponownie p√≥≈∫niej.";
              errorReason = "too_many_attempts";
            }

            // Zaloguj nieudane logowanie
            await logActivity("system", "ADMIN_LOGIN_FAILED", {
              login: login,
              reason: errorReason,
              method: "firebase",
              errorCode: error.code,
              ip: "unknown",
              userAgent: navigator.userAgent,
            });

            showStatus(errorMessage, true);
          }
        });

      // Wylogowanie administratora
      window.logoutAdmin = async () => {
        try {
          // Wyloguj z Firebase je≈õli to u≈ºytkownik Firebase
          if (currentUser && !currentUser.isLocalAdmin) {
            await signOut(auth);
          }

          // Wyczy≈õƒá dane lokalnego administratora
          currentUser = null;

          // Zatrzymaj aktualizacjƒô czasu sesji
          stopSessionTimeUpdater();

          // Wyczy≈õƒá sesjƒô administratora
          sessionStorage.removeItem('admin_session');
          localStorage.removeItem('admin_session');

          showNotification("Administrator wylogowany.");

          // Przejd≈∫ do sekcji logowania
          document.getElementById("login-section").classList.remove("hidden");
          document.getElementById("admin-panel").classList.add("hidden");
        } catch (error) {
          console.error("Logout error:", error);
        }
      };

      // Timer do aktualizacji czasu sesji co minutƒô
      let sessionTimeUpdater = null;
      function startSessionTimeUpdater() {
        if (sessionTimeUpdater) clearInterval(sessionTimeUpdater);
        sessionTimeUpdater = setInterval(updateSessionTimeDisplay, 60000); // co minutƒô
        updateSessionTimeDisplay(); // aktualizacja natychmiastowa
      }

      function stopSessionTimeUpdater() {
        if (sessionTimeUpdater) {
          clearInterval(sessionTimeUpdater);
          sessionTimeUpdater = null;
        }
      }

      // Monitorowanie stanu autoryzacji
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // Sprawd≈∫ ponownie rolƒô administratora (na wypadek zmian)
          const isAdmin = await checkAdminRole(user);
          if (!isAdmin) {
            await signOut(auth);
            showStatus("Utracono uprawnienia administratora.", true);
            return;
          }

          currentUser = user;
          updateAdminDisplay(user);
          startSessionTimeUpdater();

          document.getElementById("login-section").classList.add("hidden");
          document.getElementById("admin-panel").classList.remove("hidden");

          // Za≈Çaduj dashboard
          switchTab("dashboard");
        } else {
          currentUser = null;
          document.getElementById("login-section").classList.remove("hidden");
          document.getElementById("admin-panel").classList.add("hidden");
        }
      });

      // Funkcja od≈õwie≈ºania dashboardu z animacjƒÖ ≈Çadowania
      async function refreshDashboardWithLoading() {
        const refreshBtn = document.getElementById("dashboard-refresh-btn");

        // Dodaj klasƒô loading do przycisku
        refreshBtn.classList.add("loading-spinner");
        refreshBtn.disabled = true;

        try {
          // Poka≈º loading overlay dla ca≈Çego dashboardu
          showDashboardLoadingStates();

          // Od≈õwie≈º dane
          await loadDashboardStats();

          // Aktualizuj timestamp ostatniej aktualizacji
          const lastEventsUpdateEl = document.getElementById("last-events-update");
          if (lastEventsUpdateEl) lastEventsUpdateEl.textContent = new Date().toLocaleString("pl-PL");

          showNotification("Dashboard zosta≈Ç od≈õwie≈ºony", "success");
        } catch (error) {
          console.error("Error refreshing dashboard:", error);
          showNotification("B≈ÇƒÖd od≈õwie≈ºania dashboardu", "error");
        } finally {
          // Ukryj loading overlay
          hideDashboardLoadingStates();

          // Usu≈Ñ klasƒô loading z przycisku
          refreshBtn.classList.remove("loading-spinner");
          refreshBtn.disabled = false;
        }
      }

      // Udostƒôpnij funkcjƒô globalnie
      window.refreshDashboardWithLoading = refreshDashboardWithLoading;

      // Funkcje ≈Çadowania danych
      async function loadDashboardStats() {
        try {
          // ≈Åadowanie statusu stron
          await checkSitesStatus();

          // ≈Åadowanie statystyk aktywno≈õci
          await loadActivityStats();
          await loadContactFormsCount();

          // ≈Åadowanie statystyk Google Analytics
          await fetchGAStatistics();

          // Ustawienie listener dla activityLogs (tylko je≈õli jeszcze nie jest ustawiony)
          if (!activityLogsListener) {
            setupActivityLogsListener();
          }

          // Ustawienie listener dla pending tasks (tylko je≈õli jeszcze nie jest ustawiony)
          if (!pendingTasksListener) {
            setupPendingTasksListener();
          }
        } catch (error) {
          console.error("Error loading dashboard stats:", error);
          showNotification("B≈ÇƒÖd ≈Çadowania danych dashboard.", "error");
        }
      }

      // Funkcje do zarzƒÖdzania stanami ≈Çadowania dashboardu
      function showDashboardLoadingStates() {
        const overlay = document.getElementById("dashboard-loading-overlay");
        overlay.classList.add("active");
      }

      function hideDashboardLoadingStates() {
        const overlay = document.getElementById("dashboard-loading-overlay");
        overlay.classList.remove("active");
      }

      // ZarzƒÖdzanie u≈ºytkownikami
      async function loadUsers() {
        try {
          const usersSnapshot = await getDocs(collection(db, "userProfiles"));
          usersList = usersSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Dodaj administratora lokalnego je≈õli jest zalogowany
          if (currentUser && currentUser.isLocalAdmin) {
            // Sprawd≈∫ czy lokalny admin ju≈º nie jest na li≈õcie
            const localAdminExists = usersList.find(
              (user) => user.id === currentUser.uid,
            );
            if (!localAdminExists) {
              usersList.unshift({
                id: currentUser.uid,
                displayName: currentUser.displayName,
                email: currentUser.email,
                role: "admin",
                status: "active",
                createdAt: new Date(),
                isLocalAdmin: true,
              });
            }
          }

          renderUsersList();
        } catch (error) {
          console.error("Error loading users:", error);
          showNotification("B≈ÇƒÖd ≈Çadowania u≈ºytkownik√≥w.", "error");
        }
      }

      function filterUsers(filter) {
        currentUserFilter = filter;

        document.querySelectorAll(".user-filter-btn").forEach((btn) => {
          btn.classList.remove("active", "border-coyote", "text-coyote");
          btn.classList.add("border-zinc-700");
        });

        document
          .querySelector(`[data-filter="${filter}"]`)
          .classList.add("active", "border-coyote", "text-coyote");

        renderUsersList();
      }

      function renderUsersList() {
        let filteredUsers = usersList;

        switch (currentUserFilter) {
          case "active":
            filteredUsers = usersList.filter((u) => u.status === "active");
            break;
          case "blocked":
            filteredUsers = usersList.filter((u) => u.status === "blocked");
            break;
          case "admin":
            filteredUsers = usersList.filter((u) => u.role === "admin");
            break;
          case "company":
            filteredUsers = usersList.filter((u) => u.role === "company");
            break;
        }

        const usersHtml = filteredUsers
          .map((user) => {
            const isCurrentUser = currentUser && user.id === currentUser.uid;
            const status = user.status || "active";
            const role = user.role || "user";
            const roleDisplay = {
              admin: "ADMINISTRATOR",
              company: "FIRMA",
              user: "U≈ªYTKOWNIK",
            };

            const statusClasses = {
              active: "status-active",
              blocked: "status-blocked",
              suspended: "status-suspended",
            };

            const roleClasses = {
              admin: "role-admin",
              user: "role-user",
              company: "role-company",
            };

            const decryptedUser = {
              ...user,
              phone: user.isLocalAdmin
                ? user.phone || ""
                : user.phone
                  ? atob(user.phone)
                  : "",
              address: {
                street: user.isLocalAdmin
                  ? user.address?.street || ""
                  : user.address?.street
                    ? atob(user.address.street)
                    : "",
                city: user.isLocalAdmin
                  ? user.address?.city || ""
                  : user.address?.city
                    ? atob(user.address.city)
                    : "",
              },
            };

            return `
                    <div class="border-l-4 ${statusClasses[status]} p-4 rounded-r-lg">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-1">
                                    <h4 class="text-white font-bold">${decryptedUser.displayName}</h4>
                                    <span class="px-2 py-1 text-xs rounded font-bold ${roleClasses[role]}">${roleDisplay[role] || role.toUpperCase()}</span>
                                    <span class="px-2 py-1 text-xs rounded bg-gray-600 text-white">${status.toUpperCase()}</span>
                                    ${isCurrentUser ? '<span class="px-2 py-1 text-xs rounded bg-purple-600 text-white">TY</span>' : ""}
                                </div>
                                <div class="text-sm text-zinc-400 space-y-1">
                                    <div>üìß ${decryptedUser.email}</div>
                                    <div>üì± ${decryptedUser.phone || "Brak"}</div>
                                    <div>üè† ${decryptedUser.address.city || "Brak adresu"}</div>
                                    <div>üìÖ ${new Date(user.createdAt?.toDate?.() || user.createdAt).toLocaleDateString("pl-PL")}</div>
                                </div>
                            </div>
                            <div class="flex space-x-2 ml-4">
                                <button onclick="viewUserDetails('${user.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Szczeg√≥≈Çy</button>
                                ${
                                  !isCurrentUser
                                    ? `
                                    <button onclick="toggleUserBlock('${user.id}')" class="text-${status === "blocked" ? "green" : "yellow"}-400 hover:text-${status === "blocked" ? "green" : "yellow"}-300 px-2 py-1 border border-${status === "blocked" ? "green" : "yellow"}-400 rounded text-xs">
                                        ${status === "blocked" ? "Odblokuj" : "Zablokuj"}
                                    </button>
                                    <button onclick="changeUserRole('${user.id}', '${role}')" class="text-purple-400 hover:text-purple-300 px-2 py-1 border border-purple-400 rounded text-xs">Zmie≈Ñ rolƒô</button>
                                    <button onclick="resetUserPassword('${user.id}', '${decryptedUser.email}')" class="text-orange-400 hover:text-orange-300 px-2 py-1 border border-orange-400 rounded text-xs">Reset has≈Ça</button>
                                    <button onclick="deleteUser('${user.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usu≈Ñ</button>
                                `
                                    : ""
                                }
                            </div>
                        </div>
                    </div>
                `;
          })
          .join("");

        document.getElementById("users-list").innerHTML =
          usersHtml ||
          '<div class="text-center text-zinc-500 py-8">Brak u≈ºytkownik√≥w</div>';
      }

      // Szczeg√≥≈Çy u≈ºytkownika
      window.viewUserDetails = async (userId) => {
        try {
          let user;

          // Sprawd≈∫ czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              createdAt: new Date(),
              isLocalAdmin: true,
            };
          } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentEditingUser = user;

          const decryptedUser = {
            ...user,
            phone: user.isLocalAdmin
              ? user.phone || ""
              : user.phone
                ? atob(user.phone)
                : "",
            parcelLocker: user.isLocalAdmin
              ? user.parcelLocker || ""
              : user.parcelLocker
                ? atob(user.parcelLocker)
                : "",
            address: {
              street: user.isLocalAdmin
                ? user.address?.street || ""
                : user.address?.street
                  ? atob(user.address.street)
                  : "",
              buildingNumber: user.isLocalAdmin
                ? user.address?.buildingNumber || ""
                : user.address?.buildingNumber
                  ? atob(user.address.buildingNumber)
                  : "",
              postalCode: user.isLocalAdmin
                ? user.address?.postalCode || ""
                : user.address?.postalCode
                  ? atob(user.address.postalCode)
                  : "",
              city: user.isLocalAdmin
                ? user.address?.city || ""
                : user.address?.city
                  ? atob(user.address.city)
                  : "",
            },
          };

          const detailsHtml = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-bold mb-4">Informacje podstawowe</h3>
                            <div class="space-y-3">
                                <div><strong>Nazwa u≈ºytkownika:</strong> ${decryptedUser.displayName}</div>
                                <div><strong>Email:</strong> ${decryptedUser.email}</div>
                                <div><strong>Imiƒô:</strong> ${decryptedUser.firstName || "Nie podano"}</div>
                                <div><strong>Nazwisko:</strong> ${decryptedUser.lastName || "Nie podano"}</div>
                                <div><strong>Telefon:</strong> ${decryptedUser.phone || "Nie podano"}</div>
                                <div><strong>Rola:</strong> ${decryptedUser.role || "user"}</div>
                                <div><strong>Status:</strong> ${decryptedUser.status || "active"}</div>
                                <div><strong>Data rejestracji:</strong> ${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleString("pl-PL")}</div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-4">Adres dostawy</h3>
                            <div class="space-y-3">
                                <div><strong>Ulica:</strong> ${decryptedUser.address.street || "Nie podano"}</div>
                                <div><strong>Numer:</strong> ${decryptedUser.address.buildingNumber || "Nie podano"}</div>
                                <div><strong>Kod pocztowy:</strong> ${decryptedUser.address.postalCode || "Nie podano"}</div>
                                <div><strong>Miasto:</strong> ${decryptedUser.address.city || "Nie podano"}</div>
                                <div><strong>Paczkomat:</strong> ${decryptedUser.parcelLocker || "Nie podano"}</div>
                            </div>

                            <h3 class="text-lg font-bold mb-4 mt-6">Preferencje</h3>
                            <div class="space-y-3">
                                <div><strong>Newsletter:</strong> ${decryptedUser.newsletter ? "Tak" : "Nie"}</div>
                            </div>
                        </div>
                    </div>
                `;

          document.getElementById("user-details-content").innerHTML =
            detailsHtml;
          document
            .getElementById("user-details-modal")
            .classList.remove("hidden");
        } catch (error) {
          console.error("Error loading user details:", error);
          showNotification("B≈ÇƒÖd ≈Çadowania szczeg√≥≈Ç√≥w u≈ºytkownika.", "error");
        }
      };

      window.closeUserDetails = () => {
        document.getElementById("user-details-modal").classList.add("hidden");
      };

      window.switchUserTab = (tabName) => {
        document.querySelectorAll(".user-tab-btn").forEach((btn) => {
          btn.classList.remove("active", "bg-coyote", "text-black");
          btn.classList.add("text-zinc-400");
        });
        document
          .querySelector(`[data-tab="${tabName}"]`)
          .classList.add("active", "bg-coyote", "text-black");

        if (tabName === "activity") {
          loadUserActivity();
        } else if (tabName === "details") {
          loadUserDetails();
        }
      };

      async function loadUserDetails() {
        if (!currentEditingUser) return;

        // Ukryj przycisk edycji dla administratora lokalnego
        const editButton = document.querySelector(
          '[onclick="editUserDetails()"]',
        );
        if (editButton) {
          if (currentEditingUser.isLocalAdmin) {
            editButton.style.display = "none";
          } else {
            editButton.style.display = "inline-block";
          }
        }

        const decryptedUser = {
          ...currentEditingUser,
          phone: currentEditingUser.isLocalAdmin
            ? currentEditingUser.phone || ""
            : currentEditingUser.phone
              ? atob(currentEditingUser.phone)
              : "",
          parcelLocker: currentEditingUser.isLocalAdmin
            ? currentEditingUser.parcelLocker || ""
            : currentEditingUser.parcelLocker
              ? atob(currentEditingUser.parcelLocker)
              : "",
          address: {
            street: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.street || ""
              : currentEditingUser.address?.street
                ? atob(currentEditingUser.address.street)
                : "",
            buildingNumber: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.buildingNumber || ""
              : currentEditingUser.address?.buildingNumber
                ? atob(currentEditingUser.address.buildingNumber)
                : "",
            postalCode: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.postalCode || ""
              : currentEditingUser.address?.postalCode
                ? atob(currentEditingUser.address.postalCode)
                : "",
            city: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.city || ""
              : currentEditingUser.address?.city
                ? atob(currentEditingUser.address.city)
                : "",
          },
        };

        const detailsHtml = `
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                          <h3 class="text-lg font-bold mb-4 text-coyote">Informacje podstawowe</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Nazwa u≈ºytkownika:</span>
                                  <span class="text-white">${decryptedUser.displayName}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Email:</span>
                                  <span class="text-white">${decryptedUser.email}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Imiƒô:</span>
                                  <span class="text-white">${decryptedUser.firstName || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Nazwisko:</span>
                                  <span class="text-white">${decryptedUser.lastName || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Telefon:</span>
                                  <span class="text-white">${decryptedUser.phone || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Rola:</span>
                                  <span class="text-white">${decryptedUser.role || "user"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Status:</span>
                                  <span class="text-white">${decryptedUser.status || "active"}</span>
                              </div>
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Data rejestracji:</span>
                                  <span class="text-white">${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleString("pl-PL")}</span>
                              </div>
                          </div>
                      </div>
                      <div>
                          <h3 class="text-lg font-bold mb-4 text-coyote">Adres dostawy</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Ulica:</span>
                                  <span class="text-white">${decryptedUser.address.street || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Numer:</span>
                                  <span class="text-white">${decryptedUser.address.buildingNumber || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Kod pocztowy:</span>
                                  <span class="text-white">${decryptedUser.address.postalCode || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2 border-b border-zinc-700">
                                  <span class="text-zinc-400 font-medium">Miasto:</span>
                                  <span class="text-white">${decryptedUser.address.city || "Nie podano"}</span>
                              </div>
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Paczkomat:</span>
                                  <span class="text-white">${decryptedUser.parcelLocker || "Nie podano"}</span>
                              </div>
                          </div>

                          <h3 class="text-lg font-bold mb-4 mt-6 text-coyote">Preferencje</h3>
                          <div class="space-y-3">
                              <div class="flex justify-between py-2">
                                  <span class="text-zinc-400 font-medium">Newsletter:</span>
                                  <span class="text-white">${decryptedUser.newsletter ? "Tak" : "Nie"}</span>
                              </div>
                          </div>
                      </div>
                  </div>
              `;

        document.getElementById("user-details-content").innerHTML = detailsHtml;
      }

      window.editUserDetails = () => {
        showUserEditModal();
      };

      async function loadUserActivity() {
        if (!currentEditingUser) return;

        try {
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-zinc-500 py-8">
              <i class="fa-solid fa-spinner fa-spin fa-3x mb-4"></i>
              <p>≈Åadowanie historii aktywno≈õci...</p>
            </div>
          `;

          // Pobierz aktywno≈õƒá u≈ºytkownika
          const q = query(
            collection(db, "userActivity"),
            where("userId", "==", currentEditingUser.id),
            orderBy("timestamp", "desc"),
            limit(50),
          );

          const snapshot = await getDocs(q);
          const activities = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Pobierz tak≈ºe aktywno≈õƒá gdzie u≈ºytkownik jest celem (np. zosta≈Ç zablokowany przez admina)
          const targetQuery = query(
            collection(db, "userActivity"),
            where("targetUserId", "==", currentEditingUser.id),
            orderBy("timestamp", "desc"),
            limit(50),
          );

          const targetSnapshot = await getDocs(targetQuery);
          const targetActivities = targetSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          // Po≈ÇƒÖcz i posortuj wszystkie aktywno≈õci
          const allActivities = [...activities, ...targetActivities]
            .sort((a, b) => b.timestamp.toDate() - a.timestamp.toDate())
            .slice(0, 50); // Ogranicz do 50 najnowszych

          renderUserActivity(allActivities);
        } catch (error) {
          console.error("Error loading user activity:", error);
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-red-400 py-8">
              <i class="fa-solid fa-exclamation-triangle fa-3x mb-4"></i>
              <p>B≈ÇƒÖd ≈Çadowania historii aktywno≈õci</p>
              <p class="text-sm">${error.message}</p>
            </div>
          `;
        }
      }

      function renderUserActivity(activities) {
        if (activities.length === 0) {
          document.getElementById("user-details-content").innerHTML = `
            <div class="text-center text-zinc-500 py-8">
              <i class="fa-solid fa-inbox fa-3x mb-4"></i>
              <p>Brak zarejestrowanej aktywno≈õci</p>
              <p class="text-sm">Historia aktywno≈õci u≈ºytkownika pojawi siƒô tutaj po wykonaniu jakichkolwiek dzia≈Ça≈Ñ.</p>
            </div>
          `;
          return;
        }

        const activityHtml = activities
          .map((activity) => {
            const timestamp = activity.timestamp.toDate();
            const timeAgo = getTimeAgo(timestamp);

            // Ikony dla r√≥≈ºnych typ√≥w aktywno≈õci
            const activityIcons = {
              ROLE_CHANGE: "fa-user-tag",
              PASSWORD_RESET_REQUEST: "fa-key",
              USER_BLOCKED: "fa-ban",
              USER_UNBLOCKED: "fa-unlock",
              USER_DELETED: "fa-trash",
              PROFILE_EDITED: "fa-edit",
              LOGIN: "fa-sign-in-alt",
              LOGOUT: "fa-sign-out-alt",
              MESSAGE_SENT: "fa-comment",
              PRODUCT_ADDED: "fa-plus-circle",
              PRODUCT_EDITED: "fa-edit",
              LIKE_ADDED: "fa-heart",
              COMMENT_ADDED: "fa-comment-dots",
            };

            const iconClass = activityIcons[activity.action] || "fa-circle";

            // Kolory dla r√≥≈ºnych typ√≥w aktywno≈õci
            const activityColors = {
              USER_BLOCKED: "text-red-400",
              USER_UNBLOCKED: "text-green-400",
              USER_DELETED: "text-red-600",
              ROLE_CHANGE: "text-blue-400",
              PASSWORD_RESET_REQUEST: "text-orange-400",
              PROFILE_EDITED: "text-purple-400",
            };

            const colorClass =
              activityColors[activity.action] || "text-zinc-400";

            // Opis aktywno≈õci
            let description = "";
            switch (activity.action) {
              case "ROLE_CHANGE":
                description = `Zmiana roli z ${activity.details.oldRole?.toUpperCase() || "BRAK"} na ${activity.details.newRole?.toUpperCase() || "BRAK"}`;
                break;
              case "PASSWORD_RESET_REQUEST":
                description = "Wys≈Çano link resetowania has≈Ça";
                break;
              case "USER_BLOCKED":
                if (activity.details.isPermanent) {
                  description = "Konto zablokowane na zawsze";
                } else {
                  description = `Konto zablokowane na ${activity.details.duration}`;
                }
                if (activity.details.contentAction === "remove") {
                  description += " (zawarto≈õƒá usuniƒôta)";
                }
                break;
              case "USER_UNBLOCKED":
                description = "Konto odblokowane";
                break;
              case "USER_DELETED":
                description = `Konto usuniƒôte${activity.details.contentAction === "keep" ? " (zawarto≈õƒá zachowana)" : " (zawarto≈õƒá usuniƒôta)"}`;
                break;
              case "PROFILE_EDITED":
                description = `Edycja profilu (${activity.details.changes?.join(", ") || "nieznane zmiany"})`;
                break;
              default:
                description = activity.action.replace(/_/g, " ").toLowerCase();
            }

            // Szczeg√≥≈Çy wykonawcy
            let performedBy = "";
            if (activity.adminId && activity.adminId !== activity.userId) {
              performedBy = " przez administratora";
            }

            return `
            <div class="flex items-start space-x-3 p-4 bg-zinc-800 rounded-lg mb-3">
              <div class="${colorClass} mt-1">
                <i class="fa-solid ${iconClass}"></i>
              </div>
              <div class="flex-1">
                <div class="flex justify-between items-start">
                  <div class="font-semibold ${colorClass}">${activity.action.replace(/_/g, " ")}</div>
                  <div class="text-xs text-zinc-500">${timeAgo}</div>
                </div>
                <div class="text-sm text-zinc-300 mt-1">${description}${performedBy}</div>
                <div class="text-xs text-zinc-500 mt-1">
                  ${timestamp.toLocaleString("pl-PL")}
                </div>
              </div>
            </div>
          `;
          })
          .join("");

        document.getElementById("user-details-content").innerHTML = `
          <div class="mb-4">
            <h3 class="text-lg font-bold mb-4">Historia Aktywno≈õci</h3>
            <p class="text-sm text-zinc-400 mb-4">Poka≈º ostatnie 50 dzia≈Ça≈Ñ u≈ºytkownika</p>
          </div>
          <div class="space-y-1 max-h-[500px] overflow-y-auto">
            ${activityHtml}
          </div>
        `;
      }

      // Zmienna globalna do przechowywania aktualnie edytowanego u≈ºytkownika
      let currentEditingUser = null;

      function showUserEditModal() {
        if (!currentEditingUser) return;

        // Sprawd≈∫ czy to administrator lokalny
        if (currentEditingUser.isLocalAdmin) {
          showNotification(
            "Nie mo≈ºna edytowaƒá administratora lokalnego.",
            "error",
          );
          return;
        }

        const decryptedUser = {
          ...currentEditingUser,
          phone: currentEditingUser.isLocalAdmin
            ? currentEditingUser.phone || ""
            : currentEditingUser.phone
              ? atob(currentEditingUser.phone)
              : "",
          parcelLocker: currentEditingUser.isLocalAdmin
            ? currentEditingUser.parcelLocker || ""
            : currentEditingUser.parcelLocker
              ? atob(currentEditingUser.parcelLocker)
              : "",
          address: {
            street: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.street || ""
              : currentEditingUser.address?.street
                ? atob(currentEditingUser.address.street)
                : "",
            buildingNumber: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.buildingNumber || ""
              : currentEditingUser.address?.buildingNumber
                ? atob(currentEditingUser.address.buildingNumber)
                : "",
            postalCode: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.postalCode || ""
              : currentEditingUser.address?.postalCode
                ? atob(currentEditingUser.address.postalCode)
                : "",
            city: currentEditingUser.isLocalAdmin
              ? currentEditingUser.address?.city || ""
              : currentEditingUser.address?.city
                ? atob(currentEditingUser.address.city)
                : "",
          },
        };

        // Wype≈Çnij formularz danymi u≈ºytkownika
        document.getElementById("edit-user-id").value = decryptedUser.id;
        document.getElementById("edit-display-name").value =
          decryptedUser.displayName || "";
        document.getElementById("edit-email").value = decryptedUser.email || "";
        document.getElementById("edit-first-name").value =
          decryptedUser.firstName || "";
        document.getElementById("edit-last-name").value =
          decryptedUser.lastName || "";
        document.getElementById("edit-phone").value = decryptedUser.phone || "";
        document.getElementById("edit-street").value =
          decryptedUser.address?.street || "";
        document.getElementById("edit-building-number").value =
          decryptedUser.address?.buildingNumber || "";
        document.getElementById("edit-postal-code").value =
          decryptedUser.address?.postalCode || "";
        document.getElementById("edit-city").value =
          decryptedUser.address?.city || "";
        document.getElementById("edit-parcel-locker").value =
          decryptedUser.parcelLocker || "";
        document.getElementById("edit-newsletter").checked =
          decryptedUser.newsletter || false;
        document.getElementById("edit-role").value =
          decryptedUser.role || "user";
        document.getElementById("edit-status").value =
          decryptedUser.status || "active";

        document.getElementById("user-edit-modal").classList.remove("hidden");
      }

      window.closeUserEdit = () => {
        document.getElementById("user-edit-modal").classList.add("hidden");
        currentEditingUser = null;
      };

      // Zmienna globalna dla blokowanego u≈ºytkownika
      let currentBlockingUser = null;

      // Funkcje zarzƒÖdzania u≈ºytkownikami
      window.toggleUserBlock = async (userId) => {
        try {
          let user;

          // Sprawd≈∫ czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else {
          const userDoc = await getDoc(doc(db, "userProfiles", userId));
          if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentBlockingUser = user;

          const currentStatus = user.status || "active";

          if (currentStatus === "blocked") {
            // Je≈õli u≈ºytkownik jest ju≈º zablokowany, poka≈º opcje odblokowania
            showUserUnblockModal();
          } else {
            // Je≈õli u≈ºytkownik nie jest zablokowany, poka≈º modal blokowania
            showUserBlockModal();
          }
        } catch (error) {
          console.error("Error toggling user block:", error);
          showNotification("B≈ÇƒÖd zmiany statusu u≈ºytkownika.", "error");
        }
      };

      function showUserBlockModal() {
        if (!currentBlockingUser) return;

        const decryptedUser = {
          ...currentBlockingUser,
          phone: currentBlockingUser.phone
            ? atob(currentBlockingUser.phone)
            : "",
          address: {
            city: currentBlockingUser.address?.city
              ? atob(currentBlockingUser.address.city)
              : "",
          },
        };

        document.getElementById("block-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
            ${decryptedUser.phone ? ` ‚Ä¢ Tel: ${decryptedUser.phone}` : ""}
          </div>
        `;

        document.getElementById("block-user-id").value = decryptedUser.id;
        document.getElementById("user-block-modal").classList.remove("hidden");
      }

      function showUserUnblockModal() {
        if (!currentBlockingUser) return;

        const confirmUnblock = confirm(
          `Czy na pewno chcesz odblokowaƒá u≈ºytkownika ${currentBlockingUser.displayName}?\n\nU≈ºytkownik odzyska dostƒôp do wszystkich funkcji strony.`,
        );

        if (confirmUnblock) {
          unblockUser(currentBlockingUser.id);
        }
      }

      async function unblockUser(userId) {
        try {
          await updateDoc(doc(db, "userProfiles", userId), {
            status: "active",
            unblockedAt: new Date(),
            unblockedBy: currentUser.uid,
          });

          // Zaloguj odblokowanie u≈ºytkownika
          await logActivity(userId, "USER_UNBLOCKED", {
            unblockedBy: currentUser.uid,
          });

          showNotification("U≈ºytkownik zosta≈Ç odblokowany.");
          loadUsers();
        } catch (error) {
          console.error("Error unblocking user:", error);
          showNotification("B≈ÇƒÖd podczas odblokowywania u≈ºytkownika.", "error");
        }
      }

      window.closeUserBlock = () => {
        document.getElementById("user-block-modal").classList.add("hidden");
        currentBlockingUser = null;
      };

      function showUserDeleteModal() {
        if (!currentDeletingUser) return;

        const decryptedUser = {
          ...currentDeletingUser,
          phone: currentDeletingUser.phone
            ? atob(currentDeletingUser.phone)
            : "",
          address: {
            city: currentDeletingUser.address?.city
              ? atob(currentDeletingUser.address.city)
              : "",
          },
        };

        document.getElementById("delete-user-info").innerHTML = `
          <div class="flex items-center space-x-3 mb-2">
            <div class="font-bold text-white">${decryptedUser.displayName}</div>
            <div class="text-sm text-zinc-400">${decryptedUser.email}</div>
          </div>
          <div class="text-sm text-zinc-500">
            ${decryptedUser.address.city ? `Miasto: ${decryptedUser.address.city}` : "Brak adresu"}
            ${decryptedUser.phone ? ` ‚Ä¢ Tel: ${decryptedUser.phone}` : ""}
          </div>
          <div class="text-sm text-zinc-500 mt-1">
            Konto utworzone: ${new Date(decryptedUser.createdAt?.toDate?.() || decryptedUser.createdAt).toLocaleDateString("pl-PL")}
          </div>
        `;

        document.getElementById("delete-user-id").value = decryptedUser.id;
        document.getElementById("user-delete-modal").classList.remove("hidden");
      }

      window.closeUserDelete = () => {
        document.getElementById("user-delete-modal").classList.add("hidden");
        currentDeletingUser = null;
      };

      window.resetUserPassword = async (userId, email) => {
        // Sprawd≈∫ czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie mo≈ºna resetowaƒá has≈Ça administratora lokalnego.",
            "error",
          );
          return;
        }

        if (!confirm(`Czy wys≈Çaƒá link resetowania has≈Ça na adres: ${email}?`))
          return;

        try {
          const { sendPasswordResetEmail } =
            await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js");
          await sendPasswordResetEmail(auth, email, {
            url: `${window.location.origin}/konto.strzelca.pl/akcja.html?mode=resetPassword`,
            handleCodeInApp: true,
          });

          // Zaloguj reset has≈Ça
          await logActivity(userId, "PASSWORD_RESET_REQUEST", {
            email: email,
            requestedBy: currentUser.uid,
          });

          showNotification("Link resetowania has≈Ça zosta≈Ç wys≈Çany.");
        } catch (error) {
          console.error("Error sending password reset:", error);
          showNotification("B≈ÇƒÖd wysy≈Çania linku resetowania.", "error");
        }
      };

      window.changeUserRole = async (userId, currentRole) => {
        // Sprawd≈∫ czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie mo≈ºna zmieniƒá roli administratora lokalnego.",
            "error",
          );
          return;
        }

        let newRole;
        let confirmMessage;

        if (currentRole === "user") {
          newRole = "company";
          confirmMessage =
            "Czy na pewno chcesz zmieniƒá rolƒô tego u≈ºytkownika na FIRMA?";
        } else if (currentRole === "company") {
          newRole = "admin";
          confirmMessage =
            "Czy na pewno chcesz nadaƒá temu u≈ºytkownikowi uprawnienia ADMINISTRATORA?";
        } else if (currentRole === "admin") {
          newRole = "user";
          confirmMessage =
            "Czy na pewno chcesz odebraƒá temu u≈ºytkownikowi uprawnienia administratora?";
        }

        if (!confirm(confirmMessage)) return;

        try {
          await updateDoc(doc(db, "userProfiles", userId), { role: newRole });

          // Zaloguj zmianƒô roli
          await logActivity(userId, "ROLE_CHANGE", {
            oldRole: currentRole,
            newRole: newRole,
            changedBy: currentUser.uid,
          });

          showNotification(
            `Rola u≈ºytkownika zosta≈Ça zmieniona na: ${newRole === "company" ? "FIRMA" : newRole === "admin" ? "ADMINISTRATOR" : "U≈ªYTKOWNIK"}.`,
          );
          loadUsers();
        } catch (error) {
          console.error("Error changing user role:", error);
          showNotification("B≈ÇƒÖd zmiany roli u≈ºytkownika.", "error");
        }
      };

      // Zmienna globalna dla usuwanego u≈ºytkownika
      let currentDeletingUser = null;

      window.deleteUser = async (userId) => {
        // Sprawd≈∫ czy to administrator lokalny
        if (
          currentUser &&
          currentUser.isLocalAdmin &&
          userId === currentUser.uid
        ) {
          showNotification(
            "Nie mo≈ºna usunƒÖƒá administratora lokalnego.",
            "error",
          );
          return;
        }

        try {
          let user;

          // Sprawd≈∫ czy to administrator lokalny
          if (
            currentUser &&
            currentUser.isLocalAdmin &&
            userId === currentUser.uid
          ) {
            user = {
              id: userId,
              displayName: currentUser.displayName,
              email: currentUser.email,
              role: "admin",
              status: "active",
              isLocalAdmin: true,
            };
          } else {
            const userDoc = await getDoc(doc(db, "userProfiles", userId));
            if (!userDoc.exists()) return;
            user = { id: userId, ...userDoc.data() };
          }

          currentDeletingUser = user;

          showUserDeleteModal();
        } catch (error) {
          console.error("Error preparing user deletion:", error);
          showNotification(
            "B≈ÇƒÖd przygotowania usuniƒôcia u≈ºytkownika.",
            "error",
          );
        }
      };

      window.refreshUsers = () => {
        loadUsers();
      };

      // Funkcje zarzƒÖdzania produktami
      async function loadProducts() {
        try {
          const q = query(collection(db, "products"), orderBy("order", "asc"));
          const snapshot = await getDocs(q);
          productsList = snapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          renderProductsList();
        } catch (error) {
          console.error("Error loading products:", error);
          showNotification("B≈ÇƒÖd ≈Çadowania produkt√≥w.", "error");
        }
      }

      function renderProductsList() {
        const productsHtml = productsList
          .map(
            (product) => `
                <div class="flex justify-between items-center p-3 bg-zinc-800 rounded-lg">
                    <div class="flex-1">
                        <div class="font-semibold">${product.title}</div>
                        <div class="text-sm text-zinc-400">${product.price} z≈Ç</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="editProduct('${product.id}')" class="text-blue-400 hover:text-blue-300 px-2 py-1 border border-blue-400 rounded text-xs">Edytuj</button>
                        <button onclick="deleteProduct('${product.id}')" class="text-red-400 hover:text-red-300 px-2 py-1 border border-red-400 rounded text-xs">Usu≈Ñ</button>
                    </div>
                </div>
            `,
          )
          .join("");

        document.getElementById("products-list").innerHTML =
          productsHtml ||
          '<div class="text-center text-zinc-500 py-4">Brak produkt√≥w</div>';
      }

      // Funkcje formatowania tekstu w edytorze
      window.formatText = (command) => {
        document.execCommand(command, false, null);
      };

      window.insertImage = () => {
        const url = prompt("Wprowad≈∫ URL obrazka:");
        if (url) {
          document.execCommand("insertImage", false, url);
        }
      };

      // Placeholder funkcje - bƒôdƒÖ zaimplementowane w kolejnych krokach
      // Udostƒôpnij funkcje globalnie dla onclick - definiuj przed funkcjami
      window.loadMessages = async function() {
        console.log('üîÑ loadMessages called from window');
        // Znajd≈∫ w≈Ça≈õciwƒÖ funkcjƒô
        const messagesTab = document.getElementById('tab-messages');
        if (messagesTab && messagesTab.classList.contains('active')) {
          // Jeste≈õmy ju≈º na zak≈Çadce messages, wywo≈Çaj loadMessages
          const func = arguments.callee._originalFunction;
          if (func) return func.apply(this, arguments);
        } else {
          // Prze≈ÇƒÖcz na zak≈Çadkƒô messages i za≈Çaduj
          switchTab('messages');
        }
      };

      async function loadMessages() {
        console.log('üîÑ loadMessages called');

        // Zapisz referencjƒô do oryginalnej funkcji dla window.loadMessages
        window.loadMessages._originalFunction = loadMessages;

        const refreshBtn = document.getElementById("refresh-messages-btn");
        const refreshText = document.getElementById("refresh-text");

        console.log('üîÑ Refresh button found:', !!refreshBtn);

        // Dodaj animacjƒô ≈Çadowania
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i><span id="refresh-text">≈Åadowanie...</span>';
        }

        try {
          console.log('üì° Fetching messages from API...');

          const conversationsList = document.getElementById("conversations-list");
          if (!conversationsList) {
            console.error('‚ùå conversations-list element not found!');
            return;
          }

          conversationsList.innerHTML =
            '<div class="text-center text-zinc-500 py-8"><i class="fa-solid fa-spinner fa-spin text-xl mb-3 text-zinc-600"></i><p class="text-sm">≈Åadowanie czat√≥w...</p></div>';

          // Sprawd≈∫ czy jeste≈õmy na serwerze
          if (window.location.protocol === 'file:') {
            throw new Error('Strona otwarta lokalnie! Uruchom serwer: node server.js i otw√≥rz http://localhost:3002/admin/index.html');
          }

          // Pobierz wiadomo≈õci skierowane do administratora z API
          console.log('üåê Making API request to /api/messages?recipientId=admin&limit=100');
          const response = await fetch('/api/messages?recipientId=admin&limit=100');
          console.log('üì• Response status:', response.status);

          const data = await response.json();
          console.log('üì¶ Response data:', data);

          if (!data.success) {
            throw new Error(data.error || 'Failed to load messages');
          }

          const { messages, total } = data.data;

          if (messages.length === 0) {
            document.getElementById("conversations-list").innerHTML =
              '<div class="text-center text-zinc-500 py-8"><i class="fa-solid fa-inbox text-4xl mb-4 text-zinc-600"></i><p class="text-sm">Brak konwersacji</p></div>';
            document.getElementById("conversations-count").textContent = '0';
          } else {
            // Grupuj wiadomo≈õci w konwersacje
            const conversations = {};

            messages.forEach(msg => {
              // U≈ºyj kombinacji senderId + recipientId jako klucz konwersacji
              const participants = [msg.senderId, msg.recipientId].sort();
              const conversationKey = participants.join('_');

              if (!conversations[conversationKey]) {
                conversations[conversationKey] = {
                  participants: participants,
                  senderName: msg.senderName,
                  senderEmail: msg.senderEmail,
                  senderId: msg.senderId,
                  lastMessage: msg,
                  messages: [],
                  unreadCount: 0,
                  totalMessages: 0
                };
              }

              conversations[conversationKey].messages.push(msg);
              conversations[conversationKey].totalMessages++;

              if (!msg.isRead) {
                conversations[conversationKey].unreadCount++;
              }
            });

            // Konwertuj na tablicƒô i posortuj
            const conversationsArray = Object.values(conversations).sort((a, b) => {
              // Najpierw nieprzeczytane
              if (a.unreadCount > 0 && b.unreadCount === 0) return -1;
              if (a.unreadCount === 0 && b.unreadCount > 0) return 1;
              // Potem po dacie ostatniej wiadomo≈õci
              return b.lastMessage.timestamp - a.lastMessage.timestamp;
            });

            // Wy≈õwietl konwersacje w stylu WhatsApp/Messenger
            const conversationsHtml = conversationsArray.map((conversation) => {
              const lastMsg = conversation.lastMessage;
              const date = new Date(lastMsg.timestamp).toLocaleString("pl-PL", {
                day: '2-digit',
                month: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
              });
              const hasUnread = conversation.unreadCount > 0;

            return `
                <div class="conversation-item p-3 border-b border-zinc-700/50 hover:bg-zinc-800/50 cursor-pointer transition-all duration-200 ${hasUnread ? 'bg-zinc-800/30 border-l-4 border-l-coyote' : 'bg-zinc-800/10'}"
                     data-user-id="${conversation.senderId}"
                     data-user-name="${conversation.senderName}"
                     data-user-email="${conversation.senderEmail}">
                  <div class="flex justify-between items-start">
                    <div class="flex-1 min-w-0">
                      <div class="flex items-center justify-between mb-1">
                        <h4 class="text-sm font-semibold text-white truncate pr-2">
                          ${conversation.senderName}
                        </h4>
                        <span class="text-xs text-zinc-500 flex-shrink-0">${date}</span>
                  </div>
                      <p class="text-xs text-zinc-400 truncate mb-2">
                        ${lastMsg.topic ? lastMsg.topic + ': ' : ''}${lastMsg.content.substring(0, 60)}${lastMsg.content.length > 60 ? '...' : ''}
                      </p>
                      <div class="flex items-center justify-between">
                        <span class="text-xs text-zinc-500">${conversation.totalMessages} wiadomo≈õci</span>
                        ${hasUnread ? `<span class="bg-coyote text-black text-xs px-2 py-1 rounded-full font-semibold">${conversation.unreadCount}</span>` : ''}
                  </div>
                </div>
                </div>
              </div>
            `;
            }).join('');

            document.getElementById("conversations-list").innerHTML = conversationsHtml;
            document.getElementById("conversations-count").textContent = conversationsArray.length;
          }

          // Zaktualizuj liczniki w nag≈Ç√≥wku
          const unreadCount = messages.filter(msg => !msg.isRead).length;
          const unreadCountEl = document.getElementById("unread-count");
          if (unreadCountEl) unreadCountEl.textContent = unreadCount;

          const totalCountEl = document.getElementById("total-count");
          if (totalCountEl) totalCountEl.textContent = total;

        } catch (error) {
          console.error("Error loading messages:", error);
            document.getElementById("conversations-list").innerHTML =
            '<div class="text-center text-red-400 py-8"><i class="fa-solid fa-exclamation-triangle text-4xl mb-4"></i><p class="text-sm">B≈ÇƒÖd ≈Çadowania czat√≥w</p></div>';
        } finally {
          // Usu≈Ñ animacjƒô ≈Çadowania
          if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fa-solid fa-sync-alt mr-2"></i><span id="refresh-text">Od≈õwie≈º</span>';
          }
        }
      }

      // Zmienne globalne dla aktualnej konwersacji
      let currentConversationUser = null;

      // Funkcja do otwierania konwersacji
      async function openConversation(userId, userName, userEmail) {
        currentConversationUser = { id: userId, name: userName, email: userEmail };

        // Ustaw informacje o u≈ºytkowniku w modalu
        document.getElementById('chat-user-name').textContent = userName;
        document.getElementById('chat-user-email').textContent = userEmail;

        // Poka≈º modal
        document.getElementById('chat-modal').classList.remove('hidden');

        // Za≈Çaduj wiadomo≈õci konwersacji
        await loadConversationMessages(userId);
      }

      // Funkcja do zamykania modalu czatu
      function closeChatModal() {
        document.getElementById('chat-modal').classList.add('hidden');
        currentConversationUser = null;
        document.getElementById('chat-reply-input').value = '';
      }

      // Funkcja do ≈Çadowania wiadomo≈õci konwersacji
      async function loadConversationMessages(userId) {
        try {
          const messagesContainer = document.getElementById('chat-messages-container');
          messagesContainer.innerHTML = '<div class="text-center text-zinc-500 py-8"><i class="fa-solid fa-spinner fa-spin"></i> ≈Åadowanie...</div>';

          // Pobierz wszystkie wiadomo≈õci miƒôdzy adminem a u≈ºytkownikiem
          const response1 = await fetch(`/api/messages?senderId=${userId}&recipientId=admin&limit=100`);
          const response2 = await fetch(`/api/messages?senderId=admin&recipientId=${userId}&limit=100`);

          const data1 = await response1.json();
          const data2 = await response2.json();

          if (!data1.success || !data2.success) {
            throw new Error('Failed to load conversation');
          }

          // Po≈ÇƒÖcz wiadomo≈õci i posortuj chronologicznie
          const allMessages = [...data1.data.messages, ...data2.data.messages]
            .sort((a, b) => a.timestamp - b.timestamp);

          if (allMessages.length === 0) {
            messagesContainer.innerHTML = '<div class="text-center text-zinc-500 py-8"><i class="fa-solid fa-comment-slash text-4xl mb-4 text-zinc-600"></i><p class="text-sm">Brak wiadomo≈õci w tej konwersacji</p></div>';
            return;
          }

          // Wy≈õwietl wiadomo≈õci
          const messagesHtml = allMessages.map(msg => {
            const isFromUser = msg.senderId !== 'admin';
            const time = new Date(msg.timestamp).toLocaleString("pl-PL", {
              hour: '2-digit',
              minute: '2-digit',
              day: '2-digit',
              month: '2-digit'
            });

            return `
              <div class="flex ${isFromUser ? 'justify-start' : 'justify-end'}">
                <div class="max-w-[70%] ${isFromUser ? 'bg-zinc-700' : 'bg-coyote'} rounded-lg p-3">
                  ${msg.topic ? `<div class="font-semibold text-sm mb-1">${msg.topic}</div>` : ''}
                  <div class="text-sm ${isFromUser ? 'text-zinc-100' : 'text-black'} whitespace-pre-wrap">${msg.content}</div>
                  <div class="text-xs ${isFromUser ? 'text-zinc-400' : 'text-black/70'} mt-2">${time}</div>
                </div>
              </div>
            `;
          }).join('');

          messagesContainer.innerHTML = messagesHtml;

          // Przewi≈Ñ na d√≥≈Ç
          setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }, 100);

          // Oznacz wiadomo≈õci jako przeczytane
          for (const msg of allMessages) {
            if (msg.senderId === userId && !msg.isRead) {
              await fetch(`/api/messages/${msg.id}/read`, { method: 'PUT' });
            }
          }

          // Od≈õwie≈º listƒô konwersacji
          loadMessages();

        } catch (error) {
          console.error('Error loading conversation:', error);
          document.getElementById('chat-messages-container').innerHTML =
            '<div class="text-center text-red-400 py-8"><i class="fa-solid fa-exclamation-triangle text-4xl mb-4"></i><p class="text-sm">B≈ÇƒÖd ≈Çadowania konwersacji</p></div>';
        }
      }

      // Funkcja do zamykania bie≈ºƒÖcego czatu
      function closeCurrentChat() {
        document.getElementById('chat-header').classList.add('hidden');
        document.getElementById('chat-messages-container').classList.add('hidden');
        document.getElementById('chat-input-container').classList.add('hidden');

        // Przywr√≥ƒá widok powitalny
        document.getElementById('chat-messages-container').innerHTML = `
          <div class="text-center text-zinc-500 py-12">
            <i class="fa-solid fa-comments text-4xl mb-4 text-zinc-600"></i>
            <h3 class="text-lg font-semibold mb-2">Wybierz konwersacjƒô</h3>
            <p class="text-sm">Kliknij na czat z listy, aby rozpoczƒÖƒá rozmowƒô</p>
          </div>
        `;

        currentConversationUser = null;
        document.getElementById('chat-reply-input').value = '';
      }

      // Funkcja do rozpoczynania nowego czatu
      function startNewChat() {
        // Utw√≥rz modal do tworzenia nowego czatu
        const modalHtml = `
          <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50" id="new-chat-modal">
            <div class="bg-zinc-900 rounded-xl shadow-2xl w-full max-w-md mx-4">
              <div class="p-6">
                <div class="flex items-center justify-between mb-6">
                  <h3 class="text-xl font-bold text-white">Nowy czat</h3>
                  <button onclick="closeNewChatModal()" class="text-zinc-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                  </button>
                </div>

                <form id="new-chat-form" onsubmit="createNewChat(event)">
                  <div class="space-y-4">
                  <div>
                      <label class="block text-sm font-medium text-zinc-300 mb-2">
                        Adres email u≈ºytkownika
                      </label>
                      <input
                        type="email"
                        id="new-chat-email"
                        required
                        placeholder="user@example.com"
                        class="w-full bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-coyote"
                      >
                  </div>

                    <div>
                      <label class="block text-sm font-medium text-zinc-300 mb-2">
                        Temat rozmowy
                      </label>
                      <input
                        type="text"
                        id="new-chat-topic"
                        placeholder="Opcjonalny temat..."
                        class="w-full bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-coyote"
                      >
                  </div>

                    <div>
                      <label class="block text-sm font-medium text-zinc-300 mb-2">
                        Pierwsza wiadomo≈õƒá
                      </label>
                      <textarea
                        id="new-chat-message"
                        required
                        rows="3"
                        placeholder="Wpisz pierwszƒÖ wiadomo≈õƒá..."
                        class="w-full bg-zinc-800 border border-zinc-600 rounded-lg px-3 py-2 text-white placeholder-zinc-400 focus:outline-none focus:ring-2 focus:ring-coyote resize-none"
                      ></textarea>
                </div>
                  </div>

                  <div class="flex space-x-3 mt-6">
                    <button
                      type="button"
                      onclick="closeNewChatModal()"
                      class="flex-1 btn-secondary"
                    >
                      Anuluj
                    </button>
                    <button
                      type="submit"
                      class="flex-1 btn-admin"
                      id="create-chat-btn"
                    >
                      <i class="fa-solid fa-paper-plane mr-2"></i>
                      Utw√≥rz czat
                    </button>
                  </div>
                </form>
              </div>
                </div>
              </div>
            `;

        // Dodaj modal do strony
        document.body.insertAdjacentHTML('beforeend', modalHtml);
      }

      // Funkcja do zamykania modalu nowego czatu
      function closeNewChatModal() {
        const modal = document.getElementById('new-chat-modal');
        if (modal) {
          modal.remove();
        }
      }

      // Funkcja do tworzenia nowego czatu
      async function createNewChat(event) {
        event.preventDefault();

        const email = document.getElementById('new-chat-email').value.trim();
        const topic = document.getElementById('new-chat-topic').value.trim();
        const message = document.getElementById('new-chat-message').value.trim();

        if (!email || !message) {
          showNotification("Wype≈Çnij wszystkie wymagane pola", "warning");
          return;
        }

        const createBtn = document.getElementById('create-chat-btn');
        createBtn.disabled = true;
        createBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Tworzenie...';

        try {
          // Utw√≥rz ID dla nowego u≈ºytkownika
          const userId = `guest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
          const userName = email.split('@')[0]; // U≈ºyj czƒô≈õci przed @ jako nazwy

          // Wy≈õlij pierwszƒÖ wiadomo≈õƒá
          const response = await fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              senderId: userId,
              senderName: userName,
              senderEmail: email,
              senderType: 'guest',
              recipientId: 'admin',
              recipientType: 'admin',
              topic: topic || 'Nowa rozmowa',
              content: message,
              conversationType: 'support_chat'
            })
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to create chat');
          }

          // Zamknij modal
          closeNewChatModal();

          // Od≈õwie≈º listƒô konwersacji
          loadMessages();

          // Otw√≥rz nowƒÖ konwersacjƒô
          openConversation(userId, userName, email);

          showNotification("Czat zosta≈Ç utworzony!", "success");

        } catch (error) {
          console.error('Error creating chat:', error);
          showNotification("B≈ÇƒÖd podczas tworzenia czatu", "error");
        } finally {
          createBtn.disabled = false;
          createBtn.innerHTML = '<i class="fa-solid fa-paper-plane mr-2"></i>Utw√≥rz czat';
        }
      }

      // Funkcja do filtrowania konwersacji
      function filterConversations() {
        const searchTerm = document.getElementById('chat-search').value.toLowerCase().trim();
        const conversationItems = document.querySelectorAll('.conversation-item');

        let visibleCount = 0;

        conversationItems.forEach(item => {
          const userName = item.dataset.userName.toLowerCase();
          const userEmail = item.dataset.userEmail.toLowerCase();
          const messageText = item.textContent.toLowerCase();

          const isVisible = !searchTerm ||
            userName.includes(searchTerm) ||
            userEmail.includes(searchTerm) ||
            messageText.includes(searchTerm);

          item.style.display = isVisible ? 'block' : 'none';

          if (isVisible) visibleCount++;
        });

        // Zaktualizuj licznik widocznych konwersacji
        const countElement = document.getElementById('conversations-count');
        if (countElement) {
          const originalText = countElement.textContent.replace(/^\d+/, visibleCount);
          countElement.textContent = originalText;
        }
      }

      // Dodaj obs≈Çugƒô zdarze≈Ñ po za≈Çadowaniu strony
      document.addEventListener('DOMContentLoaded', function() {
        // Sprawd≈∫ kt√≥ra zak≈Çadka jest aktywna i za≈Çaduj odpowiednie dane
        const activeTab = document.querySelector('.tab-content.active');
        if (activeTab && activeTab.id === 'tab-messages') {
          loadMessages();
        }

        // Obs≈Çuga klikniƒôƒá w konwersacje
        document.addEventListener('click', function(e) {
          if (e.target.closest('.conversation-item')) {
            const item = e.target.closest('.conversation-item');
            const userId = item.dataset.userId;
            const userName = item.dataset.userName;
            const userEmail = item.dataset.userEmail;

            if (userId && userName) {
              openConversation(userId, userName, userEmail);
            }
          }
        });

        // Obs≈Çuga wyszukiwania konwersacji
        const chatSearch = document.getElementById('chat-search');
        if (chatSearch) {
          chatSearch.addEventListener('input', function() {
            filterConversations();
          });
        }

        // Obs≈Çuga klawisza Enter w polu czatu
        const chatInput = document.getElementById('chat-reply-input');
        if (chatInput) {
          chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              sendChatReply();
            }
          });
        }
      });

      // Funkcja do wysy≈Çania odpowiedzi
      async function sendChatReply() {
        if (!currentConversationUser) return;

        const input = document.getElementById('chat-reply-input');
        const sendBtn = document.getElementById('send-message-btn');
        const content = input.value.trim();

        if (!content) {
          showNotification("Wpisz wiadomo≈õƒá przed wys≈Çaniem", "warning");
          return;
        }

        // Zablokuj przycisk podczas wysy≈Çania
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

        try {
          const response = await fetch('/api/messages', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              senderId: 'admin',
              senderName: 'Administrator',
              senderType: 'admin',
              recipientId: currentConversationUser.id,
              recipientType: 'user',
              content: content,
              topic: 'Odpowied≈∫ administratora'
            })
          });

          const data = await response.json();

          if (!data.success) {
            throw new Error(data.error || 'Failed to send message');
          }

          // Wyczy≈õƒá input
          input.value = '';

          // Prze≈Çaduj konwersacjƒô
          await loadConversationMessages(currentConversationUser.id);

          // Od≈õwie≈º listƒô konwersacji
          loadMessages();

          showNotification("Wiadomo≈õƒá zosta≈Ça wys≈Çana", "success");

        } catch (error) {
          console.error('Error sending reply:', error);
          showNotification("B≈ÇƒÖd wysy≈Çania wiadomo≈õci", "error");
        } finally {
          // Odblokuj przycisk
          sendBtn.disabled = false;
          sendBtn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
        }
      }

      async function completeMessage(messageId) {
        try {
          const response = await fetch(`/api/messages/${messageId}/status`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ status: 'completed' })
          });

          if (!response.ok) {
            throw new Error('Failed to update message status');
          }

          showNotification("Sprawa zosta≈Ça zako≈Ñczona", "success");
          // Ponownie za≈Çaduj wiadomo≈õci aby od≈õwie≈ºyƒá widok
          loadMessages();
        } catch (error) {
          console.error("Error completing message:", error);
          showNotification("B≈ÇƒÖd podczas ko≈Ñczenia sprawy", "error");
        }
      }

      // Funkcja oznaczajƒÖca wiadomo≈õƒá jako przeczytanƒÖ
      async function markMessageAsRead(messageId) {
        try {
          await fetch(`/api/messages/${messageId}/read`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
            }
          });
        } catch (error) {
          console.error("Error marking message as read:", error);
        }
      }

      // Funkcja aktualizujƒÖca statystyki wiadomo≈õci w nag≈Ç√≥wku
      async function updateMessageStats() {
        try {
          const response = await fetch('/api/messages/stats');
          if (response.ok) {
            const stats = await response.json();
            const unreadCountEl = document.getElementById("unread-count");
            if (unreadCountEl) unreadCountEl.textContent = stats.unread;

            const totalCountEl = document.getElementById("total-count");
            if (totalCountEl) totalCountEl.textContent = stats.total;
          }
        } catch (error) {
          console.error("Error updating message stats:", error);
        }
      }


      function renderConversations(conversations) {
        if (conversations.length === 0) {
          document.getElementById("conversations-list").innerHTML = `
            <div id="conversations-empty" class="text-center py-8 text-zinc-400">
              <i class="fa-solid fa-comments text-3xl mb-3 text-zinc-600"></i>
              <p class="text-sm">Brak konwersacji</p>
            </div>
          `;
          return;
        }

        const conversationsHtml = conversations.map((conversation) => {
          const lastMessage = conversation.lastMessage;
          const timeAgo = getTimeAgo(lastMessage.timestamp);
          const hasUnread = conversation.unreadCount > 0;
          const conversationKey = conversation.participants.join('_');

          return `
            <div class="conversation-item p-2 border-b border-zinc-700/50 hover:bg-zinc-800/70 cursor-pointer transition-colors relative group ${hasUnread ? 'bg-zinc-800/30' : ''}"
                 onclick="selectConversation('${conversation.participants.join(',')}')">
              <!-- Przycisk usuniƒôcia -->
              <button onclick="deleteConversation('${conversationKey}'); event.stopPropagation();"
                      class="absolute top-2 right-2 text-zinc-500 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity text-sm p-1"
                      title="Usu≈Ñ konwersacjƒô">
                <i class="fa-solid fa-trash"></i>
              </button>

              <div class="flex justify-between items-center pr-8">
                <div class="flex-1 min-w-0">
                  <div class="flex items-center justify-between">
                    <h4 class="text-sm font-medium text-white truncate">
                      ${conversation.participants.filter(p => p !== 'admin').join(', ')}
                    </h4>
                    <span class="text-xs text-zinc-500 ml-2 flex-shrink-0">${timeAgo}</span>
                  </div>
                  <p class="text-xs text-zinc-400 truncate mt-0.5">
                    ${lastMessage.senderId === 'admin' ? 'Ty:' : ''} ${lastMessage.content || 'Za≈ÇƒÖcznik'}
                  </p>
                </div>
                ${hasUnread ? `<span class="bg-coyote text-black text-xs px-1.5 py-0.5 rounded-full ml-2 flex-shrink-0">${conversation.unreadCount}</span>` : ''}
              </div>
            </div>
          `;
        }).join('');

        document.getElementById("conversations-list").innerHTML = conversationsHtml;
      }

      // Funkcja filtrowania konwersacji w czasie rzeczywistym
      window.filterConversations = () => {
        const statusFilter = document.getElementById("conversations-status-filter").value;
        const sortFilter = document.getElementById("conversations-sort-filter").value;
        const searchText = document.getElementById("conversations-search").value.toLowerCase().trim();

        // Poka≈º/ukryj przycisk czyszczenia
        const clearBtn = document.getElementById("clear-search-btn");
        if (searchText.length > 0) {
          clearBtn.classList.remove("opacity-0");
          clearBtn.classList.add("opacity-100");
        } else {
          clearBtn.classList.add("opacity-0");
          clearBtn.classList.remove("opacity-100");
        }

        // Pobierz wszystkie konwersacje i zastosuj filtry
        loadConversationsWithFilters(statusFilter, sortFilter, '', '', searchText);
      };

      // Funkcja czyszczenia wyszukiwania
      window.clearSearch = () => {
        const searchInput = document.getElementById("conversations-search");
        searchInput.value = "";
        searchInput.focus();
        filterConversations();
      };

      // Funkcja prze≈ÇƒÖczania zaawansowanych filtr√≥w
      window.toggleAdvancedFilters = () => {
        const advancedFilters = document.getElementById("advanced-filters");
        advancedFilters.classList.toggle("hidden");
      };

      // Funkcja usuniƒôcia konwersacji
      window.deleteConversation = async (conversationKey) => {
        if (!confirm('Czy na pewno chcesz usunƒÖƒá tƒô konwersacjƒô? Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
          return;
        }

        try {
          // Rozdziel conversationKey na uczestnik√≥w
          const participants = conversationKey.split('_');

          // Pobierz wszystkie wiadomo≈õci tej konwersacji
          const messagesQuery = query(
            collection(db, "privateMessages"),
            where("senderId", "in", participants),
            where("receiverId", "in", participants)
          );

          const snapshot = await getDocs(messagesQuery);

          // Usu≈Ñ wszystkie wiadomo≈õci tej konwersacji
          const deletePromises = snapshot.docs.map(doc => deleteDoc(doc.ref));
          await Promise.all(deletePromises);

          showNotification("Konwersacja zosta≈Ça usuniƒôta", "success");

          // Od≈õwie≈º listƒô konwersacji
          await loadConversations();

        } catch (error) {
          console.error("Error deleting conversation:", error);
          showNotification("B≈ÇƒÖd podczas usuwania konwersacji", "error");
        }
      };

      // Funkcja ≈Çadowania konwersacji z filtrami
      async function loadConversationsWithFilters(statusFilter, sortFilter, dateFrom, dateTo, searchText) {
        try {
          // Je≈õli nie ma za≈Çadowanych danych, za≈Çaduj najpierw
          if (!window.allConversationsData) {
            await loadAllConversationsData();
          }

          let conversationsArray = [...window.allConversationsData];

          // Zastosuj filtry statusu
          if (statusFilter !== 'all') {
            conversationsArray = conversationsArray.filter(conv => {
              if (statusFilter === 'unread') return conv.unreadCount > 0;
              if (statusFilter === 'read') return conv.unreadCount === 0;
              return true;
            });
          }

          // Filtr wyszukiwania
          if (searchText) {
            conversationsArray = conversationsArray.filter(conv => {
              const userNames = conv.participants.filter(p => p !== 'admin').join(' ').toLowerCase();
              const lastMessageContent = (conv.lastMessage.content || '').toLowerCase();

              return userNames.includes(searchText) || lastMessageContent.includes(searchText);
            });
          }

          // Zastosuj sortowanie
          conversationsArray.sort((a, b) => {
            switch (sortFilter) {
              case 'unread-first':
                if (a.unreadCount > 0 && b.unreadCount === 0) return -1;
                if (a.unreadCount === 0 && b.unreadCount > 0) return 1;
                return b.lastMessage.timestamp - a.lastMessage.timestamp;

              case 'date-desc':
                return b.lastMessage.timestamp - a.lastMessage.timestamp;

              case 'date-asc':
                return a.lastMessage.timestamp - b.lastMessage.timestamp;

              default:
                return 0;
            }
          });

          renderConversations(conversationsArray);

        } catch (error) {
          console.error("Error filtering conversations:", error);
          showNotification("B≈ÇƒÖd filtrowania konwersacji", "error");
        }
      }

      // Funkcja ≈Çadowania wszystkich danych konwersacji
      async function loadAllConversationsData() {
        const messagesQuery = query(
          collection(db, "privateMessages"),
          orderBy("timestamp", "desc")
        );

        const snapshot = await getDocs(messagesQuery);
        const messages = [];

        snapshot.forEach((doc) => {
          const data = doc.data();
          messages.push({
            id: doc.id,
            ...data,
            timestamp: data.timestamp?.toDate() || new Date(),
          });
        });

        // Grupuj wiadomo≈õci po konwersacjach
        const conversations = {};
        messages.forEach((message) => {
          const participants = [message.senderId, message.receiverId].sort();
          const conversationKey = participants.join('_');

          if (!conversations[conversationKey]) {
            conversations[conversationKey] = {
              participants: participants,
              lastMessage: message,
              unreadCount: 0,
              messages: []
            };
          }

          conversations[conversationKey].messages.push(message);

          if (message.receiverId === 'admin' && !message.read) {
            conversations[conversationKey].unreadCount++;
          }
        });

        window.allConversationsData = Object.values(conversations);
      }

      // Funkcja od≈õwie≈ºania konwersacji
      window.refreshConversations = async () => {
        const refreshBtn = document.getElementById("refresh-conversations-btn");

        // Dodaj efekt ≈Çadowania
        refreshBtn.classList.add("loading-spinner");
        refreshBtn.disabled = true;

        try {
          await loadConversations();
          showNotification("Konwersacje zosta≈Çy od≈õwie≈ºone", "success");
        } catch (error) {
          console.error("Error refreshing conversations:", error);
          showNotification("B≈ÇƒÖd od≈õwie≈ºania konwersacji", "error");
        } finally {
          refreshBtn.classList.remove("loading-spinner");
          refreshBtn.disabled = false;
        }
      };

      // Funkcja rozpoczynajƒÖca automatyczne od≈õwie≈ºanie
      function startConversationsAutoRefresh() {
        if (conversationsAutoRefreshInterval) {
          clearInterval(conversationsAutoRefreshInterval);
        }

        conversationsAutoRefreshInterval = setInterval(async () => {
          // Nie od≈õwie≈ºaj je≈õli u≈ºytkownik pisze wiadomo≈õƒá
          if (!isTypingInMessage) {
            try {
              await loadConversations();
              console.log("Konwersacje automatycznie od≈õwie≈ºone:", new Date().toLocaleTimeString());
            } catch (error) {
              console.error("Error auto-refreshing conversations:", error);
            }
          }
        }, 60000); // 60 sekund = 1 minuta
      }

      // Funkcja zatrzymujƒÖca automatyczne od≈õwie≈ºanie
      function stopConversationsAutoRefresh() {
        if (conversationsAutoRefreshInterval) {
          clearInterval(conversationsAutoRefreshInterval);
          conversationsAutoRefreshInterval = null;
        }
      }

      async function loadEvents() {
        document.getElementById("events-list").innerHTML =
          '<div class="text-center text-zinc-500 py-8">≈Åadowanie wydarze≈Ñ...</div>';
      }

      async function loadCharity() {
        document.getElementById("charity-content").innerHTML =
          '<div class="text-center text-zinc-500 py-8">≈Åadowanie zawarto≈õci pomocy charytatywnej...</div>';
      }

      async function loadSettings() {
        // ≈Åadowanie ustawie≈Ñ kontaktowych i temat√≥w
        try {
          // Placeholder - bƒôdzie zaimplementowane
          document.getElementById("topics-list").innerHTML =
            '<div class="text-center text-zinc-500 py-4">≈Åadowanie temat√≥w...</div>';
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

        window.refreshProducts = () => {
          loadProducts();
        };

        // Funkcje dashboard
        const SITES_TO_CHECK = [
        "strzelca.pl",
        "sklep.strzelca.pl",
        "bazar.strzelca.pl",
        "szkolenia.strzelca.pl",
        "wydarzenia.strzelca.pl",
        "blog.strzelca.pl",
        "pomoc.strzelca.pl",
        "dokumenty.strzelca.pl",
        "kontakt.strzelca.pl",
        "konto.strzelca.pl",
        ];

        let sitesStatus = {};
        let lastStatusCheck = new Date();

        // Stan us≈Çug g≈Ç√≥wych (dla logowania zmian)
        let previousServicesStatus = {
          firestore: true,
          auth: true,
          domain: true
        };

      // Sprawdzanie pojedynczej subdomeny - tylko status dostƒôpno≈õci
      async function checkSubdomainStatus(site) {
        const timeout = 10000; // 10 sekund timeout

        try {
          // Pr√≥ba fetch z timeout
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), timeout);

          const response = await fetch(`https://${site}`, {
              method: "HEAD",
              cache: "no-cache",
              signal: controller.signal,
            });

            clearTimeout(timeoutId);

          // Strona jest dostƒôpna je≈õli odpowied≈∫ jest OK
            return {
              online: response.ok,
              lastCheck: new Date(),
              status: response.status,
            };

        } catch (error) {
          clearTimeout(timeoutId);

          // Zapisz awariƒô do localStorage
          const failureKey = `site_failure_${site}`;
          const failureData = {
            site: site,
            timestamp: new Date().toISOString(),
            error: error.message,
          };

          try {
            localStorage.setItem(failureKey, JSON.stringify(failureData));
          } catch (storageError) {
            console.warn("Nie mo≈ºna zapisaƒá do localStorage:", storageError);
          }

          return {
                online: false,
                lastCheck: new Date(),
            error: error.message,
            lastFailure: failureData,
          };
        }
      }

      // Funkcje zdarze≈Ñ i log√≥w (globalne)
      // Funkcja pomocnicza do budowania URL API
      function getApiUrl(endpoint) {
        if (window.location.protocol === 'file:') {
          // Lokalne testowanie - u≈ºyj localhost
          return `http://localhost:3002${endpoint}`;
        } else {
          // Produkcja - u≈ºyj wzglƒôdnego URL (API na tym samym serwerze)
          return endpoint;
        }
      }

      // Globalna funkcja powiadomie≈Ñ
      window.showNotification = function(message, type = "success") {
        console.log(`${type}: ${message}`);
        // Mo≈ºna rozszerzyƒá o wizualne powiadomienia
      }

        // Funkcja pomocnicza do sprawdzenia ostatniego zdarzenia dla us≈Çugi
        async function getLastEventForService(site, eventType) {
          try {
            // Sprawd≈∫ najpierw w API
            const response = await fetch(getApiUrl('/api/events-log'));
            if (response.ok) {
              const eventsLog = await response.json();
              // Znajd≈∫ ostatnie zdarzenie dla tej us≈Çugi i typu
              for (let i = eventsLog.length - 1; i >= 0; i--) {
                if (eventsLog[i].site === site && eventsLog[i].type === eventType) {
                  return eventsLog[i];
                }
              }
            }
          } catch (apiError) {
            // Sprawd≈∫ w localStorage
            try {
              const localEventsKey = 'admin_events_log';
              const localEvents = JSON.parse(localStorage.getItem(localEventsKey) || '[]');
              for (let i = localEvents.length - 1; i >= 0; i--) {
                if (localEvents[i].site === site && localEvents[i].type === eventType) {
                  return localEvents[i];
                }
              }
            } catch (localStorageError) {
              console.error('B≈ÇƒÖd sprawdzania localStorage:', localStorageError);
            }
          }
          return null; // Nie znaleziono takiego zdarzenia
      }

      async function logEvent(eventType, site, details) {
          // Sprawd≈∫ czy ju≈º istnieje ostatnie zdarzenie tego typu dla tej us≈Çugi
          const lastEvent = await getLastEventForService(site, eventType);
          if (lastEvent) {
            // Je≈õli zdarzenie ju≈º istnieje, nie tw√≥rz duplikatu
            console.log(`Zdarzenie ${eventType} dla ${site} ju≈º istnieje, pomijam`);
            return;
          }

        const eventData = {
          id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
          timestamp: new Date().toISOString(),
          type: eventType,
          site: site,
          details: details
        };

          // Najpierw spr√≥buj przez API
        try {
          const response = await fetch(getApiUrl('/api/events-log'), {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });

          let eventsLog = [];
          if (response.ok) {
            eventsLog = await response.json();
          }

          // Dodaj nowe zdarzenie
          eventsLog.push(eventData);

          // Zapisz z powrotem (max 1000 zdarze≈Ñ)
          if (eventsLog.length > 1000) {
            eventsLog = eventsLog.slice(-1000);
          }

          await fetch(getApiUrl('/api/events-log'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventsLog)
          });

          } catch (apiError) {
            // API niedostƒôpne - u≈ºyj localStorage jako fallback
            console.warn('API niedostƒôpne, u≈ºywam localStorage dla log√≥w:', apiError.message);

            try {
              const localEventsKey = 'admin_events_log';
              let localEvents = JSON.parse(localStorage.getItem(localEventsKey) || '[]');

              // Dodaj nowe zdarzenie
              localEvents.push(eventData);

              // Zachowaj tylko ostatnie 100 zdarze≈Ñ lokalnie
              if (localEvents.length > 100) {
                localEvents = localEvents.slice(-100);
              }

              localStorage.setItem(localEventsKey, JSON.stringify(localEvents));
              console.log('Zdarzenie zapisane w localStorage:', eventData);
            } catch (localStorageError) {
              console.error('B≈ÇƒÖd localStorage:', localStorageError);
            }
        }
      }

      async function loadEventsLog() {
        const container = document.getElementById('events-log-container');
        const refreshBtn = document.getElementById('refresh-events-btn');

        // Poka≈º stan ≈Çadowania
        if (refreshBtn) {
          refreshBtn.disabled = true;
          refreshBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-1"></i>≈Åadowanie...';
        }

        try {
          const response = await fetch(getApiUrl('/api/events-log'));
            let eventsLog = [];

            if (response.ok) {
              eventsLog = await response.json();
            } else {
              // API niedostƒôpne - pobierz z localStorage
              console.warn('API niedostƒôpne, pobieram logi z localStorage');
              const localEventsKey = 'admin_events_log';
              const localEvents = JSON.parse(localStorage.getItem(localEventsKey) || '[]');
              eventsLog = localEvents;

              // Dodaj informacjƒô ≈ºe to dane lokalne
              if (eventsLog.length > 0) {
                container.innerHTML = '<div class="text-center text-orange-400 py-2 text-sm mb-2"><i class="fa-solid fa-exclamation-triangle mr-1"></i>Wy≈õwietlane dane lokalne (API niedostƒôpne)</div>';
              } else {
                container.innerHTML = '<div class="text-center text-orange-400 py-4"><i class="fa-solid fa-exclamation-triangle mr-2"></i>API niedostƒôpne - sprawd≈∫ konfiguracjƒô serwera</div>';
            return;
              }
          }

          if (eventsLog.length === 0) {
            container.innerHTML = '<div class="text-center text-zinc-400 py-4">Brak zdarze≈Ñ w logach</div>';
            return;
          }

          // Sortuj po czasie (najnowsze na g√≥rze)
          eventsLog.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

          const eventsHtml = eventsLog.map(event => {
            const eventDate = new Date(event.timestamp);
            const formattedDate = eventDate.toLocaleString('pl-PL');

            let eventIcon, eventColor, eventTitle;

            switch(event.type) {
              case 'site_offline':
                eventIcon = 'fa-times-circle';
                eventColor = 'text-red-400';
                eventTitle = 'Strona offline';
                break;
                case 'site_online':
                  eventIcon = 'fa-check-circle';
                  eventColor = 'text-green-400';
                  eventTitle = 'Strona online';
                  break;
                case 'service_offline':
                eventIcon = 'fa-exclamation-triangle';
                eventColor = 'text-orange-400';
                  eventTitle = 'Us≈Çuga offline';
                  break;
                case 'service_online':
                  eventIcon = 'fa-check-circle';
                  eventColor = 'text-green-400';
                  eventTitle = 'Us≈Çuga online';
                break;
              default:
                eventIcon = 'fa-info-circle';
                eventColor = 'text-blue-400';
                eventTitle = 'Inne zdarzenie';
            }

            return `
              <div class="flex items-center justify-between p-3 bg-zinc-800/50 rounded-lg mb-2 animate-fade-in">
                <div class="flex items-center space-x-3">
                  <span class="${eventColor}"><i class="fa-solid ${eventIcon}"></i></span>
                  <div>
                    <div class="text-sm font-medium">${eventTitle} - ${event.site}</div>
                    <div class="text-xs text-zinc-500">${formattedDate}</div>
                    ${event.details ? `<div class="text-xs text-zinc-400 mt-1">${event.details}</div>` : ''}
                  </div>
                </div>
                <button
                  onclick="deleteEvent('${event.id}', this)"
                  class="text-zinc-400 hover:text-red-400 p-1 transition-colors duration-200"
                  title="Usu≈Ñ zdarzenie"
                  id="delete-btn-${event.id}"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            `;
          }).join('');

          container.innerHTML = eventsHtml;
          showNotification("Logi zdarze≈Ñ zosta≈Çy od≈õwie≈ºone", "success");

        } catch (error) {
          console.error('B≈ÇƒÖd podczas ≈Çadowania log√≥w:', error);
          container.innerHTML = '<div class="text-center text-red-400 py-4">B≈ÇƒÖd ≈Çadowania log√≥w</div>';
          showNotification("B≈ÇƒÖd ≈Çadowania log√≥w zdarze≈Ñ", "error");
        } finally {
          // Przywr√≥ƒá przycisk do normalnego stanu
          if (refreshBtn) {
            refreshBtn.disabled = false;
            refreshBtn.innerHTML = '<i class="fa-solid fa-refresh mr-1"></i>Od≈õwie≈º';
          }
        }
      }

      async function deleteEvent(eventId, buttonElement) {
        // Poka≈º stan ≈Çadowania na przycisku
        if (buttonElement) {
          buttonElement.disabled = true;
          buttonElement.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
          buttonElement.classList.add('opacity-50');
        }

        try {
            // Najpierw spr√≥buj przez API
          const response = await fetch(getApiUrl('/api/events-log'));
            let eventsLog = [];

            if (response.ok) {
              // API dzia≈Ça - usu≈Ñ przez API
              eventsLog = await response.json();
          const originalLength = eventsLog.length;
          eventsLog = eventsLog.filter(event => event.id !== eventId);

          if (eventsLog.length === originalLength) {
            showNotification("Zdarzenie nie zosta≈Ço znalezione", "error");
            return;
          }

          const saveResponse = await fetch(getApiUrl('/api/events-log'), {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventsLog)
          });

          if (!saveResponse.ok) {
            showNotification("B≈ÇƒÖd zapisywania zmian", "error");
            return;
              }
            } else {
              // API niedostƒôpne - usu≈Ñ z localStorage
              console.warn('API niedostƒôpne, usuwam z localStorage');
              const localEventsKey = 'admin_events_log';
              let localEvents = JSON.parse(localStorage.getItem(localEventsKey) || '[]');
              const originalLength = localEvents.length;
              localEvents = localEvents.filter(event => event.id !== eventId);

              if (localEvents.length === originalLength) {
                showNotification("Zdarzenie nie zosta≈Ço znalezione", "error");
                return;
              }

              localStorage.setItem(localEventsKey, JSON.stringify(localEvents));
          }

          // Animacja usuniƒôcia elementu
          const eventElement = buttonElement.closest('.flex.items-center.justify-between');
          if (eventElement) {
            eventElement.style.transition = 'all 0.3s ease';
            eventElement.style.opacity = '0';
            eventElement.style.transform = 'translateX(-20px)';
            setTimeout(() => {
              // Od≈õwie≈º tabelƒô
              loadEventsLog();
            }, 300);
          } else {
            // Je≈õli nie ma elementu, od≈õwie≈º od razu
            loadEventsLog();
          }

          showNotification("Zdarzenie zosta≈Ço usuniƒôte", "success");

        } catch (error) {
          console.error('B≈ÇƒÖd podczas usuwania zdarzenia:', error);
          showNotification("B≈ÇƒÖd podczas usuwania zdarzenia", "error");
        } finally {
          // Przywr√≥ƒá przycisk do normalnego stanu
          if (buttonElement) {
            setTimeout(() => {
              buttonElement.disabled = false;
              buttonElement.innerHTML = '<i class="fa-solid fa-trash"></i>';
              buttonElement.classList.remove('opacity-50');
            }, 300);
          }
        }
      }

        // Sprawdzanie statusu wszystkich stron
      async function checkSitesStatus() {
        const statusContainer = document.getElementById("sites-status");
        statusContainer.innerHTML =
          '<div class="col-span-full text-center text-zinc-400 py-4"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Sprawdzanie status√≥w...</div>';

        // Sprawd≈∫ wszystkie strony r√≥wnolegle dla lepszej wydajno≈õci
        const promises = SITES_TO_CHECK.map((site) =>
          checkSubdomainStatus(site),
        );
        const results = await Promise.allSettled(promises);

        // Zapisz wyniki i loguj zdarzenia
        SITES_TO_CHECK.forEach((site, index) => {
          const result = results[index];
          const previousStatus = sitesStatus[site];

          if (result.status === "fulfilled") {
            const currentStatus = result.value;
            sitesStatus[site] = currentStatus;

            // Loguj tylko zmiany stanu: offline -> online
            if (previousStatus && !previousStatus.online && currentStatus.online) {
              logEvent('site_online', site, 'Strona wr√≥ci≈Ça do dzia≈Çania');
            }

          } else {
            const errorStatus = {
              online: false,
              lastCheck: new Date(),
              error: result.reason.message,
            };
            sitesStatus[site] = errorStatus;

            // Loguj tylko zmiany stanu: online -> offline
            if (!previousStatus || previousStatus.online) {
              logEvent('site_offline', site, `Strona sta≈Ça siƒô niedostƒôpna: ${result.reason.message}`);
            }
          }
        });

          renderSitesStatus();
          loadEventsLog();
          lastStatusCheck = new Date();
        const lastStatusCheckEl = document.getElementById("last-status-check");
        if (lastStatusCheckEl) lastStatusCheckEl.textContent = lastStatusCheck.toLocaleString("pl-PL");
        }

        function renderSitesStatus() {
        const statusContainer = document.getElementById("sites-status");
        const statusHtml = SITES_TO_CHECK.map((site) => {
            const status = sitesStatus[site];
          if (!status) return "";

          let statusClass, statusIcon, statusText;

          if (status.online) {
            statusClass = "text-green-400";
            statusIcon = "fa-circle";
            statusText = "Online";
          } else {
            statusClass = "text-red-400";
            statusIcon = "fa-circle";
            statusText = "Offline";
          }

            return `
              <div class="flex justify-between items-center p-3 bg-zinc-800 rounded-lg animate-fade-in">
                <span class="text-sm font-medium">${site}</span>
                <span class="${statusClass} text-sm font-medium">
                  <i class="fa-solid ${statusIcon} mr-1"></i>${statusText}
                </span>
              </div>
            `;
        }).join("");

          statusContainer.innerHTML = statusHtml;
        }


        // Funkcje aktywno≈õci
        async function loadActivityStats() {
          try {
            // Symulacja danych - w rzeczywisto≈õci pobieraƒá z Firebase
            const activeUsersEl = document.getElementById("active-users-count");
            if (activeUsersEl) activeUsersEl.textContent = Math.floor(Math.random() * 50) + 10;

            const todayVisitsEl = document.getElementById("today-visits");
            if (todayVisitsEl) todayVisitsEl.textContent = Math.floor(Math.random() * 500) + 100;

            const todayContactsEl = document.getElementById("today-contacts");
            if (todayContactsEl) todayContactsEl.textContent = Math.floor(Math.random() * 20) + 5;

            const pendingTasksEl = document.getElementById("pending-tasks");
            if (pendingTasksEl) pendingTasksEl.textContent = Math.floor(Math.random() * 15) + 3;

            const weekVisitsEl = document.getElementById("week-visits");
            if (weekVisitsEl) weekVisitsEl.textContent = Math.floor(Math.random() * 2000) + 500;

            const monthVisitsEl = document.getElementById("month-visits");
            if (monthVisitsEl) monthVisitsEl.textContent = Math.floor(Math.random() * 8000) + 2000;

            const yearVisitsEl = document.getElementById("year-visits");
            if (yearVisitsEl) yearVisitsEl.textContent = Math.floor(Math.random() * 50000) + 10000;
          } catch (error) {
          console.error("Error loading activity stats:", error);
          }
        }

        // Funkcje zdarze≈Ñ
        let eventsData = [];

        async function loadRecentEvents() {
          try {
            // Symulacja zdarze≈Ñ - w rzeczywisto≈õci pobieraƒá z Firebase
            eventsData = [];

            renderRecentEvents();
          const lastEventsUpdateEl = document.getElementById("last-events-update");
          if (lastEventsUpdateEl) lastEventsUpdateEl.textContent = new Date().toLocaleString("pl-PL");
          } catch (error) {
          console.error("Error loading events:", error);
          }
        }

        function renderRecentEvents() {
        const eventsContainer = document.getElementById("recent-events");
          const recentEvents = eventsData.slice(0, 10); // Poka≈º 10 najnowszych

        const eventsHtml = recentEvents
          .map((event) => {
            const timeAgo = getTimeAgo(event.timestamp);
            const activityLog = renderActivityLog(event);
            return `
              <div class="p-4 bg-zinc-800 rounded-lg cursor-pointer hover:bg-zinc-700 transition" onclick="showEventDetails('${event.id}')">
                <div class="flex justify-between items-start mb-2">
                  <div class="font-semibold text-white">${event.user || "System"}</div>
                  <div class="text-xs text-zinc-500">${timeAgo}</div>
                </div>
                <div class="text-sm text-zinc-300">${activityLog.description}</div>
                <div class="text-xs text-zinc-500 mt-1">${activityLog.content}</div>
              </div>
            `;
          })
          .join("");

        eventsContainer.innerHTML =
          eventsHtml ||
          '<div class="text-center text-zinc-500 py-4">Brak zdarze≈Ñ</div>';
        }

        function getTimeAgo(date) {
          const now = new Date();
          const diffMs = now - date;
          const diffMins = Math.floor(diffMs / (1000 * 60));
          const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
          const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

          if (diffMins < 60) return `${diffMins} min temu`;
          if (diffHours < 24) return `${diffHours} godz. temu`;
          return `${diffDays} dni temu`;
        }

        // Modal ze szczeg√≥≈Çami zdarzenia
        function showEventDetails(eventId) {
        const event = eventsData.find((e) => e.id === eventId);
          if (!event) return;

        const activityLog = renderActivityLog(event);

          // Utw√≥rz modal
          const modalHtml = `
            <div id="event-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
              <div class="bg-zinc-900 p-6 rounded-2xl border border-zinc-700 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                  <h2 class="text-2xl font-bold coyote-text">Szczeg√≥≈Çy Zdarzenia</h2>
                  <button onclick="closeEventModal()" class="text-zinc-400 hover:text-white">
                    <i class="fa-solid fa-times text-xl"></i>
                  </button>
                </div>

                <div class="space-y-4">
                  <div>
                    <label class="text-sm text-zinc-400">U≈ºytkownik:</label>
                    <div class="text-white font-semibold">${event.user || "System"}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Rodzaj zdarzenia:</label>
                    <div class="text-white">${event.type}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Nag≈Ç√≥wek:</label>
                    <div class="text-white">${activityLog.description}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Szczeg√≥≈Çy:</label>
                    <div class="text-white">${activityLog.details}</div>
                  </div>

                  <div>
                    <label class="text-sm text-zinc-400">Data i czas:</label>
                    <div class="text-white">${event.timestamp?.toDate?.()?.toLocaleString("pl-PL") || new Date(event.timestamp).toLocaleString("pl-PL")}</div>
                  </div>
                </div>
              </div>
            </div>
          `;

        document.body.insertAdjacentHTML("beforeend", modalHtml);
        }

        window.closeEventModal = () => {
        const modal = document.getElementById("event-modal");
          if (modal) modal.remove();
        };

        // Funkcja sprawdzania g≈Ç√≥wnych us≈Çug serwera
        async function checkMainServicesStatus() {
          try {
            // Sprawd≈∫ Firestore
          const firestoreStatus = document.getElementById("firestore-status");
          const firestoreIcon = firestoreStatus.querySelector("i");
          const firestoreText =
            firestoreStatus.querySelector("span:last-child");

          // Poka≈º ≈Çadowanie dla Firestore
          firestoreIcon.className = "fa-solid fa-spinner fa-spin text-lg text-zinc-400";
          firestoreText.className = "text-zinc-400 font-semibold text-sm";
          firestoreText.textContent = "Sprawdzanie...";

            // Sprawd≈∫ Auth
          const authStatus = document.getElementById("auth-status");
          const authIcon = authStatus.querySelector("i");
          const authText = authStatus.querySelector("span:last-child");

          // Poka≈º ≈Çadowanie dla Auth
          authIcon.className = "fa-solid fa-spinner fa-spin text-lg text-zinc-400";
          authText.className = "text-zinc-400 font-semibold text-sm";
          authText.textContent = "Sprawdzanie...";

            // Sprawd≈∫ domenƒô
          const domainStatus = document.getElementById("domain-status");
          const domainIcon = domainStatus.querySelector("i");
          const domainText = domainStatus.querySelector("span:last-child");

          // Poka≈º ≈Çadowanie dla domeny
          domainIcon.className = "fa-solid fa-spinner fa-spin text-lg text-zinc-400";
          domainText.className = "text-zinc-400 font-semibold text-sm";
          domainText.textContent = "Sprawdzanie...";

            let allServicesOnline = true;

            // Sprawd≈∫ Firestore
            try {
              const testDoc = await getDoc(doc(db, "test", "connection"));
              const firestoreOnline = true;

              // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_online (je≈õli nie, utw√≥rz)
              const lastOnlineEvent = await getLastEventForService('Baza danych', 'service_online');
              if (!lastOnlineEvent) {
                logEvent('service_online', 'Baza danych', 'Baza danych Firestore przywr√≥cona');
              }

              firestoreIcon.className = "fa-solid fa-check-circle text-lg text-green-400";
              firestoreText.className = "text-green-400 font-semibold text-sm";
              firestoreText.textContent = "Online";
            } catch (error) {
              console.error("Firestore error:", error);
              const firestoreOnline = false;

              // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_offline (je≈õli nie, utw√≥rz)
              const lastOfflineEvent = await getLastEventForService('Baza danych', 'service_offline');
              if (!lastOfflineEvent) {
                logEvent('service_offline', 'Baza danych', 'Baza danych Firestore niedostƒôpna: ' + error.message);
              }

              firestoreIcon.className = "fa-solid fa-times-circle text-lg text-red-400";
              firestoreText.className = "text-red-400 font-semibold text-sm";
              firestoreText.textContent = "Offline";
              allServicesOnline = false;
            }

            // Sprawd≈∫ Auth - czy kto≈õ jest zalogowany (opr√≥cz lokalnego administratora)
            try {
              // Sprawd≈∫ czy jest jaki≈õ zalogowany u≈ºytkownik
              if (auth.currentUser) {
                // Sprawd≈∫ czy to nie jest lokalny administrator
                const userEmail = auth.currentUser.email;
                const isLocalAdmin = userEmail === 'admin@local' || userEmail === 'admin';

                if (!isLocalAdmin) {
                  // Jest zalogowany rzeczywisty u≈ºytkownik - Auth dzia≈Ça
                  const authOnline = true;

                  // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_online
                  const lastOnlineEvent = await getLastEventForService('Logowanie', 'service_online');
                  if (!lastOnlineEvent) {
                    logEvent('service_online', 'Logowanie', 'System logowania przywr√≥cony');
                  }

                  authIcon.className = "fa-solid fa-check-circle text-lg text-green-400";
                authText.className = "text-green-400 font-semibold text-sm";
                authText.textContent = "Po≈ÇƒÖczony";
              } else {
                  // Tylko lokalny administrator - traktuj jako nieaktywne
                  const authOnline = false;

                  // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_offline
                  const lastOfflineEvent = await getLastEventForService('Logowanie', 'service_offline');
                  if (!lastOfflineEvent) {
                    logEvent('service_offline', 'Logowanie', 'Brak aktywnych u≈ºytkownik√≥w w systemie logowania');
                  }

                  authIcon.className = "fa-solid fa-times-circle text-lg text-orange-400";
                  authText.className = "text-orange-400 font-semibold text-sm";
                  authText.textContent = "Tylko lokalny";
                  allServicesOnline = false;
                }
              } else {
                // Nikt nie jest zalogowany
                const authOnline = false;

                // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_offline
                const lastOfflineEvent = await getLastEventForService('Logowanie', 'service_offline');
                if (!lastOfflineEvent) {
                  logEvent('service_offline', 'Logowanie', 'Brak zalogowanych u≈ºytkownik√≥w w systemie');
                }

                authIcon.className = "fa-solid fa-times-circle text-lg text-orange-400";
                authText.className = "text-orange-400 font-semibold text-sm";
                authText.textContent = "Roz≈ÇƒÖczony";
                allServicesOnline = false;
              }
            } catch (error) {
              console.error("Auth error:", error);
              const authOnline = false;

              // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_offline
              const lastOfflineEvent = await getLastEventForService('Logowanie', 'service_offline');
              if (!lastOfflineEvent) {
                logEvent('service_offline', 'Logowanie', 'B≈ÇƒÖd systemu logowania: ' + error.message);
              }

              authIcon.className = "fa-solid fa-times-circle text-lg text-red-400";
              authText.className = "text-red-400 font-semibold text-sm";
              authText.textContent = "B≈ÇƒÖd";
              allServicesOnline = false;
            }

            // Sprawd≈∫ domenƒô - dostƒôpno≈õƒá g≈Ç√≥wnego pliku index.html
            try {
              const response = await fetch(window.location.origin + '/index.html', {
              method: "HEAD",
                cache: "no-cache"
              });

              if (response.ok) {
                const domainOnline = true;

                // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_online
                const lastOnlineEvent = await getLastEventForService('Domena', 'service_online');
                if (!lastOnlineEvent) {
                  logEvent('service_online', 'Domena', 'Domena g≈Ç√≥wna przywr√≥cona');
                }

                domainIcon.className = "fa-solid fa-check-circle text-lg text-green-400";
              domainText.className = "text-green-400 font-semibold text-sm";
                domainText.textContent = "Dostƒôpna";
              } else {
                const domainOnline = false;

                // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_offline
                const lastOfflineEvent = await getLastEventForService('Domena', 'service_offline');
                if (!lastOfflineEvent) {
                  logEvent('service_offline', 'Domena', 'Domena g≈Ç√≥wna niedostƒôpna (HTTP ' + response.status + ')');
                }

                domainIcon.className = "fa-solid fa-times-circle text-lg text-red-400";
                domainText.className = "text-red-400 font-semibold text-sm";
                domainText.textContent = "Niedostƒôpna (" + response.status + ")";
                allServicesOnline = false;
              }
            } catch (error) {
              console.error("Domain error:", error);
              const domainOnline = false;

              // Sprawd≈∫ czy ju≈º istnieje zdarzenie service_offline
              const lastOfflineEvent = await getLastEventForService('Domena', 'service_offline');
              if (!lastOfflineEvent) {
                logEvent('service_offline', 'Domena', 'B≈ÇƒÖd dostƒôpu do domeny g≈Ç√≥wnej: ' + error.message);
              }

              domainIcon.className = "fa-solid fa-times-circle text-lg text-red-400";
              domainText.className = "text-red-400 font-semibold text-sm";
              domainText.textContent = "B≈ÇƒÖd";
              allServicesOnline = false;
            }

            // Aktualizuj kolor zak≈Çadki status
          const statusTabText = document.getElementById("status-tab-text");
            if (allServicesOnline) {
              statusTabText.className = "text-green-400";
            } else {
              statusTabText.className = "text-red-400";
            }

            // Aktualizuj czas ostatniego sprawdzenia
          const lastStatusCheckEl = document.getElementById("last-status-check");
          if (lastStatusCheckEl) lastStatusCheckEl.textContent = new Date().toLocaleString("pl-PL");

            // Sprawd≈∫ r√≥wnie≈º status subdomen
            await checkSitesStatus();

            showNotification("Status wszystkich us≈Çug zosta≈Ç zaktualizowany", "success");
          } catch (error) {
            console.error("Error checking main services:", error);
            showNotification("B≈ÇƒÖd sprawdzania statusu us≈Çug", "error");
          }
        }


        async function clearAllEvents() {
          if (!confirm('Czy na pewno chcesz usunƒÖƒá WSZYSTKIE zdarzenia? Tej operacji nie mo≈ºna cofnƒÖƒá.')) {
            return;
          }

          try {
            // Spr√≥buj wyczy≈õciƒá przez API
            const apiResponse = await fetch(getApiUrl('/api/events-log'), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify([])
            });

            if (apiResponse.ok) {
              // Wyczy≈õƒá te≈º localStorage
              localStorage.removeItem('admin_events_log');
              showNotification("Wszystkie zdarzenia zosta≈Çy usuniƒôte", "success");
            } else {
              throw new Error('API error');
            }
          } catch (apiError) {
            // API niedostƒôpne - wyczy≈õƒá tylko localStorage
            console.warn('API niedostƒôpne, usuwam tylko lokalne dane');
            localStorage.removeItem('admin_events_log');
            showNotification("Lokalne zdarzenia zosta≈Çy usuniƒôte", "success");
          }

          // Od≈õwie≈º tabelƒô
          loadEventsLog();
        }

        window.checkSitesStatus = checkSitesStatus;
        window.checkMainServicesStatus = checkMainServicesStatus;
        window.refreshEvents = loadRecentEvents;
        window.loadEventsLog = loadEventsLog;
        window.deleteEvent = deleteEvent;
        window.clearAllEvents = clearAllEvents;

        // Sprawd≈∫ dostƒôpno≈õƒá API przy starcie
        async function checkApiAvailability() {
          try {
            const response = await fetch(getApiUrl('/api/status'), { timeout: 5000 });
            return response.ok;
          } catch (error) {
            console.warn('API niedostƒôpne:', error.message);
            return false;
          }
        }

        // Inicjalizacja - za≈Çaduj logi zdarze≈Ñ je≈õli jeste≈õmy w zak≈Çadce status
        if (document.querySelector('#tab-status.active')) {
          setTimeout(async () => {
            const apiAvailable = await checkApiAvailability();
            if (!apiAvailable) {
              console.warn('API niedostƒôpne - niekt√≥re funkcje mogƒÖ nie dzia≈Çaƒá');
              const container = document.getElementById('events-log-container');
              if (container) {
                container.innerHTML = '<div class="text-center text-orange-400 py-4"><i class="fa-solid fa-exclamation-triangle mr-2"></i>API serwera niedostƒôpne - sprawd≈∫ konfiguracjƒô</div>';
              }
            } else {
              loadEventsLog();
            }
          }, 100);
        }
        window.openEventsPanel = () => {
          // TODO: Implement full events panel with filtering
        alert("Panel wszystkich zdarze≈Ñ bƒôdzie dostƒôpny wkr√≥tce");
        };
        window.showEventDetails = showEventDetails;

      // Integracja z activityLogs - Firestore listener
      function setupActivityLogsListener() {
        if (activityLogsListener) {
          clearInterval(activityLogsListener); // Od≈ÇƒÖcz poprzedni interval
        }

        // Zamiast real-time listener, u≈ºyj pollingu co 30 sekund
        activityLogsListener = setInterval(async () => {
          try {
            const response = await fetch('/api/admin/activity-logs?limit=10');
            if (response.ok) {
              const data = await response.json();
              eventsData = data.logs || [];

            renderRecentEvents();
              const lastEventsUpdateEl = document.getElementById("last-events-update");
              if (lastEventsUpdateEl) lastEventsUpdateEl.textContent = new Date().toLocaleString("pl-PL");
            }
          } catch (error) {
            console.error("Activity logs polling error:", error);
            showNotification("B≈ÇƒÖd ≈Çadowania log√≥w aktywno≈õci.", "error");
          }
        }, 30000); // Co 30 sekund

        // Pierwsze wywo≈Çanie natychmiastowe
        setTimeout(async () => {
          try {
            const response = await fetch('/api/admin/activity-logs?limit=10');
            if (response.ok) {
              const data = await response.json();
              eventsData = data.logs || [];

              renderRecentEvents();
              const lastEventsUpdateEl = document.getElementById("last-events-update");
              if (lastEventsUpdateEl) lastEventsUpdateEl.textContent = new Date().toLocaleString("pl-PL");
            }
          } catch (error) {
            console.error("Initial activity logs load error:", error);
          }
        }, 1000);
      }

      function setupPendingTasksListener() {
        if (pendingTasksListener) {
          clearInterval(pendingTasksListener); // Od≈ÇƒÖcz poprzedni interval
        }

        // Zamiast real-time listener, u≈ºyj pollingu co 60 sekund
        pendingTasksListener = setInterval(async () => {
          try {
            await loadPendingTasksCount(); // U≈ºyj istniejƒÖcej funkcji
          } catch (error) {
            console.error("Pending tasks polling error:", error);
          }
        }, 60000); // Co 60 sekund

        // Pierwsze wywo≈Çanie natychmiastowe
        setTimeout(async () => {
          try {
            await loadPendingTasksCount();
          } catch (error) {
            console.error("Initial pending tasks load error:", error);
          }
        }, 2000);
      }

      // Funkcja renderowania pojedynczego logu aktywno≈õci
      function renderActivityLog(event) {
        let description = "";
        let content = "";
        let details = "";

        switch (event.type) {
          case "MESSAGE_SENT":
            description = `${event.user} wys≈Ça≈Ç wiadomo≈õƒá`;
            content = event.content || "Tre≈õƒá niedostƒôpna";
            details = `U≈ºytkownik ${event.user} wys≈Ça≈Ç wiadomo≈õƒá do ${event.recipient || "innego u≈ºytkownika"} o tre≈õci: "${event.content || "Tre≈õƒá niedostƒôpna"}"`;
            break;
          case "LIKE_BLOG":
            description = `${event.user} polubi≈Ç post`;
            content = event.content || "Tytu≈Ç niedostƒôpny";
            details = `U≈ºytkownik ${event.user} polubi≈Ç post na blogu: "${event.content || "Tytu≈Ç niedostƒôpny"}"`;
            break;
          case "CONTACT_FORM":
            description = `${event.user} wype≈Çni≈Ç formularz kontaktowy`;
            content = event.subject || "Zapytanie";
            details = `U≈ºytkownik ${event.user} wype≈Çni≈Ç formularz kontaktowy z tematem: "${event.subject || "Zapytanie"}"`;
            break;
          case "USER_REGISTER":
            description = `${event.user} zarejestrowa≈Ç siƒô`;
            content = "Nowe konto";
            details = `U≈ºytkownik ${event.user} pomy≈õlnie zarejestrowa≈Ç nowe konto w systemie`;
            break;
          case "PRODUCT_VIEW":
            description = `${event.user} przeglƒÖda≈Ç produkt`;
            content = event.productName || "Produkt";
            details = `U≈ºytkownik ${event.user} przeglƒÖda≈Ç produkt: "${event.productName || "Produkt"}"`;
            break;
          default:
            description = `${event.user} wykona≈Ç akcjƒô ${event.type}`;
            content = event.content || "Szczeg√≥≈Çy niedostƒôpne";
            details = `U≈ºytkownik ${event.user} wykona≈Ç akcjƒô typu ${event.type}: ${event.content || "Szczeg√≥≈Çy niedostƒôpne"}`;
        }

        return { description, content, details };
      }

      // Funkcje licznik√≥w formularzy i niezako≈Ñczonych spraw
      async function loadContactFormsCount() {
        try {
          // U≈ºyj API zamiast bezpo≈õredniego dostƒôpu do Firestore
          const response = await fetch('/api/admin/stats/contact-forms-today');
          if (response.ok) {
            const data = await response.json();
            const todayContactsEl = document.getElementById("today-contacts");
            if (todayContactsEl) todayContactsEl.textContent = data.count || 0;
          } else {
            console.warn("API request failed:", response.status);
            const todayContactsEl = document.getElementById("today-contacts");
            if (todayContactsEl) todayContactsEl.textContent = "0";
          }
        } catch (error) {
          console.error("Error loading contact forms count:", error);
          const todayContactsEl = document.getElementById("today-contacts");
          if (todayContactsEl) todayContactsEl.textContent = "0";
        }
      }

      async function loadPendingTasksCount() {
        try {
          // U≈ºyj API zamiast bezpo≈õredniego dostƒôpu do Firestore
          const response = await fetch('/api/admin/stats/pending-tasks');
          if (response.ok) {
            const data = await response.json();
            const pendingTasksEl = document.getElementById("pending-tasks");
            if (pendingTasksEl) pendingTasksEl.textContent = data.count || 0;
          } else {
            console.warn("API request failed:", response.status);
            const pendingTasksEl = document.getElementById("pending-tasks");
            if (pendingTasksEl) pendingTasksEl.textContent = "0";
          }
        } catch (error) {
          console.error("Error loading pending tasks count:", error);
          const pendingTasksEl = document.getElementById("pending-tasks");
          if (pendingTasksEl) pendingTasksEl.textContent = "0";
        }
      }

      // Placeholder dla Google Analytics - przygotowanie do integracji
      async function fetchGAStatistics() {
        try {
          // TODO: Integracja z Google Analytics Data API
          // Wymaga Service Account i odpowiednich uprawnie≈Ñ

          const today = new Date().toISOString().split("T")[0];
          const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];
          const yearAgo = new Date(Date.now() - 365 * 24 * 60 * 60 * 1000)
            .toISOString()
            .split("T")[0];

          // Placeholder - w rzeczywisto≈õci pobieraƒá z GA API
          const todayVisitsEl = document.getElementById("today-visits");
          if (todayVisitsEl) todayVisitsEl.textContent = Math.floor(Math.random() * 500) + 100;

          const weekVisitsEl = document.getElementById("week-visits");
          if (weekVisitsEl) weekVisitsEl.textContent = Math.floor(Math.random() * 2000) + 500;

          const monthVisitsEl = document.getElementById("month-visits");
          if (monthVisitsEl) monthVisitsEl.textContent = Math.floor(Math.random() * 8000) + 2000;

          const yearVisitsEl = document.getElementById("year-visits");
          if (yearVisitsEl) yearVisitsEl.textContent = Math.floor(Math.random() * 50000) + 10000;

          console.log("GA Statistics fetched (placeholder implementation)");
        } catch (error) {
          console.error("Error fetching GA statistics:", error);
          // Fallback warto≈õci
          const todayVisitsEl = document.getElementById("today-visits");
          if (todayVisitsEl) todayVisitsEl.textContent = "0";

          const weekVisitsEl = document.getElementById("week-visits");
          if (weekVisitsEl) weekVisitsEl.textContent = "0";

          const monthVisitsEl = document.getElementById("month-visits");
          if (monthVisitsEl) monthVisitsEl.textContent = "0";

          const yearVisitsEl = document.getElementById("year-visits");
          if (yearVisitsEl) yearVisitsEl.textContent = "0";
        }
      }

      window.editProduct = (productId) => {
        const product = productsList.find((p) => p.id === productId);
        if (!product) return;

        document.getElementById("product-id").value = product.id;
        document.getElementById("product-title").value = product.title || "";
        document.getElementById("product-price").value = product.price || "";
        document.getElementById("product-description").innerHTML =
          product.description || "";

        // Scroll do formularza
        document
          .querySelector("#tab-products")
          .scrollIntoView({ behavior: "smooth" });
      };

      window.deleteProduct = async (productId) => {
        if (!confirm("Czy na pewno chcesz usunƒÖƒá ten produkt?")) return;

        try {
          await deleteDoc(doc(db, "products", productId));
          showNotification("Produkt zosta≈Ç usuniƒôty.");
          loadProducts();
        } catch (error) {
          console.error("Error deleting product:", error);
          showNotification("B≈ÇƒÖd usuwania produktu.", "error");
        }
      };

      window.sendMessage = () => {
        // Placeholder - implementacja wysy≈Çania wiadomo≈õci
        showNotification(
          "Funkcja wysy≈Çania wiadomo≈õci bƒôdzie dostƒôpna wkr√≥tce.",
        );
      };

      window.addTopic = () => {
        // Placeholder - implementacja dodawania tematu
        showNotification("Funkcja dodawania tematu bƒôdzie dostƒôpna wkr√≥tce.");
      };

      // Obs≈Çuga formularza produktu
      document
        .getElementById("product-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const productId = document.getElementById("product-id").value;
          const title = document.getElementById("product-title").value.trim();
          const price = document.getElementById("product-price").value.trim();
          const description = document.getElementById(
            "product-description",
          ).innerHTML;

          if (!title || !price) {
            showNotification("Wype≈Çnij wszystkie wymagane pola.", "error");
            return;
          }

          try {
            const productData = {
              title,
              price,
              description,
              date: Date.now(),
              order: productsList.length,
            };

            if (productId) {
              // Aktualizacja istniejƒÖcego produktu
              await updateDoc(doc(db, "products", productId), productData);
              showNotification("Produkt zosta≈Ç zaktualizowany.");
            } else {
              // Dodanie nowego produktu
              await addDoc(collection(db, "products"), productData);
              showNotification("Produkt zosta≈Ç dodany.");
            }

            // Wyczy≈õƒá formularz
            document.getElementById("product-form").reset();
            document.getElementById("product-description").innerHTML = "";
            document.getElementById("product-id").value = "";

            loadProducts();
          } catch (error) {
            console.error("Error saving product:", error);
            showNotification("B≈ÇƒÖd zapisywania produktu.", "error");
          }
        });

      // Obs≈Çuga formularza edycji u≈ºytkownika
      document
        .getElementById("user-edit-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("edit-user-id").value;
          if (!userId) return;

          const saveBtn = e.target.querySelector('button[type="submit"]');
          saveBtn.disabled = true;
          saveBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Zapisywanie...';

          try {
            // Zaszyfruj wra≈ºliwe dane przed zapisaniem
            const updatedProfile = {
              displayName: document
                .getElementById("edit-display-name")
                .value.trim(),
              firstName: document
                .getElementById("edit-first-name")
                .value.trim(),
              lastName: document.getElementById("edit-last-name").value.trim(),
              phone: btoa(document.getElementById("edit-phone").value.trim()),
              address: {
                street: btoa(
                  document.getElementById("edit-street").value.trim(),
                ),
                buildingNumber: btoa(
                  document.getElementById("edit-building-number").value.trim(),
                ),
                postalCode: btoa(
                  document.getElementById("edit-postal-code").value.trim(),
                ),
                city: btoa(document.getElementById("edit-city").value.trim()),
              },
              parcelLocker: btoa(
                document.getElementById("edit-parcel-locker").value.trim(),
              ),
              newsletter: document.getElementById("edit-newsletter").checked,
              role: document.getElementById("edit-role").value,
              status: document.getElementById("edit-status").value,
              updatedAt: new Date(),
              updatedBy: currentUser.uid,
            };

            await updateDoc(doc(db, "userProfiles", userId), updatedProfile);

            // Zaloguj edycjƒô profilu
            await logActivity(userId, "PROFILE_EDITED", {
              editedBy: currentUser.uid,
              changes: Object.keys(updatedProfile),
            });

            showNotification("Dane u≈ºytkownika zosta≈Çy zaktualizowane.");
            closeUserEdit();
            loadUsers(); // Od≈õwie≈º listƒô u≈ºytkownik√≥w
          } catch (error) {
            console.error("Error updating user:", error);
            showNotification(
              "B≈ÇƒÖd podczas aktualizacji danych u≈ºytkownika.",
              "error",
            );
          } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML =
              '<i class="fa-solid fa-save mr-2"></i>Zapisz zmiany';
          }
        });

      // Obs≈Çuga formularza blokowania u≈ºytkownika
      document
        .getElementById("user-block-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("block-user-id").value;
          if (!userId) return;

          const duration = document.getElementById("block-duration").value;
          const contentAction = document.querySelector(
            'input[name="content-action"]:checked',
          ).value;

          const blockBtn = e.target.querySelector('button[type="submit"]');
          blockBtn.disabled = true;
          blockBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Blokowanie...';

          try {
            // Oblicz datƒô zako≈Ñczenia blokady
            let blockedUntil = null;
            const now = new Date();

            switch (duration) {
              case "15min":
                blockedUntil = new Date(now.getTime() + 15 * 60 * 1000);
                break;
              case "1hour":
                blockedUntil = new Date(now.getTime() + 60 * 60 * 1000);
                break;
              case "6hours":
                blockedUntil = new Date(now.getTime() + 6 * 60 * 60 * 1000);
                break;
              case "24hours":
                blockedUntil = new Date(now.getTime() + 24 * 60 * 60 * 1000);
                break;
              case "7days":
                blockedUntil = new Date(
                  now.getTime() + 7 * 24 * 60 * 60 * 1000,
                );
                break;
              case "30days":
                blockedUntil = new Date(
                  now.getTime() + 30 * 24 * 60 * 60 * 1000,
                );
                break;
              case "permanent":
                blockedUntil = null; // Blokada permanentna
                break;
            }

            const blockData = {
              status: "blocked",
              blockedAt: now,
              blockedUntil: blockedUntil,
              blockedBy: currentUser.uid,
              blockDuration: duration,
              contentAction: contentAction,
              isPermanentBlock: duration === "permanent",
            };

            await updateDoc(doc(db, "userProfiles", userId), blockData);

            // Zaloguj blokadƒô u≈ºytkownika
            await logActivity(userId, "USER_BLOCKED", {
              duration: duration,
              blockedUntil: blockedUntil,
              contentAction: contentAction,
              isPermanent: duration === "permanent",
              blockedBy: currentUser.uid,
            });

            // Je≈õli wybrano usuniƒôcie zawarto≈õci, tutaj nale≈ºa≈Çoby dodaƒá logikƒô usuwania
            // (produkty, wiadomo≈õci, itp.) - bƒôdzie implementowane w nastƒôpnych krokach

            showNotification(
              `U≈ºytkownik zosta≈Ç zablokowany${blockedUntil ? " do " + blockedUntil.toLocaleString("pl-PL") : " na zawsze"}.`,
            );
            closeUserBlock();
            loadUsers();
          } catch (error) {
            console.error("Error blocking user:", error);
            showNotification("B≈ÇƒÖd podczas blokowania u≈ºytkownika.", "error");
          } finally {
            blockBtn.disabled = false;
            blockBtn.innerHTML =
              '<i class="fa-solid fa-ban mr-2"></i>Zablokuj u≈ºytkownika';
          }
        });

      // Obs≈Çuga formularza usuwania u≈ºytkownika
      document
        .getElementById("user-delete-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const userId = document.getElementById("delete-user-id").value;
          if (!userId) return;

          const contentAction = document.querySelector(
            'input[name="delete-content-action"]:checked',
          ).value;

          const deleteBtn = e.target.querySelector('button[type="submit"]');
          deleteBtn.disabled = true;
          deleteBtn.innerHTML =
            '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Usuwanie...';

          try {
            if (contentAction === "remove") {
              // Usu≈Ñ ca≈ÇƒÖ zawarto≈õƒá u≈ºytkownika - tutaj nale≈ºa≈Çoby dodaƒá logikƒô usuwania
              // produkt√≥w, wiadomo≈õci, komentarzy itp. z innych kolekcji
              // Na razie tylko oznaczamy, ≈ºe zawarto≈õƒá zosta≈Ça usuniƒôta
              console.log("Usuwanie zawarto≈õci u≈ºytkownika:", userId);
            }

            // Usu≈Ñ profil u≈ºytkownika
            await deleteDoc(doc(db, "userProfiles", userId));

            // Zaloguj usuniƒôcie u≈ºytkownika PRZED faktycznym usuniƒôciem
            await logActivity(userId, "USER_DELETED", {
              contentAction: contentAction,
              deletedBy: currentUser.uid,
              userEmail: currentDeletingUser.email,
              userDisplayName: currentDeletingUser.displayName,
            });

            // Usu≈Ñ z listy mailingowej je≈õli by≈Ç zapisany
            try {
              await deleteDoc(
                doc(db, "mailingList", currentDeletingUser.email),
              );
            } catch (error) {
              // Ignoruj b≈ÇƒÖd je≈õli u≈ºytkownik nie by≈Ç na li≈õcie mailingowej
            }

            showNotification(
              `U≈ºytkownik zosta≈Ç ca≈Çkowicie usuniƒôty z systemu${contentAction === "keep" ? " (zawarto≈õƒá zachowana)" : " (zawarto≈õƒá usuniƒôta)"}.`,
            );
            closeUserDelete();
            loadUsers();
          } catch (error) {
            console.error("Error deleting user:", error);
            showNotification("B≈ÇƒÖd podczas usuwania u≈ºytkownika.", "error");
          } finally {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML =
              '<i class="fa-solid fa-trash mr-2"></i>Usu≈Ñ u≈ºytkownika';
          }
        });

      // Automatyczne od≈õwie≈ºanie co 1 godzinƒô (aby nie traciƒá limit√≥w Firebase)
      setInterval(
        async () => {
          if (currentUser && !currentUser.isLocalAdmin) {
            // Tylko dla administrator√≥w Firebase (nie lokalnych)
          try {
            await checkSitesStatus();
              // Activity logs sƒÖ automatycznie aktualizowane przez listener
              console.log(
                "Dashboard auto-refreshed at",
                new Date().toLocaleString("pl-PL"),
              );
          } catch (error) {
              console.error("Auto-refresh error:", error);
            }
          }
        },
        60 * 60 * 1000,
      ); // 1 godzina

      // ===== FUNKCJE DO MODERACJI OPINII =====

      // ≈Åadowanie opinii do moderacji
      async function loadReviews() {
        try {
          document.getElementById("reviews-loading").classList.remove("hidden");
          document.getElementById("reviews-empty").classList.add("hidden");

          const reviewsQuery = query(
            collection(db, "userReviews"),
            orderBy("timestamp", "desc"),
          );

          const reviewsSnapshot = await getDocs(reviewsQuery);
          const reviews = reviewsSnapshot.docs.map((doc) => ({
            id: doc.id,
            ...doc.data(),
          }));

          displayReviewsForModeration(reviews);
        } catch (error) {
          console.error("B≈ÇƒÖd ≈Çadowania opinii:", error);
          showNotification("B≈ÇƒÖd ≈Çadowania opinii", "error");
        } finally {
          document.getElementById("reviews-loading").classList.add("hidden");
        }
      }

      // Wy≈õwietlanie opinii do moderacji
      function displayReviewsForModeration(reviews) {
        const reviewsList = document.getElementById("reviews-list");
        const reviewsEmpty = document.getElementById("reviews-empty");

        if (reviews.length === 0) {
          reviewsEmpty.classList.remove("hidden");
          reviewsList.innerHTML = "";
          return;
        }

        reviewsEmpty.classList.add("hidden");

        reviewsList.innerHTML = reviews
          .map(
            (review) => `
          <div class="admin-card" data-review-id="${review.id}">
            <div class="flex justify-between items-start mb-4">
              <div>
                <div class="font-bold text-lg">${review.raterName} ‚Üí ${review.ratedName}</div>
                <div class="text-sm text-zinc-400">${formatDate(review.timestamp)}</div>
              </div>
              <div class="flex items-center space-x-2">
                <span class="status-badge status-${review.status || "pending"}">
                  ${getStatusText(review.status || "pending")}
                </span>
                <div class="flex space-x-1">
                  ${generateStars(review.rating)}
                </div>
              </div>
            </div>

            <div class="bg-zinc-800 p-4 rounded-lg mb-4">
              <p class="text-zinc-300">${review.comment}</p>
            </div>

            ${
              review.status === "pending"
                ? `
              <div class="flex space-x-2">
                <button onclick="approveReview('${review.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  <i class="fa-solid fa-check mr-2"></i>
                  Zatwierd≈∫
                </button>
                <button onclick="rejectReview('${review.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                  <i class="fa-solid fa-times mr-2"></i>
                  Odrzuƒá
                </button>
              </div>
            `
                : review.status === "approved"
                  ? `
              <div class="flex space-x-2">
                <button onclick="rejectReview('${review.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 transition">
                  <i class="fa-solid fa-times mr-2"></i>
                  Odrzuƒá
                </button>
              </div>
            `
                  : `
              <div class="flex space-x-2">
                <button onclick="approveReview('${review.id}')" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition">
                  <i class="fa-solid fa-check mr-2"></i>
                  Zatwierd≈∫
                </button>
              </div>
            `
            }
          </div>
        `,
          )
          .join("");

        // Obs≈Çuga filtra
        document
          .getElementById("reviews-filter")
          .addEventListener("change", (e) => {
            const filter = e.target.value;
            filterReviews(reviews, filter);
          });
      }

      // Filtrowanie opinii
      function filterReviews(reviews, status) {
        let filteredReviews = reviews;

        if (status !== "all") {
          filteredReviews = reviews.filter(
            (review) => (review.status || "pending") === status,
          );
        }

        displayReviewsForModeration(filteredReviews);
      }

      // Generowanie gwiazdek dla opinii
      function generateStars(rating) {
        let stars = "";
        for (let i = 1; i <= 5; i++) {
          stars += `<i class="fa-solid fa-star ${i <= rating ? "text-yellow-400" : "text-zinc-600"}"></i>`;
        }
        return stars;
      }

      // Pobieranie tekstu statusu
      function getStatusText(status) {
        switch (status) {
          case "pending":
            return "Oczekuje";
          case "approved":
            return "Zatwierdzona";
          case "rejected":
            return "Odrzucona";
          default:
            return "Nieznany";
        }
      }

      // Zatwierdzanie opinii
      async function approveReview(reviewId) {
        try {
          await updateDoc(doc(db, "userReviews", reviewId), {
            status: "approved",
          });

          showNotification("Opinia zosta≈Ça zatwierdzona", "success");
          loadReviews(); // Od≈õwie≈º listƒô
        } catch (error) {
          console.error("B≈ÇƒÖd zatwierdzania opinii:", error);
          showNotification("B≈ÇƒÖd zatwierdzania opinii", "error");
        }
      }

      // Odrzucanie opinii
      async function rejectReview(reviewId) {
        try {
          await updateDoc(doc(db, "userReviews", reviewId), {
            status: "rejected",
          });

          showNotification("Opinia zosta≈Ça odrzucona", "success");
          loadReviews(); // Od≈õwie≈º listƒô
        } catch (error) {
          console.error("B≈ÇƒÖd odrzucania opinii:", error);
          showNotification("B≈ÇƒÖd odrzucania opinii", "error");
        }
      }

      // ===== KONIEC FUNKCJI MODERACJI OPINII =====

      // Funkcja sprawdzajƒÖca sesjƒô lokalnego administratora przy ≈Çadowaniu strony
      // Funkcja sprawdzajƒÖca sesjƒô lokalnego administratora przy ≈Çadowaniu strony
      function checkLocalAdminSessionOnLoad() {
        console.log('üîç Checking local admin session on page load...');
        try {
          // Sprawd≈∫ najpierw localStorage (g≈Ç√≥wny), potem sessionStorage (dodatkowy)
          const localSession = localStorage.getItem('admin_session');
          const sessionSession = sessionStorage.getItem('admin_session');
          const adminSession = localSession || sessionSession;

          console.log('üì¶ Local storage session:', localSession ? 'EXISTS' : 'NOT FOUND');
          console.log('üì¶ Session storage session:', sessionSession ? 'EXISTS' : 'NOT FOUND');

          if (adminSession) {
            console.log('‚úÖ Admin session found, parsing...');
            const sessionData = JSON.parse(adminSession);
            const now = Date.now();
            const expiresAt = sessionData.expiresAt || (sessionData.loginTime + 2 * 60 * 60 * 1000);

            console.log('‚è∞ Session expires at:', new Date(expiresAt).toLocaleString());
            console.log('‚è∞ Current time:', new Date(now).toLocaleString());
            console.log('‚è∞ Time remaining:', Math.floor((expiresAt - now) / (1000 * 60)), 'minutes');

            if (now < expiresAt) {
              console.log('üöÄ Session is valid - auto-logging in admin...');
              // Sesja jest wa≈ºna - zaloguj lokalnego administratora
              currentUser = {
                uid: sessionData.uid || 'local-admin',
                email: sessionData.email || sessionData.login,
                displayName: sessionData.displayName || `${sessionData.login}@Administrator`,
                isLocalAdmin: true,
                originalLogin: sessionData.login
              };

              updateAdminDisplay(currentUser);
              startSessionTimeUpdater();
              document.getElementById("login-section").classList.add("hidden");
              document.getElementById("admin-panel").classList.remove("hidden");
              switchTab("dashboard");

              console.log('‚úÖ Auto-login successful!');
              return true; // Znalaziono i zalogowano lokalnego administratora
            } else {
              console.log('‚ùå Session expired - removing');
              // Sesja wygas≈Ça - usu≈Ñ jƒÖ
              localStorage.removeItem('admin_session');
              sessionStorage.removeItem('admin_session');
            }
          } else {
            console.log('‚ùå No admin session found in storage');
          }
        } catch (error) {
          console.warn('‚ùå Error checking local admin session:', error);
          localStorage.removeItem('admin_session');
          sessionStorage.removeItem('admin_session');
        }
        console.log('‚ùå checkLocalAdminSessionOnLoad returning false');
        return false;
      }

      // ZJEDNOCZONY SYSTEM AUTORYZACJI (Hybrid Auth)
      let localAdminLoggedIn = false; // Globalna flaga dla lokalnego administratora

      // G≈Ç√≥wny listener autoryzacji - obs≈Çuguje zar√≥wno Firebase jak i lokalnych administrator√≥w
        onAuthStateChanged(auth, async (user) => {
        // Je≈õli ju≈º jeste≈õmy zalogowani jako lokalny administrator, nie r√≥b nic
        if (currentUser && currentUser.isLocalAdmin) {
          console.log('üîê Already logged in as local admin, skipping Firebase check');
          return;
        }

          if (user && (await checkAdminRole(user))) {
          // Firebase administrator
          console.log('üîê Firebase admin logged in');
            currentUser = user;
            updateAdminDisplay(user);
            document.getElementById("login-section").classList.add("hidden");
            document.getElementById("admin-panel").classList.remove("hidden");
            switchTab("dashboard");
        } else {
          // Firebase nie widzi administratora - sprawd≈∫ lokalnego administratora
          console.log('üîê Firebase user not found or not admin, checking local admin session');
          const localSessionValid = checkLocalAdminSessionOnLoad();
          if (!localSessionValid) {
            // Ani Firebase ani lokalna sesja - poka≈º sekcjƒô logowania
            console.log('üîê No valid authentication found, showing login section');
            document.getElementById("login-section").classList.remove("hidden");
            document.getElementById("admin-panel").classList.add("hidden");
          }
        }
      });

      // Obs≈Çuga checkboxa "Zapamiƒôtaj ADMIN"
      document.addEventListener("DOMContentLoaded", function () {
        const toggleElement = document.getElementById("admin-remember-toggle");
        if (toggleElement) {
          toggleElement.addEventListener("click", function () {
            const checkbox = document.getElementById("admin-remember");
            const text1 = document.getElementById("admin-remember-text-1");
            const text2 = document.getElementById("admin-remember-text-2");

            if (!checkbox || !text1 || !text2) return;

            checkbox.checked = !checkbox.checked;

            if (checkbox.checked) {
              text1.classList.add("text-green-500");
              text1.classList.remove("text-zinc-400");
              text2.classList.add("text-green-500");
              text2.classList.remove("text-zinc-400");
            } else {
              text1.classList.add("text-zinc-400");
              text1.classList.remove("text-green-500");
              text2.classList.add("text-zinc-400");
              text2.classList.remove("text-green-500");
            }
          });

          // Hover efekty
          toggleElement.addEventListener("mouseenter", function () {
            const text1 = document.getElementById("admin-remember-text-1");
            const text2 = document.getElementById("admin-remember-text-2");

            text1.classList.add("text-green-500");
            text1.classList.remove("text-zinc-400");
            text2.classList.add("text-green-500");
            text2.classList.remove("text-zinc-400");
          });

          toggleElement.addEventListener("mouseleave", function () {
            const checkbox = document.getElementById("admin-remember");
            const text1 = document.getElementById("admin-remember-text-1");
            const text2 = document.getElementById("admin-remember-text-2");

            if (!checkbox.checked) {
              text1.classList.add("text-zinc-400");
              text1.classList.remove("text-green-500");
              text2.classList.add("text-zinc-400");
              text2.classList.remove("text-green-500");
            }
          });
        }

        // Event listener dla pola wiadomo≈õci - wykrywanie pisania
        const messageInput = document.getElementById("message-input");
        if (messageInput) {
          messageInput.addEventListener("input", function() {
            isTypingInMessage = this.value.length > 0;
          });

          messageInput.addEventListener("blur", function() {
            // Po kr√≥tkim op√≥≈∫nieniu oznacz jako niepisanie (≈ºeby daƒá czas na wys≈Çanie)
            setTimeout(() => {
              isTypingInMessage = false;
            }, 1000);
          });
        }

      });
    </script>

    <!-- Global loading overlay -->
    <div id="dashboard-loading-overlay" class="dashboard-loading-overlay">
      <div class="loading-content">
        <div class="loading-spinner-large">
          <i class="fa-solid fa-sync-alt"></i>
        </div>
        <p class="loading-text">Od≈õwie≈ºanie dashboardu...</p>
      </div>
    </div>
  </body>
</html>